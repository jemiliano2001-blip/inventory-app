<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Central de Inventario</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <!-- jsPDF for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- SheetJS for Excel Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- PWA Manifest (Ensure you have a manifest.json file) -->
    <!-- <link rel="manifest" href="manifest.json"> -->
    <meta name="theme-color" content="#4f46e5">

    <style>
        /* CSS Variables for Theming */
        :root {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --text-color-light: #6b7280;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --sidebar-bg: #4338ca;
            --sidebar-hover-bg: #3730a3;
            --sidebar-active-bg: #3730a3;
            --sidebar-text: #ffffff;
            --header-bg: #ffffff;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
        }

        html.dark {
            --bg-color: #111827; /* gray-900 - m√°s suave que slate-900 */
            --text-color: #f9fafb; /* gray-50 - m√°s brillante */
            --text-color-light: #9ca3af; /* gray-400 */
            --card-bg: #1f2937; /* gray-800 - m√°s c√°lido */
            --border-color: #374151; /* gray-700 */
            --sidebar-bg: #111827; /* gray-900 - mismo que bg-color */
            --sidebar-hover-bg: #374151; /* gray-700 */
            --sidebar-active-bg: #4b5563; /* gray-600 */
            --sidebar-text: #f9fafb; /* gray-50 */
            --header-bg: #1f2937; /* gray-800 */
            --input-bg: #374151; /* gray-700 */
            --input-border: #4b5563; /* gray-600 */
        }

        /* Applying Variables */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .themed-bg {
            background-color: var(--bg-color);
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        #app-container {
            height: 100vh;
        }
        
        #login-screen, #app-container, #modal-container, #notification-container {
            color: #1f2937; /* Reset text color for overlays */
        }
        
        html.dark #login-screen, html.dark #app-container, html.dark #modal-container, html.dark #notification-container {
             color: var(--text-color);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        html.dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0, -30px, 0); }
            70% { transform: translate3d(0, -15px, 0); }
            90% { transform: translate3d(0, -4px, 0); }
        }

        /* Animation Classes */
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }

        .animate-slide-in-right {
            animation: slideInRight 0.3s ease-out;
        }

        .animate-scale-in {
            animation: scaleIn 0.3s ease-out;
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        .animate-bounce {
            animation: bounce 1s;
        }

        /* Hover Effects */
        .hover-lift {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .hover-glow {
            transition: box-shadow 0.3s ease;
        }

        .hover-glow:hover {
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.3);
        }

        /* Loading States */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Notification Animations */
        .pop-animation {
            animation: scaleIn 0.3s ease-out;
        }

        /* Smooth Transitions */
        .transition-all {
            transition: all 0.3s ease;
        }

        .transition-colors {
            transition: color 0.2s ease, background-color 0.2s ease, border-color 0.2s ease;
        }

        .transition-transform {
            transition: transform 0.2s ease;
        }

        /* Responsive Design Improvements */
        @media (max-width: 768px) {
            .mobile-hidden {
                display: none !important;
            }
            
            .mobile-full {
                width: 100% !important;
            }
            
            .mobile-stack {
                flex-direction: column !important;
            }
            
            .mobile-p-4 {
                padding: 1rem !important;
            }
            
            .mobile-text-sm {
                font-size: 0.875rem !important;
            }
            
            .mobile-text-xs {
                font-size: 0.75rem !important;
            }
            
            /* Enhanced Mobile Table Styles */
            .mobile-table {
                display: block;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-table table {
                min-width: 600px;
                width: 100%;
            }
            
            .mobile-table thead {
                display: none;
            }
            
            .mobile-table tbody,
            .mobile-table tr,
            .mobile-table td {
                display: block;
                width: 100%;
            }
            
            .mobile-table tr {
                background: var(--card-bg);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                margin-bottom: 12px;
                padding: 12px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            
            .mobile-table td {
                border: none;
                padding: 8px 0;
                text-align: left;
                position: relative;
                padding-left: 30%;
            }
            
            .mobile-table td:before {
                content: attr(data-label) ": ";
                position: absolute;
                left: 0;
                width: 25%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: 600;
                color: var(--text-color-light);
                font-size: 0.875rem;
            }
            
            /* Enhanced Mobile Cards */
            .mobile-card {
                background: var(--card-bg);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 16px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            
            /* Enhanced Mobile Buttons */
            .mobile-btn {
                width: 100%;
                padding: 12px 16px;
                font-size: 16px;
                border-radius: 8px;
                margin-bottom: 8px;
                min-height: 44px; /* iOS touch target minimum */
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Mobile Sidebar */
            .mobile-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 280px;
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .mobile-sidebar.open {
                transform: translateX(0);
            }
            
            .mobile-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }
        }

        @media (max-width: 640px) {
            .sm-mobile-p-2 {
                padding: 0.5rem !important;
            }
            
            .sm-mobile-text-xs {
                font-size: 0.625rem !important;
            }
            
            .sm-mobile-hidden {
                display: none !important;
            }
        }

        /* Enhanced Mobile Responsive Styles */
        @media (max-width: 768px) {
            /* Dark mode adjustments */
            html.dark .mobile-table tr {
                background: var(--card-bg);
                border-color: var(--border-color);
            }
            
            html.dark .mobile-card {
                background: var(--card-bg);
                border-color: var(--border-color);
            }
            
            /* Form improvements */
            .mobile-form input,
            .mobile-form select,
            .mobile-form textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
                border-radius: 8px;
                min-height: 44px;
            }
            
            /* Modal improvements */
            .mobile-modal {
                margin: 16px;
                max-height: calc(100vh - 32px);
                overflow-y: auto;
            }
            
            /* Header improvements */
            .mobile-header {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            /* Search improvements */
            .mobile-search {
                width: 100%;
                margin-bottom: 12px;
            }
            
            /* Navigation improvements */
            .mobile-nav {
                padding: 8px 0;
            }
            
            .mobile-nav .nav-link {
                padding: 12px 16px;
                margin: 4px 0;
                border-radius: 8px;
                min-height: 44px;
            }
            
            /* Dashboard widgets */
            .mobile-dashboard-widget {
                margin-bottom: 16px;
            }
            
            /* Table container improvements */
            .mobile-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border-radius: 8px;
                border: 1px solid var(--border-color);
            }
            
            /* Button group improvements */
            .mobile-btn-group {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .mobile-btn-group .btn {
                width: 100%;
                min-height: 44px;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 480px) {
            .mobile-p-2 {
                padding: 8px !important;
            }
            
            .mobile-text-xs {
                font-size: 0.75rem !important;
            }
            
            .mobile-hidden {
                display: none !important;
            }
            
            /* Even smaller touch targets for very small screens */
            .mobile-btn {
                min-height: 40px;
                font-size: 14px;
            }
        }

        /* Other styles */
        .low-stock {
            background-color: #fee2e2 !important;
        }
        html.dark .low-stock {
             background-color: #450a0a !important;
             color: #fca5a5;
        }
        
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-animation {
            animation: pop 0.3s ease-out forwards;
        }
        
        i[data-lucide], svg {
            pointer-events: none;
        }

        /* Themed components */
        .themed-card { background-color: var(--card-bg); border-color: var(--border-color); }
        .themed-sidebar { 
            background: linear-gradient(180deg, var(--sidebar-bg) 0%, rgba(17, 24, 39, 0.95) 100%);
            color: var(--sidebar-text); 
            min-height: 100vh;
        }
        .themed-sidebar .nav-link:hover { background-color: var(--sidebar-hover-bg); }
        .themed-sidebar .nav-link.active { background-color: var(--sidebar-active-bg); }
        .themed-header { background-color: var(--header-bg); border-color: var(--border-color); color: var(--text-color); }
        .themed-input { background-color: var(--input-bg); border-color: var(--input-border); color: var(--text-color); }
        .themed-table-header { background-color: var(--bg-color); }
        .themed-table-body { background-color: var(--card-bg); }
        .themed-border { border-color: var(--border-color); }
        .themed-divide > * + * { border-color: var(--border-color); }
        .themed-text-light { color: var(--text-color-light); }
        
        /* AI Insights specific styles */
        #ai-content {
            display: block !important;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }
        
        #ai-content.hidden {
            display: none !important;
        }
        
        #ai-loading {
            display: flex;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }
        
        #ai-loading.hidden {
            display: none !important;
        }
        
        .ai-tab-link {
            position: relative;
            overflow: hidden;
        }
        
        .ai-tab-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: #4f46e5;
            transition: width 0.3s ease;
        }
        
        .ai-tab-link:hover::after {
            width: 100%;
        }
        
        .ai-tab-link.border-indigo-500::after {
            width: 100%;
        }
        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;}
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s;  border-radius: 50%;}
        input:checked + .slider { background-color: #4f46e5; }
        input:focus + .slider { box-shadow: 0 0 1px #4f46e5; }
        input:checked + .slider:before { transform: translateX(16px); }
        html.dark .slider { background-color: #475569; }
        html.dark input:checked + .slider { background-color: #6366f1; }
        
        /* Modern scrollbar styles */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        /* Enhanced focus styles */
        .themed-input:focus, select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        
        /* Gradient backgrounds for sections */
        .gradient-bg {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
        }
        
        /* Card hover effects */
        .hover-lift {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        html.dark .hover-lift:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        /* Loading animation */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Modern button styles */
        .btn-modern {
            position: relative;
            overflow: hidden;
            transform: translateZ(0);
            transition: all 0.2s ease;
        }
        .btn-modern:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .btn-modern:active {
            transform: translateY(0);
        }

        /* Settings CSS */
        :root {
            --font-size: 16px;
        }

        /* Font size settings */
        body.small-font {
            font-size: 14px;
        }
        body.large-font {
            font-size: 18px;
        }

        /* Compact sidebar */
        .compact-sidebar .sidebar {
            width: 4rem;
        }
        .compact-sidebar .sidebar .nav-text {
            display: none;
        }
        .compact-sidebar .main-content {
            margin-left: 4rem;
        }

        /* Table density settings */
        .table-compact table td,
        .table-compact table th {
            padding: 0.5rem;
        }
        .table-spacious table td,
        .table-spacious table th {
            padding: 1rem;
        }

        /* Column lines */
        .no-column-lines table td,
        .no-column-lines table th {
            border-right: none;
        }

        /* Row hover */
        .no-row-hover table tr:hover {
            background-color: transparent;
        }

        /* Animations */
        .no-animations * {
            transition: none !important;
            animation: none !important;
        }

        /* High contrast mode */
        .high-contrast {
            filter: contrast(150%);
        }
        .high-contrast .themed-card {
            border: 2px solid #000;
        }

    </style>
</head>
<body class="themed-bg">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-gradient-to-br from-indigo-50 via-white to-cyan-50 z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <!-- Login Card -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 p-8 space-y-8">
                <!-- Header -->
                <div class="text-center">
                    <div class="mx-auto h-16 w-16 flex items-center justify-center rounded-2xl bg-gradient-to-r from-indigo-500 to-purple-600 shadow-lg">
                        <i data-lucide="package" class="h-8 w-8 text-white"></i>
                    </div>
                    <h2 class="mt-6 text-2xl font-bold text-gray-900">
                        Inventario Central
                    </h2>
                    <p class="mt-2 text-sm text-gray-600">
                        Gestiona tu inventario de forma inteligente
                    </p>
                </div>

                <!-- Login Form -->
                <form id="login-form" class="space-y-6">
                    <div class="space-y-4">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                                Correo electr√≥nico
                            </label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="mail" class="h-5 w-5 text-gray-400"></i>
                                </div>
                                <input id="email" name="email" type="email" autocomplete="email" required 
                                       class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200" 
                                       placeholder="tu@email.com">
                            </div>
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                                Contrase√±a
                            </label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="lock" class="h-5 w-5 text-gray-400"></i>
                                </div>
                                <input id="password" name="password" type="password" autocomplete="current-password" required 
                                       class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200" 
                                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                        </div>
                    </div>

                    <div id="auth-error-message" class="text-red-600 text-center text-base font-medium hidden bg-red-100 p-4 rounded-lg border-2 border-red-300 shadow-sm"></div>

                    <!-- Debug button (temporary) -->
                    <button type="button" id="debug-button" 
                            class="w-full flex justify-center items-center py-2 px-4 border border-gray-300 rounded-xl text-sm font-medium text-gray-700 bg-gray-50 hover:bg-gray-100 mb-4">
                        üîç Debug: Test Firebase Connection
                    </button>

                    <button type="submit" id="login-button" 
                            class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-xl shadow-sm text-sm font-medium text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                        <i data-lucide="log-in" class="h-5 w-5 mr-2" id="login-icon"></i>
                        <span id="login-text">Iniciar Sesi√≥n</span>
                        <div id="login-spinner" class="hidden">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </button>
                </form>
            </div>

            <!-- Footer -->
            <div class="mt-8 text-center">
                <p class="text-xs text-gray-500">
                    Sistema de Gesti√≥n de Inventario v2.0
                </p>
            </div>
        </div>
    </div>

    <!-- Main App Structure (hidden by default) -->
    <div id="app-container" class="hidden h-screen w-full flex">
        <!-- Sidebar -->
        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
        
        <aside id="sidebar" class="themed-sidebar w-72 h-screen space-y-1 pt-6 pb-0 px-4 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-all duration-300 ease-in-out z-30 flex flex-col overflow-y-auto">
            <!-- Logo Section -->
            <div class="px-2">
                <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-white/10 transition-all duration-200">
                    <div class="h-10 w-10 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center">
                        <i data-lucide="package" class="h-6 w-6 text-white"></i>
                    </div>
                    <div>
                        <span class="text-xl font-bold text-white">Inventario</span>
                        <p class="text-xs text-white/70">Sistema Central</p>
                    </div>
                </a>
            </div>

            <!-- Navigation -->
            <nav id="main-nav" class="flex-1 space-y-1 px-2">
                <a href="#dashboard" class="nav-link flex items-center space-x-3 py-2 px-4 rounded-xl transition-all duration-200 active group">
                    <div class="h-8 w-8 rounded-lg bg-white/10 flex items-center justify-center group-hover:bg-white/20 transition-colors">
                        <i data-lucide="layout-dashboard" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Dashboard</span>
                </a>
                <a href="#inventory" class="nav-link flex items-center space-x-3 py-2 px-4 rounded-xl transition-all duration-200 group">
                    <div class="h-8 w-8 rounded-lg bg-white/10 flex items-center justify-center group-hover:bg-white/20 transition-colors">
                        <i data-lucide="archive" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Inventario</span>
                </a>
                <a href="#active-loans" class="nav-link flex items-center space-x-3 py-2 px-4 rounded-xl transition-all duration-200 group">
                    <div class="h-8 w-8 rounded-lg bg-white/10 flex items-center justify-center group-hover:bg-white/20 transition-colors">
                        <i data-lucide="arrow-right-left" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Pr√©stamos</span>
                </a>
                <a href="#history" class="nav-link flex items-center space-x-3 py-2 px-4 rounded-xl transition-all duration-200 group">
                    <div class="h-8 w-8 rounded-lg bg-white/10 flex items-center justify-center group-hover:bg-white/20 transition-colors">
                        <i data-lucide="history" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Historial</span>
                </a>
                <a href="#reports" class="nav-link flex items-center space-x-3 py-2 px-4 rounded-xl transition-all duration-200 group">
                    <div class="h-8 w-8 rounded-lg bg-white/10 flex items-center justify-center group-hover:bg-white/20 transition-colors">
                        <i data-lucide="file-down" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Reportes</span>
                </a>
                <a href="#shopping-list" class="nav-link flex items-center space-x-3 py-2 px-4 rounded-xl transition-all duration-200 group relative">
                    <div class="h-8 w-8 rounded-lg bg-white/10 flex items-center justify-center group-hover:bg-white/20 transition-colors">
                        <i data-lucide="shopping-cart" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Compras</span>
                    <span id="shopping-list-count" class="absolute right-4 top-1/2 -translate-y-1/2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </a>
                <a href="#users" id="users-nav-link" class="nav-link flex items-center space-x-3 py-2 px-4 rounded-xl transition-all duration-200 group hidden">
                    <div class="h-8 w-8 rounded-lg bg-white/10 flex items-center justify-center group-hover:bg-white/20 transition-colors">
                        <i data-lucide="users" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Usuarios</span>
                </a>
                <a href="#settings" id="settings-nav-link" class="nav-link flex items-center space-x-3 py-2 px-4 rounded-xl transition-all duration-200 group">
                    <div class="h-8 w-8 rounded-lg bg-white/10 flex items-center justify-center group-hover:bg-white/20 transition-colors">
                        <i data-lucide="settings" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Configuraci√≥n</span>
                </a>
                <a href="#" id="logout-button" class="nav-link flex items-center space-x-3 py-2 px-4 rounded-xl transition-all duration-200 group">
                    <div class="h-8 w-8 rounded-lg bg-white/10 flex items-center justify-center group-hover:bg-white/20 transition-colors">
                        <i data-lucide="log-out" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Cerrar Sesi√≥n</span>
                </a>
                <a href="#" id="dark-mode-toggle" class="nav-link flex items-center space-x-3 py-2 px-4 rounded-xl transition-all duration-200 group">
                    <div class="h-8 w-8 rounded-lg bg-white/10 flex items-center justify-center group-hover:bg-white/20 transition-colors">
                        <i data-lucide="moon" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Modo Oscuro</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="themed-header flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 sm:p-6 border-b bg-white/80 backdrop-blur-sm mobile-header">
                <div class="flex items-center space-x-4">
                    <button id="menu-button" class="focus:outline-none md:hidden p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i data-lucide="menu" class="h-5 w-5"></i>
                    </button>
                    <div>
                        <h1 id="page-title" class="text-2xl font-bold text-gray-900 dark:text-white">Dashboard</h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Vista general del inventario</p>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                    <div class="relative w-full sm:w-80 mobile-search">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <i data-lucide="search" class="h-5 w-5 text-gray-400"></i>
                        </div>
                        <input id="search-input" type="text" 
                               class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white transition-all duration-200 text-base" 
                               placeholder="Buscar art√≠culos...">
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="h-8 w-8 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center">
                            <i data-lucide="user" class="h-4 w-4 text-white"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300" id="user-name">Usuario</span>
                    </div>
                </div>
            </header>

            <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto p-4 sm:p-6">
                <!-- Views will be injected here -->
            </main>
        </div>
    </div>

    <!-- Modals Container -->
    <div id="modal-container"></div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 right-4 sm:top-5 sm:right-5 z-50 max-w-sm sm:max-w-md"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, onSnapshot, addDoc, updateDoc, writeBatch, query, where, serverTimestamp, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- CONFIGURACI√ìN ---
        // NOTA DE SEGURIDAD CR√çTICA: Tu configuraci√≥n de Firebase est√° expuesta en el lado del cliente.
        // Esto es normal, pero significa que DEBES asegurar tu base de datos usando Reglas de Seguridad de Firebase.
        // El error "Missing or insufficient permissions" significa que tus reglas son demasiado restrictivas.
        // Para desarrollo, puedes empezar con estas reglas en tu Consola de Firebase -> Firestore -> Reglas:
        /*
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            match /{document=**} {
              // Permite leer y escribir a cualquier usuario autenticado.
              // ¬°NO USAR EN PRODUCCI√ìN SIN RESTRINGIR M√ÅS!
              allow read, write: if request.auth != null;
            }
          }
        }
        */
        const firebaseConfig = {
            apiKey: "AIzaSyDPvm07EShBWY_tqG1J6DZCxuKj0sbN1Cw",
            authDomain: "mi-inventario-app-e44a9.firebaseapp.com",
            projectId: "mi-inventario-app-e44a9",
            storageBucket: "mi-inventario-app-e44a9.appspot.com",
            messagingSenderId: "863395232436",
            appId: "1:863395232436:web:3f65ad3cc2ce61d30175e1",
            measurementId: "G-GE6QRCGJRH"
        };

        // --- INICIALIZACI√ìN DE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- ESTADO GLOBAL DE LA APP ---
        function getInitialState() {
            return {
                inventory: [],
                activeLoans: [],
                transactions: [],
                shoppingList: [],
                categories: [],
                allUsers: [],
                searchIndex: new Map(), // √çndice para b√∫squeda r√°pida
                currentUser: null,
                userRole: 'operator',
                currentPage: 1,
                itemsPerPage: 10,
                searchTerm: '',
                activeCategory: 'Todas',
                inventoryFilter: 'all', // 'all', 'low', 'returnable'
                isInitialized: false,
                settings: {
                    itemsPerPage: 10,
                    defaultUnit: 'pza',
                    defaultMinStock: 5,
                    sessionTimeout: 480, // 8 hours in minutes
                    enableAuditLog: true,
                    barcodeScanning: false,
                    customValidations: {
                        maxQuantityPerTransaction: 1000,
                        preventNegativeStock: true
                    },
                    displayPreferences: {
                        tableDensity: 'comfortable', // compact, comfortable, spacious
                        showColumnLines: true,
                        enableRowHover: true
                    },
                    operationalPreferences: {
                        confirmBeforeDelete: true,
                        defaultTransactionType: 'Salida',
                        showRecentItems: true,
                        recentItemsCount: 10
                    },
                    dashboardCustomization: {
                        showStockOverview: true,
                        showRecentTransactions: true,
                        showLowStockAlerts: true,
                        showQuickActions: true
                    },
                    interfaceCustomization: {
                        compactSidebar: false,
                        animationsEnabled: true,
                        fontSize: 'medium' // small, medium, large
                    },
                    notificationPreferences: {
                        lowStockAlert: 'on_login' // always, on_login, never
                    }
                }
            };
        }
        
        let state = getInitialState();
        let unsubscribeFunctions = []; // Store unsubscribe functions for cleanup
        
        // --- L√ìGICA DE INICIALIZACI√ìN Y AUTENTICACI√ìN ---
        
        // Cleanup function to prevent memory leaks
        function cleanupListeners() {
            unsubscribeFunctions.forEach(unsubscribe => {
                if (typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
            unsubscribeFunctions = [];
        }
        
        // --- UTILITY FUNCTIONS ---
        
        // --- FUNCIONES DE B√öSQUEDA OPTIMIZADA ---
        
        // Construir √≠ndice de b√∫squeda para acceso r√°pido
        function buildSearchIndex() {
            const index = new Map();
            state.inventory.forEach(item => {
                const searchText = `${item.description} ${item.category}`.toLowerCase();
                const words = searchText.split(/\s+/);
                const itemData = {
                    id: item.id,
                    description: item.description,
                    category: item.category,
                    searchText: searchText,
                    words: words
                };
                index.set(item.id, itemData);
            });
            state.searchIndex = index;
        }
        
        // Algoritmo de fuzzy matching optimizado
        function fuzzyMatch(search, target, threshold = 0.6) {
            search = search.toLowerCase();
            target = target.toLowerCase();
            
            // Coincidencia exacta
            if (target.includes(search)) return 1.0;
            
            // B√∫squeda por palabras individuales
            const searchWords = search.split(/\s+/);
            const targetWords = target.split(/\s+/);
            
            let matches = 0;
            searchWords.forEach(sw => {
                if (targetWords.some(tw => tw.startsWith(sw) || tw.includes(sw))) {
                    matches++;
                }
            });
            
            const score = matches / searchWords.length;
            return score >= threshold ? score : 0;
        }
        
        function safeCreateIcons() {
            if (window.lucide) {
                try {
                    lucide.createIcons();
                } catch (e) {
                    console.error("Error creating lucide icons:", e);
                }
            } else {
                setTimeout(() => {
                    if(window.lucide) {
                        try {
                           lucide.createIcons();
                        } catch (e) {
                           console.error("Error creating lucide icons on retry:", e);
                        }
                    } else {
                        console.error("Lucide icons library failed to load.");
                    }
                }, 1000);
            }
        }
        
        window.addEventListener('load', () => {
            setupStaticEventListeners();
            if (localStorage.getItem('theme') === 'dark') {
                document.documentElement.classList.add('dark');
            }
            
            // Update dark mode toggle after a short delay to ensure DOM is ready
            setTimeout(() => {
                updateDarkModeToggle();
            }, 100);

            console.log('üîß Setting up onAuthStateChanged listener...');
            onAuthStateChanged(auth, async (user) => {
                console.log('üîÑ Auth state changed:', user ? `User logged in: ${user.uid}` : 'User logged out');
                console.log('üîç Login screen element:', document.getElementById('login-screen'));
                console.log('üîç App container element:', document.getElementById('app-container'));
                
                const loginScreen = document.getElementById('login-screen');
                const appContainer = document.getElementById('app-container');

                if (user) {
                    console.log('‚úÖ User authenticated, hiding login screen...');
                    try {
                        loginScreen.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        state.currentUser = user;
                        await fetchUserRole(user.uid);
                        
                        if (state.userRole === 'admin') {
                            await loadSettings();
                        }

                        if (!state.isInitialized) {
                            console.log('üöÄ Initializing app state...');
                            state.isInitialized = true;
                            initializeAppState();
                        } else {
                             // If re-authenticating, re-apply settings that affect UI
                            applyInterfaceSettings();
                        }
                        
                        const isAdmin = state.userRole === 'admin';
                        document.getElementById('users-nav-link').classList.toggle('hidden', !isAdmin);
                        // Settings link is now visible for both admins and operators
                        
                        // Manejar visibilidad del enlace de IA
                        addAINavigation();
                    } catch (error) {
                        console.error("Firebase Initialization Error:", error);
                        if (error.code === 'permission-denied') {
                            showNotification('Error de permisos: Revisa la configuraci√≥n de la base de datos.', 'error');
                        } else {
                            showNotification('Error al cargar los datos. Intenta de nuevo.', 'error');
                        }
                    }

                } else {
                    loginScreen.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    document.getElementById('main-content').innerHTML = '';
                    state = getInitialState();
                }
            });
        });
        
        async function fetchUserRole(uid) {
            console.log('üë§ Fetching user role for UID:', uid);
            const userDocRef = doc(db, 'users', uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                state.userRole = userDoc.data().role;
                console.log('‚úÖ User role found:', state.userRole);
            } else {
                console.log('üÜï Creating new user document...');
                // Set default role for new users
                await setDoc(userDocRef, { email: auth.currentUser.email, role: 'operator' });
                state.userRole = 'operator';
                console.log('‚úÖ New user created with role:', state.userRole);
            }
        }

        async function loadSettings() {
            const settingsRef = doc(db, 'settings', 'global');
            const settingsDoc = await getDoc(settingsRef);
            if (settingsDoc.exists()) {
                state.settings = { ...state.settings, ...settingsDoc.data() };
                state.itemsPerPage = state.settings.itemsPerPage || 10;
            } else if (state.userRole === 'admin') {
                // Create initial settings document if it doesn't exist
                await setDoc(settingsRef, state.settings);
            }
        }

        function displayAuthError(errorCode) {
            const errorMessage = document.getElementById('auth-error-message');
            let message = "Ocurri√≥ un error. Int√©ntelo de nuevo.";

            switch(errorCode) {
                case "auth/user-not-found":
                case "auth/wrong-password":
                case "auth/invalid-credential":
                    message = "üî¥ Correo o contrase√±a incorrectos.";
                    break;
                case "auth/invalid-input":
                    message = "üî¥ Por favor, complete todos los campos.";
                    break;
                case "auth/too-many-requests":
                    message = "üî¥ Demasiados intentos fallidos. Int√©ntelo m√°s tarde.";
                    break;
                case "auth/network-request-failed":
                    message = "üî¥ Error de conexi√≥n. Verifique su internet.";
                    break;
            }
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        async function handleSuccessfulLogin(user) {
            console.log('üéØ Handling successful login manually...');
            
            const loginScreen = document.getElementById('login-screen');
            const appContainer = document.getElementById('app-container');

            try {
                console.log('‚úÖ User authenticated, hiding login screen...');
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                state.currentUser = user;
                
                console.log('üë§ Fetching user role...');
                await fetchUserRole(user.uid);
                
                if (state.userRole === 'admin') {
                    console.log('‚öôÔ∏è Loading admin settings...');
                    await loadSettings();
                }

                if (!state.isInitialized) {
                    console.log('üöÄ Initializing app state...');
                    state.isInitialized = true;
                    await initializeAppState();
                } else {
                    console.log('üîÑ Re-applying interface settings...');
                    applyInterfaceSettings();
                }
                
                const isAdmin = state.userRole === 'admin';
                document.getElementById('users-nav-link').classList.toggle('hidden', !isAdmin);
                
                // Manejar visibilidad del enlace de IA
                addAINavigation();
                
                console.log('‚úÖ Login process completed successfully!');
                
            } catch (error) {
                console.log('‚ùå Error in handleSuccessfulLogin:', error);
                // Show error but don't reset login state
                displayAuthError('auth/unknown-error');
            }
        }

        async function initializeAppState() {
            console.log('üéØ Initializing app state, navigating to dashboard...');
            applyInterfaceSettings();
            const page = window.location.hash.substring(1) || 'dashboard';
            console.log('üìç Navigating to page:', page);
            navigateTo(page); 
            await checkAndLoadInitialData();
            setupRealtimeListeners();
            
            // Add AI navigation link for admin users
            addAINavigation();
            
            // Also try again after a delay to ensure everything is loaded
            setTimeout(() => {
                addAINavigation();
            }, 500);
        }

        async function checkAndLoadInitialData() {
            const inventoryRef = collection(db, 'inventory');
            const snapshot = await getDocs(query(inventoryRef));
            if (snapshot.empty) {
                showNotification('Cargando inventario...', 'info');
                const initialInventory = getFullInventoryList(); 
                if (initialInventory.length === 0) {
                    showNotification('No hay art√≠culos en el inventario. Agrega algunos en la secci√≥n de inventario.', 'info');
                    return;
                }
                const batch = writeBatch(db);
                initialInventory.forEach(item => {
                    const docRef = doc(collection(db, 'inventory'));
                    batch.set(docRef, { ...item });
                });
                await batch.commit();
                showNotification('Inventario cargado correctamente.', 'success');
                
                // Construir √≠ndice de b√∫squeda despu√©s de cargar inventario inicial
                buildSearchIndex();
            }
        }
        
        function setupRealtimeListeners() {
            const handleSnapshotError = (collectionName, error) => {
                console.error(`Error fetching ${collectionName}:`, error);
                showNotification(`Error al cargar ${collectionName}. Intenta de nuevo.`, 'error');
            };

            const unsubscribeInventory = onSnapshot(collection(db, 'inventory'), (snapshot) => {
                state.inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.description.localeCompare(b.description));
                
                // Reconstruir √≠ndice de b√∫squeda cuando cambia el inventario
                buildSearchIndex();
                
                const uniqueCategoriesFromInventory = [...new Set(state.inventory.map(item => item.category))];
                const categoriesFromSettings = state.settings.categories || [];
                state.categories = ['Todas', ...new Set([...uniqueCategoriesFromInventory, ...categoriesFromSettings])].sort();

                const currentPage = window.location.hash.substring(1) || 'dashboard';
                if (state.isInitialized) {
                    if (currentPage === 'inventory' || currentPage === 'settings') {
                        navigateTo(currentPage, true);
                    }
                    if (currentPage === 'dashboard') renderDashboardView();
                }
            }, (error) => handleSnapshotError('inventario', error));
            unsubscribeFunctions.push(unsubscribeInventory);

            const loansQuery = query(collection(db, 'loans'), where('returnedAt', '==', null));
            const unsubscribeLoans = onSnapshot(loansQuery, (snapshot) => {
                state.activeLoans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.isInitialized && window.location.hash === '#active-loans') renderActiveLoansView();
            }, (error) => handleSnapshotError('pr√©stamos activos', error));
            unsubscribeFunctions.push(unsubscribeLoans);

            const unsubscribeTransactions = onSnapshot(collection(db, 'transactions'), (snapshot) => {
                state.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.isInitialized) {
                    const currentPage = window.location.hash.substring(1);
                    if (currentPage === 'history') renderHistoryView();
                    if (currentPage === 'dashboard') renderDashboardView();
                }
            }, (error) => handleSnapshotError('transacciones', error));
            unsubscribeFunctions.push(unsubscribeTransactions);

            const unsubscribeShoppingList = onSnapshot(collection(db, 'shoppingList'), (snapshot) => {
                state.shoppingList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateShoppingListCount();
                if (state.isInitialized && window.location.hash === '#shopping-list') renderShoppingListView();
            }, (error) => handleSnapshotError('lista de compras', error));
            unsubscribeFunctions.push(unsubscribeShoppingList);
            
            if (state.userRole === 'admin') {
                const unsubscribeSettings = onSnapshot(doc(db, 'settings', 'global'), (docSnap) => {
                    if (docSnap.exists()) {
                        const newSettings = { ...getInitialState().settings, ...docSnap.data() };
                        const oldSettings = state.settings;
                        state.settings = newSettings;
                        state.itemsPerPage = state.settings.itemsPerPage || 10;
                        
                        // Apply all settings to UI
                        applySettingsToUI(newSettings);
                        
                        const uniqueCategoriesFromInventory = [...new Set(state.inventory.map(item => item.category))];
                        const categoriesFromSettings = state.settings.categories || [];
                        state.categories = ['Todas', ...new Set([...uniqueCategoriesFromInventory, ...categoriesFromSettings])].sort();

                        const currentPage = window.location.hash.substring(1);
                        if (state.isInitialized) {
                           if(currentPage === 'settings' || currentPage === 'inventory') navigateTo(currentPage, true);
                           if(currentPage === 'dashboard') renderDashboardView();
                        }
                    }
                }, (error) => handleSnapshotError('configuraciones', error));
                unsubscribeFunctions.push(unsubscribeSettings);

                const unsubscribeUsers = onSnapshot(collection(db, 'users'), (snapshot) => {
                    state.allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if(state.isInitialized && window.location.hash === '#users') renderUsersView();
                }, (error) => handleSnapshotError('usuarios', error));
                unsubscribeFunctions.push(unsubscribeUsers);
            }
        }

        // --- NAVEGACI√ìN Y RENDERIZADO DE VISTAS ---
        function navigateTo(page, isRefresh = false) {
            const pageTitle = document.getElementById('page-title');
            const searchContainer = document.getElementById('search-input').parentElement.parentElement;
            
            const searchablePages = ['inventory', 'active-loans', 'history'];
            searchContainer.classList.toggle('hidden', !searchablePages.includes(page));

            if (!isRefresh) {
                 updateActiveNavLink(page);
            }

            switch (page) {
                case 'dashboard':
                    if (!isRefresh) pageTitle.textContent = 'Dashboard';
                    renderDashboardView();
                    break;
                case 'inventory':
                    if (!isRefresh) pageTitle.textContent = 'Inventario';
                    renderInventoryView();
                    break;
                case 'active-loans':
                    if (!isRefresh) pageTitle.textContent = 'Pr√©stamos Activos';
                    renderActiveLoansView();
                    break;
                case 'history':
                    if (!isRefresh) pageTitle.textContent = 'Historial';
                    renderHistoryView();
                    break;
                case 'reports':
                    if (!isRefresh) pageTitle.textContent = 'Reportes';
                    renderReportsView();
                    break;
                case 'shopping-list':
                    if (!isRefresh) pageTitle.textContent = 'Lista de Compras';
                    renderShoppingListView();
                    break;
                case 'users':
                    if (state.userRole === 'admin') {
                        if (!isRefresh) pageTitle.textContent = 'Usuarios';
                        renderUsersView();
                    } else { window.location.hash = 'dashboard'; }
                    break;
                case 'settings':
                    if (!isRefresh) pageTitle.textContent = state.userRole === 'admin' ? 'Ajustes' : 'Configuraci√≥n';
                    renderSettingsView();
                    break;
                default:
                    window.location.hash = 'dashboard';
            }
            safeCreateIcons();
            // Enhance mobile tables and experience after navigation
            setTimeout(() => {
                enhanceMobileTables();
                enhanceMobileExperience();
            }, 100);
        }

        function updateActiveNavLink(page) {
            document.querySelectorAll('#main-nav .nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${page}`) {
                    link.classList.add('active');
                }
            });
        }
        
        // --- IMPLEMENTACI√ìN DE AJUSTES DE INTERFAZ ---
        function applyInterfaceSettings() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return;
            
            const isCompact = state.settings.interfaceCustomization.compactSidebar;

            sidebar.classList.toggle('w-64', !isCompact);
            sidebar.classList.toggle('w-20', isCompact);

            sidebar.querySelectorAll('span').forEach(el => {
                el.classList.toggle('opacity-0', isCompact);
                el.classList.toggle('hidden', isCompact);
            });
            sidebar.querySelectorAll('.nav-link').forEach(el => {
                el.classList.toggle('justify-center', isCompact);
            });
        }

        // --- VISTAS ---
        function renderDashboardView() {
            const mainContent = document.getElementById('main-content');
            const { dashboardCustomization } = state.settings;

            const lowStockCount = state.inventory.filter(item => item.stock < item.minStock).length;
            const activeLoansCount = state.activeLoans.length;
            const totalTransactions = state.transactions.length;

            mainContent.innerHTML = `
                <div class="space-y-8">
                    <!-- Welcome Section -->
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-8 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold mb-2">¬°Bienvenido de vuelta!</h2>
                                <p class="text-indigo-100 text-lg">Aqu√≠ tienes un resumen de tu inventario</p>
                            </div>
                            <div class="hidden md:block">
                                <i data-lucide="trending-up" class="h-16 w-16 text-white/20"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 hover:shadow-xl transition-all duration-300">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Art√≠culos Totales</p>
                                    <p class="text-3xl font-bold text-gray-900 dark:text-white">${state.inventory.length}</p>
                                </div>
                                <div class="h-12 w-12 rounded-xl bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                                    <i data-lucide="package" class="h-6 w-6 text-blue-600 dark:text-blue-400"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 hover:shadow-xl transition-all duration-300">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Stock Bajo</p>
                                    <p class="text-3xl font-bold text-red-600">${lowStockCount}</p>
                                </div>
                                <div class="h-12 w-12 rounded-xl bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                                    <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 hover:shadow-xl transition-all duration-300">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Pr√©stamos Activos</p>
                                    <p class="text-3xl font-bold text-green-600">${activeLoansCount}</p>
                                </div>
                                <div class="h-12 w-12 rounded-xl bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                                    <i data-lucide="arrow-right-left" class="h-6 w-6 text-green-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 hover:shadow-xl transition-all duration-300">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Transacciones</p>
                                    <p class="text-3xl font-bold text-purple-600">${totalTransactions}</p>
                                </div>
                                <div class="h-12 w-12 rounded-xl bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                                    <i data-lucide="activity" class="h-6 w-6 text-purple-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Dashboard Content -->
                    <div id="dashboard-widgets" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6"></div>
                </div>
            `;
            
            const widgetsContainer = document.getElementById('dashboard-widgets');
            let widgetsHTML = '';
            
            if (dashboardCustomization.showQuickActions) {
                 widgetsHTML += `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center mb-6">
                            <div class="h-8 w-8 rounded-lg bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center mr-3">
                                <i data-lucide="zap" class="h-4 w-4 text-indigo-600"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Acciones R√°pidas</h3>
                        </div>
                        <div class="space-y-3">
                            <button id="quick-add-item" class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-medium py-4 px-6 rounded-xl flex items-center justify-center transition-all duration-200 transform hover:scale-105 min-h-[60px]">
                                <i data-lucide="plus" class="h-8 w-8"></i>
                            </button>
                            <button id="quick-add-entry" class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-medium py-4 px-6 rounded-xl flex items-center justify-center transition-all duration-200 transform hover:scale-105 min-h-[60px]">
                                <i data-lucide="plus-circle" class="h-8 w-8"></i>
                            </button>
                            <button id="quick-add-checkout" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-medium py-4 px-6 rounded-xl flex items-center justify-center transition-all duration-200 transform hover:scale-105 min-h-[60px]">
                                <i data-lucide="arrow-right-left" class="h-8 w-8"></i>
                            </button>
                        </div>
                    </div>
                 `;
            }

            if (dashboardCustomization.showStockOverview) {
                widgetsHTML += `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center mb-6">
                            <div class="h-8 w-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mr-3">
                                <i data-lucide="bar-chart-3" class="h-4 w-4 text-blue-600"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Art√≠culos M√°s Utilizados</h3>
                        </div>
                        <canvas id="topConsumablesChart" class="w-full h-64"></canvas>
                    </div>`;
            }
            if (dashboardCustomization.showLowStockAlerts) {
                 widgetsHTML += `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center mb-6">
                            <div class="h-8 w-8 rounded-lg bg-red-100 dark:bg-red-900/30 flex items-center justify-center mr-3">
                                <i data-lucide="pie-chart" class="h-4 w-4 text-red-600"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Herramientas Reportadas</h3>
                        </div>
                        <canvas id="topReportedChart" class="w-full h-64"></canvas>
                    </div>`;
            }
            if (dashboardCustomization.showRecentTransactions) {
                widgetsHTML += `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center mb-6">
                            <div class="h-8 w-8 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center mr-3">
                                <i data-lucide="users" class="h-4 w-4 text-green-600"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Empleados con M√°s Pr√©stamos</h3>
                        </div>
                        <canvas id="topEmployeesChart" class="w-full h-64"></canvas>
                    </div>`;
            }

            if(widgetsHTML === ''){
                widgetsContainer.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-12 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 text-center col-span-full">
                        <div class="h-16 w-16 rounded-2xl bg-gray-100 dark:bg-gray-700 flex items-center justify-center mx-auto mb-6">
                            <i data-lucide="layout-dashboard" class="h-8 w-8 text-gray-400"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">El Panel de Control est√° vac√≠o</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-6">Personaliza tu dashboard habilitando widgets desde la configuraci√≥n</p>
                        <a href="#settings" class="inline-flex items-center px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-xl transition-colors duration-200">
                            <i data-lucide="settings" class="h-4 w-4 mr-2"></i>
                            Ir a Configuraci√≥n
                        </a>
                    </div>
                `;
            } else {
                 widgetsContainer.innerHTML = widgetsHTML;
                 generateCharts();
                 if (dashboardCustomization.showQuickActions) {
                     document.getElementById('quick-add-item').addEventListener('click', () => {
                         if (state.userRole === 'admin') {
                             showNewItemModal();
                         } else {
                             showNotification("Solo los administradores pueden agregar art√≠culos.", "info");
                         }
                     });
                     document.getElementById('quick-add-entry').addEventListener('click', () => showEntryModal());
                     document.getElementById('quick-add-checkout').addEventListener('click', () => showCheckoutModal());
                 }
            }
            safeCreateIcons();
        }

        function renderInventoryView() {
            const mainContent = document.getElementById('main-content');
            
            let filteredInventory = state.inventory;

            // Filtro de categor√≠a (r√°pido con √≠ndice)
            if (state.activeCategory !== 'Todas') {
                filteredInventory = filteredInventory.filter(item => item.category === state.activeCategory);
            }

            // B√∫squeda con fuzzy matching
            if (state.searchTerm) {
                const searchLower = state.searchTerm.toLowerCase();
                filteredInventory = filteredInventory
                    .map(item => {
                        const indexData = state.searchIndex.get(item.id);
                        const score = fuzzyMatch(searchLower, indexData.searchText);
                        return { item, score };
                    })
                    .filter(({ score }) => score > 0)
                    .sort((a, b) => b.score - a.score)
                    .map(({ item }) => item);
            }

            if (state.inventoryFilter === 'low') {
                filteredInventory = filteredInventory.filter(item => item.stock < item.minStock);
            }

            const totalPages = Math.ceil(filteredInventory.length / state.itemsPerPage);
            state.currentPage = Math.min(state.currentPage, totalPages) || 1;
            const paginatedInventory = filteredInventory.slice((state.currentPage - 1) * state.itemsPerPage, state.currentPage * state.itemsPerPage);

            const isAdmin = state.userRole === 'admin';
            
            const filterButtonClasses = (filter) => `px-4 py-2 text-sm font-medium rounded-md ${state.inventoryFilter === filter ? 'bg-indigo-600 text-white' : 'bg-white dark:bg-slate-700 themed-text hover:bg-gray-100 dark:hover:bg-slate-600'}`;

            mainContent.innerHTML = `
                <div class="space-y-6">
                    <!-- Header Section -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Inventario</h2>
                            <p class="text-gray-500 dark:text-gray-400">Gestiona tu inventario de forma eficiente</p>
                        </div>
                        <button id="new-item-btn" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-medium py-4 px-8 rounded-xl flex items-center justify-center transition-all duration-200 transform hover:scale-105 min-h-[60px] min-w-[60px]">
                            <i data-lucide="plus" class="h-8 w-8"></i>
                        </button>
                    </div>

                    <!-- Filters and Categories -->
                    <div class="flex flex-col lg:flex-row gap-6">
                        <!-- Categories Sidebar -->
                        <div class="lg:w-1/4">
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Categor√≠as</h3>
                                    <button id="add-category-btn-inventory" class="bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg transition-colors min-h-[48px] min-w-[48px] flex items-center justify-center" title="Agregar nueva categor√≠a">
                                        <i data-lucide="plus" class="h-6 w-6"></i>
                                    </button>
                                </div>
                                <ul id="category-list" class="space-y-2">
                                    <li>
                                        <a href="#" class="category-filter flex items-center px-4 py-3 rounded-lg transition-colors ${state.activeCategory === 'Todas' ? 'bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 font-medium' : 'hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300'}" data-category="Todas">
                                            <i data-lucide="grid-3x3" class="h-4 w-4 mr-3"></i>
                                            Todas
                                        </a>
                                    </li>
                                    ${state.categories.map(cat => `
                                        <li>
                                            <a href="#" class="category-filter flex items-center px-4 py-3 rounded-lg transition-colors ${state.activeCategory === cat ? 'bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 font-medium' : 'hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300'}" data-category="${cat}">
                                                <i data-lucide="folder" class="h-4 w-4 mr-3"></i>
                                                ${cat}
                                            </a>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>

                        <!-- Main Content -->
                        <div class="lg:w-3/4">
                            <!-- Filter Buttons -->
                            <div class="flex flex-wrap gap-2 mb-6">
                                <button class="inventory-filter-btn px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200 ${state.inventoryFilter === 'all' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 border border-gray-200 dark:border-gray-600'}" data-filter="all">
                                    <i data-lucide="grid-3x3" class="h-4 w-4 mr-2"></i>
                                    Todos
                                </button>
                                <button class="inventory-filter-btn px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200 ${state.inventoryFilter === 'low' ? 'bg-red-600 text-white shadow-lg' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 border border-gray-200 dark:border-gray-600'}" data-filter="low">
                                    <i data-lucide="alert-triangle" class="h-4 w-4 mr-2"></i>
                                    Stock Bajo
                                </button>
                            </div>

                            <!-- Inventory Table -->
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 overflow-hidden">
                                <div class="overflow-x-auto">
                                    <div class="mobile-table-container">
                                        <table class="min-w-full mobile-table">
                                            <thead class="bg-gray-50 dark:bg-gray-700">
                                            <tr>
                                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Art√≠culo</th>
                                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Categor√≠a</th>
                                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Stock</th>
                                                <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="inventory-table-body" class="divide-y divide-gray-200 dark:divide-gray-600">
                                            ${paginatedInventory.length > 0 ? paginatedInventory.map(item => `
                                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors ${item.stock < item.minStock ? 'bg-red-50 dark:bg-red-900/20' : ''}">
                                                    <td class="px-6 py-4">
                                                        <div class="flex items-center">
                                                            <div class="h-10 w-10 rounded-lg bg-gray-100 dark:bg-gray-600 flex items-center justify-center mr-4">
                                                                <i data-lucide="package" class="h-5 w-5 text-gray-600 dark:text-gray-300"></i>
                                                            </div>
                                                            <div>
                                                                <div class="text-sm font-medium text-gray-900 dark:text-white">${item.description}</div>
                                                                ${item.stock < item.minStock ? '<div class="text-xs text-red-600">Stock bajo</div>' : ''}
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                                                            ${item.category}
                                                        </span>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <div class="text-sm font-medium text-gray-900 dark:text-white">${item.stock} ${item.unit}</div>
                                                        <div class="text-xs text-gray-500 dark:text-gray-400">Min: ${item.minStock}</div>
                                                    </td>
                                                    <td class="px-6 py-4 text-center">
                                                        <div class="flex items-center justify-center space-x-3">
                                                            <button class="action-btn p-3 text-green-600 hover:text-green-700 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg transition-colors min-h-[48px] min-w-[48px] flex items-center justify-center" data-action="entry" data-id="${item.id}" title="Registrar Entrada">
                                                                <i data-lucide="plus-circle" class="h-6 w-6"></i>
                                                            </button>
                                                            <button class="action-btn p-3 ${item.stock <= 0 ? 'text-gray-400 cursor-not-allowed opacity-50' : 'text-blue-600 hover:text-blue-700 hover:bg-blue-100 dark:hover:bg-blue-900/30'} rounded-lg transition-colors min-h-[48px] min-w-[48px] flex items-center justify-center" data-action="checkout" data-id="${item.id}" title="${item.stock <= 0 ? 'Sin Stock Disponible' : 'Registrar Salida/Pr√©stamo'}" ${item.stock <= 0 ? 'disabled' : ''}>
                                                                <i data-lucide="arrow-right-left" class="h-6 w-6"></i>
                                                            </button>
                                                            <button class="action-btn p-3 text-yellow-600 hover:text-yellow-700 hover:bg-yellow-100 dark:hover:bg-yellow-900/30 rounded-lg transition-colors min-h-[48px] min-w-[48px] flex items-center justify-center" data-action="add-to-cart" data-id="${item.id}" title="A√±adir a Lista de Compras">
                                                                <i data-lucide="shopping-cart" class="h-6 w-6"></i>
                                                            </button>
                                                            ${isAdmin ? `
                                                                <button class="action-btn p-3 text-purple-600 hover:text-purple-700 hover:bg-purple-100 dark:hover:bg-purple-900/30 rounded-lg transition-colors min-h-[48px] min-w-[48px] flex items-center justify-center" data-action="edit" data-id="${item.id}" title="Editar Art√≠culo">
                                                                    <i data-lucide="pencil" class="h-6 w-6"></i>
                                                                </button>
                                                                <button class="action-btn p-3 text-orange-600 hover:text-orange-700 hover:bg-orange-100 dark:hover:bg-orange-900/30 rounded-lg transition-colors min-h-[48px] min-w-[48px] flex items-center justify-center" data-action="edit-stock" data-id="${item.id}" title="Editar Stock">
                                                                    <i data-lucide="edit-3" class="h-6 w-6"></i>
                                                                </button>
                                                                <button class="action-btn p-3 text-red-600 hover:text-red-700 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors min-h-[48px] min-w-[48px] flex items-center justify-center" data-action="delete" data-id="${item.id}" title="Eliminar Art√≠culo">
                                                                    <i data-lucide="trash-2" class="h-6 w-6"></i>
                                                                </button>
                                                            ` : ''}
                                                        </div>
                                                    </td>
                                                </tr>
                                            `).join('') : `
                                                <tr>
                                                    <td colspan="5" class="px-6 py-12 text-center">
                                                        <div class="flex flex-col items-center">
                                                            <i data-lucide="package" class="h-12 w-12 text-gray-400 mb-4"></i>
                                                            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No se encontraron art√≠culos</h3>
                                                            <p class="text-gray-500 dark:text-gray-400">Intenta ajustar los filtros o agregar nuevos art√≠culos</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `}
                                </tbody>
                                        </table>
                                    </div>
                            <div id="paginator" class="px-6 py-3 border-t themed-border">${generatePaginator(totalPages)}</div>
                        </div>
                    </div>
                </div>
            `;
            if (isAdmin) {
                document.getElementById('new-item-btn').addEventListener('click', showNewItemModal);
            }
            safeCreateIcons();
        }

        function renderActiveLoansView() {
            const mainContent = document.getElementById('main-content');
            
            let filteredLoans = state.activeLoans;
            
            // B√∫squeda optimizada con fuzzy matching
            if (state.searchTerm) {
                const searchLower = state.searchTerm.toLowerCase();
                filteredLoans = filteredLoans
                    .map(loan => {
                        const searchText = `${loan.itemDescription} ${loan.borrower}`.toLowerCase();
                        const score = fuzzyMatch(searchLower, searchText);
                        return { loan, score };
                    })
                    .filter(({ score }) => score > 0)
                    .sort((a, b) => b.score - a.score)
                    .map(({ loan }) => loan);
            }

            // Check if user has seen the onboarding tooltip before
            const hasSeenOnboarding = localStorage.getItem('devoluciones-onboarding-seen') === 'true';
            const showOnboarding = !hasSeenOnboarding && filteredLoans.length > 0;

            mainContent.innerHTML = `
                <div class="relative">
                    ${showOnboarding ? `
                        <div id="onboarding-tooltip" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 bg-yellow-400 border-4 border-yellow-600 rounded-2xl p-6 shadow-2xl max-w-sm mx-auto">
                            <div class="flex items-start space-x-3">
                                <div class="text-4xl">üí°</div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-bold text-gray-800 mb-2">Primera vez aqu√≠?</h3>
                                    <div class="text-gray-700 text-sm space-y-1">
                                        <p><strong>1.</strong> Toque aqu√≠ para escanear el art√≠culo</p>
                                        <p><strong>2.</strong> Toque el bot√≥n verde para confirmar</p>
                                    </div>
                                </div>
                                <button id="close-tooltip" class="text-gray-600 hover:text-gray-800 text-xl font-bold">&times;</button>
                            </div>
                        </div>
                        <div id="tooltip-overlay" class="fixed inset-0 bg-black bg-opacity-30 z-40"></div>
                    ` : ''}
                    
                    <div class="themed-card rounded-lg shadow-md overflow-x-auto">
                        <div class="mobile-table-container">
                            <table class="min-w-full themed-divide divide-y mobile-table">
                            <thead class="themed-table-header">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium themed-text-light uppercase tracking-wider">Art√≠culo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium themed-text-light uppercase tracking-wider">Prestado a</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium themed-text-light uppercase tracking-wider">Fecha de Pr√©stamo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium themed-text-light uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="themed-table-body themed-divide divide-y">
                                ${filteredLoans.length > 0 ? filteredLoans.map(loan => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">${loan.itemDescription}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${loan.borrower}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${new Date(loan.loanedAt.seconds * 1000).toLocaleString()}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-3">
                                            <button class="return-btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg min-h-[48px] min-w-[48px] flex items-center justify-center transition-all duration-200" data-loan-id="${loan.id}" data-item-id="${loan.itemId}" title="Devoluci√≥n">
                                                <i data-lucide="rotate-ccw" class="h-6 w-6"></i>
                                            </button>
                                            <button class="report-loss-btn bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg min-h-[48px] min-w-[48px] flex items-center justify-center transition-all duration-200" data-loan-id="${loan.id}" data-item-id="${loan.itemId}" title="P√©rdida">
                                                <i data-lucide="x-circle" class="h-6 w-6"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('') : `<tr><td colspan="4" class="text-center py-10 themed-text-light">No hay pr√©stamos activos.</td></tr>`}
                            </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners for onboarding tooltip
            if (showOnboarding) {
                const tooltip = document.getElementById('onboarding-tooltip');
                const overlay = document.getElementById('tooltip-overlay');
                const closeBtn = document.getElementById('close-tooltip');
                
                const dismissTooltip = () => {
                    tooltip.style.display = 'none';
                    overlay.style.display = 'none';
                    localStorage.setItem('devoluciones-onboarding-seen', 'true');
                };
                
                closeBtn.addEventListener('click', dismissTooltip);
                overlay.addEventListener('click', dismissTooltip);
                
                // Dismiss when user performs any action
                const actionButtons = document.querySelectorAll('.return-btn, .report-loss-btn');
                actionButtons.forEach(btn => {
                    btn.addEventListener('click', dismissTooltip);
                });
            }
            
            safeCreateIcons();
        }

        function renderHistoryView() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="themed-card rounded-lg shadow-md">
                    <div class="p-4">
                        <nav class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                            <a href="#" class="tab-link whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm themed-text-light dark:text-gray-300" data-type="salidas">Salidas</a>
                            <a href="#" class="tab-link whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm themed-text-light dark:text-gray-300" data-type="prestamos">Pr√©stamos</a>
                            <a href="#" class="tab-link whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm themed-text-light dark:text-gray-300" data-type="devoluciones">Devoluciones</a>
                            <a href="#" class="tab-link whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm themed-text-light dark:text-gray-300" data-type="bajas">Bajas</a>
                            <a href="#" class="tab-link whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm themed-text-light dark:text-gray-300" data-type="entradas">Entradas</a>
                        </nav>
                    </div>
                    <div id="history-content" class="p-4"></div>
                </div>
            `;
            renderHistoryTab('salidas');
        }

        function renderHistoryTab(tabType) {
            document.querySelectorAll('.tab-link').forEach(tab => {
                const isSelected = tab.dataset.type === tabType;
                tab.classList.toggle('border-indigo-500', isSelected);
                tab.classList.toggle('text-indigo-600', isSelected);
                tab.classList.toggle('dark:text-indigo-400', isSelected);
                tab.classList.toggle('border-transparent', !isSelected);
                tab.classList.toggle('themed-text-light', !isSelected);
                tab.classList.toggle('dark:text-gray-300', !isSelected);
            });

            const content = document.getElementById('history-content');
            const typeMap = {
                salidas: ['Salida', 'Intercambio'], prestamos: ['Pr√©stamo'],
                devoluciones: ['Devoluci√≥n'], bajas: ['Baja', 'Eliminado'], entradas: ['Entrada', 'Creaci√≥n']
            };
            
            const lowerCaseSearch = state.searchTerm.toLowerCase();
            let data = state.transactions.filter(t => typeMap[tabType].includes(t.type));
            
            // B√∫squeda optimizada con fuzzy matching
            if (state.searchTerm) {
                data = data
                    .map(t => {
                        const searchText = `${t.itemDescription} ${t.user || ''} ${t.borrower || ''} ${t.supplier || ''}`.toLowerCase();
                        const score = fuzzyMatch(lowerCaseSearch, searchText);
                        return { transaction: t, score };
                    })
                    .filter(({ score }) => score > 0)
                    .sort((a, b) => b.score - a.score)
                    .map(({ transaction }) => transaction);
            }
            
            data = data.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);
            
            const headers = ['Fecha', 'Tipo', 'Art√≠culo', 'Cantidad', 'Responsable', 'Notas'];

            content.innerHTML = `
                <div class="overflow-x-auto">
                    <div class="mobile-table-container">
                        <table class="min-w-full themed-divide divide-y mobile-table">
                        <thead class="themed-table-header">
                            <tr>${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium themed-text-light uppercase tracking-wider">${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody class="themed-table-body themed-divide divide-y">
                            ${data.length > 0 ? data.map(t => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">${t.timestamp?.seconds ? new Date(t.timestamp.seconds * 1000).toLocaleString() : 'Fecha no disponible'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${t.type}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${t.itemDescription}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${t.quantity}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${t.type === 'Devoluci√≥n' ? (t.borrower || 'N/A') : (t.supplier || t.user || t.borrower) || 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${t.notes || ''}</td>
                                </tr>
                            `).join('') : `<tr><td colspan="${headers.length}" class="text-center py-10 themed-text-light">No hay registros.</td></tr>`}
                        </tbody>
                        </table>
                    </div>
                </div>
            `;
            safeCreateIcons();
        }


        function renderReportsView() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="space-y-8">
                    <!-- Header Section -->
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-8 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold mb-2">Centro de Reportes</h2>
                                <p class="text-indigo-100 text-lg">Genera reportes detallados en PDF y Excel</p>
                            </div>
                            <div class="hidden md:block">
                                <i data-lucide="file-text" class="h-16 w-16 text-white/20"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Report Types -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Inventario Completo -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 hover:shadow-xl transition-all duration-300">
                            <div class="flex items-center mb-4">
                                <div class="h-12 w-12 rounded-xl bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mr-4">
                                    <i data-lucide="archive" class="h-6 w-6 text-blue-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Inventario Completo</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Todos los art√≠culos del inventario</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button data-type="inventory" data-format="pdf" class="report-btn flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-200">
                                    <i data-lucide="file-text" class="h-4 w-4"></i>
                                    <span>PDF</span>
                                </button>
                                <button data-type="inventory" data-format="excel" class="report-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-200">
                                    <i data-lucide="file-spreadsheet" class="h-4 w-4"></i>
                                    <span>Excel</span>
                                </button>
                            </div>
                        </div>

                        <!-- Pr√©stamos Activos -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 hover:shadow-xl transition-all duration-300">
                            <div class="flex items-center mb-4">
                                <div class="h-12 w-12 rounded-xl bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center mr-4">
                                    <i data-lucide="arrow-right-left" class="h-6 w-6 text-orange-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Pr√©stamos Activos</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Pr√©stamos pendientes de devoluci√≥n</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button data-type="loans" data-format="pdf" class="report-btn flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-200">
                                    <i data-lucide="file-text" class="h-4 w-4"></i>
                                    <span>PDF</span>
                                </button>
                                <button data-type="loans" data-format="excel" class="report-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-200">
                                    <i data-lucide="file-spreadsheet" class="h-4 w-4"></i>
                                    <span>Excel</span>
                                </button>
                            </div>
                        </div>

                        <!-- Historial de Salidas -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 hover:shadow-xl transition-all duration-300">
                            <div class="flex items-center mb-4">
                                <div class="h-12 w-12 rounded-xl bg-green-100 dark:bg-green-900/30 flex items-center justify-center mr-4">
                                    <i data-lucide="log-out" class="h-6 w-6 text-green-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Historial de Salidas</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Registro de salidas de inventario</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button data-type="salidas" data-format="pdf" class="report-btn flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-200">
                                    <i data-lucide="file-text" class="h-4 w-4"></i>
                                    <span>PDF</span>
                                </button>
                                <button data-type="salidas" data-format="excel" class="report-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-200">
                                    <i data-lucide="file-spreadsheet" class="h-4 w-4"></i>
                                    <span>Excel</span>
                                </button>
                            </div>
                        </div>

                        <!-- Historial de Pr√©stamos -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 hover:shadow-xl transition-all duration-300">
                            <div class="flex items-center mb-4">
                                <div class="h-12 w-12 rounded-xl bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mr-4">
                                    <i data-lucide="arrow-right-left" class="h-6 w-6 text-blue-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Historial de Pr√©stamos</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Registro completo de pr√©stamos</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button data-type="prestamos" data-format="pdf" class="report-btn flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-200">
                                    <i data-lucide="file-text" class="h-4 w-4"></i>
                                    <span>PDF</span>
                                </button>
                                <button data-type="prestamos" data-format="excel" class="report-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-200">
                                    <i data-lucide="file-spreadsheet" class="h-4 w-4"></i>
                                    <span>Excel</span>
                                </button>
                            </div>
                        </div>

                        <!-- Historial de Devoluciones -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 hover:shadow-xl transition-all duration-300">
                            <div class="flex items-center mb-4">
                                <div class="h-12 w-12 rounded-xl bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center mr-4">
                                    <i data-lucide="log-in" class="h-6 w-6 text-purple-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Historial de Devoluciones</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Registro de devoluciones</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button data-type="devoluciones" data-format="pdf" class="report-btn flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-200">
                                    <i data-lucide="file-text" class="h-4 w-4"></i>
                                    <span>PDF</span>
                                </button>
                                <button data-type="devoluciones" data-format="excel" class="report-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-200">
                                    <i data-lucide="file-spreadsheet" class="h-4 w-4"></i>
                                    <span>Excel</span>
                                </button>
                            </div>
                        </div>

                        <!-- Inventario Manual -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 hover:shadow-xl transition-all duration-300">
                            <div class="flex items-center mb-4">
                                <div class="h-12 w-12 rounded-xl bg-yellow-100 dark:bg-yellow-900/30 flex items-center justify-center mr-4">
                                    <i data-lucide="clipboard-check" class="h-6 w-6 text-yellow-600 dark:text-yellow-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Inventario Manual</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Formulario para conteo f√≠sico</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button id="generate-manual-inventory-pdf" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-200">
                                    <i data-lucide="file-text" class="h-4 w-4"></i>
                                    <span>Generar PDF</span>
                                </button>
                            </div>
                        </div>

                        <!-- Reporte de Stock Bajo -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 hover:shadow-xl transition-all duration-300">
                            <div class="flex items-center mb-4">
                                <div class="h-12 w-12 rounded-xl bg-red-100 dark:bg-red-900/30 flex items-center justify-center mr-4">
                                    <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Stock Bajo</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Art√≠culos con stock insuficiente</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button data-type="low-stock" data-format="pdf" class="report-btn flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-200">
                                    <i data-lucide="file-text" class="h-4 w-4"></i>
                                    <span>PDF</span>
                                </button>
                                <button data-type="low-stock" data-format="excel" class="report-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-200">
                                    <i data-lucide="file-spreadsheet" class="h-4 w-4"></i>
                                    <span>Excel</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Report Preview Section -->
                    <div id="report-preview" class="hidden bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Vista Previa del Reporte</h3>
                            <button id="close-preview" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <i data-lucide="x" class="h-5 w-5"></i>
                            </button>
                        </div>
                        <div id="preview-content" class="max-h-96 overflow-y-auto">
                            <!-- Preview content will be inserted here -->
                        </div>
                    </div>
                </div>
            `;
            safeCreateIcons();
        }

        function renderShoppingListView() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="themed-card p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Lista de Compras</h2>
                        <div class="flex space-x-2">
                            <button id="generate-pdf-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg flex items-center space-x-2 transition-all duration-200 ${state.shoppingList.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${state.shoppingList.length === 0 ? 'disabled' : ''}>
                                <i data-lucide="file-text"></i><span>PDF</span>
                            </button>
                            <button id="generate-excel-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg flex items-center space-x-2 transition-all duration-200 ${state.shoppingList.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${state.shoppingList.length === 0 ? 'disabled' : ''}>
                                <i data-lucide="file-spreadsheet"></i><span>Excel</span>
                            </button>
                        </div>
                    </div>
                    <ul id="shopping-list-items" class="themed-divide divide-y">
                        ${state.shoppingList.length > 0 ? state.shoppingList.map(item => `
                            <li class="py-3 flex justify-between items-center">
                                <span><span class="font-bold text-indigo-600 dark:text-indigo-400">${item.quantity} x</span> ${item.description}</span>
                                <button class="remove-from-cart-btn text-red-500 hover:text-red-700" data-id="${item.id}"><i data-lucide="x-circle"></i></button>
                            </li>
                        `).join('') : `<li class="py-10 text-center themed-text-light">La lista de compras est√° vac√≠a.</li>`}
                    </ul>
                </div>
            `;
            safeCreateIcons();
        }

        function renderUsersView() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="themed-card rounded-lg shadow-md overflow-x-auto">
                    <div class="mobile-table-container">
                        <table class="min-w-full themed-divide divide-y mobile-table">
                        <thead class="themed-table-header">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium themed-text-light uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium themed-text-light uppercase tracking-wider">Rol</th>
                                <th class="px-6 py-3 text-left text-xs font-medium themed-text-light uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="themed-table-body themed-divide divide-y">
                            ${state.allUsers.map(user => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${user.role}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        ${state.currentUser.uid !== user.id ? `
                                            <select class="role-selector themed-input border rounded-md" data-uid="${user.id}">
                                                <option value="operator" ${user.role === 'operator' ? 'selected' : ''}>Operador</option>
                                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                            </select>
                                        ` : '<span class="themed-text-light">(T√∫)</span>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.querySelectorAll('.role-selector').forEach(selector => {
                selector.addEventListener('change', async (e) => {
                    const newRole = e.target.value;
                    const uid = e.target.dataset.uid;
                    try {
                        await updateDoc(doc(db, 'users', uid), { role: newRole });
                        showNotification('Rol actualizado correctamente.', 'success');
                    } catch (error) {
                        showNotification('Error al cambiar el rol. Intenta de nuevo.', 'error');
                    }
                });
            });
        }
        
        function renderSettingsView() {
            const mainContent = document.getElementById('main-content');
            const isAdmin = state.userRole === 'admin';
            
            mainContent.innerHTML = `
            <div class="max-w-7xl mx-auto space-y-6">
                <!-- Header -->
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold themed-text">${isAdmin ? 'Ajustes del Sistema' : 'Configuraci√≥n Personal'}</h1>
                        <p class="text-lg themed-text-light mt-1">${isAdmin ? 'Cambia c√≥mo funciona la aplicaci√≥n para que sea m√°s f√°cil de usar' : 'Personaliza tu experiencia de usuario'}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        ${isAdmin ? `
                            <button id="reset-settings-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg flex items-center space-x-2">
                                <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                <span>Restablecer</span>
                            </button>
                        ` : ''}
                        <button id="save-settings-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg flex items-center space-x-2">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            <span>Guardar Cambios</span>
                        </button>
                    </div>
                </div>

                <!-- Configuration Tabs -->
                <div class="themed-card rounded-xl shadow-lg border border-opacity-20">
                    <div class="border-b border-opacity-10 px-6 py-4">
                        <nav class="flex space-x-8 overflow-x-auto scrollbar-hide" aria-label="Settings Tabs">
                            ${isAdmin ? `
                                <a href="#" class="settings-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600 dark:text-indigo-400 transition-all duration-200" data-tab="general">
                                    <i data-lucide="settings" class="w-4 h-4 inline mr-2"></i>B√°sico
                                </a>
                                <a href="#" class="settings-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent themed-text-light dark:text-gray-300 hover:text-indigo-500 dark:hover:text-indigo-400 transition-all duration-200" data-tab="display">
                                    <i data-lucide="monitor" class="w-4 h-4 inline mr-2"></i>Apariencia
                                </a>
                                <a href="#" class="settings-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent themed-text-light dark:text-gray-300 hover:text-indigo-500 dark:hover:text-indigo-400 transition-all duration-200" data-tab="operational">
                                    <i data-lucide="zap" class="w-4 h-4 inline mr-2"></i>Funcionamiento
                                </a>
                                <a href="#" class="settings-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent themed-text-light dark:text-gray-300 hover:text-indigo-500 dark:hover:text-indigo-400 transition-all duration-200" data-tab="dashboard">
                                    <i data-lucide="layout-dashboard" class="w-4 h-4 inline mr-2"></i>Inicio
                                </a>
                                <a href="#" class="settings-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent themed-text-light dark:text-gray-300 hover:text-indigo-500 dark:hover:text-indigo-400 transition-all duration-200" data-tab="categories">
                                    <i data-lucide="folder" class="w-4 h-4 inline mr-2"></i>Categor√≠as
                                </a>
                            ` : `
                                <a href="#" class="settings-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600 dark:text-indigo-400 transition-all duration-200" data-tab="operator-display">
                                    <i data-lucide="monitor" class="w-4 h-4 inline mr-2"></i>Apariencia
                                </a>
                                <a href="#" class="settings-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent themed-text-light dark:text-gray-300 hover:text-indigo-500 dark:hover:text-indigo-400 transition-all duration-200" data-tab="operator-workflow">
                                    <i data-lucide="zap" class="w-4 h-4 inline mr-2"></i>Trabajo Diario
                                </a>
                                <a href="#" class="settings-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent themed-text-light dark:text-gray-300 hover:text-indigo-500 dark:hover:text-indigo-400 transition-all duration-200" data-tab="operator-system">
                                    <i data-lucide="settings" class="w-4 h-4 inline mr-2"></i>Ajustes del Sistema
                                </a>
                            `}
                        </nav>
                    </div>
                    <div id="settings-tab-content" class="p-8"></div>
                </div>
            </div>
            `;
            renderSettingsTab(isAdmin ? 'general' : 'operator-display');
            safeCreateIcons();
        }

        function renderSettingsTab(tabName) {
            // Update tab styling
            document.querySelectorAll('.settings-tab-link').forEach(tab => {
                const isSelected = tab.dataset.tab === tabName;
                tab.classList.toggle('border-indigo-500', isSelected);
                tab.classList.toggle('text-indigo-600', isSelected);
                tab.classList.toggle('dark:text-indigo-400', isSelected);
                tab.classList.toggle('border-transparent', !isSelected);
                tab.classList.toggle('themed-text-light', !isSelected);
                tab.classList.toggle('dark:text-gray-300', !isSelected);
            });

            const content = document.getElementById('settings-tab-content');
            
            switch(tabName) {
                case 'general':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Basic Configuration -->
                                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-blue-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-indigo-100 dark:bg-indigo-900 rounded-lg mr-3">
                                            <i data-lucide="settings" class="w-5 h-5 text-indigo-600 dark:text-indigo-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Ajustes B√°sicos</h3>
                                    </div>
                                    <div class="space-y-4">
                                        <div>
                                            <label for="items-per-page" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Art√≠culos por p√°gina</label>
                                            <input type="number" id="items-per-page" value="${state.settings.itemsPerPage || 10}" min="5" max="50" step="5" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Cu√°ntos art√≠culos mostrar en cada p√°gina</p>
                                        </div>
                                        <div>
                                            <label for="default-unit" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Unidad por defecto</label>
                                            <input type="text" id="default-unit" value="${state.settings.defaultUnit || 'pza'}" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Unidad que se pone sola cuando agregas productos nuevos</p>
                                        </div>
                                        <div>
                                            <label for="default-min-stock" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Stock m√≠nimo por defecto</label>
                                            <input type="number" id="default-min-stock" value="${state.settings.defaultMinStock || 5}" min="0" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Cantidad m√≠nima que se pone sola cuando agregas productos nuevos</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Security & Session -->
                                <div class="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-green-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-green-100 dark:bg-green-900 rounded-lg mr-3">
                                            <i data-lucide="shield" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Seguridad</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="session-timeout" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tiempo para cerrar sesi√≥n (minutos)</label>
                                            <input type="number" id="session-timeout" value="${state.settings.sessionTimeout || 480}" min="30" max="1440" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Cu√°nto tiempo antes de cerrar la sesi√≥n sola</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="enable-audit-log" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Guardar historial</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Guarda un registro de todo lo que se hace</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="enable-audit-log" ${state.settings.enableAuditLog ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="barcode-scanning" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Leer c√≥digos de barras</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Permite leer c√≥digos de barras con la c√°mara</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="barcode-scanning" ${state.settings.barcodeScanning ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'display':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Table & List Settings -->
                                <div class="bg-gradient-to-br from-purple-50 to-violet-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-purple-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-purple-100 dark:bg-purple-900 rounded-lg mr-3">
                                            <i data-lucide="table" class="w-5 h-5 text-purple-600 dark:text-purple-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">C√≥mo ver las listas</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="table-density" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Espacio entre filas</label>
                                            <select id="table-density" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors">
                                                <option value="compact" ${state.settings.displayPreferences?.tableDensity === 'compact' ? 'selected' : ''}>Compacta</option>
                                                <option value="comfortable" ${state.settings.displayPreferences?.tableDensity === 'comfortable' ? 'selected' : ''}>C√≥moda</option>
                                                <option value="spacious" ${state.settings.displayPreferences?.tableDensity === 'spacious' ? 'selected' : ''}>Espaciosa</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Cu√°nto espacio hay entre las filas</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="show-column-lines" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mostrar l√≠neas entre columnas</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Muestra l√≠neas que separan las columnas</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="show-column-lines" ${state.settings.displayPreferences?.showColumnLines ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="enable-row-hover" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Resaltar filas al pasar el mouse</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Resalta la fila cuando pasas el mouse encima</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="enable-row-hover" ${state.settings.displayPreferences?.enableRowHover ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Interface Customization -->
                                <div class="bg-gradient-to-br from-orange-50 to-amber-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-orange-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-orange-100 dark:bg-orange-900 rounded-lg mr-3">
                                            <i data-lucide="palette" class="w-5 h-5 text-orange-600 dark:text-orange-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Apariencia</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="font-size" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tama√±o de fuente</label>
                                            <select id="font-size" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors">
                                                <option value="small" ${state.settings.interfaceCustomization?.fontSize === 'small' ? 'selected' : ''}>Peque√±a</option>
                                                <option value="medium" ${state.settings.interfaceCustomization?.fontSize === 'medium' ? 'selected' : ''}>Mediana</option>
                                                <option value="large" ${state.settings.interfaceCustomization?.fontSize === 'large' ? 'selected' : ''}>Grande</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Cambia el tama√±o del texto</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="compact-sidebar" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Barra lateral peque√±a</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Hace la barra lateral m√°s peque√±a</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="compact-sidebar" ${state.settings.interfaceCustomization?.compactSidebar ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="animations-enabled" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Animaciones</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Muestra movimientos y efectos</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="animations-enabled" ${state.settings.interfaceCustomization?.animationsEnabled ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'operational':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Quick Actions & Shortcuts -->
                                <div class="bg-gradient-to-br from-cyan-50 to-blue-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-cyan-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-cyan-100 dark:bg-cyan-900 rounded-lg mr-3">
                                            <i data-lucide="zap" class="w-5 h-5 text-cyan-600 dark:text-cyan-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Acciones R√°pidas</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="default-transaction-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo de transacci√≥n por defecto</label>
                                            <select id="default-transaction-type" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-colors">
                                                <option value="Entrada" ${state.settings.operationalPreferences?.defaultTransactionType === 'Entrada' ? 'selected' : ''}>Entrada</option>
                                                <option value="Salida" ${state.settings.operationalPreferences?.defaultTransactionType === 'Salida' ? 'selected' : ''}>Salida</option>
                                                <option value="Ajuste" ${state.settings.operationalPreferences?.defaultTransactionType === 'Ajuste' ? 'selected' : ''}>Ajuste</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Tipo de transacci√≥n preseleccionado al registrar movimientos</p>
                                        </div>
                                        <div>
                                            <label for="recent-items-count" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Elementos recientes a mostrar</label>
                                            <input type="number" id="recent-items-count" value="${state.settings.operationalPreferences?.recentItemsCount || 10}" min="5" max="50" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-colors">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Cantidad de elementos recientes que se muestran para acceso r√°pido</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="show-recent-items" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mostrar elementos recientes</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Muestra una lista de elementos utilizados recientemente</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="show-recent-items" ${state.settings.operationalPreferences?.showRecentItems ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="confirm-before-delete" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Confirmar antes de eliminar</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Solicita confirmaci√≥n antes de eliminar elementos</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="confirm-before-delete" ${state.settings.operationalPreferences?.confirmBeforeDelete ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'operator':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Vista y Pantalla -->
                                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-blue-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-blue-100 dark:bg-blue-900 rounded-lg mr-3">
                                            <i data-lucide="eye" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">C√≥mo Ver el Inventario</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="operator-items-per-page" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Art√≠culos por p√°gina</label>
                                            <select id="operator-items-per-page" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                                <option value="10" ${state.settings.itemsPerPage === 10 ? 'selected' : ''}>10 art√≠culos</option>
                                                <option value="20" ${state.settings.itemsPerPage === 20 ? 'selected' : ''}>20 art√≠culos</option>
                                                <option value="30" ${state.settings.itemsPerPage === 30 ? 'selected' : ''}>30 art√≠culos</option>
                                                <option value="50" ${state.settings.itemsPerPage === 50 ? 'selected' : ''}>50 art√≠culos</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Cu√°ntos art√≠culos ver en cada p√°gina</p>
                                        </div>
                                        <div>
                                            <label for="operator-view-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Formato de vista</label>
                                            <select id="operator-view-type" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                                <option value="table" ${state.settings.displayPreferences?.defaultView === 'table' ? 'selected' : ''}>Lista en tabla</option>
                                                <option value="grid" ${state.settings.displayPreferences?.defaultView === 'grid' ? 'selected' : ''}>Cuadr√≠cula</option>
                                                <option value="list" ${state.settings.displayPreferences?.defaultView === 'list' ? 'selected' : ''}>Lista simple</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">C√≥mo quieres ver el inventario</p>
                                        </div>
                                        <div>
                                            <label for="operator-table-density" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Espacio entre filas</label>
                                            <select id="operator-table-density" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                                <option value="compact" ${state.settings.displayPreferences?.tableDensity === 'compact' ? 'selected' : ''}>Poco espacio</option>
                                                <option value="comfortable" ${state.settings.displayPreferences?.tableDensity === 'comfortable' ? 'selected' : ''}>Espacio normal</option>
                                                <option value="spacious" ${state.settings.displayPreferences?.tableDensity === 'spacious' ? 'selected' : ''}>Mucho espacio</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Cu√°nto espacio hay entre las filas</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="operator-show-lines" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mostrar l√≠neas entre columnas</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Muestra l√≠neas que separan las columnas</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="operator-show-lines" ${state.settings.displayPreferences?.showColumnLines ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Trabajo Diario -->
                                <div class="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-green-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-green-100 dark:bg-green-900 rounded-lg mr-3">
                                            <i data-lucide="clipboard-list" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Trabajo Diario</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="operator-default-action" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Acci√≥n por defecto</label>
                                            <select id="operator-default-action" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors">
                                                <option value="entry" ${state.settings.operationalPreferences?.defaultTransactionType === 'Entrada' ? 'selected' : ''}>Entrada de productos</option>
                                                <option value="exit" ${state.settings.operationalPreferences?.defaultTransactionType === 'Salida' ? 'selected' : ''}>Salida de productos</option>
                                                <option value="adjustment" ${state.settings.operationalPreferences?.defaultTransactionType === 'Ajuste' ? 'selected' : ''}>Ajuste de inventario</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Qu√© acci√≥n se selecciona autom√°ticamente</p>
                                        </div>
                                        <div>
                                            <label for="operator-recent-items" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Productos recientes a mostrar</label>
                                            <select id="operator-recent-items" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors">
                                                <option value="5" ${state.settings.operationalPreferences?.recentItemsCount === 5 ? 'selected' : ''}>5 productos</option>
                                                <option value="10" ${state.settings.operationalPreferences?.recentItemsCount === 10 ? 'selected' : ''}>10 productos</option>
                                                <option value="15" ${state.settings.operationalPreferences?.recentItemsCount === 15 ? 'selected' : ''}>15 productos</option>
                                                <option value="20" ${state.settings.operationalPreferences?.recentItemsCount === 20 ? 'selected' : ''}>20 productos</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Cu√°ntos productos recientes ver</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="operator-show-recent" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mostrar productos recientes</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Muestra productos usados recientemente</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="operator-show-recent" ${state.settings.operationalPreferences?.showRecentItems ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="operator-keyboard-shortcuts" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Atajos de teclado</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Usar teclas para acciones r√°pidas</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="operator-keyboard-shortcuts" ${state.settings.operationalPreferences?.enableKeyboardShortcuts ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Alertas y Notificaciones -->
                                <div class="bg-gradient-to-br from-orange-50 to-amber-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-orange-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-orange-100 dark:bg-orange-900 rounded-lg mr-3">
                                            <i data-lucide="bell" class="w-5 h-5 text-orange-600 dark:text-orange-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Alertas</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="operator-low-stock-alert" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Alerta de stock bajo</label>
                                            <select id="operator-low-stock-alert" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors">
                                                <option value="always" ${state.settings.notificationPreferences?.lowStockAlert === 'always' ? 'selected' : ''}>Siempre</option>
                                                <option value="on_login" ${state.settings.notificationPreferences?.lowStockAlert === 'on_login' ? 'selected' : ''}>Al entrar</option>
                                                <option value="never" ${state.settings.notificationPreferences?.lowStockAlert === 'never' ? 'selected' : ''}>Nunca</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Cu√°ndo mostrar alertas de stock bajo</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="operator-sound-alerts" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Sonidos de alerta</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Reproducir sonidos para alertas</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="operator-sound-alerts" ${state.settings.notificationPreferences?.soundAlerts ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="operator-popup-alerts" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Ventanas de alerta</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Mostrar ventanas emergentes para alertas</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="operator-popup-alerts" ${state.settings.notificationPreferences?.popupAlerts ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Apariencia -->
                                <div class="bg-gradient-to-br from-purple-50 to-violet-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-purple-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-purple-100 dark:bg-purple-900 rounded-lg mr-3">
                                            <i data-lucide="palette" class="w-5 h-5 text-purple-600 dark:text-purple-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Apariencia</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="operator-font-size" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tama√±o del texto</label>
                                            <select id="operator-font-size" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors">
                                                <option value="small" ${state.settings.interfaceCustomization?.fontSize === 'small' ? 'selected' : ''}>Peque√±o</option>
                                                <option value="medium" ${state.settings.interfaceCustomization?.fontSize === 'medium' ? 'selected' : ''}>Mediano</option>
                                                <option value="large" ${state.settings.interfaceCustomization?.fontSize === 'large' ? 'selected' : ''}>Grande</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Cambia el tama√±o del texto</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="operator-compact-sidebar" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Barra lateral peque√±a</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Hace la barra lateral m√°s peque√±a</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="operator-compact-sidebar" ${state.settings.interfaceCustomization?.compactSidebar ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="operator-animations" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Animaciones</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Muestra movimientos y efectos</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="operator-animations" ${state.settings.interfaceCustomization?.animationsEnabled ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'dashboard':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Dashboard Widgets -->
                                <div class="bg-gradient-to-br from-pink-50 to-rose-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-pink-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-pink-100 dark:bg-pink-900 rounded-lg mr-3">
                                            <i data-lucide="layout-dashboard" class="w-5 h-5 text-pink-600 dark:text-pink-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Widgets del Panel</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="show-stock-overview" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Resumen de stock</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Muestra el gr√°fico de art√≠culos m√°s utilizados</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="show-stock-overview" ${state.settings.dashboardCustomization?.showStockOverview ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="show-recent-transactions" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Transacciones recientes</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Muestra el gr√°fico de empleados con m√°s pr√©stamos</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="show-recent-transactions" ${state.settings.dashboardCustomization?.showRecentTransactions ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="show-low-stock-alerts" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Alertas de stock bajo</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Muestra el gr√°fico de herramientas m√°s reportadas</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="show-low-stock-alerts" ${state.settings.dashboardCustomization?.showLowStockAlerts ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="show-quick-actions" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Acciones r√°pidas</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Muestra widget con botones de acciones comunes</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="show-quick-actions" ${state.settings.dashboardCustomization?.showQuickActions ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Chart & Display Options -->
                                <div class="bg-gradient-to-br from-indigo-50 to-blue-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-indigo-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-indigo-100 dark:bg-indigo-900 rounded-lg mr-3">
                                            <i data-lucide="bar-chart-3" class="w-5 h-5 text-indigo-600 dark:text-indigo-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Gr√°ficos y Visualizaci√≥n</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="chart-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo de gr√°fico por defecto</label>
                                            <select id="chart-type" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                                                <option value="bar" ${state.settings.dashboardCustomization?.chartType === 'bar' ? 'selected' : ''}>Barras</option>
                                                <option value="line" ${state.settings.dashboardCustomization?.chartType === 'line' ? 'selected' : ''}>L√≠neas</option>
                                                <option value="pie" ${state.settings.dashboardCustomization?.chartType === 'pie' ? 'selected' : ''}>Circular</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Tipo de gr√°fico preferido para mostrar datos</p>
                                        </div>
                                        <div>
                                            <label for="default-date-range" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Rango de fecha por defecto</label>
                                            <select id="default-date-range" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                                                <option value="7days" ${state.settings.dashboardCustomization?.defaultDateRange === '7days' ? 'selected' : ''}>√öltimos 7 d√≠as</option>
                                                <option value="30days" ${state.settings.dashboardCustomization?.defaultDateRange === '30days' ? 'selected' : ''}>√öltimos 30 d√≠as</option>
                                                <option value="90days" ${state.settings.dashboardCustomization?.defaultDateRange === '90days' ? 'selected' : ''}>√öltimos 90 d√≠as</option>
                                                <option value="year" ${state.settings.dashboardCustomization?.defaultDateRange === 'year' ? 'selected' : ''}>√öltimo a√±o</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Periodo de tiempo predeterminado para los informes</p>
                                        </div>
                                        <div>
                                            <label for="refresh-interval" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Intervalo de actualizaci√≥n (segundos)</label>
                                            <input type="number" id="refresh-interval" value="${state.settings.dashboardCustomization?.refreshInterval || 300}" min="30" max="3600" step="30" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Frecuencia con la que se actualizan autom√°ticamente los datos del panel</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'stock':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Auto Reorder Settings -->
                                <div class="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-green-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-green-100 dark:bg-green-900 rounded-lg mr-3">
                                            <i data-lucide="package" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Reabastecimiento Autom√°tico</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="auto-reorder-enabled" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Habilitar reorden autom√°tico</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Sugiere autom√°ticamente cu√°ndo reabastecer productos</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="auto-reorder-enabled" ${state.settings.autoReorderEnabled ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div>
                                            <label for="auto-reorder-threshold" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Umbral de reorden (% del stock m√≠nimo)</label>
                                            <input type="number" id="auto-reorder-threshold" value="${(state.settings.autoReorderThreshold || 0.2) * 100}" min="10" max="100" step="5" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Sugiere reabastecimiento cuando el stock est√© por debajo de este porcentaje del m√≠nimo</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="supplier-management" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Proveedores</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Habilita funciones de gesti√≥n de proveedores</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="supplier-management" ${state.settings.supplierManagement ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Stock Validations -->
                                <div class="bg-gradient-to-br from-red-50 to-pink-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-red-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-red-100 dark:bg-red-900 rounded-lg mr-3">
                                            <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600 dark:text-red-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Validaciones de Stock</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="max-quantity-transaction" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cantidad m√°xima por transacci√≥n</label>
                                            <input type="number" id="max-quantity-transaction" value="${state.settings.customValidations?.maxQuantityPerTransaction || 1000}" min="1" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">L√≠mite m√°ximo de productos que se pueden mover en una sola transacci√≥n</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="require-notes-large" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Requerir notas en transacciones grandes</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Obliga a incluir notas cuando las cantidades son altas</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="require-notes-large" ${state.settings.customValidations?.requireNotesForLargeTransactions ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="prevent-negative-stock" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Prevenir stock negativo</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Impide realizar operaciones que resulten en stock negativo</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="prevent-negative-stock" ${state.settings.customValidations?.preventNegativeStock ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'notifications':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Stock Alerts -->
                                <div class="bg-gradient-to-br from-yellow-50 to-orange-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-yellow-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-yellow-100 dark:bg-yellow-900 rounded-lg mr-3">
                                            <i data-lucide="bell" class="w-5 h-5 text-yellow-600 dark:text-yellow-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Alertas de Stock</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="low-stock-notifications" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Alertas de stock bajo</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Recibe notificaciones cuando el stock est√© bajo</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="low-stock-notifications" ${state.settings.lowStockNotifications ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div>
                                            <label for="notification-emails" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Correos para notificaciones</label>
                                            <textarea id="notification-emails" rows="3" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors" placeholder="correo1@ejemplo.com, correo2@ejemplo.com">${state.settings.notificationEmails || ''}</textarea>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Separar m√∫ltiples correos con comas</p>
                                        </div>
                                        <div>
                                            <label for="stock-alert-days" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">D√≠as para alertas de stock</label>
                                            <input type="text" id="stock-alert-days" value="${(state.settings.stockAlertDays || [1, 7, 30]).join(', ')}" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors" placeholder="1, 7, 30">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Intervalos en d√≠as para mostrar alertas (separados por comas)</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Scheduled Reports -->
                                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-blue-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-blue-100 dark:bg-blue-900 rounded-lg mr-3">
                                            <i data-lucide="calendar" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Reportes Programados</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="enable-scheduled-reports" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Habilitar reportes autom√°ticos</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Genera y env√≠a reportes de forma autom√°tica</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="enable-scheduled-reports" ${state.settings.enableScheduledReports ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div>
                                            <label for="report-schedule" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Frecuencia de reportes</label>
                                            <select id="report-schedule" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                                <option value="daily" ${state.settings.reportSchedule === 'daily' ? 'selected' : ''}>Diario</option>
                                                <option value="weekly" ${state.settings.reportSchedule === 'weekly' ? 'selected' : ''}>Semanal</option>
                                                <option value="monthly" ${state.settings.reportSchedule === 'monthly' ? 'selected' : ''}>Mensual</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Con qu√© frecuencia se generan los reportes autom√°ticos</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'workflow':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Approval Workflows -->
                                <div class="bg-gradient-to-br from-purple-50 to-violet-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-purple-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-purple-100 dark:bg-purple-900 rounded-lg mr-3">
                                            <i data-lucide="workflow" class="w-5 h-5 text-purple-600 dark:text-purple-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Flujos de Aprobaci√≥n</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="enable-workflow-approvals" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Requerir aprobaciones</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Requiere aprobaci√≥n para transacciones importantes</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="enable-workflow-approvals" ${state.settings.enableWorkflowApprovals ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div>
                                            <label for="approval-threshold" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Umbral para aprobaci√≥n (cantidad)</label>
                                            <input type="number" id="approval-threshold" value="${state.settings.approvalThreshold || 100}" min="1" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Transacciones superiores a esta cantidad requerir√°n aprobaci√≥n de supervisor</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Data Management -->
                                <div class="bg-gradient-to-br from-gray-50 to-slate-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-gray-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-gray-100 dark:bg-gray-900 rounded-lg mr-3">
                                            <i data-lucide="database" class="w-5 h-5 text-gray-600 dark:text-gray-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Gesti√≥n de Datos</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="data-retention-days" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">D√≠as de retenci√≥n de historial</label>
                                            <input type="number" id="data-retention-days" value="${state.settings.dataRetentionDays || 365}" min="30" max="2555" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-gray-500 focus:border-gray-500 transition-colors">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Tiempo para mantener registros hist√≥ricos antes del archivado autom√°tico</p>
                                        </div>
                                        <div class="pt-4">
                                            <button id="archive-old-data-btn" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-medium py-2.5 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors">
                                                <i data-lucide="archive" class="w-4 h-4"></i>
                                                <span>Archivar Datos Antiguos</span>
                                            </button>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Archiva registros m√°s antiguos que el per√≠odo de retenci√≥n configurado</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'data':
                    content.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold flex items-center"><i data-lucide="upload" class="mr-2"></i>Importar Datos</h3>
                                <div>
                                    <label for="import-file" class="block text-sm font-medium themed-text-light mb-1">Importar inventario desde CSV</label>
                                    <input type="file" id="import-file" accept=".csv" class="themed-input w-full border rounded-md px-4 py-3">
                                    <p class="text-xs themed-text-light mt-1">Formato: descripci√≥n, categor√≠a, tipo, stock, unidad, minStock</p>
                                </div>
                                <button id="import-data-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded flex items-center space-x-2">
                                    <i data-lucide="upload"></i><span>Importar Datos</span>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold flex items-center"><i data-lucide="download" class="mr-2"></i>Exportar y Respaldar</h3>
                                <div class="space-y-2">
                                    <button id="export-inventory-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded flex items-center justify-center space-x-2">
                                        <i data-lucide="download"></i><span>Exportar Inventario Completo</span>
                                    </button>
                                    <button id="export-settings-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded flex items-center justify-center space-x-2">
                                        <i data-lucide="settings"></i><span>Respaldar Configuraciones</span>
                                    </button>
                                    <button id="export-full-backup-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded flex items-center justify-center space-x-2">
                                        <i data-lucide="hard-drive"></i><span>Respaldo Completo</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'categories':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Category Management -->
                                <div class="bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-emerald-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-emerald-100 dark:bg-emerald-900 rounded-lg mr-3">
                                            <i data-lucide="folder-plus" class="w-5 h-5 text-emerald-600 dark:text-emerald-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Gesti√≥n de Categor√≠as</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="new-category-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">A√±adir Nueva Categor√≠a</label>
                                            <div class="flex space-x-3">
                                                <input type="text" id="new-category-name" placeholder="Nombre de la categor√≠a" class="themed-input flex-grow border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                                                <button id="add-category-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-medium px-4 py-2.5 rounded-lg flex items-center space-x-2 transition-colors">
                                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                                    <span>A√±adir</span>
                                                </button>
                                            </div>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Crea una nueva categor√≠a para organizar tus productos</p>
                                        </div>
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Categor√≠as Existentes</h4>
                                            <div id="category-management-list" class="space-y-2 max-h-80 overflow-y-auto">
                                                ${state.categories.filter(c => c !== 'Todas').map(cat => `
                                                    <div class="flex items-center justify-between p-3 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-emerald-300 dark:hover:border-emerald-600 transition-colors">
                                                        <div class="flex items-center space-x-3">
                                                            <div class="p-1.5 bg-emerald-100 dark:bg-emerald-900 rounded-md">
                                                                <i data-lucide="folder" class="w-3.5 h-3.5 text-emerald-600 dark:text-emerald-400"></i>
                                                            </div>
                                                            <span class="category-name text-gray-900 dark:text-white font-medium">${cat}</span>
                                                        </div>
                                                        <div class="flex items-center space-x-2">
                                                            <button class="rename-category-btn p-1.5 text-blue-500 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900 rounded-md transition-colors" data-category="${cat}" title="Renombrar categor√≠a">
                                                                <i data-lucide="pencil" class="w-4 h-4"></i>
                                                            </button>
                                                            <button class="delete-category-btn p-1.5 text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900 rounded-md transition-colors" data-category="${cat}" title="Eliminar categor√≠a">
                                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Bulk Operations -->
                                <div class="bg-gradient-to-br from-amber-50 to-orange-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-amber-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-amber-100 dark:bg-amber-900 rounded-lg mr-3">
                                            <i data-lucide="layers" class="w-5 h-5 text-amber-600 dark:text-amber-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Acciones Masivas</h3>
                                    </div>
                                    <div class="space-y-6">
                                        <div class="p-4 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3 flex items-center">
                                                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                                                Cambiar Tipo de Categor√≠a
                                            </h4>
                                            <div class="space-y-3">
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                    <div>
                                                        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Categor√≠a</label>
                                                        <select id="bulk-category-select" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors">
                                                            ${state.categories.filter(c => c !== 'Todas').map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Nuevo Tipo</label>
                                                        <select id="bulk-type-select" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors">
                                                            <option value="Consumible">Consumible</option>
                                                            <option value="Retornable">Retornable</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <button id="bulk-update-type-btn" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors">
                                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                                    <span>Actualizar Tipo</span>
                                                </button>
                                                <p class="text-xs text-gray-500 dark:text-gray-400">Esta acci√≥n cambiar√° el tipo de todos los art√≠culos en la categor√≠a seleccionada</p>
                                            </div>
                                        </div>
                                        
                                        <div class="p-4 bg-red-50 dark:bg-red-950 rounded-lg border border-red-200 dark:border-red-800">
                                            <h4 class="text-sm font-medium text-red-700 dark:text-red-300 mb-3 flex items-center">
                                                <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                                                Eliminar Categor√≠a Completa
                                            </h4>
                                            <div class="space-y-3">
                                                <div>
                                                    <label class="block text-xs text-red-600 dark:text-red-400 mb-1">Seleccionar categor√≠a a eliminar</label>
                                                    <select id="bulk-delete-category-select" class="themed-input w-full border border-red-300 dark:border-red-600 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors">
                                                        <option value="" selected disabled>Seleccionar categor√≠a...</option>
                                                        ${state.categories.filter(c => c !== 'Todas').map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                                    </select>
                                                </div>
                                                <button id="bulk-delete-category-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    <span>Eliminar Categor√≠a</span>
                                                </button>
                                                <div class="p-3 bg-red-100 dark:bg-red-900 rounded-md">
                                                    <p class="text-xs text-red-700 dark:text-red-300 font-medium">‚ö†Ô∏è Acci√≥n Irreversible</p>
                                                    <p class="text-xs text-red-600 dark:text-red-400 mt-1">Esta acci√≥n eliminar√° la categor√≠a y todos los art√≠culos que contiene de forma permanente</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'operator-display':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Display Preferences -->
                                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-blue-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-blue-100 dark:bg-blue-900 rounded-lg mr-3">
                                            <i data-lucide="monitor" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Preferencias de Visualizaci√≥n</h3>
                                    </div>
                                    <div class="space-y-4">
                                        <div>
                                            <label for="operator-items-per-page" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Art√≠culos por p√°gina</label>
                                            <input type="number" id="operator-items-per-page" value="${state.settings.itemsPerPage || 10}" min="5" max="50" step="5" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Cu√°ntos art√≠culos mostrar en cada p√°gina</p>
                                        </div>
                                        <div>
                                            <label for="operator-view-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo de vista</label>
                                            <select id="operator-view-type" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                                <option value="table" ${state.settings.displayPreferences?.defaultView === 'table' ? 'selected' : ''}>Tabla</option>
                                                <option value="grid" ${state.settings.displayPreferences?.defaultView === 'grid' ? 'selected' : ''}>Cuadr√≠cula</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="operator-table-density" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Densidad de tabla</label>
                                            <select id="operator-table-density" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                                <option value="compact" ${state.settings.displayPreferences?.tableDensity === 'compact' ? 'selected' : ''}>Compacta</option>
                                                <option value="comfortable" ${state.settings.displayPreferences?.tableDensity === 'comfortable' ? 'selected' : ''}>C√≥moda</option>
                                                <option value="spacious" ${state.settings.displayPreferences?.tableDensity === 'spacious' ? 'selected' : ''}>Espaciosa</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Interface Settings -->
                                <div class="bg-gradient-to-br from-purple-50 to-pink-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-purple-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-purple-100 dark:bg-purple-900 rounded-lg mr-3">
                                            <i data-lucide="palette" class="w-5 h-5 text-purple-600 dark:text-purple-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Interfaz</h3>
                                    </div>
                                    <div class="space-y-4">
                                        <div class="flex items-center justify-between p-3 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="operator-show-lines" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mostrar l√≠neas de tabla</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Mostrar l√≠neas divisorias en las tablas</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="operator-show-lines" ${state.settings.displayPreferences?.showColumnLines ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-3 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="operator-enable-hover" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Efecto hover en filas</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Resaltar filas al pasar el mouse</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="operator-enable-hover" ${state.settings.displayPreferences?.enableRowHover ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'operator-workflow':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Workflow Preferences -->
                                <div class="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-green-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-green-100 dark:bg-green-900 rounded-lg mr-3">
                                            <i data-lucide="zap" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Preferencias de Trabajo</h3>
                                    </div>
                                    <div class="space-y-4">
                                        <div>
                                            <label for="operator-default-action" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Acci√≥n por defecto</label>
                                            <select id="operator-default-action" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors">
                                                <option value="entry" ${state.settings.operationalPreferences?.defaultTransactionType === 'Entrada' ? 'selected' : ''}>Entrada</option>
                                                <option value="exit" ${state.settings.operationalPreferences?.defaultTransactionType === 'Salida' ? 'selected' : ''}>Salida</option>
                                                <option value="adjustment" ${state.settings.operationalPreferences?.defaultTransactionType === 'Ajuste' ? 'selected' : ''}>Ajuste</option>
                                            </select>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Acci√≥n que se selecciona por defecto en los formularios</p>
                                        </div>
                                        <div class="flex items-center justify-between p-3 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="operator-confirm-delete" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Confirmar antes de eliminar</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Pedir confirmaci√≥n antes de eliminar art√≠culos</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="operator-confirm-delete" ${state.settings.operationalPreferences?.confirmBeforeDelete ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Quick Actions -->
                                <div class="bg-gradient-to-br from-orange-50 to-red-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-orange-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-orange-100 dark:bg-orange-900 rounded-lg mr-3">
                                            <i data-lucide="clock" class="w-5 h-5 text-orange-600 dark:text-orange-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Acciones R√°pidas</h3>
                                    </div>
                                    <div class="space-y-4">
                                        <div class="flex items-center justify-between p-3 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <div>
                                                <label for="operator-show-recent" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mostrar art√≠culos recientes</label>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Mostrar lista de art√≠culos usados recientemente</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="operator-show-recent" ${state.settings.operationalPreferences?.showRecentItems ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div>
                                            <label for="operator-recent-count" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cantidad de art√≠culos recientes</label>
                                            <input type="number" id="operator-recent-count" value="${state.settings.operationalPreferences?.recentItemsCount || 10}" min="5" max="20" class="themed-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Cu√°ntos art√≠culos mostrar en la lista de recientes</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'operator-system':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <!-- Informational Banner -->
                            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-6">
                                <div class="flex items-center">
                                    <div class="p-2 bg-blue-100 dark:bg-blue-900 rounded-lg mr-3">
                                        <i data-lucide="info" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-blue-900 dark:text-blue-100">Configuraci√≥n del Sistema</h3>
                                        <p class="text-sm text-blue-700 dark:text-blue-300 mt-1">Esta informaci√≥n muestra la configuraci√≥n actual del sistema establecida por el administrador.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Basic System Settings -->
                                <div class="bg-gradient-to-br from-gray-50 to-slate-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-gray-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-gray-100 dark:bg-gray-900 rounded-lg mr-3">
                                            <i data-lucide="settings" class="w-5 h-5 text-gray-600 dark:text-gray-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Configuraci√≥n B√°sica</h3>
                                    </div>
                                    <div class="space-y-4">
                                        <div class="p-3 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Unidad por defecto</label>
                                            <div class="text-lg font-semibold text-gray-900 dark:text-white">${state.settings.defaultUnit || 'pza'}</div>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Unidad que se asigna autom√°ticamente a nuevos art√≠culos</p>
                                        </div>
                                        <div class="p-3 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Stock m√≠nimo por defecto</label>
                                            <div class="text-lg font-semibold text-gray-900 dark:text-white">${state.settings.defaultMinStock || 5}</div>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Cantidad m√≠nima establecida para nuevos art√≠culos</p>
                                        </div>
                                        <div class="p-3 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tiempo de sesi√≥n</label>
                                            <div class="text-lg font-semibold text-gray-900 dark:text-white">${Math.floor((state.settings.sessionTimeout || 480) / 60)} horas</div>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Tiempo antes de cerrar sesi√≥n autom√°ticamente</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Security Settings -->
                                <div class="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-green-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-green-100 dark:bg-green-900 rounded-lg mr-3">
                                            <i data-lucide="shield" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Configuraci√≥n de Seguridad</h3>
                                    </div>
                                    <div class="space-y-4">
                                        <div class="p-3 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Registro de auditor√≠a</label>
                                            <div class="flex items-center">
                                                <div class="text-lg font-semibold text-gray-900 dark:text-white mr-2">${state.settings.enableAuditLog ? 'Habilitado' : 'Deshabilitado'}</div>
                                                <div class="w-3 h-3 rounded-full ${state.settings.enableAuditLog ? 'bg-green-500' : 'bg-red-500'}"></div>
                                            </div>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Registro de todas las acciones del sistema</p>
                                        </div>
                                        <div class="p-3 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Escaneo de c√≥digos</label>
                                            <div class="flex items-center">
                                                <div class="text-lg font-semibold text-gray-900 dark:text-white mr-2">${state.settings.barcodeScanning ? 'Habilitado' : 'Deshabilitado'}</div>
                                                <div class="w-3 h-3 rounded-full ${state.settings.barcodeScanning ? 'bg-green-500' : 'bg-red-500'}"></div>
                                            </div>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Funcionalidad de escaneo de c√≥digos de barras</p>
                                        </div>
                                        <div class="p-3 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Prevenir stock negativo</label>
                                            <div class="flex items-center">
                                                <div class="text-lg font-semibold text-gray-900 dark:text-white mr-2">${state.settings.customValidations?.preventNegativeStock ? 'Habilitado' : 'Deshabilitado'}</div>
                                                <div class="w-3 h-3 rounded-full ${state.settings.customValidations?.preventNegativeStock ? 'bg-green-500' : 'bg-red-500'}"></div>
                                            </div>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Evita transacciones que resulten en stock negativo</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Operational Settings -->
                                <div class="bg-gradient-to-br from-purple-50 to-pink-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-purple-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-purple-100 dark:bg-purple-900 rounded-lg mr-3">
                                            <i data-lucide="zap" class="w-5 h-5 text-purple-600 dark:text-purple-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Configuraci√≥n Operacional</h3>
                                    </div>
                                    <div class="space-y-4">
                                        <div class="p-3 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cantidad m√°xima por transacci√≥n</label>
                                            <div class="text-lg font-semibold text-gray-900 dark:text-white">${state.settings.customValidations?.maxQuantityPerTransaction || 1000}</div>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">L√≠mite m√°ximo de cantidad en una sola transacci√≥n</p>
                                        </div>
                                        <div class="p-3 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notificaciones de stock bajo</label>
                                            <div class="flex items-center">
                                                <div class="text-lg font-semibold text-gray-900 dark:text-white mr-2">${state.settings.lowStockNotifications ? 'Habilitado' : 'Deshabilitado'}</div>
                                                <div class="w-3 h-3 rounded-full ${state.settings.lowStockNotifications ? 'bg-green-500' : 'bg-red-500'}"></div>
                                            </div>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Alertas cuando el stock est√° por debajo del m√≠nimo</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Dashboard Settings -->
                                <div class="bg-gradient-to-br from-indigo-50 to-blue-50 dark:from-slate-800 dark:to-slate-700 rounded-xl p-6 border border-indigo-200 dark:border-slate-600">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-indigo-100 dark:bg-indigo-900 rounded-lg mr-3">
                                            <i data-lucide="layout-dashboard" class="w-5 h-5 text-indigo-600 dark:text-indigo-400"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Configuraci√≥n del Dashboard</h3>
                                    </div>
                                    <div class="space-y-4">
                                        <div class="p-3 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Vista general de stock</label>
                                            <div class="flex items-center">
                                                <div class="text-lg font-semibold text-gray-900 dark:text-white mr-2">${state.settings.dashboardCustomization?.showStockOverview ? 'Habilitado' : 'Deshabilitado'}</div>
                                                <div class="w-3 h-3 rounded-full ${state.settings.dashboardCustomization?.showStockOverview ? 'bg-green-500' : 'bg-red-500'}"></div>
                                            </div>
                                        </div>
                                        <div class="p-3 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Transacciones recientes</label>
                                            <div class="flex items-center">
                                                <div class="text-lg font-semibold text-gray-900 dark:text-white mr-2">${state.settings.dashboardCustomization?.showRecentTransactions ? 'Habilitado' : 'Deshabilitado'}</div>
                                                <div class="w-3 h-3 rounded-full ${state.settings.dashboardCustomization?.showRecentTransactions ? 'bg-green-500' : 'bg-red-500'}"></div>
                                            </div>
                                        </div>
                                        <div class="p-3 bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Alertas de stock bajo</label>
                                            <div class="flex items-center">
                                                <div class="text-lg font-semibold text-gray-900 dark:text-white mr-2">${state.settings.dashboardCustomization?.showLowStockAlerts ? 'Habilitado' : 'Deshabilitado'}</div>
                                                <div class="w-3 h-3 rounded-full ${state.settings.dashboardCustomization?.showLowStockAlerts ? 'bg-green-500' : 'bg-red-500'}"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
            safeCreateIcons();
        }



        // --- L√ìGICA DE EVENTOS ---
        function setupStaticEventListeners() {
            // Handle form submission
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault(); // Prevent default form submission
                
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                const loginButton = document.getElementById('login-button');
                const loginIcon = document.getElementById('login-icon');
                const loginText = document.getElementById('login-text');
                const loginSpinner = document.getElementById('login-spinner');

                console.log('üîç Login attempt started:', { email: email ? 'provided' : 'empty', password: password ? 'provided' : 'empty' });

                // Hide any previous error messages
                document.getElementById('auth-error-message').classList.add('hidden');

                // Validate inputs
                if (!email || !password) {
                    console.log('‚ùå Validation failed: empty fields');
                    displayAuthError('auth/invalid-input');
                    return;
                }

                // Show loading state
                loginButton.disabled = true;
                loginIcon.classList.add('hidden');
                loginText.classList.add('hidden');
                loginSpinner.classList.remove('hidden');

                try {
                    console.log('üî• Attempting Firebase sign in...');
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    console.log('‚úÖ Firebase sign in successful:', userCredential.user.uid);
                    console.log('üë§ User email:', userCredential.user.email);
                    console.log('üîë User token:', await userCredential.user.getIdToken());
                    console.log('üîç Current auth user after sign in:', auth.currentUser?.uid);
                    
                    // Manual redirect since onAuthStateChanged might not be working
                    console.log('üöÄ Manual redirect after successful login...');
                    await handleSuccessfulLogin(userCredential.user);
                    
                } catch (error) {
                    console.log('‚ùå Firebase sign in failed:', error.code, error.message);
                    console.log('üîç Full error object:', error);
                    displayAuthError(error.code);
                } finally {
                    // Reset button state
                    loginButton.disabled = false;
                    loginIcon.classList.remove('hidden');
                    loginText.classList.remove('hidden');
                    loginSpinner.classList.add('hidden');
                }
            });

            // Debug button (temporary)
            document.getElementById('debug-button').addEventListener('click', async () => {
                console.log('üîç Debug: Testing Firebase connection...');
                console.log('Firebase config:', firebaseConfig);
                console.log('Auth object:', auth);
                console.log('Current user:', auth.currentUser);
                
                try {
                    // Test with a simple Firebase operation
                    const testRef = collection(db, 'test');
                    console.log('‚úÖ Firebase connection test successful');
                    alert('‚úÖ Firebase est√° conectado correctamente');
                } catch (error) {
                    console.log('‚ùå Firebase connection test failed:', error);
                    alert('‚ùå Error de conexi√≥n con Firebase: ' + error.message);
                }
            });

            document.getElementById('logout-button').addEventListener('click', () => { 
                cleanupListeners(); // Clean up listeners before logout
                signOut(auth); 
            });
            
            document.getElementById('main-nav').addEventListener('click', (e) => {
                const navLink = e.target.closest('.nav-link');
                if (navLink) {
                    e.preventDefault();
                    window.location.hash = navLink.getAttribute('href').substring(1);
                }
            });
            
            document.getElementById('dark-mode-toggle').addEventListener('click', (e) => {
                e.preventDefault();
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                updateDarkModeToggle();
            });

            window.addEventListener('hashchange', () => {
                const page = window.location.hash.substring(1) || 'dashboard';
                if(state.isInitialized) navigateTo(page);
            });

            // Mobile menu functionality
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobile-overlay');
            const menuButton = document.getElementById('menu-button');
            
            function toggleSidebar() {
                const isOpen = !sidebar.classList.contains('-translate-x-full');
                if (isOpen) {
                    sidebar.classList.add('-translate-x-full');
                    mobileOverlay.classList.add('hidden');
                } else {
                    sidebar.classList.remove('-translate-x-full');
                    mobileOverlay.classList.remove('hidden');
                }
            }
            
            menuButton.addEventListener('click', toggleSidebar);
            
            // Close sidebar when clicking overlay
            mobileOverlay.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                mobileOverlay.classList.add('hidden');
            });
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth < 768) {
                    const isClickInsideSidebar = sidebar.contains(e.target);
                    const isClickOnMenuButton = menuButton.contains(e.target);
                    
                    if (!isClickInsideSidebar && !isClickOnMenuButton && !sidebar.classList.contains('-translate-x-full')) {
                        sidebar.classList.add('-translate-x-full');
                        mobileOverlay.classList.add('hidden');
                    }
                }
            });
            
            // Handle window resize for mobile enhancements
            window.addEventListener('resize', () => {
                setTimeout(() => {
                    enhanceMobileTables();
                    enhanceMobileExperience();
                }, 100);
            });

            // Debounced search for better performance
            let searchTimeout;
            document.getElementById('search-input').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    state.searchTerm = e.target.value;
                    state.currentPage = 1;
                    const page = window.location.hash.substring(1) || 'dashboard';
                    navigateTo(page, true); // Use true to refresh the current view
                }, 200); // 200ms delay
            });
            
            document.body.addEventListener('click', (e) => {
                if (!state.isInitialized) return;
                const target = e.target;

                // Settings Page Events
                if (window.location.hash === '#settings') {
                    if (target.closest('#save-settings-btn')) { handleSaveSettings(); return; }
                    if (target.closest('#add-category-btn')) { handleAddCategory(); return; }
                    if (target.closest('#bulk-update-type-btn')) { handleBulkUpdateCategoryType(); return; }
                    if (target.closest('#bulk-delete-category-btn')) {
                        const categoryToDelete = document.getElementById('bulk-delete-category-select').value;
                        if (categoryToDelete) {
                            handleDeleteCategory(categoryToDelete);
                        } else {
                            showNotification('Selecciona una categor√≠a para eliminar.', 'info');
                        }
                        return;
                    }
                    if (target.closest('#import-data-btn')) { handleImportData(); return; }
                    if (target.closest('#export-inventory-btn')) { handleExportInventory(); return; }
                    if (target.closest('#export-settings-btn')) { handleExportSettings(); return; }
                    if (target.closest('#export-full-backup-btn')) { handleExportFullBackup(); return; }
                    if (target.closest('#archive-old-data-btn')) { handleArchiveOldData(); return; }
                    
                    const settingsTab = target.closest('.settings-tab-link');
                    if (settingsTab) { e.preventDefault(); renderSettingsTab(settingsTab.dataset.tab); return; }
                    
                    const renameBtn = target.closest('.rename-category-btn');
                    if (renameBtn) { handleRenameCategory(renameBtn.dataset.category); return; }
                    const deleteBtn = target.closest('.delete-category-btn');
                    if (deleteBtn) { handleDeleteCategory(deleteBtn.dataset.category); return; }
                }
                
                const addCategoryBtnInventory = target.closest('#add-category-btn-inventory');
                if (addCategoryBtnInventory) { showAddCategoryModal(); return; }

                const categoryFilter = target.closest('.category-filter');
                if (categoryFilter) { e.preventDefault(); state.activeCategory = categoryFilter.dataset.category; state.currentPage = 1; renderInventoryView(); return; }

                const inventoryFilter = target.closest('.inventory-filter-btn');
                if (inventoryFilter) { e.preventDefault(); state.inventoryFilter = inventoryFilter.dataset.filter; state.currentPage = 1; renderInventoryView(); return; }

                const pageLink = target.closest('.page-link');
                if (pageLink) { e.preventDefault(); const page = parseInt(pageLink.dataset.page, 10); if (page) { state.currentPage = page; renderInventoryView(); } return; }

                const actionBtn = target.closest('.action-btn');
                if (actionBtn) { handleInventoryAction(actionBtn.dataset.action, actionBtn.dataset.id); return; }

                const returnBtn = target.closest('.return-btn');
                if (returnBtn) { handleReturnLoan(returnBtn.dataset.loanId, returnBtn.dataset.itemId); return; }
                
                const reportLossBtn = target.closest('.report-loss-btn');
                if(reportLossBtn) { handleReportLoanLoss(reportLossBtn.dataset.loanId, reportLossBtn.dataset.itemId); return; }

                const tabLink = target.closest('.tab-link');
                if (tabLink) { e.preventDefault(); renderHistoryTab(tabLink.dataset.type); return; }

                const reportBtn = target.closest('.report-btn');
                if (reportBtn) { 
                    const reportType = reportBtn.dataset.type;
                    const format = reportBtn.dataset.format;
                    if (format === 'excel') {
                        generateExcelReport(reportType);
                    } else {
                        generatePDFReport(reportType);
                    }
                    return; 
                }

                const removeFromCartBtn = target.closest('.remove-from-cart-btn');
                if (removeFromCartBtn) { removeFromShoppingList(removeFromCartBtn.dataset.id); return; }
                
                if (target.id === 'generate-pdf-btn') { generateShoppingListPDF(); return; }
                if (target.id === 'generate-excel-btn') { generateShoppingListExcel(); return; }
                if (target.id === 'generate-manual-inventory-pdf') { generateManualInventoryPDF(); return; }
            });
            
            // Keyboard shortcuts listener
            document.body.addEventListener('keydown', (e) => {
                if (!state.isInitialized || !state.settings.operationalPreferences.enableKeyboardShortcuts) return;

                // Ignore shortcuts if user is typing in an input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    return;
                }

                if (e.key.toLowerCase() === 'n' && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    if (state.userRole === 'admin') {
                        showNewItemModal();
                    } else {
                        showNotification("Solo los administradores pueden agregar art√≠culos.", "info");
                    }
                }

                if (e.key.toLowerCase() === 'f' && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    document.getElementById('search-input')?.focus();
                }
            });
        }
        
        // --- MANEJO DE ACCIONES ---
        function handleInventoryAction(action, id) {
            const item = state.inventory.find(i => i.id === id);
            if (!item) return;
            switch (action) {
                case 'entry': showEntryModal(item); break;
                case 'checkout':
                    if (item.stock <= 0) {
                        showNotification('No hay stock disponible para este art√≠culo.', 'error');
                        return;
                    }
                    showCheckoutModal(item);
                    break;
                case 'edit': showEditItemModal(item); break;
                case 'edit-stock': showEditStockModal(item); break;
                case 'delete': handleDeleteItem(item); break;
                case 'add-to-cart': showAddToCartModal(item); break;
            }
        }

        async function handleDeleteItem(item) {
            const deleteLogic = async () => {
                try {
                    await deleteDoc(doc(db, 'inventory', item.id));
                    await addDoc(collection(db, 'transactions'), {
                        itemDescription: item.description, type: 'Eliminado', quantity: item.stock,
                        timestamp: serverTimestamp(), user: state.currentUser.email, notes: 'Art√≠culo eliminado del sistema'
                    });
                    showNotification('Art√≠culo eliminado.', 'success');
                } catch (error) {
                    showNotification('Error al eliminar. Intenta de nuevo.', 'error');
                }
            };

            if (state.settings.operationalPreferences.confirmBeforeDelete) {
                showConfirmationModal(`¬øEst√°s seguro de que quieres eliminar "${item.description}"? Esta acci√≥n no se puede deshacer.`, deleteLogic);
            } else {
                deleteLogic();
            }
        }

        async function handleReturnLoan(loanId, itemId) {
            const itemRef = doc(db, 'inventory', itemId);
            const loanRef = doc(db, 'loans', loanId);
            try {
                const itemDoc = await getDoc(itemRef);
                if (!itemDoc.exists()) throw new Error("Item not found");
                const loanDoc = await getDoc(loanRef);
                if (!loanDoc.exists()) throw new Error("Loan not found");
                
                const batch = writeBatch(db);
                batch.update(itemRef, { stock: itemDoc.data().stock + 1 });
                batch.update(loanRef, { returnedAt: serverTimestamp() });
                const transactionRef = doc(collection(db, 'transactions'));
                batch.set(transactionRef, {
                    itemId: itemId, itemDescription: itemDoc.data().description, type: 'Devoluci√≥n',
                    quantity: 1, borrower: loanDoc.data().borrower,
                    timestamp: serverTimestamp(), user: state.currentUser.email,
                    returnedBy: state.currentUser.email
                });
                await batch.commit();
                showNotification('Devoluci√≥n guardada.', 'success');
            } catch (error) {
                showNotification('Error al devolver. Intenta de nuevo.', 'error');
            }
        }
        async function handleReportLoanLoss(loanId, itemId) {
            const loan = state.activeLoans.find(l => l.id === loanId);
            const item = state.inventory.find(i => i.id === itemId);
            if (!loan || !item) return;
            showReportLossModal(loan, item);
        }

        // --- L√ìGICA DE MODALES ---
        function showModal(title, content, maxWidth = 'max-w-2xl') {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div id="app-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40">
                    <div class="relative top-4 sm:top-20 mx-auto p-4 sm:p-5 border w-full sm:w-auto ${maxWidth} shadow-lg rounded-md themed-card themed-border pop-animation mobile-modal">
                        <div class="flex justify-between items-center pb-3 border-b themed-border">
                            <h3 class="text-xl sm:text-2xl font-bold">${title}</h3>
                            <button id="close-modal-btn" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <i data-lucide="x" class="h-5 w-5 sm:h-6 sm:w-6"></i>
                            </button>
                        </div>
                        <div class="mt-3">${content}</div>
                    </div>
                </div>`;
            safeCreateIcons();
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('app-modal').addEventListener('click', (e) => { if (e.target.id === 'app-modal') closeModal(); });
        }
        function closeModal() { document.getElementById('modal-container').innerHTML = ''; }
        
        // Mobile table enhancement function
        function enhanceMobileTables() {
            const tables = document.querySelectorAll('.mobile-table');
            tables.forEach(table => {
                const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
                const rows = table.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    cells.forEach((cell, index) => {
                        if (headers[index]) {
                            cell.setAttribute('data-label', headers[index]);
                        }
                    });
                });
            });
        }
        
        // Mobile-specific enhancements
        function enhanceMobileExperience() {
            // Add mobile classes to buttons
            const buttons = document.querySelectorAll('button:not(.mobile-btn)');
            buttons.forEach(btn => {
                if (window.innerWidth < 768) {
                    btn.classList.add('mobile-btn');
                }
            });
            
            // Enhance form inputs for mobile
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (window.innerWidth < 768) {
                    input.classList.add('mobile-form');
                }
            });
            
            // Close sidebar on mobile when navigating
            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                const mobileOverlay = document.getElementById('mobile-overlay');
                if (sidebar && !sidebar.classList.contains('-translate-x-full')) {
                    sidebar.classList.add('-translate-x-full');
                    mobileOverlay.classList.add('hidden');
                }
            }
        }

        function showConfirmationModal(message, onConfirm) {
            const content = `
                <p class="themed-text-light mb-6">${message}</p>
                <div class="flex justify-end space-x-4">
                    <button id="confirm-cancel" class="bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 text-black dark:text-white font-bold py-2 px-4 rounded">Cancelar</button>
                    <button id="confirm-accept" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Confirmar</button>
                </div>`;
            showModal('Confirmaci√≥n Requerida', content, 'max-w-md');
            document.getElementById('confirm-accept').addEventListener('click', () => { onConfirm(); closeModal(); });
            document.getElementById('confirm-cancel').addEventListener('click', closeModal);
        }

        function showEntryModal(item = null) {
            // If no item is passed, show a selector
            const itemSelector = !item ? `
                <div class="mb-4">
                    <label for="item-select" class="block text-sm font-medium themed-text-light">Seleccionar Art√≠culo</label>
                    <select id="item-select" name="item-select" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        <option value="" disabled selected>Elige un art√≠culo...</option>
                        ${state.inventory.map(i => `<option value="${i.id}">${i.description}</option>`).join('')}
                    </select>
                </div>` : `<p class="mb-4"><strong>Art√≠culo:</strong> ${item.description}</p>`;

            const content = `
                ${itemSelector}
                <form id="entry-form">
                    <div class="mb-4">
                        <label for="quantity" class="block text-sm font-medium themed-text-light">Cantidad</label>
                        <input type="number" id="quantity" name="quantity" min="1" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                    </div>
                    <div class="mb-4">
                        <label for="supplier" class="block text-sm font-medium themed-text-light">Proveedor (Opcional)</label>
                        <input type="text" id="supplier" name="supplier" class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                    </div>
                    <div class="mb-4">
                        <label for="notes" class="block text-sm font-medium themed-text-light">Notas (Opcional)</label>
                        <textarea id="notes" name="notes" rows="2" class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm"></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg min-h-[56px] flex items-center justify-center transition-all duration-200">
                            <i data-lucide="plus-circle" class="h-6 w-6 mr-2"></i>
                            Registrar Entrada
                        </button>
                    </div>
                </form>`;
            showModal('Registrar Entrada', content, 'max-w-md');
            document.getElementById('entry-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const itemToUpdate = item || state.inventory.find(i => i.id === e.target.closest('.relative').querySelector('#item-select')?.value);
                if (!itemToUpdate) {
                    showNotification("Por favor, selecciona un art√≠culo.", "error");
                    return;
                }
                const { quantity, supplier, notes } = e.target.elements;
                const itemRef = doc(db, 'inventory', itemToUpdate.id);
                await updateDoc(itemRef, { stock: itemToUpdate.stock + parseInt(quantity.value) });
                await addDoc(collection(db, 'transactions'), {
                    itemId: itemToUpdate.id, itemDescription: itemToUpdate.description, type: 'Entrada', quantity: parseInt(quantity.value),
                    supplier: supplier.value, notes: notes.value, timestamp: serverTimestamp(), user: state.currentUser.email
                });
                showNotification('Entrada registrada.', 'success');
                closeModal();
            });
        }
        function showCheckoutModal(item = null) {
             const itemSelector = !item ? `
                <div class="mb-4">
                    <label for="item-select" class="block text-sm font-medium themed-text-light mb-2">Seleccionar Art√≠culo</label>
                    
                    <!-- B√∫squeda inteligente -->
                    <div class="relative mb-3">
                        <input type="text" id="item-search" placeholder="Buscar..." 
                               class="themed-input w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <i data-lucide="search" class="h-4 w-4 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <!-- Sugerencias inteligentes -->
                    <div id="smart-suggestions" class="mb-3">
                        <div class="flex items-center mb-2">
                            <i data-lucide="zap" class="h-4 w-4 text-yellow-500 mr-2"></i>
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">M√°s utilizados</span>
                        </div>
                        <div id="suggestions-list" class="grid grid-cols-1 gap-2">
                            <!-- Las sugerencias se cargar√°n din√°micamente -->
                        </div>
                    </div>
                    
                    <!-- Selector tradicional -->
                    <select id="item-select" name="item-select" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        <option value="" disabled selected>O elige de la lista...</option>
                        ${state.inventory.map(i => `<option value="${i.id}">${i.description}</option>`).join('')}
                    </select>
                </div>` : `<p class="mb-4"><strong>Art√≠culo:</strong> ${item.description}</p>`;

            const content = `
                ${itemSelector}
                <form id="checkout-form">
                     <!-- Form fields will be populated by JS -->
                </form>`;
            showModal('Registrar Salida / Pr√©stamo', content, 'max-w-md');

            const formContainer = document.getElementById('checkout-form');
            const itemSelect = document.getElementById('item-select');
            
            // Cargar sugerencias inteligentes
            if (!item) {
                loadSmartSuggestions();
                setupSmartSearch();
            }
            
            const populateForm = (selectedItem) => {
                if (!selectedItem) {
                    formContainer.innerHTML = '';
                    return;
                }
                
                const hasStock = selectedItem.stock > 0;
                const isEndmill = selectedItem.category.toLowerCase().includes('endmill');
                const maxQuantity = Math.min(selectedItem.stock, state.settings.customValidations?.maxQuantityPerTransaction || 1000);
                const requireNotes = state.settings.customValidations?.requireNotesForLargeTransactions;
                
                formContainer.innerHTML = `
                    <div class="mb-4">
                        <label class="block text-sm font-medium themed-text-light">Tipo de Operaci√≥n</label>
                        <div class="mt-2 space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="operationType" value="consumible" class="form-radio text-blue-600" checked>
                                <span class="ml-2 text-sm themed-text-light">Consumible (Salida)</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="operationType" value="retornable" class="form-radio text-green-600">
                                <span class="ml-2 text-sm themed-text-light">Retornable (Pr√©stamo)</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Consumible fields -->
                    <div id="consumible-fields">
                        <div class="mb-4">
                            <label for="quantity" class="block text-sm font-medium themed-text-light">Cantidad</label>
                            <input type="number" id="quantity" name="quantity" min="1" max="${maxQuantity}" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                            <p class="text-xs themed-text-light mt-1">M√°ximo: ${maxQuantity} ${selectedItem.unit}</p>
                        </div>
                        <div class="mb-4">
                            <label for="user" class="block text-sm font-medium themed-text-light">Nombre de quien retira</label>
                            <input type="text" id="user" name="user" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        </div>
                        ${isEndmill ? `
                        <div class="mb-4">
                            <label class="block text-sm font-medium themed-text-light">¬øDevolvi√≥ pieza rota?</label>
                            <div class="mt-2 space-x-4">
                                <label><input type="radio" name="exchange" value="yes" class="form-radio"> S√≠ (Intercambio)</label>
                                <label><input type="radio" name="exchange" value="no" class="form-radio" checked> No (Salida)</label>
                            </div>
                        </div>` : ''}
                        <div class="mb-4" id="notes-container" ${requireNotes ? '' : 'style="display:none"'}>
                            <label for="notes" class="block text-sm font-medium themed-text-light">Notas ${requireNotes ? '(Requerido para cantidades grandes)' : '(Opcional)'}</label>
                            <textarea id="notes" name="notes" rows="2" class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm"></textarea>
                        </div>
                    </div>
                    
                    <!-- Retornable fields -->
                    <div id="retornable-fields" style="display: none;">
                        <div class="mb-4">
                            <label for="borrower" class="block text-sm font-medium themed-text-light">Nombre de quien solicita</label>
                            <input type="text" id="borrower" name="borrower" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm" ${!hasStock ? 'disabled' : ''}>
                        </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg min-h-[56px] flex items-center justify-center transition-all duration-200 ${!hasStock ? 'opacity-50 cursor-not-allowed' : ''}" ${!hasStock ? 'disabled' : ''}>
                            <i data-lucide="arrow-right-left" class="h-6 w-6 mr-2"></i>
                            <span id="submit-btn-text">Registrar Salida</span>
                        </button>
                    </div>
                `;
                
                // Add event listeners for radio buttons
                const operationTypeRadios = formContainer.querySelectorAll('input[name="operationType"]');
                const consumibleFields = document.getElementById('consumible-fields');
                const retornableFields = document.getElementById('retornable-fields');
                const submitBtnText = document.getElementById('submit-btn-text');
                
                operationTypeRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        if (e.target.value === 'consumible') {
                            consumibleFields.style.display = 'block';
                            retornableFields.style.display = 'none';
                            submitBtnText.textContent = 'Registrar Salida';
                        } else {
                            consumibleFields.style.display = 'none';
                            retornableFields.style.display = 'block';
                            submitBtnText.textContent = 'Registrar Pr√©stamo';
                        }
                    });
                });
            };
            
            if(item) {
                populateForm(item);
            } else {
                itemSelect.addEventListener('change', (e) => {
                    const selectedItem = state.inventory.find(i => i.id === e.target.value);
                    populateForm(selectedItem);
                });
            }

            formContainer.addEventListener('submit', async (e) => {
                e.preventDefault();
                const selectedItem = item || state.inventory.find(i => i.id === itemSelect.value);
                if (!selectedItem) {
                     showNotification("Selecciona un art√≠culo.", "error");
                     return;
                }
                
                // Get the operation type selected by the operator
                const operationType = e.target.elements.operationType.value;
                
                if (operationType === 'consumible') {
                    // Logic for Consumable
                    const { quantity, user, exchange, notes } = e.target.elements;
                    const qty = parseInt(quantity.value);
                    const isEndmill = selectedItem.category.toLowerCase().includes('endmill');
                    const isExchange = isEndmill && exchange && exchange.value === 'yes';

                    if (state.settings.customValidations?.preventNegativeStock && !isExchange && selectedItem.stock - qty < 0) {
                        showNotification('No puedes tener menos de 0 en stock.', 'error');
                        return;
                    }

                    const itemRef = doc(db, 'inventory', selectedItem.id);
                    if (!isExchange) {
                        await updateDoc(itemRef, { stock: selectedItem.stock - qty });
                    }
                    await addDoc(collection(db, 'transactions'), {
                        itemId: selectedItem.id, itemDescription: selectedItem.description, type: isExchange ? 'Intercambio' : 'Salida',
                        quantity: qty, user: user.value, notes: notes?.value || '', timestamp: serverTimestamp()
                    });
                    showNotification('Salida guardada.', 'success');
                } else {
                    // Logic for Retornable
                    if (selectedItem.stock <= 0) {
                        showNotification('No hay stock disponible para este art√≠culo.', 'error');
                        return;
                    }
                    
                    const borrower = e.target.borrower.value;
                    const batch = writeBatch(db);
                    batch.update(doc(db, 'inventory', selectedItem.id), { stock: selectedItem.stock - 1 });
                    batch.set(doc(collection(db, 'loans')), {
                        itemId: selectedItem.id, itemDescription: selectedItem.description, borrower: borrower,
                        loanedAt: serverTimestamp(), returnedAt: null
                    });
                    batch.set(doc(collection(db, 'transactions')), {
                        itemId: selectedItem.id, itemDescription: selectedItem.description, type: 'Pr√©stamo',
                        quantity: 1, borrower: borrower, timestamp: serverTimestamp()
                    });
                    await batch.commit();
                    showNotification('Pr√©stamo registrado.', 'success');
                }
                closeModal();
            });
        }

        function loadSmartSuggestions() {
            const suggestionsList = document.getElementById('suggestions-list');
            if (!suggestionsList) return;

            const suggestions = getSmartSuggestions('', null, 6);
            
            if (suggestions.length === 0) {
                suggestionsList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">No hay datos de uso reciente</p>';
                return;
            }

            suggestionsList.innerHTML = suggestions.map(suggestion => {
                const item = state.inventory.find(i => i.id === suggestion.itemId);
                if (!item) return '';
                
                const usageText = suggestion.totalUsage > 0 ? 
                    `${suggestion.totalUsage} usos` : 'Nuevo';
                const lastUsed = suggestion.lastUsed ? 
                    `√öltimo: ${new Date(suggestion.lastUsed).toLocaleDateString()}` : '';
                
                return `
                    <button type="button" 
                            class="suggestion-item w-full text-left p-3 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                            data-item-id="${suggestion.itemId}">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900 dark:text-white">${suggestion.description}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">${suggestion.category}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 dark:text-gray-400">${usageText}</div>
                                ${lastUsed ? `<div class="text-xs text-gray-400">${lastUsed}</div>` : ''}
                            </div>
                        </div>
                    </button>
                `;
            }).join('');

            // Agregar event listeners a las sugerencias
            suggestionsList.querySelectorAll('.suggestion-item').forEach(button => {
                button.addEventListener('click', () => {
                    const itemId = button.dataset.itemId;
                    const selectedItem = state.inventory.find(i => i.id === itemId);
                    if (selectedItem) {
                        // Seleccionar en el dropdown
                        const itemSelect = document.getElementById('item-select');
                        if (itemSelect) {
                            itemSelect.value = itemId;
                            itemSelect.dispatchEvent(new Event('change'));
                        }
                        // Limpiar b√∫squeda
                        const searchInput = document.getElementById('item-search');
                        if (searchInput) {
                            searchInput.value = '';
                        }
                    }
                });
            });
        }

        function setupSmartSearch() {
            const searchInput = document.getElementById('item-search');
            if (!searchInput) return;

            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const searchTerm = e.target.value;
                    const suggestions = getSmartSuggestions(searchTerm, null, 8);
                    updateSuggestionsList(suggestions);
                }, 200);
            });

            // Limpiar b√∫squeda al hacer clic fuera
            searchInput.addEventListener('blur', () => {
                setTimeout(() => {
                    if (document.activeElement !== searchInput) {
                        searchInput.value = '';
                        loadSmartSuggestions();
                    }
                }, 200);
            });
        }

        function updateSuggestionsList(suggestions) {
            const suggestionsList = document.getElementById('suggestions-list');
            if (!suggestionsList) return;

            if (suggestions.length === 0) {
                suggestionsList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">No se encontraron art√≠culos</p>';
                return;
            }

            suggestionsList.innerHTML = suggestions.map(suggestion => {
                const item = state.inventory.find(i => i.id === suggestion.itemId);
                if (!item) return '';
                
                const usageText = suggestion.totalUsage > 0 ? 
                    `${suggestion.totalUsage} usos` : 'Nuevo';
                const lastUsed = suggestion.lastUsed ? 
                    `√öltimo: ${new Date(suggestion.lastUsed).toLocaleDateString()}` : '';
                
                return `
                    <button type="button" 
                            class="suggestion-item w-full text-left p-3 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                            data-item-id="${suggestion.itemId}">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900 dark:text-white">${suggestion.description}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">${suggestion.category}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 dark:text-gray-400">${usageText}</div>
                                ${lastUsed ? `<div class="text-xs text-gray-400">${lastUsed}</div>` : ''}
                            </div>
                        </div>
                    </button>
                `;
            }).join('');

            // Agregar event listeners a las sugerencias
            suggestionsList.querySelectorAll('.suggestion-item').forEach(button => {
                button.addEventListener('click', () => {
                    const itemId = button.dataset.itemId;
                    const selectedItem = state.inventory.find(i => i.id === itemId);
                    if (selectedItem) {
                        // Seleccionar en el dropdown
                        const itemSelect = document.getElementById('item-select');
                        if (itemSelect) {
                            itemSelect.value = itemId;
                            itemSelect.dispatchEvent(new Event('change'));
                        }
                        // Limpiar b√∫squeda
                        const searchInput = document.getElementById('item-search');
                        if (searchInput) {
                            searchInput.value = '';
                        }
                    }
                });
            });
        }

        
        function showReportLossModal(loan, item) {
            const content = `
                <p class="mb-2"><strong>Art√≠culo:</strong> ${item.description}</p>
                <p class="mb-4"><strong>Prestado a:</strong> ${loan.borrower}</p>
                <p class="text-sm text-red-600 mb-4">Esta acci√≥n cerrar√° el pr√©stamo y registrar√° el art√≠culo como baja por p√©rdida.</p>
                <form id="report-loss-form">
                    <div class="mb-4">
                        <label for="reason" class="block text-sm font-medium themed-text-light">Motivo de P√©rdida</label>
                        <input type="text" id="reason" name="reason" value="Perdido durante pr√©stamo" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                    </div>
                    <div class="flex justify-end"><button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-8 rounded-lg min-h-[56px] flex items-center justify-center transition-all duration-200">
                        <i data-lucide="x-circle" class="h-6 w-6 mr-2"></i>
                        Confirmar P√©rdida
                    </button></div>
                </form>`;
            showModal('Reportar Herramienta Perdida', content, 'max-w-md');
            document.getElementById('report-loss-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const reason = e.target.reason.value;
                const batch = writeBatch(db);
                batch.update(doc(db, 'loans', loan.id), { returnedAt: serverTimestamp(), status: 'lost' });
                batch.set(doc(collection(db, 'transactions')), {
                    itemId: item.id, itemDescription: item.description, type: 'Baja', quantity: 1,
                    notes: `P√©rdida por ${loan.borrower}. Motivo: ${reason}`,
                    timestamp: serverTimestamp(), user: state.currentUser.email
                });
                await batch.commit();
                showNotification('P√©rdida registrada.', 'success');
                closeModal();
            });
        }
        function showAddToCartModal(item) {
            const content = `
                <p class="mb-4"><strong>Art√≠culo:</strong> ${item.description}</p>
                <form id="add-to-cart-form">
                    <div class="mb-4">
                        <label for="quantity" class="block text-sm font-medium themed-text-light">Cantidad</label>
                        <input type="number" id="quantity" name="quantity" min="1" value="1" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                    </div>
                    <div class="flex justify-end"><button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-4 px-8 rounded-lg min-h-[56px] flex items-center justify-center transition-all duration-200">
                        <i data-lucide="shopping-cart" class="h-6 w-6 mr-2"></i>
                        A√±adir a la Lista
                    </button></div>
                </form>`;
            showModal('A√±adir a Lista de Compras', content, 'max-w-md');
            document.getElementById('add-to-cart-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const quantity = parseInt(e.target.quantity.value);
                await addToShoppingList(item, quantity);
                closeModal();
            });
        }
        
        function getCategoryOptions(selectedCategory) {
            return state.categories
                .filter(c => c !== 'Todas')
                .map(cat => `<option value="${cat}" ${cat === selectedCategory ? 'selected' : ''}>${cat}</option>`)
                .join('');
        }

        function showEditItemModal(item) {
            const content = `
                <form id="edit-item-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label for="description" class="block text-sm font-medium themed-text-light">Descripci√≥n</label>
                            <input type="text" id="description" value="${item.description}" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="category" class="block text-sm font-medium themed-text-light">Categor√≠a</label>
                            <select id="category" class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">${getCategoryOptions(item.category)}</select>
                        </div>
                        <div>
                            <label for="minStock" class="block text-sm font-medium themed-text-light">Stock M√≠nimo</label>
                            <input type="number" id="minStock" value="${item.minStock || 0}" min="0" class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        </div>
                         <div>
                            <label for="unit" class="block text-sm font-medium themed-text-light">Unidad</label>
                            <input type="text" id="unit" value="${item.unit || 'pza'}" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        </div>
                    </div>
                    <div class="flex justify-end mt-6">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg min-h-[56px] flex items-center justify-center transition-all duration-200">
                             <i data-lucide="save" class="h-6 w-6 mr-2"></i>
                             <span id="save-btn-text">Guardar Cambios</span>
                             <i id="save-spinner" data-lucide="loader" class="h-5 w-5 animate-spin hidden ml-2"></i>
                        </button>
                    </div>
                </form>
            `;
            showModal('Editar Art√≠culo', content);
            document.getElementById('edit-item-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const { description, category, minStock, unit } = e.target.elements;
                const saveBtnText = document.getElementById('save-btn-text');
                const saveSpinner = document.getElementById('save-spinner');
                saveBtnText.classList.add('hidden');
                saveSpinner.classList.remove('hidden');

                const updatedData = {
                    description: description.value,
                    category: category.value,
                    unit: unit.value,
                    minStock: parseInt(minStock.value)
                };

                await updateDoc(doc(db, 'inventory', item.id), updatedData);
                showNotification('Art√≠culo actualizado.', 'success');
                closeModal();
            });
        }

        function showEditStockModal(item) {
            const content = `
                <form id="edit-stock-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium themed-text-light mb-2">Art√≠culo</label>
                        <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div class="font-medium text-gray-900 dark:text-white">${item.description}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">${item.category}</div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="current-stock" class="block text-sm font-medium themed-text-light mb-2">Stock Actual</label>
                        <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                            <div class="text-lg font-semibold text-blue-700 dark:text-blue-300">${item.stock} ${item.unit}</div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label for="new-stock" class="block text-sm font-medium themed-text-light mb-2">Nuevo Stock Total</label>
                        <input type="number" id="new-stock" value="${item.stock}" min="0" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Ingresa el nuevo total de stock para este art√≠culo</p>
                    </div>
                    <div class="mb-4">
                        <label for="stock-reason" class="block text-sm font-medium themed-text-light mb-2">Motivo del Ajuste</label>
                        <textarea id="stock-reason" rows="3" placeholder="Ej: Inventario f√≠sico, correcci√≥n de error, etc." class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm"></textarea>
                    </div>
                    <div class="flex justify-end mt-6">
                        <button type="submit" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 px-8 rounded-lg min-h-[56px] flex items-center justify-center transition-all duration-200">
                             <i data-lucide="edit-3" class="h-6 w-6 mr-2"></i>
                             <span id="save-btn-text">Actualizar Stock</span>
                             <i id="save-spinner" data-lucide="loader" class="h-5 w-5 animate-spin hidden ml-2"></i>
                        </button>
                    </div>
                </form>
            `;
            showModal('Editar Stock', content);
            
            document.getElementById('edit-stock-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveBtnText = document.getElementById('save-btn-text');
                const saveSpinner = document.getElementById('save-spinner');
                saveBtnText.classList.add('hidden');
                saveSpinner.classList.remove('hidden');

                const newStock = parseInt(e.target['new-stock'].value);
                const reason = e.target['stock-reason'].value || 'Ajuste de stock por administrador';
                const stockDifference = newStock - item.stock;

                try {
                    // Update the stock in the database
                    await updateDoc(doc(db, 'inventory', item.id), { stock: newStock });
                    
                    // Add transaction record
                    await addDoc(collection(db, 'transactions'), {
                        itemId: item.id,
                        itemDescription: item.description,
                        type: stockDifference > 0 ? 'Ajuste Positivo' : 'Ajuste Negativo',
                        quantity: Math.abs(stockDifference),
                        timestamp: serverTimestamp(),
                        user: state.currentUser.email,
                        notes: reason
                    });
                    
                    showNotification(`Stock actualizado de ${item.stock} a ${newStock} ${item.unit}.`, 'success');
                    closeModal();
                } catch(error) {
                    showNotification('Error al actualizar el stock.', 'error');
                    saveBtnText.classList.remove('hidden');
                    saveSpinner.classList.add('hidden');
                }
            });
        }

        function showNewItemModal() {
             const content = `
                <form id="new-item-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label for="description" class="block text-sm font-medium themed-text-light">Descripci√≥n</label>
                            <input type="text" id="description" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="category" class="block text-sm font-medium themed-text-light">Categor√≠a</label>
                            <select id="category" class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">${getCategoryOptions('')}</select>
                        </div>
                        <div>
                            <label for="stock" class="block text-sm font-medium themed-text-light">Stock Inicial</label>
                            <input type="number" id="stock" value="0" min="0" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="minStock" class="block text-sm font-medium themed-text-light">Stock M√≠nimo</label>
                            <input type="number" id="minStock" value="${state.settings.defaultMinStock || 5}" min="0" class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        </div>
                         <div>
                            <label for="unit" class="block text-sm font-medium themed-text-light">Unidad</label>
                            <input type="text" id="unit" value="${state.settings.defaultUnit || 'pza'}" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        </div>
                    </div>
                    <div class="flex justify-end mt-6">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg min-h-[56px] flex items-center justify-center transition-all duration-200">
                             <i data-lucide="plus" class="h-6 w-6 mr-2"></i>
                             <span id="save-btn-text">Crear Art√≠culo</span>
                             <i id="save-spinner" data-lucide="loader" class="h-5 w-5 animate-spin hidden ml-2"></i>
                        </button>
                    </div>
                </form>
            `;
            showModal('Crear Nuevo Art√≠culo', content);

            document.getElementById('new-item-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveBtnText = document.getElementById('save-btn-text');
                const saveSpinner = document.getElementById('save-spinner');
                saveBtnText.classList.add('hidden');
                saveSpinner.classList.remove('hidden');

                const { description, category, minStock, unit, stock } = e.target.elements;
                const newItem = {
                    description: description.value,
                    category: category.value,
                    unit: unit.value,
                    stock: parseInt(stock.value),
                    minStock: parseInt(minStock.value)
                };

                try {
                    const docRef = await addDoc(collection(db, 'inventory'), newItem);
                    await addDoc(collection(db, 'transactions'), {
                        itemId: docRef.id, itemDescription: newItem.description, type: 'Creaci√≥n', quantity: newItem.stock,
                        timestamp: serverTimestamp(), user: state.currentUser.email, notes: 'Art√≠culo nuevo creado'
                    });
                    showNotification('Art√≠culo creado con √©xito.', 'success');
                    closeModal();
                    // Force refresh the inventory view if we're on the inventory page
                    if (window.location.hash.substring(1) === 'inventory') {
                        renderInventoryView();
                    }
                } catch(error) {
                    console.error('Error creating article:', error);
                    showNotification('Error al crear el art√≠culo.', 'error');
                    saveBtnText.classList.remove('hidden');
                    saveSpinner.classList.add('hidden');
                }
            });
        }

        function showAddCategoryModal() {
            const content = `
                <form id="add-category-form">
                    <div class="space-y-4">
                        <div>
                            <label for="new-category-name-modal" class="block text-sm font-medium themed-text-light">Nombre de la Categor√≠a</label>
                            <input type="text" id="new-category-name-modal" required placeholder="Ej: Herramientas, Materiales, etc." class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" id="cancel-category-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-8 rounded-lg min-h-[56px] flex items-center justify-center transition-all duration-200">
                                <i data-lucide="x" class="h-6 w-6 mr-2"></i>
                                Cancelar
                            </button>
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg min-h-[56px] flex items-center justify-center transition-all duration-200">
                                <i data-lucide="plus" class="h-6 w-6 mr-2"></i>
                                <span id="save-category-btn-text">Crear Categor√≠a</span>
                                <i id="save-category-spinner" data-lucide="loader" class="h-5 w-5 animate-spin hidden ml-2"></i>
                            </button>
                        </div>
                    </div>
                </form>
            `;
            showModal('Crear Nueva Categor√≠a', content, 'max-w-md');
            
            document.getElementById('add-category-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveBtnText = document.getElementById('save-category-btn-text');
                const saveSpinner = document.getElementById('save-category-spinner');
                saveBtnText.classList.add('hidden');
                saveSpinner.classList.remove('hidden');

                const input = document.getElementById('new-category-name-modal');
                const newCategory = input.value.trim();
                
                if (!newCategory) {
                    showNotification('El nombre de la categor√≠a no puede estar vac√≠o.', 'error');
                    saveBtnText.classList.remove('hidden');
                    saveSpinner.classList.add('hidden');
                    return;
                }
                
                if (state.categories.includes(newCategory)) {
                    showNotification('Esa categor√≠a ya existe.', 'info');
                    saveBtnText.classList.remove('hidden');
                    saveSpinner.classList.add('hidden');
                    return;
                }
                
                const updatedCategories = [...state.categories.filter(c => c !== 'Todas'), newCategory].sort();
                
                try {
                    await setDoc(doc(db, 'settings', 'global'), { categories: updatedCategories }, { merge: true });
                    showNotification('Categor√≠a creada exitosamente.', 'success');
                    closeModal();
                    // Refresh the inventory view to show the new category
                    if (window.location.hash.substring(1) === 'inventory') {
                        renderInventoryView();
                    }
                } catch (error) {
                    console.error('Error creating category:', error);
                    showNotification('Error al crear la categor√≠a.', 'error');
                    saveBtnText.classList.remove('hidden');
                    saveSpinner.classList.add('hidden');
                }
            });
            
            document.getElementById('cancel-category-btn').addEventListener('click', closeModal);
        }

        // --- L√ìGICA DE AJUSTES ---
        
        function applySettingsToUI(settings) {
            // Apply items per page setting
            state.itemsPerPage = settings.itemsPerPage || 10;
            
            // Apply interface customization settings
            if (settings.interfaceCustomization) {
                const { fontSize, compactSidebar, animationsEnabled, highContrastMode } = settings.interfaceCustomization;
                
                // Apply font size
                if (fontSize) {
                    document.body.classList.remove('small-font', 'large-font');
                    if (fontSize === 'small') {
                        document.body.classList.add('small-font');
                    } else if (fontSize === 'large') {
                        document.body.classList.add('large-font');
                    }
                }
                
                // Apply compact sidebar
                if (compactSidebar) {
                    document.body.classList.add('compact-sidebar');
                } else {
                    document.body.classList.remove('compact-sidebar');
                }
                
                // Apply animations
                if (!animationsEnabled) {
                    document.body.classList.add('no-animations');
                } else {
                    document.body.classList.remove('no-animations');
                }
                
                // Apply high contrast mode
                if (highContrastMode) {
                    document.body.classList.add('high-contrast');
                } else {
                    document.body.classList.remove('high-contrast');
                }
            }
            
            // Apply display preferences
            if (settings.displayPreferences) {
                const { tableDensity, showColumnLines, enableRowHover } = settings.displayPreferences;
                
                // Apply table density
                if (tableDensity) {
                    document.body.classList.remove('table-compact', 'table-comfortable', 'table-spacious');
                    document.body.classList.add(`table-${tableDensity}`);
                }
                
                // Apply column lines
                if (!showColumnLines) {
                    document.body.classList.add('no-column-lines');
                } else {
                    document.body.classList.remove('no-column-lines');
                }
                
                // Apply row hover
                if (!enableRowHover) {
                    document.body.classList.add('no-row-hover');
                } else {
                    document.body.classList.remove('no-row-hover');
                }
            }
            
            // Refresh current view to apply settings
            const currentPage = window.location.hash.substring(1) || 'dashboard';
            if (currentPage === 'dashboard') {
                renderDashboardView();
            } else if (currentPage === 'inventory') {
                renderInventoryView();
            } else if (currentPage === 'settings') {
                renderSettingsTab(document.querySelector('.settings-tab-link.border-indigo-500')?.dataset.tab || 'general');
            }
        }
        
        async function handleSaveSettings() {
            // Helper function to safely parse integers, falling back to a default if NaN
            const safeParseInt = (value, fallback) => {
                const parsed = parseInt(value, 10);
                return isNaN(parsed) ? fallback : parsed;
            };

            // Create a deep copy of the current settings to modify
            const updatedSettings = JSON.parse(JSON.stringify(state.settings));

            // Go through each possible setting in the DOM.
            // If the element exists (i.e., its tab is active), update the value in our copied object.
            // This prevents overwriting settings from inactive tabs with null/undefined.
            
            // General Tab
            const itemsPerPageEl = document.getElementById('items-per-page');
            if (itemsPerPageEl) updatedSettings.itemsPerPage = safeParseInt(itemsPerPageEl.value, updatedSettings.itemsPerPage);

            const defaultUnitEl = document.getElementById('default-unit');
            if (defaultUnitEl) updatedSettings.defaultUnit = defaultUnitEl.value;

            const defaultMinStockEl = document.getElementById('default-min-stock');
            if (defaultMinStockEl) updatedSettings.defaultMinStock = safeParseInt(defaultMinStockEl.value, updatedSettings.defaultMinStock);
            
            const sessionTimeoutEl = document.getElementById('session-timeout');
            if (sessionTimeoutEl) updatedSettings.sessionTimeout = safeParseInt(sessionTimeoutEl.value, updatedSettings.sessionTimeout);

            const enableAuditLogEl = document.getElementById('enable-audit-log');
            if (enableAuditLogEl) updatedSettings.enableAuditLog = enableAuditLogEl.checked;
            
            const barcodeScanningEl = document.getElementById('barcode-scanning');
            if (barcodeScanningEl) updatedSettings.barcodeScanning = barcodeScanningEl.checked;
            
            // Display Tab
            const tableDensityEl = document.getElementById('table-density');
            if (tableDensityEl) updatedSettings.displayPreferences.tableDensity = tableDensityEl.value;
            
            const defaultViewEl = document.getElementById('default-view');
            if (defaultViewEl) updatedSettings.displayPreferences.defaultView = defaultViewEl.value;
            
            const showColumnLinesEl = document.getElementById('show-column-lines');
            if (showColumnLinesEl) updatedSettings.displayPreferences.showColumnLines = showColumnLinesEl.checked;

            const enableRowHoverEl = document.getElementById('enable-row-hover');
            if (enableRowHoverEl) updatedSettings.displayPreferences.enableRowHover = enableRowHoverEl.checked;

            // Missing display preferences settings
            const itemsPerRowEl = document.getElementById('items-per-row');
            if (itemsPerRowEl) updatedSettings.displayPreferences.itemsPerRow = safeParseInt(itemsPerRowEl.value, updatedSettings.displayPreferences.itemsPerRow);

            const showStockBadgesEl = document.getElementById('show-stock-badges');
            if (showStockBadgesEl) updatedSettings.displayPreferences.showStockBadges = showStockBadgesEl.checked;

            const enableQuickEditEl = document.getElementById('enable-quick-edit');
            if (enableQuickEditEl) updatedSettings.displayPreferences.enableQuickEdit = enableQuickEditEl.checked;

            const fontSizeEl = document.getElementById('font-size');
            if (fontSizeEl) updatedSettings.interfaceCustomization.fontSize = fontSizeEl.value;
            
            const headerStyleEl = document.getElementById('header-style');
            if (headerStyleEl) updatedSettings.interfaceCustomization.headerStyle = headerStyleEl.value;
            
            const compactSidebarEl = document.getElementById('compact-sidebar');
            if (compactSidebarEl) updatedSettings.interfaceCustomization.compactSidebar = compactSidebarEl.checked;
            
            const animationsEnabledEl = document.getElementById('animations-enabled');
            if (animationsEnabledEl) updatedSettings.interfaceCustomization.animationsEnabled = animationsEnabledEl.checked;

            // Missing interface customization settings
            const sidebarPositionEl = document.getElementById('sidebar-position');
            if (sidebarPositionEl) updatedSettings.interfaceCustomization.sidebarPosition = sidebarPositionEl.value;

            const showBreadcrumbsEl = document.getElementById('show-breadcrumbs');
            if (showBreadcrumbsEl) updatedSettings.interfaceCustomization.showBreadcrumbs = showBreadcrumbsEl.checked;

            const highContrastModeEl = document.getElementById('high-contrast-mode');
            if (highContrastModeEl) updatedSettings.interfaceCustomization.highContrastMode = highContrastModeEl.checked;

            // Operational Tab
            const defaultTransactionTypeEl = document.getElementById('default-transaction-type');
            if (defaultTransactionTypeEl) updatedSettings.operationalPreferences.defaultTransactionType = defaultTransactionTypeEl.value;

            const recentItemsCountEl = document.getElementById('recent-items-count');
            if (recentItemsCountEl) updatedSettings.operationalPreferences.recentItemsCount = safeParseInt(recentItemsCountEl.value, updatedSettings.operationalPreferences.recentItemsCount);
            
            const enableKeyboardShortcutsEl = document.getElementById('enable-keyboard-shortcuts');
            if (enableKeyboardShortcutsEl) updatedSettings.operationalPreferences.enableKeyboardShortcuts = enableKeyboardShortcutsEl.checked;
            
            const showRecentItemsEl = document.getElementById('show-recent-items');
            if (showRecentItemsEl) updatedSettings.operationalPreferences.showRecentItems = showRecentItemsEl.checked;
            
            const autoSaveChangesEl = document.getElementById('auto-save-changes');
            if (autoSaveChangesEl) updatedSettings.operationalPreferences.autoSaveChanges = autoSaveChangesEl.checked;
            
            const confirmBeforeDeleteEl = document.getElementById('confirm-before-delete');
            if (confirmBeforeDeleteEl) updatedSettings.operationalPreferences.confirmBeforeDelete = confirmBeforeDeleteEl.checked;
            
            const enableBulkOperationsEl = document.getElementById('enable-bulk-operations');
            if (enableBulkOperationsEl) updatedSettings.operationalPreferences.enableBulkOperations = enableBulkOperationsEl.checked;
            
            const showAdvancedFiltersEl = document.getElementById('show-advanced-filters');
            if (showAdvancedFiltersEl) updatedSettings.operationalPreferences.showAdvancedFilters = showAdvancedFiltersEl.checked;

            // Dashboard Tab
            const showStockOverviewEl = document.getElementById('show-stock-overview');
            if (showStockOverviewEl) updatedSettings.dashboardCustomization.showStockOverview = showStockOverviewEl.checked;

            const showRecentTransactionsEl = document.getElementById('show-recent-transactions');
            if (showRecentTransactionsEl) updatedSettings.dashboardCustomization.showRecentTransactions = showRecentTransactionsEl.checked;
            
            const showLowStockAlertsEl = document.getElementById('show-low-stock-alerts');
            if (showLowStockAlertsEl) updatedSettings.dashboardCustomization.showLowStockAlerts = showLowStockAlertsEl.checked;

            const showQuickActionsEl = document.getElementById('show-quick-actions');
            if (showQuickActionsEl) updatedSettings.dashboardCustomization.showQuickActions = showQuickActionsEl.checked;

            const chartTypeEl = document.getElementById('chart-type');
            if (chartTypeEl) updatedSettings.dashboardCustomization.chartType = chartTypeEl.value;

            const defaultDateRangeEl = document.getElementById('default-date-range');
            if (defaultDateRangeEl) updatedSettings.dashboardCustomization.defaultDateRange = defaultDateRangeEl.value;
            
            const refreshIntervalEl = document.getElementById('refresh-interval');
            if (refreshIntervalEl) updatedSettings.dashboardCustomization.refreshInterval = safeParseInt(refreshIntervalEl.value, updatedSettings.dashboardCustomization.refreshInterval);

            // Stock Tab
            const autoReorderEnabledEl = document.getElementById('auto-reorder-enabled');
            if (autoReorderEnabledEl) updatedSettings.autoReorderEnabled = autoReorderEnabledEl.checked;

            const autoReorderThresholdEl = document.getElementById('auto-reorder-threshold');
            if (autoReorderThresholdEl) updatedSettings.autoReorderThreshold = safeParseInt(autoReorderThresholdEl.value, updatedSettings.autoReorderThreshold * 100) / 100;

            const supplierManagementEl = document.getElementById('supplier-management');
            if (supplierManagementEl) updatedSettings.supplierManagement = supplierManagementEl.checked;

            const maxQuantityTransactionEl = document.getElementById('max-quantity-transaction');
            if (maxQuantityTransactionEl) updatedSettings.customValidations.maxQuantityPerTransaction = safeParseInt(maxQuantityTransactionEl.value, updatedSettings.customValidations.maxQuantityPerTransaction);
            
            const requireNotesLargeEl = document.getElementById('require-notes-large');
            if (requireNotesLargeEl) updatedSettings.customValidations.requireNotesForLargeTransactions = requireNotesLargeEl.checked;

            const preventNegativeStockEl = document.getElementById('prevent-negative-stock');
            if (preventNegativeStockEl) updatedSettings.customValidations.preventNegativeStock = preventNegativeStockEl.checked;

            // Notifications Tab
            const lowStockNotificationsEl = document.getElementById('low-stock-notifications');
            if (lowStockNotificationsEl) updatedSettings.lowStockNotifications = lowStockNotificationsEl.checked;
            
            const notificationEmailsEl = document.getElementById('notification-emails');
            if (notificationEmailsEl) updatedSettings.notificationEmails = notificationEmailsEl.value;

            const stockAlertDaysEl = document.getElementById('stock-alert-days');
            if (stockAlertDaysEl) {
                updatedSettings.stockAlertDays = stockAlertDaysEl.value.split(',').map(d => safeParseInt(d.trim(), null)).filter(d => d !== null);
            }

            const enableScheduledReportsEl = document.getElementById('enable-scheduled-reports');
            if (enableScheduledReportsEl) updatedSettings.enableScheduledReports = enableScheduledReportsEl.checked;
            
            const reportScheduleEl = document.getElementById('report-schedule');
            if (reportScheduleEl) updatedSettings.reportSchedule = reportScheduleEl.value;

            // Workflow Tab
            const enableWorkflowApprovalsEl = document.getElementById('enable-workflow-approvals');
            if (enableWorkflowApprovalsEl) updatedSettings.enableWorkflowApprovals = enableWorkflowApprovalsEl.checked;

            // Operator Tab - Vista y Pantalla
            const operatorItemsPerPageEl = document.getElementById('operator-items-per-page');
            if (operatorItemsPerPageEl) updatedSettings.itemsPerPage = safeParseInt(operatorItemsPerPageEl.value, updatedSettings.itemsPerPage);

            const operatorViewTypeEl = document.getElementById('operator-view-type');
            if (operatorViewTypeEl) updatedSettings.displayPreferences.defaultView = operatorViewTypeEl.value;

            const operatorTableDensityEl = document.getElementById('operator-table-density');
            if (operatorTableDensityEl) updatedSettings.displayPreferences.tableDensity = operatorTableDensityEl.value;

            const operatorShowLinesEl = document.getElementById('operator-show-lines');
            if (operatorShowLinesEl) updatedSettings.displayPreferences.showColumnLines = operatorShowLinesEl.checked;

            // Operator Tab - Trabajo Diario
            const operatorDefaultActionEl = document.getElementById('operator-default-action');
            if (operatorDefaultActionEl) {
                const actionMap = {
                    'entry': 'Entrada',
                    'exit': 'Salida', 
                    'adjustment': 'Ajuste'
                };
                updatedSettings.operationalPreferences.defaultTransactionType = actionMap[operatorDefaultActionEl.value] || 'Entrada';
            }

            const operatorRecentItemsEl = document.getElementById('operator-recent-items');
            if (operatorRecentItemsEl) updatedSettings.operationalPreferences.recentItemsCount = safeParseInt(operatorRecentItemsEl.value, updatedSettings.operationalPreferences.recentItemsCount);

            const operatorShowRecentEl = document.getElementById('operator-show-recent');
            if (operatorShowRecentEl) updatedSettings.operationalPreferences.showRecentItems = operatorShowRecentEl.checked;

            const operatorKeyboardShortcutsEl = document.getElementById('operator-keyboard-shortcuts');
            if (operatorKeyboardShortcutsEl) updatedSettings.operationalPreferences.enableKeyboardShortcuts = operatorKeyboardShortcutsEl.checked;

            // Operator-specific settings
            const operatorConfirmDeleteEl = document.getElementById('operator-confirm-delete');
            if (operatorConfirmDeleteEl) updatedSettings.operationalPreferences.confirmBeforeDelete = operatorConfirmDeleteEl.checked;

            const operatorRecentCountEl = document.getElementById('operator-recent-count');
            if (operatorRecentCountEl) updatedSettings.operationalPreferences.recentItemsCount = safeParseInt(operatorRecentCountEl.value, updatedSettings.operationalPreferences.recentItemsCount);

            const operatorEnableHoverEl = document.getElementById('operator-enable-hover');
            if (operatorEnableHoverEl) updatedSettings.displayPreferences.enableRowHover = operatorEnableHoverEl.checked;

            // Operator Tab - Alertas
            const operatorLowStockAlertEl = document.getElementById('operator-low-stock-alert');
            if (operatorLowStockAlertEl) updatedSettings.notificationPreferences.lowStockAlert = operatorLowStockAlertEl.value;

            const operatorSoundAlertsEl = document.getElementById('operator-sound-alerts');
            if (operatorSoundAlertsEl) updatedSettings.notificationPreferences.soundAlerts = operatorSoundAlertsEl.checked;

            const operatorPopupAlertsEl = document.getElementById('operator-popup-alerts');
            if (operatorPopupAlertsEl) updatedSettings.notificationPreferences.popupAlerts = operatorPopupAlertsEl.checked;

            // Missing notification preferences
            const lowStockAlertEl = document.getElementById('low-stock-alert');
            if (lowStockAlertEl) updatedSettings.notificationPreferences.lowStockAlert = lowStockAlertEl.value;

            const soundAlertsEl = document.getElementById('sound-alerts');
            if (soundAlertsEl) updatedSettings.notificationPreferences.soundAlerts = soundAlertsEl.checked;

            const popupAlertsEl = document.getElementById('popup-alerts');
            if (popupAlertsEl) updatedSettings.notificationPreferences.popupAlerts = popupAlertsEl.checked;

            const emailNotificationsEl = document.getElementById('email-notifications');
            if (emailNotificationsEl) updatedSettings.notificationPreferences.emailNotifications = emailNotificationsEl.checked;

            // Operator Tab - Apariencia
            const operatorFontSizeEl = document.getElementById('operator-font-size');
            if (operatorFontSizeEl) updatedSettings.interfaceCustomization.fontSize = operatorFontSizeEl.value;

            const operatorCompactSidebarEl = document.getElementById('operator-compact-sidebar');
            if (operatorCompactSidebarEl) updatedSettings.interfaceCustomization.compactSidebar = operatorCompactSidebarEl.checked;

            const operatorAnimationsEl = document.getElementById('operator-animations');
            if (operatorAnimationsEl) updatedSettings.interfaceCustomization.animationsEnabled = operatorAnimationsEl.checked;

            const approvalThresholdEl = document.getElementById('approval-threshold');
            if (approvalThresholdEl) updatedSettings.approvalThreshold = safeParseInt(approvalThresholdEl.value, updatedSettings.approvalThreshold);

            const dataRetentionDaysEl = document.getElementById('data-retention-days');
            if (dataRetentionDaysEl) updatedSettings.dataRetentionDays = safeParseInt(dataRetentionDaysEl.value, updatedSettings.dataRetentionDays);

            // Validation
            if (updatedSettings.itemsPerPage < 5 || updatedSettings.itemsPerPage > 50) {
                 showNotification('Art√≠culos por p√°gina debe estar entre 5 y 50.', 'error');
                 return;
            }

            try {
                // Save the fully merged and updated settings object
                await setDoc(doc(db, 'settings', 'global'), updatedSettings);
                
                // Apply settings to the UI immediately
                applySettingsToUI(updatedSettings);
                
                showNotification('Ajustes guardados con √©xito.', 'success');

            } catch (error) {
                showNotification('Error al guardar los ajustes.', 'error');
                console.error("Error saving settings: ", error);
            }
        }
        
        async function handleAddCategory() {
            const input = document.getElementById('new-category-name');
            const newCategory = input.value.trim();
            if (!newCategory) {
                showNotification('El nombre de la categor√≠a no puede estar vac√≠o.', 'error');
                return;
            }
            if (state.categories.includes(newCategory)) {
                showNotification('Esa categor√≠a ya existe.', 'info');
                return;
            }
            
            const updatedCategories = [...state.categories.filter(c => c !== 'Todas'), newCategory].sort();
            
            try {
                await setDoc(doc(db, 'settings', 'global'), { categories: updatedCategories }, { merge: true });
                input.value = '';
                showNotification('Categor√≠a a√±adida.', 'success');
            } catch (error) {
                showNotification('Error al a√±adir la categor√≠a.', 'error');
            }
        }

        async function handleRenameCategory(oldName) {
            const newName = prompt(`Renombrar categor√≠a "${oldName}":`, oldName);
            if (!newName || newName.trim() === '' || newName === oldName) return;
            if (state.categories.includes(newName)) {
                showNotification('Ya existe una categor√≠a con ese nombre.', 'error');
                return;
            }

            showConfirmationModal(`¬øSeguro que quieres renombrar "${oldName}" a "${newName}"? Esto actualizar√° todos los art√≠culos de esta categor√≠a.`, async () => {
                const batch = writeBatch(db);
                const itemsToUpdateQuery = query(collection(db, 'inventory'), where('category', '==', oldName));
                const querySnapshot = await getDocs(itemsToUpdateQuery);
                
                querySnapshot.forEach(itemDoc => {
                    batch.update(itemDoc.ref, { category: newName });
                });
                
                const updatedCategories = state.categories.map(c => c === oldName ? newName : c).sort();
                batch.set(doc(db, 'settings', 'global'), { categories: updatedCategories.filter(c => c !== 'Todas')}, { merge: true });

                try {
                    await batch.commit();
                    showNotification('Categor√≠a renombrada con √©xito.', 'success');
                } catch (error) {
                    showNotification('Error al renombrar la categor√≠a.', 'error');
                }
            });
        }

        async function handleDeleteCategory(categoryName) {
            const itemsInCategoryQuery = query(collection(db, 'inventory'), where('category', '==', categoryName));
            const querySnapshot = await getDocs(itemsInCategoryQuery);
            const itemsCount = querySnapshot.size;

            let confirmationMessage = `¬øSeguro que quieres eliminar la categor√≠a "${categoryName}"?`;
            if (itemsCount > 0) {
                confirmationMessage = `¬øSeguro que quieres eliminar la categor√≠a "${categoryName}"? Se eliminar√°n tambi√©n los ${itemsCount} art√≠culos que contiene. Esta acci√≥n no se puede deshacer.`;
            }

            showConfirmationModal(confirmationMessage, async () => {
                const batch = writeBatch(db);

                // Delete all items in the category
                querySnapshot.forEach(itemDoc => {
                    const itemData = itemDoc.data();
                    batch.delete(itemDoc.ref);

                    // Add a transaction log for each deleted item
                    const transactionRef = doc(collection(db, 'transactions'));
                    batch.set(transactionRef, {
                        itemDescription: itemData.description,
                        type: 'Eliminado',
                        quantity: itemData.stock,
                        timestamp: serverTimestamp(),
                        user: state.currentUser.email,
                        notes: `Art√≠culo eliminado por borrado de categor√≠a: ${categoryName}`
                    });
                });

                // Delete the category from settings
                const updatedCategories = state.categories.filter(c => c !== categoryName && c !== 'Todas');
                const settingsRef = doc(db, 'settings', 'global');
                batch.set(settingsRef, { categories: updatedCategories }, { merge: true });

                try {
                    await batch.commit();
                    showNotification(`Categor√≠a "${categoryName}" y sus art√≠culos han sido eliminados.`, 'success');
                } catch (error) {
                    console.error("Error deleting category and its items:", error);
                    showNotification('Error al eliminar la categor√≠a y sus art√≠culos.', 'error');
                }
            });
        }


        async function handleBulkUpdateCategoryType() {
            const categoryToUpdate = document.getElementById('bulk-category-select').value;
            const newType = document.getElementById('bulk-type-select').value;

            if (!categoryToUpdate) {
                showNotification('Por favor, selecciona una categor√≠a.', 'error');
                return;
            }

            const message = `¬øEst√°s seguro de que quieres cambiar todos los art√≠culos en la categor√≠a "${categoryToUpdate}" al tipo "${newType}"? Esta acci√≥n es irreversible.`;

            showConfirmationModal(message, async () => {
                const itemsToUpdateQuery = query(collection(db, 'inventory'), where('category', '==', categoryToUpdate));
                const querySnapshot = await getDocs(itemsToUpdateQuery);

                if (querySnapshot.empty) {
                    showNotification('No hay art√≠culos en esta categor√≠a para actualizar.', 'info');
                    return;
                }

                const batch = writeBatch(db);
                querySnapshot.forEach(itemDoc => {
                    batch.update(itemDoc.ref, { type: newType });
                });

                try {
                    await batch.commit();
                    showNotification(`Se actualizaron ${querySnapshot.size} art√≠culos en la categor√≠a "${categoryToUpdate}".`, 'success');
                } catch (error) {
                    showNotification('Ocurri√≥ un error al actualizar los art√≠culos.', 'error');
                    console.error("Error during bulk category type update:", error);
                }
            });
        }

        // --- ENHANCED DATA MANAGEMENT FUNCTIONS ---
        async function handleImportData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Por favor, selecciona un archivo CSV.', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const csv = e.target.result;
                    const lines = csv.split(/\r\n|\n/); // Handles different line endings
                    const items = [];
                    
                    // Skip header line (i=1)
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const [description, category, type, stock, unit, minStock] = line.split(',').map(s => s.trim().replace(/"/g, ''));
                        
                        if (description && category && type && stock && unit) {
                            items.push({
                                description,
                                category,
                                type,
                                stock: parseInt(stock, 10) || 0,
                                unit,
                                minStock: parseInt(minStock, 10) || state.settings.defaultMinStock || 5,
                            });
                        }
                    }
                    
                    if (items.length === 0) {
                        showNotification('No se encontraron datos v√°lidos en el archivo.', 'error');
                        return;
                    }
                    
                    showConfirmationModal(`¬øImportar ${items.length} art√≠culos? Esta acci√≥n agregar√° nuevos items al inventario.`, async () => {
                        const batch = writeBatch(db);
                        let successCount = 0;
                        
                        items.forEach(item => {
                            const docRef = doc(collection(db, 'inventory'));
                            batch.set(docRef, item);
                            
                            const transactionRef = doc(collection(db, 'transactions'));
                            batch.set(transactionRef, {
                                itemDescription: item.description, type: 'Creaci√≥n', quantity: item.stock,
                                timestamp: serverTimestamp(), user: state.currentUser.email, notes: 'Importado desde CSV'
                            });
                            successCount++;
                        });
                        
                        try {
                            await batch.commit();
                            showNotification(`${successCount} art√≠culos importados con √©xito.`, 'success');
                            fileInput.value = '';
                        } catch (error) {
                            showNotification('Error al importar los datos.', 'error');
                            console.error('Import error:', error);
                        }
                    });
                } catch (error) {
                    showNotification('Error al procesar el archivo CSV.', 'error');
                    console.error('CSV processing error:', error);
                }
            };
            reader.readAsText(file);
        }

        async function handleExportInventory() {
            const data = state.inventory.map(item => [
                item.description, item.category,
                item.stock, item.unit, item.minStock || 0
            ]);
            const headers = ['Descripci√≥n', 'Categor√≠a', 'Stock', 'Unidad', 'Stock M√≠nimo'];
            exportToCSV('inventario_completo', headers, data);
        }

        async function handleExportSettings() {
            const settingsJson = JSON.stringify(state.settings, null, 2);
            const blob = new Blob([settingsJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `configuraciones_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
            showNotification('Configuraciones exportadas.', 'success');
        }

        async function handleExportFullBackup() {
            try {
                const backup = {
                    timestamp: new Date().toISOString(),
                    settings: state.settings,
                    categories: state.categories.filter(c => c !== 'Todas'),
                    inventory: state.inventory,
                    transactions: state.transactions,
                    activeLoans: state.activeLoans,
                    shoppingList: state.shoppingList
                };
                
                const backupJson = JSON.stringify(backup, null, 2);
                const blob = new Blob([backupJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `respaldo_completo_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link);
                link.click();
                link.remove();
                URL.revokeObjectURL(url);
                showNotification('Respaldo completo creado.', 'success');
            } catch (error) {
                showNotification('Error al crear el respaldo.', 'error');
                console.error('Backup error:', error);
            }
        }

        async function handleArchiveOldData() {
            const retentionDays = state.settings.dataRetentionDays || 365;
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - retentionDays);
            
            const oldTransactionsQuery = query(collection(db, 'transactions'), where('timestamp', '<', cutoffDate));
            const querySnapshot = await getDocs(oldTransactionsQuery);
            
            if (querySnapshot.empty) {
                showNotification('No hay datos antiguos para archivar.', 'info');
                return;
            }
            
            showConfirmationModal(`¬øArchivar ${querySnapshot.size} transacciones anteriores a ${cutoffDate.toLocaleDateString()}?`, async () => {
                try {
                    const archiveBatch = writeBatch(db);
                    const deleteBatch = writeBatch(db);
                    
                    querySnapshot.forEach(transactionDoc => {
                        const transactionData = transactionDoc.data();
                        const archiveRef = doc(collection(db, 'archived_transactions'));
                        archiveBatch.set(archiveRef, { ...transactionData, archivedAt: serverTimestamp() });
                        deleteBatch.delete(transactionDoc.ref);
                    });
                    
                    await archiveBatch.commit();
                    await deleteBatch.commit();
                    
                    showNotification(`${querySnapshot.size} transacciones archivadas.`, 'success');
                } catch (error) {
                    showNotification('Error al archivar los datos.', 'error');
                    console.error('Archive error:', error);
                }
            });
        }

        // --- L√ìGICA DE UTILIDADES ---
        async function uploadImage(file) {
            if (!file) return null;
            const storageRef = ref(storage, `item_images/${Date.now()}_${file.name}`);
            try {
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                return downloadURL;
            } catch (error) {
                console.error("Error uploading image: ", error);
                showNotification("Error al subir la imagen.", "error");
                return null;
            }
        }

        function generatePaginator(totalPages) {
            if (totalPages <= 1) return '';
            let pages = '';
            for (let i = 1; i <= totalPages; i++) {
                pages += `<a href="#" class="page-link px-3 py-1 rounded text-sm font-medium transition-colors ${i === state.currentPage ? 'bg-indigo-600 text-white' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-indigo-600 dark:hover:text-indigo-400'}" data-page="${i}">${i}</a>`;
            }
            return `<div class="flex items-center justify-center space-x-1 flex-wrap">${pages}</div>`;
        }
        function showNotification(message, type = 'info') {
            // Input validation
            if (!message || typeof message !== 'string') {
                console.warn('Invalid notification message:', message);
                return;
            }
            
            const container = document.getElementById('notification-container');
            if (!container) {
                console.warn('Notification container not found');
                return;
            }
            
            const id = `notif-${Date.now()}`;
            const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500' };
            const notif = document.createElement('div');
            notif.id = id;
            
            // Sanitize message to prevent XSS
            const sanitizedMessage = message.replace(/[<>]/g, '');
            
            notif.className = `text-white px-6 py-4 border-0 rounded relative mb-4 ${colors[type] || colors.info} pop-animation`;
            notif.innerHTML = `<span class="inline-block align-middle mr-8">${sanitizedMessage}</span>`;
            container.appendChild(notif);
            setTimeout(() => { 
                if (notif.parentNode) {
                    notif.remove(); 
                }
            }, 5000);
        }
        // Input validation helper
        function validateInput(value, type = 'string', min = null, max = null) {
            if (value === null || value === undefined || value === '') {
                return { valid: false, error: 'Campo requerido' };
            }
            
            switch (type) {
                case 'number':
                    const num = parseFloat(value);
                    if (isNaN(num)) return { valid: false, error: 'Debe ser un n√∫mero v√°lido' };
                    if (min !== null && num < min) return { valid: false, error: `Debe ser mayor o igual a ${min}` };
                    if (max !== null && num > max) return { valid: false, error: `Debe ser menor o igual a ${max}` };
                    return { valid: true, value: num };
                case 'string':
                    if (typeof value !== 'string') return { valid: false, error: 'Debe ser texto' };
                    if (value.length < 1) return { valid: false, error: 'No puede estar vac√≠o' };
                    if (value.length > 255) return { valid: false, error: 'Muy largo (m√°ximo 255 caracteres)' };
                    return { valid: true, value: value.trim() };
                default:
                    return { valid: true, value };
            }
        }

        async function addToShoppingList(item, quantity) {
            const quantityValidation = validateInput(quantity, 'number', 1);
            if (!quantityValidation.valid) {
                showNotification(quantityValidation.error, 'error');
                return;
            }
            const existingItemQuery = query(collection(db, 'shoppingList'), where('itemId', '==', item.id));
            const querySnapshot = await getDocs(existingItemQuery);

            if (!querySnapshot.empty) {
                showNotification(`${item.description} ya est√° en la lista.`, 'info');
                return;
            }
            await addDoc(collection(db, 'shoppingList'), {
                itemId: item.id, description: item.description, quantity: quantity
            });
            showNotification(`${quantity} x ${item.description} a√±adido(s).`, 'success');
        }
        async function removeFromShoppingList(docId) {
            await deleteDoc(doc(db, 'shoppingList', docId));
            showNotification('Art√≠culo eliminado de la lista.', 'success');
        }
        function updateShoppingListCount() {
            const countEl = document.getElementById('shopping-list-count');
            const count = state.shoppingList.length;
            countEl.textContent = count;
            countEl.classList.toggle('hidden', count === 0);
        }
        function generateShoppingListPDF() {
            if (state.shoppingList.length === 0) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(22);
            doc.text("Lista de Compras", 20, 20);
            doc.setFontSize(12);
            doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 20, 30);
            let y = 40;
            doc.setFontSize(10);
            state.shoppingList.forEach((item, index) => {
                if (y > 280) { doc.addPage(); y = 20; }
                const textLines = doc.splitTextToSize(`[  ] ${item.quantity} x ${item.description}`, 160);
                doc.text(textLines, 25, y);
                y += (textLines.length * 5) + 5;
            });
            doc.save("lista_de_compras.pdf");
        }

        function generateManualInventoryPDF() {
            if (state.inventory.length === 0) {
                showNotification('No hay art√≠culos en el inventario para generar el formulario.', 'info');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuraci√≥n del documento
            doc.setFontSize(20);
            doc.text("Formulario de Inventario Manual", 20, 20);
            doc.setFontSize(12);
            doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 20, 30);
            doc.text(`Generado por: ${state.currentUser?.email || 'Usuario'}`, 20, 35);
            doc.text(`Total de art√≠culos: ${state.inventory.length}`, 20, 40);
            
            // Instrucciones
            doc.setFontSize(10);
            doc.text("Instrucciones:", 20, 50);
            doc.text("‚Ä¢ Marque con ‚úì los art√≠culos que encuentre en el almac√©n", 25, 55);
            doc.text("‚Ä¢ Anote la cantidad real encontrada en la columna 'Cantidad Real'", 25, 60);
            doc.text("‚Ä¢ Compare con el stock registrado en el sistema", 25, 65);
            
            let y = 75;
            const itemsPerPage = 25;
            let currentPage = 1;
            
            // Agregar encabezados de tabla
            doc.setFontSize(8);
            doc.text("Art√≠culo", 20, y);
            doc.text("Stock Sistema", 80, y);
            doc.text("Cantidad Real", 120, y);
            doc.text("‚úì", 160, y);
            doc.text("Observaciones", 170, y);
            y += 5;
            
            // Dibujar l√≠nea separadora
            doc.line(20, y, 190, y);
            y += 8;
            
            // Agrupar inventario por categor√≠as
            const inventoryByCategory = {};
            state.inventory.forEach(item => {
                if (!inventoryByCategory[item.category]) {
                    inventoryByCategory[item.category] = [];
                }
                inventoryByCategory[item.category].push(item);
            });
            
            // Generar formulario por categor√≠as
            Object.keys(inventoryByCategory).sort().forEach(category => {
                const items = inventoryByCategory[category];
                
                // Agregar t√≠tulo de categor√≠a (verificar espacio para t√≠tulo + al menos un art√≠culo)
                if (y > 240) {
                    doc.addPage();
                    y = 20;
                    currentPage++;
                    
                    // Repetir encabezados en nueva p√°gina
                    doc.setFontSize(8);
                    doc.text("Art√≠culo", 20, y);
                    doc.text("Stock Sistema", 80, y);
                    doc.text("Cantidad Real", 120, y);
                    doc.text("‚úì", 160, y);
                    doc.text("Observaciones", 170, y);
                    y += 5;
                    doc.line(20, y, 190, y);
                    y += 8;
                }
                
                doc.setFontSize(9);
                doc.text(`CATEGOR√çA: ${category.toUpperCase()}`, 20, y);
                y += 8;
                
                items.forEach(item => {
                    // Verificar si necesitamos nueva p√°gina antes de agregar el art√≠culo
                    const itemHeight = item.description.length > 35 ? 10 : 6;
                    if (y + itemHeight > 280) {
                        doc.addPage();
                        y = 20;
                        currentPage++;
                        
                        // Repetir encabezados en nueva p√°gina
                        doc.setFontSize(8);
                        doc.text("Art√≠culo", 20, y);
                        doc.text("Stock Sistema", 80, y);
                        doc.text("Cantidad Real", 120, y);
                        doc.text("‚úì", 160, y);
                        doc.text("Observaciones", 170, y);
                        y += 5;
                        doc.line(20, y, 190, y);
                        y += 8;
                    }
                    
                    doc.setFontSize(8);
                    
                    // Nombre del art√≠culo con mejor manejo de texto largo
                    let itemName = item.description;
                    if (itemName.length > 35) {
                        // Si es muy largo, dividir en m√∫ltiples l√≠neas
                        const words = itemName.split(' ');
                        let line1 = '';
                        let line2 = '';
                        
                        for (let word of words) {
                            if ((line1 + ' ' + word).length <= 35) {
                                line1 += (line1 ? ' ' : '') + word;
                            } else if ((line2 + ' ' + word).length <= 35) {
                                line2 += (line2 ? ' ' : '') + word;
                            } else {
                                line2 += '...';
                                break;
                            }
                        }
                        
                        doc.text(line1, 20, y);
                        if (line2) {
                            doc.text(line2, 20, y + 4);
                        }
                    } else {
                        doc.text(itemName, 20, y);
                    }
                    
                    // Stock del sistema
                    doc.text(item.stock.toString(), 80, y);
                    
                    // Espacio para cantidad real (l√≠nea en blanco)
                    doc.text("_____", 120, y);
                    
                    // Checkbox
                    doc.text("‚ñ°", 160, y);
                    
                    // Espacio para observaciones
                    doc.text("_________________", 170, y);
                    
                    // Ajustar altura seg√∫n si hay texto en dos l√≠neas
                    y += itemName.length > 35 ? 10 : 6;
                });
                
                y += 5; // Espacio entre categor√≠as
            });
            
            // Agregar pie de p√°gina con informaci√≥n adicional
            if (y > 250) {
                doc.addPage();
                y = 20;
            }
            
            doc.setFontSize(10);
            doc.text("Informaci√≥n adicional:", 20, y);
            y += 8;
            doc.text("‚Ä¢ Fecha de conteo: _________________", 25, y);
            y += 5;
            doc.text("‚Ä¢ Responsable del conteo: _________________", 25, y);
            y += 5;
            doc.text("‚Ä¢ Supervisor: _________________", 25, y);
            y += 5;
            doc.text("‚Ä¢ Observaciones generales:", 25, y);
            y += 5;
            doc.text("_________________________________________________", 25, y);
            y += 5;
            doc.text("_________________________________________________", 25, y);
            
            // Guardar el PDF
            const fileName = `inventario_manual_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            showNotification('Formulario de inventario manual generado exitosamente', 'success');
        }

        function generateShoppingListExcel() {
            if (state.shoppingList.length === 0) {
                showNotification("La lista de compras est√° vac√≠a.", 'info');
                return;
            }
            
            try {
                // Preparar datos para Excel
                const excelData = [
                    ['Lista de Compras'],
                    [`Fecha: ${new Date().toLocaleDateString()}`],
                    [`Generado por: ${state.currentUser?.email || 'Usuario'}`],
                    [''], // L√≠nea vac√≠a
                    ['Cantidad', 'Descripci√≥n', 'Categor√≠a', 'Prioridad'] // Encabezados
                ];
                
                // Agregar elementos de la lista
                state.shoppingList.forEach(item => {
                    excelData.push([
                        item.quantity,
                        item.description,
                        item.category || 'Sin categor√≠a',
                        item.priority || 'Normal'
                    ]);
                });
                
                // Crear libro de trabajo
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                // Configurar ancho de columnas
                ws['!cols'] = [
                    { wch: 10 }, // Cantidad
                    { wch: 40 }, // Descripci√≥n
                    { wch: 20 }, // Categor√≠a
                    { wch: 15 }  // Prioridad
                ];
                
                // Agregar hoja al libro
                XLSX.utils.book_append_sheet(wb, ws, 'Lista de Compras');
                
                // Generar y descargar archivo
                const date = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `lista_de_compras_${date}.xlsx`);
                showNotification('Lista de compras en Excel generada exitosamente', 'success');
                
            } catch (error) {
                console.error('Error generando lista de compras Excel:', error);
                showNotification('Error al generar la lista de compras en Excel', 'error');
            }
        }

        // --- FUNCIONES DE GENERACI√ìN DE REPORTES ---
        function generatePDFReport(reportType) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuraci√≥n del documento
            doc.setFontSize(20);
            doc.text(getReportTitle(reportType), 20, 20);
            doc.setFontSize(12);
            doc.text(`Fecha de generaci√≥n: ${new Date().toLocaleDateString()}`, 20, 30);
            doc.text(`Generado por: ${state.currentUser?.email || 'Usuario'}`, 20, 35);
            
            let y = 50;
            const data = getReportData(reportType);
            
            if (data.length === 0) {
                doc.setFontSize(14);
                doc.text("No hay datos para mostrar en este reporte.", 20, y);
                doc.save(`${getReportFileName(reportType)}.pdf`);
                return;
            }
            
            // Generar tabla
            const headers = getReportHeaders(reportType);
            const tableData = data.map(row => headers.map(header => row[header.key] || ''));
            
            // Agregar encabezados
            doc.setFontSize(10);
            let x = 20;
            headers.forEach((header, index) => {
                doc.text(header.label, x, y);
                x += header.width || 40;
            });
            y += 10;
            
            // Agregar l√≠neas de datos
            tableData.forEach((row, rowIndex) => {
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
                x = 20;
                row.forEach((cell, colIndex) => {
                    const cellText = String(cell).substring(0, 20); // Limitar longitud
                    doc.text(cellText, x, y);
                    x += headers[colIndex].width || 40;
                });
                y += 8;
            });
            
            doc.save(`${getReportFileName(reportType)}.pdf`);
            showNotification(`Reporte ${getReportTitle(reportType)} generado exitosamente`, 'success');
        }

        function generateExcelReport(reportType) {
            try {
                const data = getReportData(reportType);
                const headers = getReportHeaders(reportType);
                
                if (data.length === 0) {
                    showNotification("No hay datos para mostrar en este reporte.", 'info');
                    return;
                }
                
                // Preparar datos para Excel
                const excelData = [
                    [getReportTitle(reportType)],
                    [`Fecha de generaci√≥n: ${new Date().toLocaleDateString()}`],
                    [`Generado por: ${state.currentUser?.email || 'Usuario'}`],
                    [''], // L√≠nea vac√≠a
                    headers.map(h => h.label) // Encabezados
                ];
                
                // Agregar datos
                data.forEach(row => {
                    excelData.push(headers.map(header => row[header.key] || ''));
                });
                
                // Crear libro de trabajo
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                // Configurar ancho de columnas
                const colWidths = headers.map(header => ({ wch: header.width ? header.width / 4 : 15 }));
                ws['!cols'] = colWidths;
                
                // Agregar hoja al libro
                XLSX.utils.book_append_sheet(wb, ws, 'Reporte');
                
                // Generar y descargar archivo
                XLSX.writeFile(wb, `${getReportFileName(reportType)}.xlsx`);
                showNotification(`Reporte ${getReportTitle(reportType)} en Excel generado exitosamente`, 'success');
                
            } catch (error) {
                console.error('Error generando reporte Excel:', error);
                showNotification('Error al generar el reporte Excel', 'error');
            }
        }

        function getReportTitle(reportType) {
            const titles = {
                'inventory': 'Inventario Completo',
                'loans': 'Pr√©stamos Activos',
                'salidas': 'Historial de Salidas',
                'prestamos': 'Historial de Pr√©stamos',
                'devoluciones': 'Historial de Devoluciones',
                'low-stock': 'Reporte de Stock Bajo'
            };
            return titles[reportType] || 'Reporte';
        }

        function getReportFileName(reportType) {
            const date = new Date().toISOString().split('T')[0];
            const names = {
                'inventory': `inventario_completo_${date}`,
                'loans': `prestamos_activos_${date}`,
                'salidas': `historial_salidas_${date}`,
                'prestamos': `historial_prestamos_${date}`,
                'devoluciones': `historial_devoluciones_${date}`,
                'low-stock': `stock_bajo_${date}`
            };
            return names[reportType] || `reporte_${date}`;
        }

        function getReportHeaders(reportType) {
            const headers = {
                'inventory': [
                    { key: 'description', label: 'Descripci√≥n', width: 60 },
                    { key: 'category', label: 'Categor√≠a', width: 30 },
                    { key: 'type', label: 'Tipo', width: 20 },
                    { key: 'stock', label: 'Stock', width: 15 },
                    { key: 'unit', label: 'Unidad', width: 15 },
                    { key: 'minStock', label: 'Stock M√≠nimo', width: 20 }
                ],
                'loans': [
                    { key: 'itemDescription', label: 'Art√≠culo', width: 50 },
                    { key: 'borrower', label: 'Prestatario', width: 30 },
                    { key: 'quantity', label: 'Cantidad', width: 15 },
                    { key: 'loanDate', label: 'Fecha Pr√©stamo', width: 25 },
                    { key: 'expectedReturn', label: 'Fecha Esperada', width: 25 }
                ],
                'salidas': [
                    { key: 'itemDescription', label: 'Art√≠culo', width: 50 },
                    { key: 'quantity', label: 'Cantidad', width: 15 },
                    { key: 'user', label: 'Usuario', width: 30 },
                    { key: 'date', label: 'Fecha', width: 25 },
                    { key: 'reason', label: 'Motivo', width: 40 }
                ],
                'prestamos': [
                    { key: 'itemDescription', label: 'Art√≠culo', width: 50 },
                    { key: 'borrower', label: 'Prestatario', width: 30 },
                    { key: 'quantity', label: 'Cantidad', width: 15 },
                    { key: 'loanDate', label: 'Fecha Pr√©stamo', width: 25 },
                    { key: 'returnDate', label: 'Fecha Devoluci√≥n', width: 25 }
                ],
                'devoluciones': [
                    { key: 'itemDescription', label: 'Art√≠culo', width: 50 },
                    { key: 'borrower', label: 'Prestatario', width: 30 },
                    { key: 'quantity', label: 'Cantidad', width: 15 },
                    { key: 'returnDate', label: 'Fecha Devoluci√≥n', width: 25 },
                    { key: 'condition', label: 'Condici√≥n', width: 20 }
                ],
                'low-stock': [
                    { key: 'description', label: 'Descripci√≥n', width: 60 },
                    { key: 'category', label: 'Categor√≠a', width: 30 },
                    { key: 'stock', label: 'Stock Actual', width: 20 },
                    { key: 'minStock', label: 'Stock M√≠nimo', width: 20 },
                    { key: 'unit', label: 'Unidad', width: 15 }
                ]
            };
            return headers[reportType] || [];
        }

        function getReportData(reportType) {
            switch (reportType) {
                case 'inventory':
                    return state.inventory.map(item => ({
                        ...item,
                        stock: `${item.stock} ${item.unit}`,
                        minStock: item.minStock
                    }));
                
                case 'loans':
                    return state.activeLoans.map(loan => ({
                        ...loan,
                        loanDate: new Date(loan.loanDate).toLocaleDateString(),
                        expectedReturn: loan.expectedReturn ? new Date(loan.expectedReturn).toLocaleDateString() : 'No definida'
                    }));
                
                case 'salidas':
                    return state.transactions
                        .filter(t => t.type === 'Salida')
                        .map(t => ({
                            ...t,
                            date: new Date(t.date).toLocaleDateString()
                        }));
                
                case 'prestamos':
                    return state.transactions
                        .filter(t => t.type === 'Pr√©stamo')
                        .map(t => ({
                            ...t,
                            loanDate: new Date(t.date).toLocaleDateString(),
                            returnDate: t.returnDate ? new Date(t.returnDate).toLocaleDateString() : 'Pendiente'
                        }));
                
                case 'devoluciones':
                    return state.transactions
                        .filter(t => t.type === 'Devoluci√≥n')
                        .map(t => ({
                            ...t,
                            returnDate: new Date(t.date).toLocaleDateString()
                        }));
                
                case 'low-stock':
                    return state.inventory
                        .filter(item => item.stock < item.minStock)
                        .map(item => ({
                            ...item,
                            stock: `${item.stock} ${item.unit}`,
                            minStock: item.minStock
                        }));
                
                default:
                    return [];
            }
        }

        // --- SISTEMA DE SUGERENCIAS INTELIGENTES ---
        function getItemUsageStats() {
            const usageStats = {};
            
            // Analizar transacciones de los √∫ltimos 30 d√≠as
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            state.transactions
                .filter(t => new Date(t.date) >= thirtyDaysAgo)
                .forEach(transaction => {
                    const itemId = transaction.itemId;
                    if (!usageStats[itemId]) {
                        usageStats[itemId] = {
                            itemId,
                            description: transaction.itemDescription,
                            category: transaction.category,
                            type: transaction.type,
                            totalUsage: 0,
                            recentUsage: 0,
                            lastUsed: new Date(transaction.date),
                            loanCount: 0,
                            checkoutCount: 0
                        };
                    }
                    
                    usageStats[itemId].totalUsage += transaction.quantity || 1;
                    usageStats[itemId].recentUsage += transaction.quantity || 1;
                    
                    if (transaction.type === 'Pr√©stamo') {
                        usageStats[itemId].loanCount++;
                    } else if (transaction.type === 'Salida') {
                        usageStats[itemId].checkoutCount++;
                    }
                });
            
            return Object.values(usageStats);
        }

        function getMostUsedItems(limit = 10, itemType = null) {
            const usageStats = getItemUsageStats();
            
            // Filtrar por tipo si se especifica
            let filteredStats = usageStats;
            
            // Ordenar por uso reciente y total
            return filteredStats
                .sort((a, b) => {
                    // Priorizar uso reciente (√∫ltimos 7 d√≠as)
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    
                    const aRecent = a.lastUsed >= sevenDaysAgo ? a.recentUsage : 0;
                    const bRecent = b.lastUsed >= sevenDaysAgo ? b.recentUsage : 0;
                    
                    if (aRecent !== bRecent) {
                        return bRecent - aRecent;
                    }
                    
                    // Luego por uso total
                    return b.totalUsage - a.totalUsage;
                })
                .slice(0, limit);
        }

        function getSmartSuggestions(searchTerm = '', itemType = null, limit = 8) {
            const mostUsed = getMostUsedItems(limit * 2, itemType);
            
            if (!searchTerm) {
                return mostUsed.slice(0, limit);
            }
            
            const searchLower = searchTerm.toLowerCase();
            
            // B√∫squeda fuzzy en items m√°s usados
            const filteredUsed = mostUsed
                .map(item => ({
                    ...item,
                    score: fuzzyMatch(searchLower, `${item.description} ${item.category}`)
                }))
                .filter(item => item.score > 0)
                .sort((a, b) => b.score - a.score);
            
            if (filteredUsed.length >= limit) {
                return filteredUsed.slice(0, limit);
            }
            
            // B√∫squeda fuzzy en todo el inventario usando √≠ndice
            const allMatches = Array.from(state.searchIndex.values())
                .map(indexData => ({
                    itemId: indexData.id,
                    description: indexData.description,
                    category: indexData.category,
                    score: fuzzyMatch(searchLower, indexData.searchText),
                    totalUsage: 0,
                    recentUsage: 0,
                    lastUsed: null,
                    loanCount: 0,
                    checkoutCount: 0
                }))
                .filter(item => item.score > 0)
                .sort((a, b) => b.score - a.score);
            
            // Combinar sin duplicados
            const usedIds = new Set(filteredUsed.map(i => i.itemId));
            const newMatches = allMatches.filter(i => !usedIds.has(i.itemId));
            
            return [...filteredUsed, ...newMatches].slice(0, limit);
        }
        function generateCharts() {
            if (typeof Chart === 'undefined') {
                console.error("Chart.js is not loaded.");
                const chartAreas = ['topConsumablesChart', 'topReportedChart', 'topEmployeesChart'];
                chartAreas.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.parentElement.innerHTML = '<p class="text-center themed-text-light">No se pudieron cargar los gr√°ficos.</p>';
                    }
                });
                return;
            }

            const topConsumablesChartEl = document.getElementById('topConsumablesChart');
            if (topConsumablesChartEl) {
                const consumableUsage = state.transactions.filter(t => t.type === 'Salida' || t.type === 'Intercambio').reduce((acc, t) => {
                    acc[t.itemDescription] = (acc[t.itemDescription] || 0) + t.quantity; return acc; }, {});
                const topConsumables = Object.entries(consumableUsage).sort(([,a],[,b]) => b-a).slice(0, 10);
                new Chart(topConsumablesChartEl, {
                    type: 'bar', data: { labels: topConsumables.map(item => item[0]), datasets: [{ label: 'Cantidad', data: topConsumables.map(item => item[1]), backgroundColor: 'rgba(79, 70, 229, 0.8)' }] },
                    options: { indexAxis: 'y', responsive: true }
                });
            }
            
            const topReportedChartEl = document.getElementById('topReportedChart');
            if (topReportedChartEl) {
                const reportedItems = state.transactions.filter(t => t.type === 'Baja').reduce((acc, t) => {
                    acc[t.itemDescription] = (acc[t.itemDescription] || 0) + t.quantity; return acc; }, {});
                const topReported = Object.entries(reportedItems).sort(([,a],[,b]) => b-a).slice(0, 10);
                new Chart(topReportedChartEl, {
                    type: 'doughnut', data: { labels: topReported.map(item => item[0]), datasets: [{ data: topReported.map(item => item[1]), backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef'] }] },
                    options: { responsive: true }
                });
            }

            const topEmployeesChartEl = document.getElementById('topEmployeesChart');
            if (topEmployeesChartEl) {
                const employeeLoans = state.transactions.filter(t => t.type === 'Pr√©stamo').reduce((acc, t) => {
                    if(t.borrower) acc[t.borrower] = (acc[t.borrower] || 0) + 1; return acc; }, {});
                const topEmployees = Object.entries(employeeLoans).sort(([,a],[,b]) => b-a).slice(0, 10);
                new Chart(topEmployeesChartEl, {
                    type: 'bar', data: { labels: topEmployees.map(item => item[0]), datasets: [{ label: 'N¬∫ de Pr√©stamos', data: topEmployees.map(item => item[1]), backgroundColor: 'rgba(20, 184, 166, 0.8)' }] },
                    options: { responsive: true }
                });
            }
        }
        function exportToCSV(type, headers, data) {
            const filename = `${type}_${new Date().toISOString().slice(0,10)}.csv`;
            let csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...data.map(row => row.map(cell => `"${String(cell ?? '').replace(/"/g, '""')}"`).join(','))].join('\n');
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            link.remove();
        }
        
        function getFullInventoryList() {
            return [
                { description: 'Tornillo Allen 1/4"', category: 'Torniller√≠a', stock: 500, unit: 'pza', minStock: 100 },
                { description: 'Endmill Plano 1/2"', category: 'Herramientas de Corte', stock: 15, unit: 'pza', minStock: 5 },
                { description: 'Calibrador Vernier Digital', category: 'Herramientas de Medici√≥n', stock: 5, unit: 'pza', minStock: 0 },
                { description: 'Guantes de Nitrilo', category: 'Seguridad', stock: 2, unit: 'caja', minStock: 1 },
                { description: 'WD-40 Lata Grande', category: 'Qu√≠micos', stock: 10, unit: 'lata', minStock: 3 },
                { description: 'Taladro Inal√°mbrico Dewalt', category: 'Herramienta El√©ctrica', stock: 3, unit: 'pza', minStock: 0 },
            ];
        }

        // Agregar link de IA en la navegaci√≥n (llamar esto en initApp o despu√©s de cargar la app)
        function addAINavigation() {
            console.log('üîç Adding AI navigation...', { 
                userRole: state.userRole, 
                navExists: !!document.getElementById('main-nav'),
                settingsLinkExists: !!document.getElementById('settings-nav-link'),
                aiLinkExists: !!document.getElementById('ai-nav-link')
            });
            
            const navLinks = document.getElementById('main-nav');
            const isAdmin = state.userRole === 'admin';
            
            if (navLinks && !document.getElementById('ai-nav-link') && isAdmin) {
                const aiNavHTML = `
                    <a href="#ai-insights" id="ai-nav-link" class="nav-link flex items-center space-x-3 py-2 px-4 rounded-xl transition-all duration-200 group">
                        <div class="h-8 w-8 rounded-lg bg-white/10 flex items-center justify-center group-hover:bg-white/20 transition-colors">
                            <i data-lucide="brain" class="h-4 w-4"></i>
                        </div>
                        <span class="font-medium">IA Insights</span>
                    </a>
                `;
                
                // Insertar antes del link de configuraci√≥n
                const settingsLink = document.getElementById('settings-nav-link');
                if (settingsLink) {
                    settingsLink.insertAdjacentHTML('beforebegin', aiNavHTML);
                    safeCreateIcons();
                    console.log('‚úÖ AI navigation link added successfully');
                } else {
                    console.warn('‚ö†Ô∏è Settings link not found, trying alternative insertion');
                    // Fallback: insert at the end of nav
                    navLinks.insertAdjacentHTML('beforeend', aiNavHTML);
                    safeCreateIcons();
                }
            } else {
                console.log('‚ùå AI navigation not added:', { 
                    navExists: !!navLinks, 
                    aiLinkExists: !!document.getElementById('ai-nav-link'), 
                    isAdmin 
                });
            }
        }

        // Modificar navigateTo para incluir la nueva vista de IA
        const originalNavigateTo = navigateTo;
        navigateTo = function(page, isRefresh = false) {
            if (page === 'ai-insights') {
                if (state.userRole === 'admin') {
                    const pageTitle = document.getElementById('page-title');
                    if (!isRefresh) pageTitle.textContent = 'IA Insights';
                    renderAIInsightsView();
                    return;
                } else {
                    // Si no es admin, redirigir al dashboard
                    window.location.hash = 'dashboard';
                    return;
                }
            }
            return originalNavigateTo(page, isRefresh);
        };

        // --- AI ANALYZER CLASS ---
        
        class InventoryAIAnalyzer {
            constructor() {
                this.patterns = [];
                this.anomalies = [];
                this.predictions = [];
            }

            // Analizar patrones de uso de art√≠culos
            async analyzeUsagePatterns() {
                const transactions = (state.transactions || []).filter(t => t.description && t.description.trim() !== '');
                const items = (state.items || []).filter(i => i.description && i.description.trim() !== '');
                
                const usagePatterns = {};
                
                // Agrupar transacciones por art√≠culo
                transactions.forEach(trans => {
                    if (!usagePatterns[trans.description]) {
                        usagePatterns[trans.description] = {
                            entries: [],
                            exits: [],
                            adjustments: [],
                            users: new Set(),
                            timestamps: []
                        };
                    }
                    
                    const pattern = usagePatterns[trans.description];
                    pattern.timestamps.push(new Date(trans.timestamp));
                    pattern.users.add(trans.userName || 'Desconocido');
                    
                    if (trans.type === 'Entrada') pattern.entries.push(trans.quantity);
                    else if (trans.type === 'Salida') pattern.exits.push(trans.quantity);
                    else if (trans.type === 'Ajuste') pattern.adjustments.push(trans.quantity);
                });
                
                // Analizar patrones
                const analyzedPatterns = Object.entries(usagePatterns).map(([item, data]) => {
                    const avgEntry = data.entries.length > 0 
                        ? data.entries.reduce((a, b) => a + b, 0) / data.entries.length 
                        : 0;
                    const avgExit = data.exits.length > 0 
                        ? data.exits.reduce((a, b) => a + b, 0) / data.exits.length 
                        : 0;
                    
                    // Calcular frecuencia de uso (transacciones por d√≠a)
                    const dayRange = this.getDayRange(data.timestamps);
                    const frequency = data.timestamps.length / (dayRange || 1);
                    
                    // Detectar patr√≥n estacional
                    const seasonal = this.detectSeasonality(data.timestamps);
                    
                    return {
                        item,
                        avgEntry,
                        avgExit,
                        frequency,
                        totalTransactions: data.timestamps.length,
                        uniqueUsers: data.users.size,
                        seasonal,
                        trend: avgExit > avgEntry ? 'Descendente' : 'Ascendente'
                    };
                });
                
                this.patterns = analyzedPatterns;
                return analyzedPatterns;
            }

            // Detectar anomal√≠as en el inventario
            async detectAnomalies() {
                const transactions = (state.transactions || []).filter(t => t.description && t.description.trim() !== '');
                const items = (state.items || []).filter(i => i.description && i.description.trim() !== '');
                const anomalies = [];
                
                // 1. Transacciones de cantidad inusual
                transactions.forEach(trans => {
                    const itemTransactions = transactions.filter(t => t.description === trans.description);
                    const quantities = itemTransactions.map(t => t.quantity);
                    const avg = quantities.reduce((a, b) => a + b, 0) / quantities.length;
                    const stdDev = Math.sqrt(quantities.reduce((sq, n) => sq + Math.pow(n - avg, 2), 0) / quantities.length);
                    
                    // Si la cantidad est√° 2 desviaciones est√°ndar por encima de la media
                    if (trans.quantity > avg + (2 * stdDev)) {
                        anomalies.push({
                            type: 'Cantidad Inusual',
                            severity: 'Media',
                            description: `${trans.description}: Cantidad de ${trans.quantity} es ${((trans.quantity / avg - 1) * 100).toFixed(0)}% mayor que el promedio`,
                            timestamp: trans.timestamp,
                            item: trans.description
                        });
                    }
                });
                
                // 2. Stock bajo repentino
                items.forEach(item => {
                    if (item.stock < item.minStock) {
                        const recentTransactions = transactions
                            .filter(t => t.description === item.description)
                            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                            .slice(0, 5);
                        
                        const recentExits = recentTransactions.filter(t => t.type === 'Salida').length;
                        
                        if (recentExits >= 3) {
                            anomalies.push({
                                type: 'Stock Bajo Repentino',
                                severity: 'Alta',
                                description: `${item.description}: Stock bajo (${item.stock}) con ${recentExits} salidas recientes`,
                                timestamp: new Date().toISOString(),
                                item: item.description
                            });
                        }
                    }
                });
                
                // 3. Actividad fuera de horario normal
                const normalHours = { start: 7, end: 18 };
                transactions.forEach(trans => {
                    const hour = new Date(trans.timestamp).getHours();
                    if (hour < normalHours.start || hour > normalHours.end) {
                        anomalies.push({
                            type: 'Actividad Fuera de Horario',
                            severity: 'Baja',
                            description: `${trans.description}: Transacci√≥n a las ${hour}:00 (fuera de horario 7:00-18:00)`,
                            timestamp: trans.timestamp,
                            item: trans.description
                        });
                    }
                });
                
                // 4. M√∫ltiples ajustes consecutivos
                const adjustments = transactions.filter(t => t.type === 'Ajuste');
                adjustments.forEach((adj, idx) => {
                    if (idx > 0 && adjustments[idx - 1].description === adj.description) {
                        const timeDiff = new Date(adj.timestamp) - new Date(adjustments[idx - 1].timestamp);
                        const hoursDiff = timeDiff / (1000 * 60 * 60);
                        
                        if (hoursDiff < 24) {
                            anomalies.push({
                                type: 'Ajustes Consecutivos',
                                severity: 'Media',
                                description: `${adj.description}: M√∫ltiples ajustes en menos de 24 horas`,
                                timestamp: adj.timestamp,
                                item: adj.description
                            });
                        }
                    }
                });
                
                this.anomalies = anomalies;
                return anomalies;
            }

            // Predecir demanda futura
            async predictDemand(daysAhead = 30) {
                const transactions = (state.transactions || []).filter(t => t.description && t.description.trim() !== '');
                const items = (state.items || []).filter(i => i.description && i.description.trim() !== '');
                const predictions = [];
                
                items.forEach(item => {
                    const itemTransactions = transactions
                        .filter(t => t.description === item.description && t.type === 'Salida')
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    if (itemTransactions.length < 2) {
                        predictions.push({
                            item: item.description,
                            predicted: 'Insuficientes datos',
                            confidence: 0
                        });
                        return;
                    }
                    
                    // Calcular tasa de uso diaria
                    const firstDate = new Date(itemTransactions[0].timestamp);
                    const lastDate = new Date(itemTransactions[itemTransactions.length - 1].timestamp);
                    const daysDiff = (lastDate - firstDate) / (1000 * 60 * 60 * 24) || 1;
                    const totalUsed = itemTransactions.reduce((sum, t) => sum + t.quantity, 0);
                    const dailyRate = totalUsed / daysDiff;
                    
                    // Predecir stock futuro
                    const predictedUsage = dailyRate * daysAhead;
                    const predictedStock = item.stock - predictedUsage;
                    
                    // Calcular cu√°ndo se agotar√°
                    const daysUntilEmpty = item.stock / dailyRate;
                    const emptyDate = new Date();
                    emptyDate.setDate(emptyDate.getDate() + daysUntilEmpty);
                    
                    // Calcular confianza basada en consistencia de datos
                    const consistency = this.calculateConsistency(itemTransactions);
                    
                    predictions.push({
                        item: item.description,
                        currentStock: item.stock,
                        dailyUsageRate: Math.round(dailyRate * 100) / 100,
                        predictedStockIn30Days: Math.round(predictedStock),
                        daysUntilEmpty: Math.round(daysUntilEmpty),
                        emptyDate: emptyDate.toLocaleDateString('es-MX'),
                        needsRestock: predictedStock < item.minStock,
                        suggestedOrderQuantity: predictedStock < item.minStock 
                            ? Math.ceil((item.minStock * 2) - predictedStock) 
                            : 0,
                        confidence: consistency,
                        trend: dailyRate > 0 ? 'Consumo constante' : 'Sin movimiento'
                    });
                });
                
                this.predictions = predictions;
                return predictions;
            }

            // Optimizar niveles de stock
            async optimizeStockLevels() {
                const patterns = this.patterns.length > 0 ? this.patterns : await this.analyzeUsagePatterns();
                const predictions = this.predictions.length > 0 ? this.predictions : await this.predictDemand();
                const items = (state.items || []).filter(i => i.description && i.description.trim() !== '');
                
                const optimizations = items.map(item => {
                    const pattern = patterns.find(p => p.item === item.description);
                    const prediction = predictions.find(p => p.item === item.description);
                    
                    if (!pattern || !prediction) {
                        return {
                            item: item.description,
                            currentMinStock: item.minStock,
                            suggestedMinStock: item.minStock,
                            reason: 'Insuficientes datos para optimizaci√≥n'
                        };
                    }
                    
                    // Calcular nuevo nivel m√≠nimo basado en:
                    // 1. Tasa de uso diaria
                    // 2. Frecuencia de transacciones
                    // 3. Tiempo de reabastecimiento estimado (asumiendo 7 d√≠as)
                    const leadTime = 7; // d√≠as
                    const safetyStock = Math.ceil(prediction.dailyUsageRate * 3); // 3 d√≠as de seguridad
                    const suggestedMin = Math.ceil((prediction.dailyUsageRate * leadTime) + safetyStock);
                    
                    let reason = '';
                    if (suggestedMin > item.minStock) {
                        reason = `Incrementar para cubrir ${leadTime} d√≠as de reabastecimiento + ${3} d√≠as de seguridad`;
                    } else if (suggestedMin < item.minStock) {
                        reason = `Reducir por baja frecuencia de uso (${pattern.frequency.toFixed(2)} trans/d√≠a)`;
                    } else {
                        reason = 'Nivel actual es √≥ptimo';
                    }
                    
                    return {
                        item: item.description,
                        currentMinStock: item.minStock,
                        suggestedMinStock: suggestedMin,
                        difference: suggestedMin - item.minStock,
                        reason,
                        impact: suggestedMin > item.minStock ? 'Mejorar√≠a disponibilidad' : 'Reducir√≠a costos de almacenamiento'
                    };
                });
                
                return optimizations;
            }

            // M√©todos auxiliares
            getDayRange(timestamps) {
                if (timestamps.length === 0) return 0;
                const sorted = timestamps.sort((a, b) => a - b);
                const daysDiff = (sorted[sorted.length - 1] - sorted[0]) / (1000 * 60 * 60 * 24);
                return daysDiff || 1;
            }

            detectSeasonality(timestamps) {
                if (timestamps.length < 10) return false;
                
                // Agrupar por d√≠a de la semana
                const byDayOfWeek = {};
                timestamps.forEach(ts => {
                    const day = ts.getDay();
                    byDayOfWeek[day] = (byDayOfWeek[day] || 0) + 1;
                });
                
                const values = Object.values(byDayOfWeek);
                const avg = values.reduce((a, b) => a + b, 0) / values.length;
                const variance = values.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / values.length;
                
                // Si hay alta varianza, hay estacionalidad
                return variance > avg;
            }

            calculateConsistency(transactions) {
                if (transactions.length < 3) return 0.3;
                
                const quantities = transactions.map(t => t.quantity);
                const avg = quantities.reduce((a, b) => a + b, 0) / quantities.length;
                const variance = quantities.reduce((sum, q) => sum + Math.pow(q - avg, 2), 0) / quantities.length;
                const coefficientOfVariation = Math.sqrt(variance) / avg;
                
                // Convertir a confianza (menor variaci√≥n = mayor confianza)
                const confidence = Math.max(0, Math.min(1, 1 - coefficientOfVariation));
                return Math.round(confidence * 100) / 100;
            }
        }

        // --- AI UI FUNCTIONS ---
        
        // Instancia global del analizador de IA
        const aiAnalyzer = new InventoryAIAnalyzer();

        async function renderAIInsightsView() {
            const mainContent = document.getElementById('main-content');
            
            mainContent.innerHTML = `
                <div class="max-w-7xl mx-auto space-y-6">
                    <!-- Header -->
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-3xl font-bold themed-text flex items-center">
                                <i data-lucide="brain" class="w-8 h-8 mr-3 text-indigo-600"></i>
                                Insights Inteligentes
                            </h1>
                            <p class="text-lg themed-text-light mt-1">An√°lisis impulsado por inteligencia artificial</p>
                        </div>
                        <button id="refresh-ai-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg flex items-center space-x-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            <span>Actualizar An√°lisis</span>
                        </button>
                    </div>

                    <!-- Loading State -->
                    <div id="ai-loading" class="flex items-center justify-center py-12">
                        <div class="text-center">
                            <i data-lucide="loader" class="w-12 h-12 animate-spin text-indigo-600 mx-auto mb-4"></i>
                            <p class="text-lg themed-text-light">Analizando datos con IA...</p>
                        </div>
                    </div>

                    <!-- AI Content -->
                    <div id="ai-content" class="hidden space-y-6">
                        <!-- Tabs -->
                        <div class="themed-card rounded-xl shadow-lg">
                            <div class="border-b border-opacity-10 px-6 py-4">
                                <nav class="flex space-x-8 overflow-x-auto" aria-label="AI Tabs">
                                    <a href="#" class="ai-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600 transition-colors duration-200" data-tab="anomalies">
                                        <i data-lucide="alert-triangle" class="w-4 h-4 inline mr-2"></i>Anomal√≠as
                                    </a>
                                    <a href="#" class="ai-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent themed-text-light hover:text-indigo-500 transition-colors duration-200" data-tab="patterns">
                                        <i data-lucide="activity" class="w-4 h-4 inline mr-2"></i>Patrones
                                    </a>
                                    <a href="#" class="ai-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent themed-text-light hover:text-indigo-500 transition-colors duration-200" data-tab="predictions">
                                        <i data-lucide="trending-up" class="w-4 h-4 inline mr-2"></i>Predicciones
                                    </a>
                                    <a href="#" class="ai-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent themed-text-light hover:text-indigo-500 transition-colors duration-200" data-tab="optimization">
                                        <i data-lucide="zap" class="w-4 h-4 inline mr-2"></i>Optimizaci√≥n
                                    </a>
                                </nav>
                            </div>
                            <div id="ai-tab-content" class="p-8 min-h-[400px]"></div>
                        </div>
                    </div>
                </div>
            `;
            
            safeCreateIcons();
            await loadAIInsights();
            
            // Event listeners para tabs
            document.querySelectorAll('.ai-tab-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tab = e.currentTarget.dataset.tab;
                    renderAITab(tab);
                    
                    // Update active tab
                    document.querySelectorAll('.ai-tab-link').forEach(l => {
                        l.classList.remove('border-indigo-500', 'text-indigo-600');
                        l.classList.add('border-transparent', 'themed-text-light');
                    });
                    e.currentTarget.classList.remove('border-transparent', 'themed-text-light');
                    e.currentTarget.classList.add('border-indigo-500', 'text-indigo-600');
                });
            });
            
            // Refresh button
            document.getElementById('refresh-ai-btn').addEventListener('click', async () => {
                document.getElementById('ai-content').classList.add('hidden');
                document.getElementById('ai-loading').classList.remove('hidden');
                await loadAIInsights();
            });
        }

        async function loadAIInsights() {
            try {
                // Show loading state
                const loadingElement = document.getElementById('ai-loading');
                const contentElement = document.getElementById('ai-content');
                
                if (loadingElement && contentElement) {
                    loadingElement.classList.remove('hidden');
                    contentElement.classList.add('hidden');
                }
                
                // Ejecutar an√°lisis en paralelo
                await Promise.all([
                    aiAnalyzer.detectAnomalies(),
                    aiAnalyzer.analyzeUsagePatterns(),
                    aiAnalyzer.predictDemand(),
                    aiAnalyzer.optimizeStockLevels()
                ]);
                
                // Show content with smooth transition
                if (loadingElement && contentElement) {
                    loadingElement.classList.add('hidden');
                    contentElement.classList.remove('hidden');
                    
                    // Ensure content is visible and properly positioned
                    setTimeout(() => {
                        contentElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
                
                renderAITab('anomalies');
            } catch (error) {
                console.error('Error loading AI insights:', error);
                showNotification('Error al cargar los insights de IA', 'error');
                
                // Show content even if there's an error
                const loadingElement = document.getElementById('ai-loading');
                const contentElement = document.getElementById('ai-content');
                if (loadingElement && contentElement) {
                    loadingElement.classList.add('hidden');
                    contentElement.classList.remove('hidden');
                }
            }
        }

        function renderAITab(tab) {
            const content = document.getElementById('ai-tab-content');
            
            switch (tab) {
                case 'anomalies':
                    renderAnomaliesTab(content);
                    break;
                case 'patterns':
                    renderPatternsTab(content);
                    break;
                case 'predictions':
                    renderPredictionsTab(content);
                    break;
                case 'optimization':
                    renderOptimizationTab(content);
                    break;
            }
            
            safeCreateIcons();
        }

        function renderAnomaliesTab(content) {
            const anomalies = aiAnalyzer.anomalies;
            
            if (anomalies.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="check-circle" class="w-16 h-16 text-green-500 mx-auto mb-4"></i>
                        <h3 class="text-xl font-semibold themed-text">¬°No se detectaron anomal√≠as!</h3>
                        <p class="themed-text-light mt-2">El sistema est√° funcionando normalmente</p>
                    </div>
                `;
                safeCreateIcons();
                return;
            }
            
            const severityColors = {
                'Alta': 'red',
                'Media': 'yellow',
                'Baja': 'blue'
            };
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i data-lucide="alert-circle" class="w-8 h-8 text-red-600 mr-3"></i>
                                <div>
                                    <p class="text-2xl font-bold text-red-600">${anomalies.filter(a => a.severity === 'Alta').length}</p>
                                    <p class="text-sm text-red-700 dark:text-red-300">Alta Prioridad</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i data-lucide="alert-triangle" class="w-8 h-8 text-yellow-600 mr-3"></i>
                                <div>
                                    <p class="text-2xl font-bold text-yellow-600">${anomalies.filter(a => a.severity === 'Media').length}</p>
                                    <p class="text-sm text-yellow-700 dark:text-yellow-300">Media Prioridad</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i data-lucide="info" class="w-8 h-8 text-blue-600 mr-3"></i>
                                <div>
                                    <p class="text-2xl font-bold text-blue-600">${anomalies.filter(a => a.severity === 'Baja').length}</p>
                                    <p class="text-sm text-blue-700 dark:text-blue-300">Baja Prioridad</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${anomalies.map(anomaly => `
                        <div class="themed-card p-4 rounded-lg border-l-4 border-${severityColors[anomaly.severity]}-500">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <span class="px-2 py-1 rounded text-xs font-semibold bg-${severityColors[anomaly.severity]}-100 text-${severityColors[anomaly.severity]}-800 mr-2">
                                            ${anomaly.severity}
                                        </span>
                                        <h4 class="font-semibold themed-text">${anomaly.type}</h4>
                                    </div>
                                    <p class="themed-text-light mt-2">${anomaly.description || 'Descripci√≥n no disponible'}</p>
                                    <div class="flex items-center mt-2 text-sm themed-text-light">
                                        <i data-lucide="clock" class="w-4 h-4 mr-1"></i>
                                        ${new Date(anomaly.timestamp).toLocaleString('es-MX')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            safeCreateIcons();
        }

        function renderPatternsTab(content) {
            const patterns = aiAnalyzer.patterns;
            
            if (patterns.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="bar-chart" class="w-16 h-16 themed-text-light mx-auto mb-4"></i>
                        <p class="themed-text-light">No hay suficientes datos para analizar patrones</p>
                    </div>
                `;
                safeCreateIcons();
                return;
            }
            
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-[800px]">
                            <thead>
                                <tr class="border-b border-gray-200 dark:border-gray-700">
                                    <th class="px-4 py-3 text-left text-sm font-semibold themed-text whitespace-nowrap">Art√≠culo</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold themed-text whitespace-nowrap">Frecuencia</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold themed-text whitespace-nowrap">Promedio Entrada</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold themed-text whitespace-nowrap">Promedio Salida</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold themed-text whitespace-nowrap">Usuarios</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold themed-text whitespace-nowrap">Tendencia</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${patterns.slice(0, 20).map(pattern => `
                                    <tr class="border-b border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-150">
                                        <td class="px-4 py-3 themed-text font-medium">${pattern.item || 'Art√≠culo no disponible'}</td>
                                        <td class="px-4 py-3 themed-text-light">${pattern.frequency.toFixed(2)} trans/d√≠a</td>
                                        <td class="px-4 py-3 themed-text-light">${pattern.avgEntry.toFixed(1)}</td>
                                        <td class="px-4 py-3 themed-text-light">${pattern.avgExit.toFixed(1)}</td>
                                        <td class="px-4 py-3 themed-text-light">${pattern.uniqueUsers}</td>
                                        <td class="px-4 py-3">
                                            <span class="px-2 py-1 rounded text-xs font-semibold ${pattern.trend === 'Ascendente' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}">
                                                ${pattern.trend}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderPredictionsTab(content) {
            const predictions = aiAnalyzer.predictions;
            
            if (predictions.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="trending-up" class="w-16 h-16 themed-text-light mx-auto mb-4"></i>
                        <p class="themed-text-light">No hay suficientes datos para hacer predicciones</p>
                    </div>
                `;
                safeCreateIcons();
                return;
            }
            
            const needsRestock = predictions.filter(p => p.needsRestock);
            
            content.innerHTML = `
                <div class="space-y-6">
                    ${needsRestock.length > 0 ? `
                        <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-4">
                            <div class="flex items-center">
                                <i data-lucide="alert-triangle" class="w-6 h-6 text-amber-600 mr-3"></i>
                                <div>
                                    <h3 class="font-semibold text-amber-900 dark:text-amber-100">Acci√≥n Requerida</h3>
                                    <p class="text-sm text-amber-700 dark:text-amber-300">${needsRestock.length} art√≠culo(s) necesitar√°n reabastecimiento en los pr√≥ximos 30 d√≠as</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${predictions.filter(p => typeof p.predicted !== 'string').slice(0, 10).map(pred => `
                            <div class="themed-card p-4 rounded-lg ${pred.needsRestock ? 'border-l-4 border-amber-500' : ''} transition-all duration-200 hover:shadow-md">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1 min-w-0">
                                        <h4 class="font-semibold themed-text truncate">${pred.item || 'Art√≠culo no disponible'}</h4>
                                        <div class="mt-3 space-y-2 text-sm">
                                            <div class="flex justify-between items-center">
                                                <span class="themed-text-light">Stock actual:</span>
                                                <span class="themed-text font-medium">${pred.currentStock}</span>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="themed-text-light">Uso diario:</span>
                                                <span class="themed-text font-medium">${pred.dailyUsageRate}</span>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="themed-text-light">Stock en 30 d√≠as:</span>
                                                <span class="themed-text font-medium ${pred.predictedStockIn30Days < 0 ? 'text-red-600 dark:text-red-400' : ''}">${pred.predictedStockIn30Days}</span>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="themed-text-light">Se agota en:</span>
                                                <span class="themed-text font-medium">${pred.daysUntilEmpty} d√≠as</span>
                                            </div>
                                            ${pred.needsRestock ? `
                                                <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                                                    <div class="flex items-center justify-between">
                                                        <span class="text-amber-700 dark:text-amber-300 font-medium">Ordenar:</span>
                                                        <span class="text-amber-900 dark:text-amber-100 font-bold">${pred.suggestedOrderQuantity} unidades</span>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div class="mt-3">
                                            <div class="flex items-center text-xs text-gray-500 dark:text-gray-400">
                                                <i data-lucide="target" class="w-3 h-3 mr-1"></i>
                                                Confianza: ${(pred.confidence * 100).toFixed(0)}%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            safeCreateIcons();
        }

        async function renderOptimizationTab(content) {
            const optimizations = await aiAnalyzer.optimizeStockLevels();
            
            if (optimizations.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="zap" class="w-16 h-16 themed-text-light mx-auto mb-4"></i>
                        <p class="themed-text-light">No hay datos suficientes para optimizaci√≥n</p>
                    </div>
                `;
                safeCreateIcons();
                return;
            }
            
            const needsAdjustment = optimizations.filter(o => o.difference !== 0);
            
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800 rounded-lg p-4">
                        <div class="flex items-center">
                            <i data-lucide="lightbulb" class="w-6 h-6 text-indigo-600 mr-3"></i>
                            <div>
                                <h3 class="font-semibold text-indigo-900 dark:text-indigo-100">Sugerencias de Optimizaci√≥n</h3>
                                <p class="text-sm text-indigo-700 dark:text-indigo-300">${needsAdjustment.length} art√≠culo(s) podr√≠an optimizarse</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        ${optimizations.slice(0, 15).map(opt => `
                            <div class="themed-card p-4 rounded-lg ${opt.difference !== 0 ? 'border-l-4 border-indigo-500' : ''} transition-all duration-200 hover:shadow-md">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1 min-w-0">
                                        <h4 class="font-semibold themed-text truncate">${opt.item || 'Art√≠culo no disponible'}</h4>
                                        <p class="text-sm themed-text-light mt-1 break-words">${opt.reason}</p>
                                        ${opt.difference !== 0 ? `
                                            <div class="mt-3 flex flex-wrap items-center gap-2 text-sm">
                                                <div class="flex items-center space-x-1">
                                                    <span class="themed-text-light">Actual:</span>
                                                    <span class="themed-text font-medium">${opt.currentMinStock}</span>
                                                </div>
                                                <i data-lucide="arrow-right" class="w-4 h-4 themed-text-light"></i>
                                                <div class="flex items-center space-x-1">
                                                    <span class="themed-text-light">Sugerido:</span>
                                                    <span class="themed-text font-bold">${opt.suggestedMinStock}</span>
                                                </div>
                                                <span class="px-2 py-1 rounded text-xs font-semibold ${opt.difference > 0 ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'}">
                                                    ${opt.difference > 0 ? '+' : ''}${opt.difference}
                                                </span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            safeCreateIcons();
        }

        // Function to update dark mode toggle button appearance
        function updateDarkModeToggle() {
            const toggleButton = document.getElementById('dark-mode-toggle');
            if (!toggleButton) {
                console.warn('Dark mode toggle button not found');
                return;
            }
            
            // Try multiple selectors to find the icon
            let icon = toggleButton.querySelector('i[data-lucide]');
            if (!icon) {
                icon = toggleButton.querySelector('i');
            }
            if (!icon) {
                icon = toggleButton.querySelector('svg');
            }
            
            const text = toggleButton.querySelector('span');
            
            if (!icon || !text) {
                console.warn('Dark mode toggle icon or text not found', { 
                    icon: !!icon, 
                    text: !!text,
                    toggleButtonHTML: toggleButton.outerHTML.substring(0, 200)
                });
                return;
            }
            
            if (document.documentElement.classList.contains('dark')) {
                // Currently in dark mode, show sun icon for switching to light
                if (icon.hasAttribute('data-lucide')) {
                    icon.setAttribute('data-lucide', 'sun');
                }
                text.textContent = 'Modo Claro';
            } else {
                // Currently in light mode, show moon icon for switching to dark
                if (icon.hasAttribute('data-lucide')) {
                    icon.setAttribute('data-lucide', 'moon');
                }
                text.textContent = 'Modo Oscuro';
            }
            
            // Re-initialize Lucide icons to update the display
            safeCreateIcons();
        }

    </script>
</body>
</html>

