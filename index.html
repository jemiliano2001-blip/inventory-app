<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema de gestión de inventario central para uso empresarial">
    <title>Gestión Central de Inventario</title>
    
    <!-- Tailwind CSS: Always try local compiled CSS first, CDN only as fallback on localhost -->
    <!-- In production (Vercel), the build process compiles CSS to ./dist/output.css -->
    <link rel="stylesheet" href="./dist/output.css" id="tailwind-css">
    <script>
        // Only use CDN as fallback if:
        // 1. We're on localhost (development)
        // 2. AND the local CSS file failed to load or is empty
        (function() {
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1' ||
                               window.location.hostname === '' ||
                               window.location.hostname.startsWith('192.168.');
            
            // Check if CSS loaded successfully after a short delay
            setTimeout(function() {
                const cssLink = document.getElementById('tailwind-css');
                const stylesheets = Array.from(document.styleSheets);
                const tailwindLoaded = stylesheets.some(sheet => {
                    try {
                        const hasOutputCss = sheet.href && sheet.href.includes('output.css');
                        const hasRules = sheet.cssRules && sheet.cssRules.length > 0;
                        return hasOutputCss && hasRules;
                    } catch(e) {
                        return false;
                    }
                });
                
                // Only use CDN fallback on localhost if CSS didn't load properly
                if (isLocalhost && !tailwindLoaded) {
                    console.warn('Local Tailwind CSS not found, using CDN for localhost development only');
                    const script = document.createElement('script');
                    script.src = 'https://cdn.tailwindcss.com';
                    document.head.appendChild(script);
                }
            }, 100);
        })();
    </script>
    
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js for Dashboard (without source maps to avoid 404 errors) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <!-- jsPDF for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- jsPDF-AutoTable for Professional PDF Tables -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
    
    <!-- SheetJS for Excel Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- PWA Manifest (Ensure you have a manifest.json file) -->
    <!-- <link rel="manifest" href="manifest.json"> -->
    <meta name="theme-color" content="#1e40af">

    <style>
        /* CSS Variables for Minimalist Monochrome Theme - Enhanced */
        :root {
            --color-primary-accent: #000000;
            --color-bg-page: #FAFAFA;
            --color-bg-content: #FFFFFF;
            --card-bg: #FFFFFF;
            --color-text-primary: #000000;
            --color-text-secondary: #666666;
            --color-status-danger: #333333;
            --border-color: #E5E5E5;
            --primary-color: #000000;
            --primary-hover: #333333;
            --sidebar-hover-bg: #F5F5F5;
            --sidebar-active-bg: #000000;
            --input-border: #E5E5E5;
            --header-bg: #FFFFFF;
            --input-bg: #FFFFFF;
            --text-color: #000000;
            --text-color-light: #666666;
            --bg-color: #FAFAFA;
            
            /* Enhanced Shadow System */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            
            /* Enhanced Border Radius System */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;
            
            /* Enhanced Spacing System */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* Enhanced Transition System */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slower: 500ms cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Enhanced Elevation System */
            --elevation-1: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            --elevation-2: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
            --elevation-3: 0 10px 20px rgba(0, 0, 0, 0.19), 0 6px 6px rgba(0, 0, 0, 0.23);
            --elevation-4: 0 15px 25px rgba(0, 0, 0, 0.2), 0 10px 10px rgba(0, 0, 0, 0.22);
            --elevation-5: 0 20px 40px rgba(0, 0, 0, 0.25), 0 15px 12px rgba(0, 0, 0, 0.22);
        }

        /* Button Sizes */
        .button-size-normal {
            --button-padding: 0.875rem 1.5rem;
            --button-font-size: 0.875rem;
            --button-height: 2.75rem;
        }

        .button-size-large {
            --button-padding: 1rem 1.5rem;
            --button-font-size: 1rem;
            --button-height: 3rem;
        }

        .button-size-extra-large {
            --button-padding: 1.25rem 2rem;
            --button-font-size: 1.125rem;
            --button-height: 3.5rem;
        }

        /* Apply button sizes to all buttons */
        .btn, button, .themed-button {
            padding: var(--button-padding);
            font-size: var(--button-font-size);
            height: var(--button-height);
            min-height: 44px; /* Touch-friendly */
        }

        /* Enhanced Minimalist button styles */
        .btn-primary, .btn-modern {
            background: var(--primary-color);
            border: 1px solid var(--primary-color);
            color: white;
            font-weight: 500;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .btn-primary:hover, .btn-modern:hover {
            background: var(--primary-hover);
            border-color: var(--primary-hover);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .btn-primary:active, .btn-modern:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
            border-radius: var(--radius-md);
            transition: all var(--transition-base);
        }

        .btn-secondary:hover {
            background: var(--sidebar-hover-bg);
            border-color: var(--primary-hover);
            color: var(--primary-hover);
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .btn-secondary:active {
            transform: translateY(0);
        }

        /* Apply primary colors to themed elements */
        .bg-indigo-600, .bg-blue-600 {
            background-color: var(--primary-color) !important;
        }

        .bg-indigo-700, .bg-blue-700 {
            background-color: var(--primary-hover) !important;
        }

        .text-indigo-600, .text-blue-600 {
            color: var(--primary-color) !important;
        }

        .border-indigo-500, .border-blue-500 {
            border-color: var(--primary-color) !important;
        }

        .ring-indigo-500, .ring-blue-500 {
            --tw-ring-color: var(--primary-color);
        }

        /* Settings Preview Styles */
        .setting-changed {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 1px #3b82f6 !important;
        }

        .change-indicator {
            opacity: 0.8;
        }

        .unsaved-indicator {
            opacity: 0.8;
        }

        /* Table Density Styles */
        .table-compact table {
            font-size: 0.75rem;
        }

        .table-compact th,
        .table-compact td {
            padding: 0.25rem 0.5rem;
        }

        .table-spacious table {
            font-size: 1rem;
        }

        .table-spacious th,
        .table-spacious td {
            padding: 1rem 1.5rem;
        }

        /* Column Lines */
        .show-column-lines table {
            border-collapse: separate;
            border-spacing: 0;
        }

        .show-column-lines th,
        .show-column-lines td {
            border-right: 1px solid #e5e7eb;
        }

        .show-column-lines th:last-child,
        .show-column-lines td:last-child {
            border-right: none;
        }

        /* Row Hover */
        .enable-row-hover tbody tr:hover {
            background-color: #f9fafb;
        }

        .dark .enable-row-hover tbody tr:hover {
            background-color: #374151;
        }

        /* Stock Badges */
        .show-stock-badges .stock-badge {
            display: inline-block;
        }

        .stock-badge {
            display: none;
            padding: 0.125rem 0.375rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .stock-badge.low {
            background-color: #fef3c7;
            color: #92400e;
        }

        .stock-badge.critical {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .dark .stock-badge.low {
            background-color: #451a03;
            color: #fbbf24;
        }

        .dark .stock-badge.critical {
            background-color: #7f1d1d;
            color: #fca5a5;
        }

        /* No Animations */
        .no-animations * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }

        /* Enhanced Chart Container Styles */
        .chart-container {
            position: relative;
            height: 100%;
            width: 100%;
        }

        /* Smooth Chart Animations */
        canvas {
            transition: opacity 0.3s ease-in-out;
        }

        /* Enhanced Widget Hover Effects */
        .dashboard-widget {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dashboard-widget:hover {
            transform: translateY(-4px);
        }

        /* Gradient Backgrounds for Cards */
        .card-gradient-blue {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card-gradient-green {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .card-gradient-purple {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        /* Improved Responsive Charts */
        @media (max-width: 768px) {
            .chart-container {
                height: 250px !important;
            }
            
            canvas {
                max-height: 250px;
            }
        }

        /* Loading State for Charts */
        .chart-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }

        .chart-loading::after {
            content: '';
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Font Sizes */
        .small-font {
            font-size: 0.875rem;
        }

        .large-font {
            font-size: 1.125rem;
        }

        /* Settings Search */
        .settings-search-container {
            position: relative;
        }

        .settings-search-container .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        .settings-search-container input {
            padding-left: 2.5rem;
        }

        /* Preset Buttons */
        .preset-btn {
            transition: background-color 0.2s ease;
        }

        .preset-btn:hover {
            background: var(--sidebar-hover-bg);
        }

        .preset-btn.compact {
            background: var(--primary-color);
            color: white;
        }

        .preset-btn.balanced {
            background: var(--primary-color);
            color: white;
        }

        .preset-btn.spacious {
            background: var(--primary-color);
            color: white;
        }

        /* Applying Variables */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .themed-bg {
            background-color: var(--bg-color);
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        #app-container {
            height: 100vh;
        }
        
        #login-screen, #app-container, #modal-container, #notification-container {
            color: #1f2937; /* Reset text color for overlays */
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Enhanced Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes scaleInUp {
            from { transform: scale(0.95) translateY(10px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Enhanced Animation Classes */
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }

        .animate-slide-in-right {
            animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .animate-slide-in-left {
            animation: slideInLeft 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .animate-scale-in {
            animation: scaleIn 0.3s ease-out;
        }

        .animate-scale-in-up {
            animation: scaleInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        .animate-bounce-in {
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* Staggered Animation Delays */
        .animate-delay-100 { animation-delay: 100ms; }
        .animate-delay-200 { animation-delay: 200ms; }
        .animate-delay-300 { animation-delay: 300ms; }
        .animate-delay-400 { animation-delay: 400ms; }
        .animate-delay-500 { animation-delay: 500ms; }

        /* Hover Effects */
        .hover-lift {
            transition: border-color 0.2s ease;
        }

        .hover-lift:hover {
            border-color: var(--primary-color);
        }

        /* Loading States */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Notification Animations */
        .pop-animation {
            animation: scaleIn 0.3s ease-out;
        }

        /* Modern Notification Styles */
        .notification-modern {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 320px;
            max-width: 420px;
            padding: 16px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            overflow: hidden;
            animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            transition: all 0.3s ease;
        }

        .notification-modern::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: currentColor;
        }

        .notification-icon {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: currentColor;
            opacity: 0.1;
        }

        .notification-icon svg {
            width: 20px;
            height: 20px;
            color: currentColor;
            opacity: 1;
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-message {
            font-size: 14px;
            font-weight: 500;
            line-height: 1.5;
            color: #1F2937;
        }

        .notification-type-success { 
            color: #10B981; 
        }
        .notification-type-error { 
            color: #EF4444; 
        }
        .notification-type-warning { 
            color: #F59E0B; 
        }
        .notification-type-info { 
            color: #3B82F6; 
        }

        .notification-close {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.2s ease;
        }

        .notification-close:hover {
            opacity: 1;
            background: rgba(0, 0, 0, 0.05);
        }

        .notification-close svg {
            width: 16px;
            height: 16px;
            color: #6B7280;
        }

        /* Notification progress bar */
        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, currentColor, currentColor);
            background-size: 0% 100%;
            background-repeat: no-repeat;
            animation: notificationProgress linear forwards;
        }

        @keyframes notificationProgress {
            from { background-size: 100% 100%; }
            to { background-size: 0% 100%; }
        }

        /* Notification fade out */
        .notification-fade-out {
            animation: slideOutRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(120%);
                opacity: 0;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(120%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Smooth Transitions */
        .transition-all {
            transition: all 0.3s ease;
        }

        .transition-colors {
            transition: color 0.2s ease, background-color 0.2s ease, border-color 0.2s ease;
        }

        .transition-transform {
            transition: transform 0.2s ease;
        }

        /* Responsive Design Improvements */
        @media (max-width: 768px) {
            .mobile-hidden {
                display: none !important;
            }
            
            .mobile-full {
                width: 100% !important;
            }
            
            .mobile-stack {
                flex-direction: column !important;
            }
            
            .mobile-p-4 {
                padding: 1rem !important;
            }
            
            .mobile-text-sm {
                font-size: 0.875rem !important;
            }
            
            .mobile-text-xs {
                font-size: 0.75rem !important;
            }
            
            /* Enhanced Mobile Table Styles */
            .mobile-table {
                display: block;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-table table {
                min-width: 600px;
                width: 100%;
            }
            
            .mobile-table thead {
                display: none;
            }
            
            .mobile-table tbody,
            .mobile-table tr,
            .mobile-table td {
                display: block;
                width: 100%;
            }
            
            .mobile-table tr {
                background: var(--card-bg);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                margin-bottom: 12px;
                padding: 12px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            
            .mobile-table td {
                border: none;
                padding: 8px 0;
                text-align: left;
                position: relative;
                padding-left: 30%;
            }
            
            .mobile-table td:before {
                content: attr(data-label) ": ";
                position: absolute;
                left: 0;
                width: 25%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: 600;
                color: var(--text-color-light);
                font-size: 0.875rem;
            }
            
            /* Enhanced Mobile Cards */
            .mobile-card {
                background: var(--card-bg);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 16px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            
            /* Enhanced Mobile Buttons */
            .mobile-btn {
                width: 100%;
                padding: 12px 16px;
                font-size: 16px;
                border-radius: 8px;
                margin-bottom: 8px;
                min-height: 44px; /* iOS touch target minimum */
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Mobile Sidebar */
            .mobile-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 280px;
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .mobile-sidebar.open {
                transform: translateX(0);
            }
            
            .mobile-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }
        }

        @media (max-width: 640px) {
            .sm-mobile-p-2 {
                padding: 0.5rem !important;
            }
            
            .sm-mobile-text-xs {
                font-size: 0.625rem !important;
            }
            
            .sm-mobile-hidden {
                display: none !important;
            }
        }

        /* Enhanced Mobile Responsive Styles */
        @media (max-width: 768px) {
            /* Form improvements */
            .mobile-form input,
            .mobile-form select,
            .mobile-form textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
                border-radius: 8px;
                min-height: 44px;
            }
            
            /* Modal improvements */
            .mobile-modal {
                margin: 16px;
                max-height: calc(100vh - 32px);
                overflow-y: auto;
            }
            
            /* Header improvements */
            .mobile-header {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            /* Search improvements */
            .mobile-search {
                width: 100%;
                margin-bottom: 12px;
            }
            
            /* Navigation improvements */
            .mobile-nav {
                padding: 8px 0;
            }
            
            .mobile-nav .nav-link {
                padding: 12px 16px;
                margin: 4px 0;
                border-radius: 8px;
                min-height: 48px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            }
            
            /* Mejoras móviles para pestañas del sidebar */
            .themed-sidebar .nav-link {
                min-height: 48px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            }
            
            /* Indicador más visible en móvil */
            @media (max-width: 768px) {
                .themed-sidebar .nav-link.active::before {
                    width: 5px;
                    height: 70%;
                }
                
                .themed-sidebar .nav-link {
                    padding: 0.875rem 1rem;
                    margin: 0.25rem 0;
                }
                
                .themed-sidebar .nav-link > div {
                    width: 2rem;
                    height: 2rem;
                }
                
                .themed-sidebar .nav-link i {
                    width: 1.25rem;
                    height: 1.25rem;
                }
                
                .themed-sidebar .nav-link span {
                    font-size: 0.9375rem;
                }
                
                /* Badge más visible en móvil */
                #shopping-list-count {
                    min-width: 1.5rem;
                    height: 1.5rem;
                    font-size: 0.75rem;
                    right: 0.75rem;
                }
            }
            
            /* Mejoras móviles para pestañas de configuración */
            @media (max-width: 768px) {
                .settings-tab-link {
                    padding: 1rem 0.75rem;
                    min-height: 48px;
                    touch-action: manipulation;
                    -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
                    font-size: 0.875rem;
                    margin: 0 0.25rem;
                }
                
                .settings-tab-link i {
                    width: 1.125rem;
                    height: 1.125rem;
                    margin-right: 0.375rem;
                }
                
                /* Indicador más grueso en móvil */
                .settings-tab-link.active::after,
                .settings-tab-link[class*="border-indigo-500"]:not([class*="border-transparent"])::after,
                .settings-tab-link[class*="border-blue-500"]:not([class*="border-transparent"])::after {
                    height: 4px;
                }
                
                /* Contenedor de pestañas con scroll mejorado */
                .settings-tab-link {
                    flex-shrink: 0;
                }
                
                nav[aria-label="Settings Tabs"] {
                    padding: 0 0.5rem;
                    -webkit-overflow-scrolling: touch;
                    scroll-behavior: smooth;
                }
            }
            
            /* Dashboard widgets */
            .mobile-dashboard-widget {
                margin-bottom: 16px;
            }
            
            /* Table container improvements */
            .mobile-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border-radius: 8px;
                border: 1px solid var(--border-color);
            }
            
            /* Button group improvements */
            .mobile-btn-group {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .mobile-btn-group .btn {
                width: 100%;
                min-height: 44px;
            }
            
            /* Inventory Mobile Card Layout */
            .inventory-mobile-cards {
                display: none;
            }
            
            /* Hide table on mobile, show cards */
            .inventory-table-desktop {
                display: none !important;
            }
            
            .inventory-mobile-cards {
                display: block !important;
            }
            
            /* Improve spacing on mobile */
            @media (max-width: 768px) {
                .inventory-mobile-cards {
                    margin-top: 1rem;
                }
            }
            
            /* Inventory card styles - Mejorado */
            .inventory-card {
                background: white;
                border: 1px solid #E5E7EB;
                border-radius: 16px;
                padding: 18px;
                margin-bottom: 16px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
            }
            
            .inventory-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 3px;
                background: linear-gradient(90deg, #10b981, #059669);
                transform: scaleX(0);
                transform-origin: left;
                transition: transform 0.3s ease;
            }
            
            .inventory-card:hover {
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
                transform: translateY(-4px);
                border-color: #D1D5DB;
            }
            
            .inventory-card:hover::before {
                transform: scaleX(1);
            }
            
            .inventory-card.low-stock {
                background: linear-gradient(to bottom, #FEF2F2 0%, #FEE2E2 100%);
                border-color: #FCA5A5;
                border-left-width: 4px;
                border-left-color: #EF4444;
            }
            
            .inventory-card.low-stock::before {
                background: linear-gradient(90deg, #EF4444, #DC2626);
                transform: scaleX(1);
            }
            
            .inventory-card-header {
                display: flex;
                align-items: flex-start;
                margin-bottom: 14px;
                gap: 12px;
            }
            
            .inventory-card-icon {
                width: 48px;
                height: 48px;
                border-radius: 12px;
                background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }
            
            .inventory-card-info {
                flex: 1;
                min-width: 0;
            }
            
            .inventory-card-title {
                font-size: 17px;
                font-weight: 700;
                color: #111827;
                margin-bottom: 6px;
                word-wrap: break-word;
                line-height: 1.4;
            }
            
            .inventory-card-subtitle {
                font-size: 13px;
                color: #6B7280;
                display: flex;
                align-items: center;
                gap: 6px;
                margin-top: 4px;
            }
            
            .inventory-card-badge {
                display: inline-flex;
                align-items: center;
                padding: 5px 12px;
                border-radius: 14px;
                font-size: 11px;
                font-weight: 600;
                background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
                color: white;
                margin-top: 6px;
                box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
            }
            
            .inventory-card-field {
                display: flex;
                align-items: center;
                margin-bottom: 12px;
                font-size: 14px;
                padding: 4px 0;
            }
            
            .inventory-card-field-label {
                color: #6B7280;
                font-weight: 600;
                min-width: 90px;
                display: flex;
                align-items: center;
                gap: 6px;
                font-size: 13px;
            }
            
            .inventory-card-field-value {
                color: #111827;
                flex: 1;
                font-weight: 500;
            }
            
            .inventory-card-category {
                display: inline-flex;
                align-items: center;
                padding: 6px 12px;
                border-radius: 14px;
                font-size: 12px;
                font-weight: 600;
                background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
                color: #374151;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            }
            
            .inventory-card-stock {
                font-weight: 700;
                font-size: 18px;
                color: #111827;
                display: inline-block;
            }
            
            .inventory-card-stock-min {
                font-size: 13px;
                color: #6B7280;
                margin-left: 10px;
                font-weight: 500;
            }
            
            .inventory-card-actions {
                display: flex;
                align-items: center;
                justify-content: flex-start;
                gap: 10px;
                margin-top: 16px;
                padding-top: 16px;
                border-top: 2px solid #F3F4F6;
                flex-wrap: wrap;
            }
            
            .inventory-card-action-btn {
                width: 48px;
                height: 48px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                border: none;
                cursor: pointer;
                flex-shrink: 0;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                position: relative;
                overflow: hidden;
            }
            
            .inventory-card-action-btn::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transform: translate(-50%, -50%);
                transition: width 0.3s, height 0.3s;
            }
            
            .inventory-card-action-btn:active::before {
                width: 100px;
                height: 100px;
            }
            
            .inventory-card-action-btn:active {
                transform: scale(0.85);
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            }
            
            .inventory-card-action-btn.entry {
                background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
                color: #059669;
            }
            
            .inventory-card-action-btn.entry:hover {
                background: linear-gradient(135deg, #A7F3D0 0%, #6EE7B7 100%);
                box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
            }
            
            .inventory-card-action-btn.checkout {
                background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
                color: #2563EB;
            }
            
            .inventory-card-action-btn.checkout:hover {
                background: linear-gradient(135deg, #BFDBFE 0%, #93C5FD 100%);
                box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
            }
            
            .inventory-card-action-btn.checkout:disabled {
                background: #F3F4F6;
                color: #9CA3AF;
                cursor: not-allowed;
                box-shadow: none;
            }
            
            .inventory-card-action-btn.cart {
                background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
                color: #D97706;
            }
            
            .inventory-card-action-btn.cart:hover {
                background: linear-gradient(135deg, #FDE68A 0%, #FCD34D 100%);
                box-shadow: 0 4px 8px rgba(217, 119, 6, 0.3);
            }
            
            .inventory-card-action-btn.edit {
                background: linear-gradient(135deg, #E9D5FF 0%, #DDD6FE 100%);
                color: #7C3AED;
            }
            
            .inventory-card-action-btn.edit:hover {
                background: linear-gradient(135deg, #DDD6FE 0%, #C4B5FD 100%);
                box-shadow: 0 4px 8px rgba(124, 58, 237, 0.3);
            }
            
            .inventory-card-action-btn.edit-stock {
                background: linear-gradient(135deg, #FED7AA 0%, #FDBA74 100%);
                color: #EA580C;
            }
            
            .inventory-card-action-btn.edit-stock:hover {
                background: linear-gradient(135deg, #FDBA74 0%, #FB923C 100%);
                box-shadow: 0 4px 8px rgba(234, 88, 12, 0.3);
            }
            
            .inventory-card-action-btn.delete {
                background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
                color: #DC2626;
            }
            
            .inventory-card-action-btn.delete:hover {
                background: linear-gradient(135deg, #FECACA 0%, #FCA5A5 100%);
                box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
            }
            
            /* Categories sidebar mobile - Mejorado */
            .categories-sidebar-mobile {
                margin-bottom: 20px;
            }
            
            .categories-toggle-btn {
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 14px 18px;
                background: white;
                border: 2px solid #E5E7EB;
                border-radius: 14px;
                font-weight: 600;
                color: #111827;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                min-height: 52px;
            }
            
            .categories-toggle-btn:hover {
                border-color: var(--color-primary-accent);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }
            
            .categories-toggle-btn:active {
                background: #F9FAFB;
                transform: scale(0.98);
            }
            
            .categories-list-mobile {
                display: none;
                margin-top: 10px;
                background: white;
                border: 2px solid #E5E7EB;
                border-radius: 14px;
                padding: 10px;
                max-height: 350px;
                overflow-y: auto;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
            
            .categories-list-mobile.open {
                display: block;
                animation: slideDown 0.3s ease-out;
            }
            
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .categories-list-mobile .category-filter {
                display: flex;
                align-items: center;
                padding: 12px 14px;
                border-radius: 10px;
                margin-bottom: 6px;
                font-size: 14px;
                font-weight: 500;
                transition: all 0.2s ease;
                cursor: pointer;
            }
            
            .categories-list-mobile .category-filter:hover {
                background: #F3F4F6;
                transform: translateX(4px);
            }
            
            .categories-list-mobile .category-filter.active {
                background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
                color: #2563EB;
                font-weight: 600;
            }
            
            /* Filter buttons mobile - Mejorado */
            .filter-buttons-mobile {
                display: flex;
                gap: 10px;
                margin-bottom: 18px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 6px;
                scrollbar-width: none;
            }
            
            .filter-buttons-mobile::-webkit-scrollbar {
                display: none;
            }
            
            .inventory-filter-btn-mobile {
                padding: 12px 18px;
                border-radius: 12px;
                font-size: 14px;
                font-weight: 600;
                white-space: nowrap;
                min-height: 48px;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            }
            
            .inventory-filter-btn-mobile:active {
                transform: scale(0.95);
            }
            
            /* Floating Action Button (FAB) for mobile - Mejorado */
            .mobile-fab {
                position: fixed;
                bottom: 28px;
                right: 28px;
                width: 68px;
                height: 68px;
                border-radius: 50%;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5), 0 10px 30px rgba(0, 0, 0, 0.2);
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                z-index: 9999;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                border: none;
                pointer-events: auto;
                -webkit-tap-highlight-color: transparent;
            }
            
            .mobile-fab::before {
                content: '';
                position: absolute;
                inset: -4px;
                border-radius: 50%;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                opacity: 0.3;
                z-index: -1;
                animation: fabRipple 2s ease-out infinite;
            }
            
            @keyframes fabRipple {
                0% {
                    transform: scale(1);
                    opacity: 0.3;
                }
                100% {
                    transform: scale(1.4);
                    opacity: 0;
                }
            }
            
            .mobile-fab:hover {
                transform: scale(1.08);
                box-shadow: 0 8px 24px rgba(16, 185, 129, 0.6), 0 14px 40px rgba(0, 0, 0, 0.25);
            }
            
            .mobile-fab:active {
                transform: scale(0.92);
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4), 0 6px 16px rgba(0, 0, 0, 0.15);
            }
            
            .mobile-fab i {
                color: white;
                width: 32px;
                height: 32px;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            }
            
            @keyframes fabPulse {
                0%, 100% {
                    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5), 0 10px 30px rgba(0, 0, 0, 0.2);
                }
                50% {
                    box-shadow: 0 8px 28px rgba(16, 185, 129, 0.7), 0 14px 40px rgba(0, 0, 0, 0.3);
                }
            }
            
            .mobile-fab.pulse {
                animation: fabPulse 2s ease-in-out infinite;
            }
        }
        
        /* Desktop: Show table, hide cards */
        @media (min-width: 769px) {
            .inventory-mobile-cards {
                display: none !important;
            }
            
            .inventory-table-desktop {
                display: block !important;
            }
        }
        
        /* Hide FAB on desktop */
        @media (min-width: 769px) {
            .mobile-fab {
                display: none !important;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 480px) {
            .mobile-p-2 {
                padding: 8px !important;
            }
            
            .mobile-text-xs {
                font-size: 0.75rem !important;
            }
            
            .mobile-hidden {
                display: none !important;
            }
            
            /* Even smaller touch targets for very small screens */
            .mobile-btn {
                min-height: 40px;
                font-size: 14px;
            }
            
            /* Optimize cards for very small screens */
            .inventory-card {
                padding: 14px;
                border-radius: 14px;
                margin-bottom: 12px;
            }
            
            .inventory-card-header {
                margin-bottom: 12px;
            }
            
            .inventory-card-icon {
                width: 44px;
                height: 44px;
            }
            
            .inventory-card-title {
                font-size: 16px;
            }
            
            .inventory-card-field {
                margin-bottom: 10px;
                font-size: 13px;
            }
            
            .inventory-card-field-label {
                min-width: 75px;
                font-size: 12px;
            }
            
            .inventory-card-actions {
                gap: 8px;
                margin-top: 14px;
                padding-top: 14px;
            }
            
            .inventory-card-action-btn {
                width: 44px;
                height: 44px;
            }
            
            .inventory-card-action-btn i {
                width: 20px !important;
                height: 20px !important;
            }
        }

        /* Other styles */
        .low-stock {
            background-color: #fee2e2 !important;
        }
        
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-animation {
            animation: pop 0.3s ease-out forwards;
        }
        
        i[data-lucide], svg {
            pointer-events: none;
        }

        /* Enhanced Themed components */
        .themed-card { 
            background-color: var(--card-bg); 
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            transition: all var(--transition-base);
            box-shadow: var(--shadow-sm);
        }

        .themed-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        .themed-sidebar { 
            background: var(--color-bg-content);
            color: var(--color-text-primary);
            border-right: 1px solid var(--border-color);
            min-height: 100vh;
        }
        .themed-sidebar .nav-link { 
            color: var(--color-text-primary);
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0.125rem 0;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        /* Indicador visual izquierdo para pestaña activa */
        .themed-sidebar .nav-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 60%;
            background: var(--sidebar-active-bg);
            border-radius: 0 2px 2px 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Estado hover mejorado con efectos de escala y sombra */
        .themed-sidebar .nav-link:hover { 
            background-color: var(--sidebar-hover-bg);
            transform: translateX(2px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }
        
        /* Resaltado del icono en hover */
        .themed-sidebar .nav-link:hover > div {
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }
        
        /* Pestaña activa con fondo mejorado */
        .themed-sidebar .nav-link.active { 
            background-color: var(--sidebar-active-bg);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .themed-sidebar .nav-link.active i,
        .themed-sidebar .nav-link.active span {
            color: white;
        }
        
        /* Efecto de hover en pestaña activa */
        .themed-sidebar .nav-link.active:hover {
            background-color: var(--sidebar-active-bg);
            opacity: 0.9;
            transform: translateX(2px);
        }
        
        /* Mejora de focus visible para accesibilidad */
        .themed-sidebar .nav-link:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        /* Mejora del badge de notificaciones (shopping-list-count) */
        #shopping-list-count {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.4);
            animation: pulse-badge 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            min-width: 1.25rem;
            height: 1.25rem;
            font-size: 0.7rem;
            line-height: 1;
            padding: 0 0.25rem;
            border: 2px solid white;
        }
        
        .themed-sidebar .nav-link.active #shopping-list-count {
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        /* Animación de pulso para el badge */
        @keyframes pulse-badge {
            0%, 100% {
                opacity: 1;
                transform: translateY(-50%) scale(1);
            }
            50% {
                opacity: 0.8;
                transform: translateY(-50%) scale(1.05);
            }
        }
        
        /* Animación de entrada para pestaña activa */
        @keyframes slideInTab {
            0% {
                transform: scaleX(0);
                opacity: 0;
            }
            100% {
                transform: scaleX(1);
                opacity: 1;
            }
        }
        
        /* Animaciones globales adicionales */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Transiciones globales suaves para elementos interactivos */
        button, a, input, select, textarea, .nav-link, .settings-tab-link, .btn, [role="button"], [tabindex] {
            transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
        
        /* Mejoras para pestañas de configuración */
        .settings-tab-link {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom-width: 3px;
            padding: 0.875rem 0.5rem;
            margin: 0 0.5rem;
            border-radius: 0.375rem 0.375rem 0 0;
        }
        
        /* Indicador de pestaña activa mejorado */
        .settings-tab-link[class*="border-indigo-500"],
        .settings-tab-link[class*="border-blue-500"] {
            border-bottom-color: var(--primary-color) !important;
            border-bottom-width: 3px !important;
            color: var(--primary-color) !important;
            font-weight: 600;
        }
        
        /* Fondo sutil en estado hover */
        .settings-tab-link:hover {
            background-color: rgba(0, 0, 0, 0.03);
            transform: translateY(-2px);
            color: var(--primary-color);
        }
        
        /* Mejora del espaciado entre iconos y texto */
        .settings-tab-link i {
            margin-right: 0.5rem;
            transition: transform 0.2s ease;
            display: inline-flex;
            align-items: center;
            vertical-align: middle;
        }
        
        /* Efecto de escala sutil en hover */
        .settings-tab-link:hover i {
            transform: scale(1.15);
        }
        
        /* Pestaña activa con indicador mejorado */
        .settings-tab-link.active,
        .settings-tab-link[class*="border-indigo-500"]:not([class*="border-transparent"]),
        .settings-tab-link[class*="border-blue-500"]:not([class*="border-transparent"]) {
            position: relative;
        }
        
        .settings-tab-link.active::after,
        .settings-tab-link[class*="border-indigo-500"]:not([class*="border-transparent"])::after,
        .settings-tab-link[class*="border-blue-500"]:not([class*="border-transparent"])::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-hover));
            border-radius: 3px 3px 0 0;
            animation: slideInTab 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Mejora de focus visible para accesibilidad */
        .settings-tab-link:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
            border-radius: 0.375rem;
        }
        
        /* Mejor contraste para pestañas inactivas */
        .settings-tab-link[class*="border-transparent"] {
            color: var(--color-text-secondary);
            border-bottom-color: transparent;
        }
        
        .settings-tab-link[class*="border-transparent"]:hover {
            color: var(--primary-color);
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }
        
        /* Quick Actions Card Styles */
        .quick-action-card {
            position: relative;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            overflow: hidden;
            animation: fadeInUp 0.4s ease-out backwards;
        }
        
        .quick-action-card:nth-child(1) {
            animation-delay: 0.1s;
        }
        
        .quick-action-card:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .quick-action-card:nth-child(3) {
            animation-delay: 0.3s;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .quick-action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, currentColor, currentColor);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }
        
        .quick-action-card:hover::before {
            transform: scaleX(1);
        }
        
        .quick-action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.08);
            border-color: currentColor;
        }
        
        .quick-action-card:active {
            transform: translateY(-2px);
        }
        
        /* Color themes for quick action cards */
        .quick-action-card.action-add-item {
            color: #10b981;
        }
        
        .quick-action-card.action-add-item:hover {
            border-color: #10b981;
            box-shadow: 0 12px 24px rgba(16, 185, 129, 0.15), 0 4px 8px rgba(16, 185, 129, 0.1);
        }
        
        .quick-action-card.action-add-entry {
            color: #06b6d4;
        }
        
        .quick-action-card.action-add-entry:hover {
            border-color: #06b6d4;
            box-shadow: 0 12px 24px rgba(6, 182, 212, 0.15), 0 4px 8px rgba(6, 182, 212, 0.1);
        }
        
        .quick-action-card.action-checkout {
            color: #f59e0b;
        }
        
        .quick-action-card.action-checkout:hover {
            border-color: #f59e0b;
            box-shadow: 0 12px 24px rgba(245, 158, 11, 0.15), 0 4px 8px rgba(245, 158, 11, 0.1);
        }
        
        .quick-action-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            background: currentColor;
            opacity: 0.1;
        }
        
        .quick-action-card:hover .quick-action-icon {
            opacity: 0.15;
            transform: scale(1.1) rotate(5deg);
        }
        
        .quick-action-icon i {
            width: 1.5rem;
            height: 1.5rem;
            color: currentColor;
            opacity: 1;
        }
        
        .quick-action-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
            transition: color 0.2s ease;
        }
        
        .quick-action-card:hover .quick-action-title {
            color: currentColor;
        }
        
        .quick-action-description {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.5;
            margin-bottom: 0.75rem;
        }
        
        .quick-action-shortcut {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.5rem;
        }
        
        .quick-action-shortcut-key {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 1.5rem;
            height: 1.5rem;
            padding: 0 0.375rem;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.7rem;
            color: #4b5563;
        }
        
        .quick-action-card:hover .quick-action-shortcut-key {
            background: currentColor;
            color: white;
            border-color: currentColor;
            opacity: 0.2;
        }
        
        .quick-action-admin-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: #fef3c7;
            color: #92400e;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }
        
        .quick-action-card.action-add-item .quick-action-admin-badge {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        
        /* Tooltip styles */
        .quick-action-tooltip {
            position: relative;
        }
        
        .quick-action-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            padding: 0.5rem 0.75rem;
            background: #1f2937;
            color: white;
            font-size: 0.75rem;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 50;
            margin-bottom: 0.5rem;
        }
        
        .quick-action-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-2px);
            border: 4px solid transparent;
            border-top-color: #1f2937;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 50;
        }
        
        .quick-action-tooltip:hover::after,
        .quick-action-tooltip:hover::before {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .quick-action-card {
                padding: 1.25rem;
            }
            
            .quick-action-icon {
                width: 2.5rem;
                height: 2.5rem;
            }
            
            .quick-action-icon i {
                width: 1.25rem;
                height: 1.25rem;
            }
            
            .quick-action-title {
                font-size: 1rem;
            }
            
            .quick-action-description {
                font-size: 0.8125rem;
            }
        }
        
        .themed-header { background-color: var(--header-bg); border-color: var(--border-color); color: var(--text-color); }
        .themed-input { 
            background-color: var(--input-bg); 
            border: 1px solid var(--input-border);
            color: var(--text-color);
            padding: 0.875rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9375rem;
            line-height: 1.5;
            transition: all 0.2s ease;
            min-height: 44px;
        }

        .themed-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 1px var(--primary-color);
        }

        .themed-input:hover {
            border-color: var(--primary-color);
        }

        /* Input field icons */
        .input-icon {
            width: 20px;
            height: 20px;
        }

        /* Button icons */
        .btn-icon {
            width: 24px;
            height: 24px;
        }

        /* Number input steppers */
        .number-input {
            position: relative;
        }

        .number-input input[type="number"] {
            appearance: textfield;
            -moz-appearance: textfield;
            padding-right: 3rem;
        }

        .number-input input[type="number"]::-webkit-outer-spin-button,
        .number-input input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .number-steppers {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--input-border);
        }

        .number-stepper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-color);
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 2rem;
        }

        .number-stepper:hover {
            background: var(--primary-color);
            color: white;
        }

        .number-stepper:first-child {
            border-bottom: 1px solid var(--input-border);
        }

        /* Validation feedback */
        .input-valid {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2) !important;
        }

        .input-invalid {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
        }

        .validation-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1rem;
            height: 1rem;
        }

        .validation-success {
            color: #10b981;
        }

        .validation-error {
            color: #ef4444;
        }

        /* Batch operations */
        .batch-toolbar {
            position: sticky;
            bottom: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 1rem;
            display: none;
            align-items: center;
            gap: 1rem;
            z-index: 20;
        }

        .batch-toolbar.active {
            display: flex;
        }

        .batch-count {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Enhanced focus states */
        .focus-enhanced:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.2);
            border-color: var(--primary-color);
        }

        /* Loading states */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .loading-spinner {
            width: 2rem;
            height: 2rem;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .themed-table-header { 
            background-color: var(--bg-color);
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(30, 64, 175, 0.1);
        }
        .themed-table-body { 
            background-color: var(--card-bg);
        }

        /* Enhanced table styles */
        .table-enhanced tbody tr:nth-child(even) {
            background-color: rgba(30, 64, 175, 0.03);
        }

        .table-enhanced tbody tr:hover {
            background-color: rgba(30, 64, 175, 0.05);
            transition: background-color 0.2s ease;
        }

        .table-enhanced tbody tr {
            transition: all 0.2s ease;
        }

        .table-enhanced tbody tr:hover .action-buttons {
            opacity: 1;
            visibility: visible;
        }

        .action-buttons {
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .table-enhanced th {
            font-weight: 600;
            color: var(--text-color);
            border-bottom: 2px solid var(--border-color);
            padding: 1rem 0.75rem;
        }

        .table-enhanced td {
            padding: 0.875rem 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .themed-border { border-color: var(--border-color); }
        .themed-divide > * + * { border-color: var(--border-color); }
        .themed-text-light { color: var(--text-color-light); }
        
        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;}
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s;  border-radius: 50%;}
        input:checked + .slider { background-color: #4f46e5; }
        input:focus + .slider { box-shadow: 0 0 1px #4f46e5; }
        input:checked + .slider:before { transform: translateX(16px); }
        
        /* Modern scrollbar styles */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        /* Enhanced focus styles */
        .themed-input:focus, select:focus {
            outline: none;
            box-shadow: 0 0 0 1px var(--primary-color);
            border-color: var(--primary-color);
        }
        
        /* Minimalist backgrounds for sections */
        .gradient-bg {
            background: var(--sidebar-hover-bg);
        }
        
        /* Card hover effects */
        .hover-lift {
            transition: border-color 0.2s ease;
        }
        .hover-lift:hover {
            border-color: var(--primary-color);
        }
        
        /* Loading animation */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Modern button styles */
        .btn-modern {
            transition: background-color 0.2s ease;
        }
        .btn-modern:hover {
            background: var(--primary-hover);
        }
        .btn-modern:active {
            background: var(--primary-color);
        }

        /* Settings CSS */
        :root {
            --font-size: 15px;
            --line-height: 1.5;
        }

        /* Font size settings */
        body.small-font {
            font-size: 14px;
        }
        body.large-font {
            font-size: 18px;
        }

        /* Enhanced typography */
        body {
            font-size: var(--font-size);
            line-height: var(--line-height);
        }

        /* Form labels */
        label {
            line-height: 1.5rem;
            font-weight: 500;
        }

        /* Compact sidebar */
        .compact-sidebar .sidebar {
            width: 4rem;
        }
        .compact-sidebar .sidebar .nav-text {
            display: none;
        }
        .compact-sidebar .main-content {
            margin-left: 4rem;
        }

        /* Table density settings */
        .table-compact table td,
        .table-compact table th {
            padding: 0.5rem;
        }
        .table-spacious table td,
        .table-spacious table th {
            padding: 1rem;
        }

        /* Column lines */
        .no-column-lines table td,
        .no-column-lines table th {
            border-right: none;
        }

        /* Row hover */
        .no-row-hover table tr:hover {
            background-color: transparent;
        }

        /* Animations */
        .no-animations * {
            transition: none !important;
            animation: none !important;
        }

        /* High contrast mode */
        .high-contrast {
            filter: contrast(150%);
        }
        .high-contrast .themed-card {
            border: 2px solid #000;
        }

        /* Skip Link for Accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary-color);
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            z-index: 10000;
            border-radius: 0 0 4px 0;
            font-weight: 600;
        }
        .skip-link:focus {
            top: 0;
        }
        
        /* Enhanced Focus Indicators */
        *:focus-visible {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
        
        /* High Contrast Mode Improvements */
        .high-contrast * {
            border-color: currentColor !important;
        }
        .high-contrast button,
        .high-contrast a {
            border: 2px solid currentColor !important;
        }
        
        /* ARIA Live Region */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* Accessible Table Styles */
        table caption {
            font-weight: 600;
            text-align: left;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
    </style>
</head>
<body class="themed-bg">
    <!-- Skip to Main Content Link -->
    <a href="#main-content" class="skip-link">Saltar al contenido principal</a>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
        <div class="w-full max-w-md animate-scale-in-up">
            <!-- Login Card -->
            <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl border border-white/30 p-8 space-y-8 animate-fade-in-up" style="box-shadow: var(--elevation-4);">
                <!-- Header -->
                <div class="text-center animate-fade-in animate-delay-200">
                    <div class="mx-auto h-20 w-20 flex items-center justify-center rounded-2xl bg-gradient-to-br from-gray-900 to-gray-700 shadow-lg transform transition-transform duration-300 hover:scale-110" style="box-shadow: var(--elevation-2);">
                        <i data-lucide="package" class="h-10 w-10 text-white"></i>
                    </div>
                    <h2 class="mt-6 text-3xl font-bold text-gray-900">
                        Inventario Central
                    </h2>
                    <p class="mt-2 text-sm text-gray-600">
                        Gestiona tu inventario de forma inteligente
                    </p>
                </div>

                <!-- Login Form -->
                <form id="login-form" class="space-y-6 animate-fade-in animate-delay-300">
                    <div class="space-y-5">
                        <div class="space-y-2">
                            <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
                                Correo electrónico
                            </label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none transition-colors duration-200 group-focus-within:text-gray-900">
                                    <i data-lucide="mail" class="h-5 w-5 text-gray-400 group-focus-within:text-gray-900"></i>
                                </div>
                                <input id="email" name="email" type="email" autocomplete="email" required 
                                       class="themed-input block w-full pl-10 pr-3 py-3.5 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 transition-all duration-200 bg-white hover:border-gray-300" 
                                       placeholder="tu@email.com"
                                       aria-required="true"
                                       aria-describedby="email-validation email-help">
                                <span id="email-help" class="sr-only">Ingrese su dirección de correo electrónico</span>
                                <div id="email-validation" class="hidden mt-1 flex items-center text-xs" role="status" aria-live="polite">
                                    <i data-lucide="check-circle" class="h-4 w-4 mr-1 text-green-600" aria-hidden="true"></i>
                                    <span class="text-green-600">Email válido</span>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">
                                Contraseña
                            </label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none transition-colors duration-200 group-focus-within:text-gray-900">
                                    <i data-lucide="lock" class="h-5 w-5 text-gray-400 group-focus-within:text-gray-900"></i>
                                </div>
                                <input id="password" name="password" type="password" autocomplete="current-password" required 
                                       class="themed-input block w-full pl-10 pr-3 py-3.5 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 transition-all duration-200 bg-white hover:border-gray-300" 
                                       placeholder="••••••••"
                                       aria-required="true"
                                       aria-describedby="password-help">
                                <span id="password-help" class="sr-only">Ingrese su contraseña</span>
                            </div>
                        </div>
                    </div>

                    <div id="auth-error-message" class="text-red-600 text-center text-base font-medium hidden bg-red-50 p-4 rounded-xl border-2 border-red-200 shadow-md animate-bounce-in" role="alert" aria-live="assertive">
                        <div class="flex items-center justify-center space-x-2">
                            <i data-lucide="alert-circle" class="h-5 w-5" aria-hidden="true"></i>
                            <span></span>
                        </div>
                    </div>

                    <!-- Debug button (temporary) -->
                    <button type="button" id="debug-button" 
                            class="w-full flex justify-center items-center py-2.5 px-4 border-2 border-gray-200 rounded-xl text-sm font-medium text-gray-700 bg-gray-50 hover:bg-gray-100 hover:border-gray-300 transition-all duration-200 mb-4"
                            aria-label="Probar conexión con Firebase">
                        🔍 Debug: Test Firebase Connection
                    </button>

                    <button type="submit" id="login-button" 
                            class="btn-primary w-full flex justify-center items-center py-3.5 px-4 border border-transparent rounded-xl text-sm font-semibold text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98]" 
                            style="box-shadow: var(--shadow-md);"
                            aria-label="Iniciar sesión en el sistema">
                        <i data-lucide="log-in" class="h-5 w-5 mr-2" id="login-icon" aria-hidden="true"></i>
                        <span id="login-text">Iniciar Sesión</span>
                        <div id="login-spinner" class="hidden ml-2">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </button>
                </form>
            </div>

            <!-- Footer -->
            <div class="mt-8 text-center animate-fade-in animate-delay-400">
                <p class="text-xs text-gray-500 font-medium">
                    Sistema de Gestión de Inventario v2.0
                </p>
            </div>
        </div>
    </div>

    <!-- Main App Structure (hidden by default) -->
    <div id="app-container" class="hidden h-screen w-full flex">
        <!-- Sidebar -->
        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
        
        <aside id="sidebar" role="complementary" aria-label="Barra lateral de navegación" class="themed-sidebar w-72 h-screen space-y-1 pt-6 pb-0 px-4 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-all duration-300 ease-in-out z-30 flex flex-col overflow-y-auto">
            <!-- Logo Section -->
            <div class="px-2">
                <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded hover:bg-gray-100 transition-colors">
                    <div class="h-10 w-10 rounded bg-black flex items-center justify-center">
                        <i data-lucide="package" class="h-6 w-6 text-white"></i>
                    </div>
                    <div>
                        <span class="text-xl font-bold text-gray-900">Inventario</span>
                        <p class="text-xs text-gray-500">Sistema Central</p>
                    </div>
                </a>
            </div>

            <!-- Navigation -->
            <nav id="main-nav" role="navigation" aria-label="Navegación principal" class="flex-1 space-y-1 px-2">
                <a href="#dashboard" class="nav-link flex items-center space-x-3 py-2 px-4 rounded transition-colors active group" aria-label="Ir al Dashboard" aria-current="page">
                    <div class="h-8 w-8 rounded flex items-center justify-center" aria-hidden="true">
                        <i data-lucide="layout-dashboard" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Dashboard</span>
                </a>
                <a href="#inventory" class="nav-link flex items-center space-x-3 py-2 px-4 rounded transition-colors group" aria-label="Ir al Inventario">
                    <div class="h-8 w-8 rounded flex items-center justify-center" aria-hidden="true">
                        <i data-lucide="archive" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Inventario</span>
                </a>
                <a href="#active-loans" class="nav-link flex items-center space-x-3 py-2 px-4 rounded transition-colors group" aria-label="Ir a Préstamos Activos">
                    <div class="h-8 w-8 rounded flex items-center justify-center" aria-hidden="true">
                        <i data-lucide="arrow-right-left" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Préstamos</span>
                </a>
                <a href="#history" class="nav-link flex items-center space-x-3 py-2 px-4 rounded transition-colors group" aria-label="Ir al Historial">
                    <div class="h-8 w-8 rounded flex items-center justify-center" aria-hidden="true">
                        <i data-lucide="history" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Historial</span>
                </a>
                <a href="#reports" class="nav-link flex items-center space-x-3 py-2 px-4 rounded transition-colors group" aria-label="Ir a Reportes">
                    <div class="h-8 w-8 rounded flex items-center justify-center" aria-hidden="true">
                        <i data-lucide="file-down" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Reportes</span>
                </a>
                <a href="#shopping-list" class="nav-link flex items-center space-x-3 py-2 px-4 rounded transition-colors group relative" aria-label="Ir a Lista de Compras">
                    <div class="h-8 w-8 rounded flex items-center justify-center" aria-hidden="true">
                        <i data-lucide="shopping-cart" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Compras</span>
                    <span id="shopping-list-count" class="absolute right-4 top-1/2 -translate-y-1/2 bg-black text-white text-xs font-bold rounded h-5 w-5 flex items-center justify-center hidden" aria-label="Cantidad de artículos en lista de compras">0</span>
                </a>
                <a href="#users" id="users-nav-link" class="nav-link flex items-center space-x-3 py-2 px-4 rounded transition-colors group hidden" aria-label="Ir a Usuarios (solo administrador)" aria-hidden="true">
                    <div class="h-8 w-8 rounded flex items-center justify-center" aria-hidden="true">
                        <i data-lucide="users" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Usuarios</span>
                </a>
                <a href="#settings" id="settings-nav-link" class="nav-link flex items-center space-x-3 py-2 px-4 rounded transition-colors group" aria-label="Ir a Configuración">
                    <div class="h-8 w-8 rounded flex items-center justify-center" aria-hidden="true">
                        <i data-lucide="settings" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Configuración</span>
                </a>
                <a href="#" id="logout-button" class="nav-link flex items-center space-x-3 py-2 px-4 rounded transition-colors group" aria-label="Cerrar sesión">
                    <div class="h-8 w-8 rounded flex items-center justify-center" aria-hidden="true">
                        <i data-lucide="log-out" class="h-4 w-4"></i>
                    </div>
                    <span class="font-medium">Cerrar Sesión</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-x-hidden">
            <header role="banner" class="themed-header flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 sm:p-6 border-b bg-white mobile-header relative overflow-visible">
                <div class="flex items-center space-x-4">
                    <button id="menu-button" class="focus:outline-none md:hidden p-2 rounded hover:bg-gray-100 transition-colors" aria-label="Abrir menú de navegación" aria-expanded="false" aria-controls="sidebar">
                        <i data-lucide="menu" class="h-5 w-5" aria-hidden="true"></i>
                    </button>
                    <div>
                        <h1 id="page-title" class="text-2xl font-bold text-gray-900">Dashboard</h1>
                        <p class="text-sm text-gray-500">Vista general del inventario</p>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                    <form autocomplete="off" class="relative w-full sm:w-96 mobile-search" onsubmit="return false;">
                        <input type="text" name="honeypot" style="position:absolute;left:-5000px;" tabindex="-1" autocomplete="new-password">
                        
                        <!-- Input Container with Syntax Highlighting -->
                        <div class="relative">
                            <!-- Highlighted background for operators -->
                            <div id="search-syntax-highlight" class="absolute inset-0 px-4 py-3.5 pointer-events-none rounded border border-transparent whitespace-pre-wrap break-words overflow-hidden text-base text-transparent" style="z-index: 1;"></div>
                            
                            <!-- Main search input -->
                            <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none" style="z-index: 3;">
                                <i data-lucide="search" class="h-5 w-5 text-gray-400"></i>
                            </div>
                            
                            <input id="search-input" type="search" 
                                   class="themed-input relative w-full pl-10 pr-24 py-3.5 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-black focus:border-black bg-transparent text-gray-900 transition-colors text-base caret-black" 
                                   placeholder="Buscar artículos... (Usa AND, OR, NOT)"
                                   autocomplete="new-password"
                                   name="search_inventory_q"
                                   autocorrect="off"
                                   autocapitalize="off"
                                   spellcheck="false"
                                   role="combobox"
                                   aria-autocomplete="list"
                                   aria-expanded="false"
                                   aria-controls="search-suggestions"
                                   aria-label="Buscar artículos en el inventario"
                                   aria-describedby="search-help"
                                   aria-keyshortcuts="Ctrl+K Meta+K"
                                   style="z-index: 2;">
                            <span id="search-help" class="sr-only">Presione Ctrl+K o Cmd+K para buscar. Use operadores AND, OR, NOT para búsquedas avanzadas.</span>
                            
                            <!-- Background for input (behind syntax highlight) -->
                            <div class="absolute inset-0 bg-white rounded pointer-events-none" style="z-index: 0;"></div>
                            
                            <!-- Action buttons container -->
                            <div class="absolute inset-y-0 right-0 flex items-center pr-2 space-x-1" style="z-index: 3;">
                                <!-- Clear button -->
                                <button id="clear-search-btn" 
                                        type="button"
                                        class="hidden p-1.5 text-gray-400 hover:text-gray-600 rounded hover:bg-gray-100 transition-all duration-200"
                                        aria-label="Limpiar búsqueda"
                                        aria-keyshortcuts="Escape"
                                        title="Limpiar búsqueda (Esc)">
                                    <i data-lucide="x" class="h-4 w-4" aria-hidden="true"></i>
                                </button>
                                
                                <!-- Advanced search toggle -->
                                <button id="advanced-search-toggle" 
                                        type="button"
                                        class="p-1.5 text-gray-400 hover:text-black rounded hover:bg-gray-100 transition-colors"
                                        aria-label="Mostrar ayuda de búsqueda avanzada"
                                        aria-expanded="false"
                                        aria-controls="advanced-search-panel"
                                        title="Búsqueda avanzada">
                                    <i data-lucide="filter" class="h-4 w-4" aria-hidden="true"></i>
                                </button>
                                
                                <!-- Keyboard shortcut hint -->
                                <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-md opacity-0 focus-within:opacity-100 transition-opacity pointer-events-none">
                                    <span class="hidden sm:inline">Ctrl+K</span>
                                    <span class="sm:hidden">⌘K</span>
                                </span>
                            </div>
                        </div>
                        
                        <!-- Advanced search panel -->
                        <div id="advanced-search-panel" class="hidden mt-2 p-4 bg-white border border-gray-200 rounded" role="region" aria-labelledby="advanced-search-title">
                            <div id="advanced-search-title" class="text-xs font-semibold text-gray-700 mb-3">Búsqueda Avanzada</div>
                            <div class="space-y-2 text-xs text-gray-600">
                                <div><strong>AND:</strong> Buscar ambos términos (ej: <code class="px-1 py-0.5 bg-gray-100 rounded">martillo AND herramientas</code>)</div>
                                <div><strong>OR:</strong> Buscar cualquiera de los términos (ej: <code class="px-1 py-0.5 bg-gray-100 rounded">tornillo OR clavo</code>)</div>
                                <div><strong>NOT:</strong> Excluir término (ej: <code class="px-1 py-0.5 bg-gray-100 rounded">pintura NOT roja</code>)</div>
                                <div><strong>"frase":</strong> Búsqueda exacta (ej: <code class="px-1 py-0.5 bg-gray-100 rounded">"sierra circular"</code>)</div>
                            </div>
                        </div>
                        
                        <!-- Suggestions dropdown -->
                        <div id="search-suggestions" class="fixed bg-white border border-gray-300 rounded shadow-sm z-[99999] hidden overflow-hidden" role="listbox" aria-label="Sugerencias de búsqueda" style="z-index: 99999 !important; position: fixed !important; max-height: 400px; overflow-y: auto;">
                            <div id="suggestions-list" class="py-2" role="list"></div>
                        </div>
                        
                        <!-- Search Results Counter -->
                        <div id="search-results-count" class="sr-only" aria-live="polite" aria-atomic="true"></div>
                    </form>
                    
                    <div class="flex items-center space-x-2">
                        <div class="h-8 w-8 rounded-full bg-black flex items-center justify-center">
                            <i data-lucide="user" class="h-4 w-4 text-white"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-700" id="user-name">Usuario</span>
                    </div>
                </div>
            </header>

            <main id="main-content" role="main" class="flex-1 overflow-x-hidden overflow-y-auto p-4 sm:p-6 relative z-0" style="background-color: var(--color-bg-page);" tabindex="-1">
                <!-- Views will be injected here -->
                <!-- ARIA Live Region for Dynamic Content -->
                <div id="aria-live-region" class="sr-only" aria-live="polite" aria-atomic="true"></div>
            </main>
        </div>
        
        <!-- Mobile Floating Action Button (FAB) -->
        <button id="mobile-fab" type="button" class="mobile-fab pulse" aria-label="Agregar artículo rápido" onclick="if(typeof window.showQuickAddItemModal === 'function') window.showQuickAddItemModal();">
            <i data-lucide="plus" aria-hidden="true"></i>
        </button>
    </div>

    <!-- Modals Container -->
    <div id="modal-container"></div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 right-4 sm:top-5 sm:right-5 z-50 max-w-sm sm:max-w-md"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, onSnapshot, addDoc, updateDoc, writeBatch, query, where, serverTimestamp, setDoc, getDoc, deleteDoc, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- CONFIGURACIÓN ---
        // NOTA DE SEGURIDAD CRÍTICA: Tu configuración de Firebase está expuesta en el lado del cliente.
        // Esto es normal, pero significa que DEBES asegurar tu base de datos usando Reglas de Seguridad de Firebase.
        // El error "Missing or insufficient permissions" significa que tus reglas son demasiado restrictivas.
        // Para desarrollo, puedes empezar con estas reglas en tu Consola de Firebase -> Firestore -> Reglas:
        /*
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            match /{document=**} {
              // Permite leer y escribir a cualquier usuario autenticado.
              // ¡NO USAR EN PRODUCCIÓN SIN RESTRINGIR MÁS!
              allow read, write: if request.auth != null;
            }
          }
        }
        */
        const firebaseConfig = {
            apiKey: window.env?.VITE_FIREBASE_API_KEY || "AIzaSyDPvm07EShBWY_tqG1J6DZCxuKj0sbN1Cw",
            authDomain: window.env?.VITE_FIREBASE_AUTH_DOMAIN || "mi-inventario-app-e44a9.firebaseapp.com",
            projectId: window.env?.VITE_FIREBASE_PROJECT_ID || "mi-inventario-app-e44a9",
            storageBucket: window.env?.VITE_FIREBASE_STORAGE_BUCKET || "mi-inventario-app-e44a9.appspot.com",
            messagingSenderId: window.env?.VITE_FIREBASE_MESSAGING_SENDER_ID || "863395232436",
            appId: window.env?.VITE_FIREBASE_APP_ID || "1:863395232436:web:3f65ad3cc2ce61d30175e1",
            measurementId: window.env?.VITE_FIREBASE_MEASUREMENT_ID || "G-GE6QRCGJRH"
        };

        // --- INICIALIZACIÓN DE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- ESTADO GLOBAL DE LA APP ---
        function getInitialState() {
            return {
                inventory: [],
                activeLoans: [],
                transactions: [],
                shoppingList: [],
                categories: [],
                allUsers: [],
                searchIndex: new Map(), // Índice para búsqueda rápida
                currentUser: null,
                userRole: 'operator',
                currentPage: 1,
                itemsPerPage: 10,
                searchTerm: '',
                activeCategory: 'Todas',
                inventoryFilter: 'all', // 'all', 'low', 'returnable'
                aiSearchResults: null, // IDs de artículos encontrados por IA
                isInitialized: false,
                historyFilters: {
                    dateFrom: null,
                    dateTo: null,
                    responsible: '',
                    quantityMin: null,
                    quantityMax: null
                },
                historySortBy: 'date', // 'date', 'quantity', 'responsible', 'item'
                historySortOrder: 'desc', // 'asc', 'desc'
                historyViewMode: 'table', // 'table', 'cards'
                historyCurrentPage: 1,
                settings: {
                    itemsPerPage: 10,
                    defaultUnit: 'pza',
                    defaultMinStock: 5,
                    sessionTimeout: 480, // 8 hours in minutes
                    enableAuditLog: true,
                    barcodeScanning: false,
                    customValidations: {
                        maxQuantityPerTransaction: 1000,
                        requireNotesForLargeTransactions: false,
                        preventNegativeStock: true
                    },
                    displayPreferences: {
                        tableDensity: 'comfortable', // compact, comfortable, spacious
                        defaultView: 'table', // table, grid, list
                        showColumnLines: true,
                        enableRowHover: true,
                        showStockBadges: true
                    },
                    operationalPreferences: {
                        confirmBeforeDelete: true,
                        defaultTransactionType: 'Salida',
                        showRecentItems: true,
                        recentItemsCount: 10,
                        enableKeyboardShortcuts: true,
                        enableBulkOperations: true,
                        showAdvancedFilters: false
                    },
                    dashboardCustomization: {
                        showStockOverview: true,
                        showRecentTransactions: true,
                        showLowStockAlerts: true,
                        showQuickActions: true,
                        chartType: 'line', // line, bar, pie, area
                        defaultDateRange: '30d', // 7d, 30d, 90d, 1y, all
                        refreshInterval: 60 // seconds
                    },
                    backup: {
                        autoBackup: false,
                        backupFrequency: 'weekly', // daily, weekly, monthly
                        lastBackupDate: null
                    },
                    lowStockNotifications: true,
                    notificationEmails: '',
                    stockAlertDays: [2, 7, 14], // Días para alertas
                    enableScheduledReports: false,
                    interfaceCustomization: {
                        compactSidebar: false,
                        animationsEnabled: true,
                        fontSize: 'medium', // small, medium, large
                        colorTheme: 'blue', // blue, green, purple, orange
                        buttonSize: 'normal' // normal, large, extra-large
                    },
                    notificationPreferences: {
                        lowStockAlert: 'on_login', // always, on_login, never
                        soundAlerts: true,
                        popupAlerts: true,
                        emailNotifications: false,
                        dailyEmail: false,
                        weeklyEmail: false,
                        emailRecipients: '',
                        inactiveItemsDays: 30,
                        categoryThresholds: {}, // Umbrales personalizados por categoría
                        alertThresholds: {
                            critical: 2, // Días de stock crítico
                            warning: 7,  // Días de stock bajo
                            info: 14     // Días de stock normal
                        }
                    },
                    productivitySettings: {
                        autoSave: false,
                        autoSaveInterval: 30, // seconds
                        rememberLastPage: true,
                        enableKeyboardShortcuts: true
                    }
                }
            };
        }
        
        let state = getInitialState();
        let unsubscribeFunctions = []; // Store unsubscribe functions for cleanup
        
        // --- LÓGICA DE INICIALIZACIÓN Y AUTENTICACIÓN ---
        
        // Cleanup function to prevent memory leaks
        function cleanupListeners() {
            unsubscribeFunctions.forEach(unsubscribe => {
                if (typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
            unsubscribeFunctions = [];
        }
        
        // --- UTILITY FUNCTIONS ---
        
        // --- FUNCIONES DE BÚSQUEDA OPTIMIZADA ---
        
        // Construir índice de búsqueda para acceso rápido
        function buildSearchIndex() {
            const index = new Map();
            state.inventory.forEach(item => {
                const searchText = `${item.description} ${item.category}`.toLowerCase();
                const words = searchText.split(/\s+/);
                const itemData = {
                    id: item.id,
                    description: item.description,
                    category: item.category,
                    searchText: searchText,
                    words: words
                };
                index.set(item.id, itemData);
            });
            state.searchIndex = index;
        }
        
        // Algoritmo de fuzzy matching optimizado
        function fuzzyMatch(search, target, threshold = 0.6) {
            search = search.toLowerCase();
            target = target.toLowerCase();
            
            // Coincidencia exacta
            if (target.includes(search)) return 1.0;
            
            // Búsqueda por palabras individuales
            const searchWords = search.split(/\s+/);
            const targetWords = target.split(/\s+/);
            
            let matches = 0;
            searchWords.forEach(sw => {
                if (targetWords.some(tw => tw.startsWith(sw) || tw.includes(sw))) {
                    matches++;
                }
            });
            
            const score = matches / searchWords.length;
            return score >= threshold ? score : 0;
        }
        
        // --- PARSER DE BÚSQUEDA AVANZADA ---
        
        // Parsear consulta con operadores lógicos (AND, OR, NOT)
        function parseAdvancedQuery(query) {
            if (!query || !query.trim()) {
                return { type: 'empty', terms: [] };
            }
            
            const originalQuery = query.trim();
            
            // Detectar si tiene operadores lógicos
            const hasOperators = /\b(AND|OR|NOT)\b/i.test(originalQuery);
            
            if (!hasOperators) {
                // Búsqueda simple (sin operadores)
                const exactPhrases = extractExactPhrases(originalQuery);
                const simpleTerms = extractSimpleTerms(originalQuery);
                
                return {
                    type: 'simple',
                    terms: exactPhrases.length > 0 ? exactPhrases : simpleTerms,
                    originalQuery
                };
            }
            
            // Búsqueda avanzada con operadores
            try {
                const parsed = parseLogicalQuery(originalQuery);
                return {
                    type: 'advanced',
                    ...parsed,
                    originalQuery
                };
            } catch (error) {
                console.error('Error parsing query:', error);
                // Fallback a búsqueda simple
                return {
                    type: 'simple',
                    terms: extractSimpleTerms(originalQuery),
                    originalQuery
                };
            }
        }
        
        // Extraer frases exactas entre comillas
        function extractExactPhrases(query) {
            const exactPhrases = [];
            const exactRegex = /"([^"]+)"/g;
            let match;
            
            while ((match = exactRegex.exec(query)) !== null) {
                exactPhrases.push({
                    type: 'exact',
                    value: match[1].trim()
                });
            }
            
            return exactPhrases;
        }
        
        // Extraer términos simples (sin comillas ni operadores)
        function extractSimpleTerms(query) {
            // Remover frases exactas primero
            let cleanedQuery = query.replace(/"([^"]+)"/g, '').trim();
            
            // Dividir por espacios y filtrar términos vacíos
            return cleanedQuery.split(/\s+/)
                .filter(term => term.length > 0 && !/^\s*$/.test(term))
                .map(term => ({
                    type: 'term',
                    value: term.trim()
                }));
        }
        
        // Parsear consulta con operadores lógicos
        function parseLogicalQuery(query) {
            // Normalizar operadores a mayúsculas
            let normalized = query.replace(/\b(and|or|not)\b/gi, (match) => match.toUpperCase());
            
            // Extraer frases exactas primero
            const exactPhrases = extractExactPhrases(normalized);
            const exactMap = new Map();
            exactPhrases.forEach((phrase, index) => {
                const placeholder = `__EXACT_${index}__`;
                exactMap.set(placeholder, phrase.value);
                normalized = normalized.replace(`"${phrase.value}"`, placeholder);
            });
            
            // Parsear estructura lógica
            const parts = tokenizeQuery(normalized);
            const ast = buildAST(parts, exactMap);
            
            return {
                ast,
                exactPhrases
            };
        }
        
        // Tokenizar la consulta
        function tokenizeQuery(query) {
            const tokens = [];
            const words = query.split(/\s+/);
            
            let i = 0;
            while (i < words.length) {
                const word = words[i].trim();
                
                if (!word) {
                    i++;
                    continue;
                }
                
                if (word === 'AND' || word === 'OR' || word === 'NOT') {
                    tokens.push({ type: 'operator', value: word });
                } else if (word === 'NOT') {
                    tokens.push({ type: 'operator', value: 'NOT' });
                } else if (word.startsWith('__EXACT_')) {
                    tokens.push({ type: 'exact', placeholder: word });
                } else {
                    tokens.push({ type: 'term', value: word });
                }
                
                i++;
            }
            
            return tokens;
        }
        
        // Construir Abstract Syntax Tree (AST)
        function buildAST(tokens, exactMap) {
            if (tokens.length === 0) return null;
            
            // Simplificar: procesar en orden (left-associative)
            let current = null;
            let pendingNot = false;
            
            for (let i = 0; i < tokens.length; i++) {
                const token = tokens[i];
                
                if (token.type === 'operator' && token.value === 'NOT') {
                    pendingNot = true;
                    continue;
                }
                
                if (token.type === 'term' || token.type === 'exact') {
                    const node = token.type === 'exact' 
                        ? { type: 'exact', value: exactMap.get(token.placeholder) || '' }
                        : { type: 'term', value: token.value };
                    
                    // Aplicar NOT si está pendiente
                    const finalNode = pendingNot ? { type: 'not', operand: node } : node;
                    pendingNot = false;
                    
                    if (current === null) {
                        current = finalNode;
                    } else {
                        // Debería haber un operador antes
                        let prevIdx = i - 1;
                        while (prevIdx >= 0 && tokens[prevIdx].type === 'operator' && tokens[prevIdx].value === 'NOT') {
                            prevIdx--;
                        }
                        
                        if (prevIdx >= 0 && tokens[prevIdx].type === 'operator') {
                            const operator = tokens[prevIdx].value;
                            if (operator === 'AND' || operator === 'OR') {
                                current = {
                                    type: operator.toLowerCase(),
                                    left: current,
                                    right: finalNode
                                };
                            }
                        } else {
                            // Default to AND if no operator specified
                            current = {
                                type: 'and',
                                left: current,
                                right: finalNode
                            };
                        }
                    }
                }
            }
            
            return current || { type: 'term', value: tokens[0]?.value || '' };
        }
        
        // Evaluar AST contra un item del inventario
        function evaluateAST(ast, item) {
            if (!ast) return false;
            
            const searchText = `${item.description} ${item.category}`.toLowerCase();
            
            switch (ast.type) {
                case 'term':
                    return searchText.includes(ast.value.toLowerCase());
                
                case 'exact':
                    return searchText.includes(ast.value.toLowerCase());
                
                case 'and':
                    return evaluateAST(ast.left, item) && evaluateAST(ast.right, item);
                
                case 'or':
                    return evaluateAST(ast.left, item) || evaluateAST(ast.right, item);
                
                case 'not':
                    return !evaluateAST(ast.operand, item);
                
                default:
                    return false;
            }
        }
        
        // Aplicar syntax highlighting al input
        function highlightSearchSyntax(query) {
            if (!query) return '';
            
            let highlighted = query
                .replace(/\b(AND|OR|NOT)\b/gi, '<span class="font-semibold text-blue-600">$1</span>')
                .replace(/"([^"]+)"/g, '<span class="text-purple-600 font-medium">"$1"</span>');
            
            return highlighted;
        }
        
        // --- SISTEMA DE SUGERENCIAS MEJORADO ---
        
        // Generar sugerencias inteligentes mejoradas
        function getSmartSuggestions(searchTerm) {
            const suggestions = [];
            
            // Si está vacío, mostrar historial y búsquedas rápidas
            if (!searchTerm || searchTerm.trim().length === 0) {
                return getEmptyStateSuggestions();
            }
            
            const term = searchTerm.trim();
            const lowerTerm = term.toLowerCase();
            
            // Detectar si tiene operadores avanzados
            const hasOperators = /\b(AND|OR|NOT)\b/i.test(term) || term.includes('"');
            
            // Si tiene operadores, mostrar ejemplos de uso
            if (hasOperators) {
                suggestions.push(...getAdvancedSearchExamples(term));
            }
            
            // 1. Búsqueda instantánea - artículos que empiezan con el término
            const exactMatches = getExactMatches(term, 4);
            suggestions.push(...exactMatches);
            
            // 2. Búsqueda parcial - artículos que contienen el término
            if (exactMatches.length < 4) {
                const partialMatches = getPartialMatches(term, 4 - exactMatches.length);
                suggestions.push(...partialMatches);
            }
            
            // 3. Categorías que coinciden
            const categoryMatches = getCategoryMatches(term, 3);
            suggestions.push(...categoryMatches);
            
            // 4. Historial de búsquedas relevantes
            if (!hasOperators) {
                const recentMatches = getRecentHistoryMatches(term, 3);
                suggestions.push(...recentMatches);
            }
            
            // 5. Sugerencias de búsqueda rápida si aplica
            const quickFilters = getQuickFilterSuggestions(term);
            suggestions.push(...quickFilters);
            
            return suggestions.slice(0, 10);
        }
        
        // Sugerencias cuando el campo está vacío
        function getEmptyStateSuggestions() {
            const suggestions = [];
            
            // Historial reciente (hasta 5)
            const recent = getSearchHistory().slice(0, 5);
            if (recent.length > 0) {
                suggestions.push({
                    type: 'header',
                    text: 'Búsquedas recientes',
                    icon: 'clock'
                });
                recent.forEach(search => {
                    suggestions.push({
                        type: 'recent',
                        text: search,
                        icon: 'clock',
                        action: () => performSmartSearch(search)
                    });
                });
            }
            
            // Búsquedas rápidas comunes
            const quickSearches = [
                { text: 'Stock bajo', icon: 'alert-triangle', action: () => performSmartSearch('stock:bajo') },
                { text: 'Artículos prestados', icon: 'users', action: () => performSmartSearch('prestado:true') },
                { text: 'Ver todo', icon: 'list', action: () => performSmartSearch('') }
            ];
            
            if (suggestions.length > 0) {
                suggestions.push({
                    type: 'header',
                    text: 'Búsquedas rápidas',
                    icon: 'zap'
                });
            }
            quickSearches.forEach(qs => {
                suggestions.push({
                    type: 'quick',
                    text: qs.text,
                    icon: qs.icon,
                    action: qs.action
                });
            });
            
            return suggestions;
        }
        
        // Obtener coincidencias exactas (empiezan con el término)
        function getExactMatches(term, limit) {
            const lowerTerm = term.toLowerCase();
            return state.inventory
                .filter(item => {
                    const desc = item.description.toLowerCase();
                    const cat = item.category.toLowerCase();
                    return desc.startsWith(lowerTerm) || cat.startsWith(lowerTerm);
                })
                .slice(0, limit)
                .map(item => ({
                    type: 'exact',
                    text: item.description,
                    category: item.category,
                    stock: item.stock,
                    icon: 'package',
                    highlight: true,
                    action: () => performSmartSearch(item.description)
                }));
        }
        
        // Obtener coincidencias parciales (contienen el término)
        function getPartialMatches(term, limit) {
            const lowerTerm = term.toLowerCase();
            const exactMatches = getExactMatches(term, 100).map(m => m.text.toLowerCase());
            
            return state.inventory
                .filter(item => {
                    const desc = item.description.toLowerCase();
                    const cat = item.category.toLowerCase();
                    const isExact = exactMatches.includes(desc);
                    return !isExact && (desc.includes(lowerTerm) || cat.includes(lowerTerm));
                })
                .slice(0, limit)
                .map(item => ({
                    type: 'partial',
                    text: item.description,
                    category: item.category,
                    stock: item.stock,
                    icon: 'package',
                    action: () => performSmartSearch(item.description)
                }));
        }
        
        // Obtener coincidencias de categorías
        function getCategoryMatches(term, limit) {
            const lowerTerm = term.toLowerCase();
            return state.categories
                .filter(cat => cat.toLowerCase().includes(lowerTerm))
                .slice(0, limit)
                .map(cat => {
                    const itemsInCat = state.inventory.filter(item => item.category === cat);
                    return {
                        type: 'category',
                        text: cat,
                        count: itemsInCat.length,
                        icon: 'folder',
                        action: () => performSmartSearch(cat)
                    };
                });
        }
        
        // Obtener historial relevante
        function getRecentHistoryMatches(term, limit) {
            const lowerTerm = term.toLowerCase();
            return getSearchHistory()
                .filter(search => search.toLowerCase().includes(lowerTerm) && search.toLowerCase() !== lowerTerm)
                .slice(0, limit)
                .map(search => ({
                    type: 'recent',
                    text: search,
                    icon: 'history',
                    action: () => performSmartSearch(search)
                }));
        }
        
        // Obtener sugerencias de filtros rápidos
        function getQuickFilterSuggestions(term) {
            const suggestions = [];
            const lowerTerm = term.toLowerCase();
            
            if (lowerTerm.includes('stock') || lowerTerm.includes('bajo') || lowerTerm.includes('poco')) {
                suggestions.push({
                    type: 'filter',
                    text: 'Filtrar: Stock bajo',
                    icon: 'alert-triangle',
                    color: 'text-orange-600',
                    action: () => performSmartSearch('stock:bajo')
                });
            }
            
            if (lowerTerm.includes('prestado') || lowerTerm.includes('préstamo')) {
                suggestions.push({
                    type: 'filter',
                    text: 'Filtrar: Artículos prestados',
                    icon: 'users',
                    color: 'text-blue-600',
                    action: () => performSmartSearch('prestado:true')
                });
            }
            
            return suggestions;
        }
        
        // Obtener ejemplos de búsqueda avanzada
        function getAdvancedSearchExamples(term) {
            const examples = [];
            const lowerTerm = term.toLowerCase();
            
            if (lowerTerm.includes('and')) {
                examples.push({
                    type: 'example',
                    text: 'Ejemplo: martillo AND herramientas',
                    icon: 'search',
                    color: 'text-purple-600',
                    action: null
                });
            }
            
            if (lowerTerm.includes('or')) {
                examples.push({
                    type: 'example',
                    text: 'Ejemplo: tornillo OR clavo',
                    icon: 'search',
                    color: 'text-purple-600',
                    action: null
                });
            }
            
            if (lowerTerm.includes('not')) {
                examples.push({
                    type: 'example',
                    text: 'Ejemplo: pintura NOT roja',
                    icon: 'search',
                    color: 'text-purple-600',
                    action: null
                });
            }
            
            if (term.includes('"')) {
                examples.push({
                    type: 'example',
                    text: 'Ejemplo: "frase exacta"',
                    icon: 'search',
                    color: 'text-purple-600',
                    action: null
                });
            }
            
            return examples;
        }
        
        // Position search suggestions dynamically
        function positionSearchSuggestions() {
            const searchInput = document.getElementById('search-input');
            const suggestions = document.getElementById('search-suggestions');
            if (!searchInput || !suggestions) return;
            
            const rect = searchInput.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const padding = 16; // 16px padding from viewport edges
            
            // Calculate position and width
            let left = rect.left;
            let width = rect.width;
            
            // Ensure dropdown doesn't extend beyond viewport
            if (left + width > viewportWidth - padding) {
                width = viewportWidth - left - padding;
            }
            
            // If dropdown would be too narrow, adjust left position
            if (width < 200 && left > padding) {
                left = Math.max(padding, viewportWidth - width - padding);
            }
            
            suggestions.style.top = `${rect.bottom + 4}px`;
            suggestions.style.left = `${left}px`;
            suggestions.style.width = `${width}px`;
            suggestions.style.maxWidth = `${width}px`;
            
            // Ensure it's on top
            suggestions.style.zIndex = '99999';
        }
        
        // Mostrar sugerencias en el dropdown (completamente mejorado)
        function showSearchSuggestions(suggestions) {
            const container = document.getElementById('search-suggestions');
            const list = document.getElementById('suggestions-list');
            
            if (!suggestions.length) {
                container.classList.add('hidden');
                return;
            }
            
            // Position the dropdown before showing
            positionSearchSuggestions();
            
            // Renderizar sugerencias mejoradas con mejor diseño
            let html = '';
            let currentGroup = null;
            
            suggestions.forEach((suggestion, index) => {
                const isHeader = suggestion.type === 'header';
                const isClickable = suggestion.action && !isHeader;
                
                // Renderizar encabezado de grupo
                if (isHeader) {
                    if (currentGroup !== null) {
                        html += '</div>'; // Cerrar grupo anterior
                    }
                    const iconMap = {
                        'clock': 'history',
                        'zap': 'bolt'
                    };
                    html += `
                        <div class="suggestion-group border-b border-gray-100 last:border-b-0">
                            <div class="px-4 py-2 text-xs font-bold text-gray-600 bg-gray-50 flex items-center space-x-2">
                                <i data-lucide="${iconMap[suggestion.icon] || suggestion.icon}" class="h-3.5 w-3.5 text-blue-500"></i>
                                <span class="uppercase tracking-wide">${suggestion.text}</span>
                            </div>
                    `;
                    currentGroup = suggestion.text;
                    return;
                }
                
                // Si es el primer elemento y no hay grupo, crear uno por defecto
                if (currentGroup === null) {
                    html += '<div class="suggestion-group">';
                    currentGroup = 'default';
                }
                
                // Mapear tipos a estilos
                const styleMap = {
                    'exact': { bg: 'bg-green-50', border: 'border-green-400', iconColor: 'text-green-600' },
                    'partial': { bg: 'bg-blue-50', border: 'border-blue-300', iconColor: 'text-blue-600' },
                    'category': { bg: 'bg-purple-50', border: 'border-purple-300', iconColor: 'text-purple-600' },
                    'recent': { bg: 'bg-gray-50', border: 'border-gray-300', iconColor: 'text-gray-600' },
                    'filter': { bg: 'bg-orange-50', border: 'border-orange-300', iconColor: 'text-orange-600' },
                    'example': { bg: 'bg-indigo-50', border: 'border-indigo-300', iconColor: 'text-indigo-600' },
                    'quick': { bg: 'bg-yellow-50', border: 'border-yellow-300', iconColor: 'text-yellow-600' }
                };
                
                const style = styleMap[suggestion.type] || { bg: 'bg-gray-50', border: 'border-gray-300', iconColor: 'text-gray-600' };
                const iconColor = suggestion.color || style.iconColor;
                
                // Badge de stock si aplica
                const stockBadge = suggestion.stock !== undefined ? `
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${
                        suggestion.stock < 5 ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'
                    }">
                        Stock: ${suggestion.stock}
                    </span>
                ` : '';
                
                // Contador de categoría si aplica
                const countBadge = suggestion.count !== undefined ? `
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                        ${suggestion.count} ${suggestion.count === 1 ? 'artículo' : 'artículos'}
                    </span>
                ` : '';
                
                const hoverBorderClass = style.border.replace('border-', 'hover:border-');
                const cursorClass = isClickable ? 'cursor-pointer' : 'cursor-default';
                const hoverBgClass = style.bg.replace('bg-', 'hover:bg-');
                
                html += `
                    <div class="suggestion-item flex items-center space-x-3 px-4 py-3 ${hoverBgClass} ${cursorClass} transition-all duration-150 border-l-4 border-transparent ${hoverBorderClass} group" 
                         ${isClickable ? `data-action="clickable" data-suggestion-index="${index}"` : ''}>
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 rounded ${style.bg} flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i data-lucide="${suggestion.icon}" class="h-4 w-4 ${iconColor}"></i>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2">
                                <div class="text-sm font-semibold text-gray-900 truncate ${suggestion.highlight ? 'text-blue-700' : ''}">
                                    ${suggestion.text}
                                </div>
                                ${stockBadge || countBadge || ''}
                            </div>
                            ${suggestion.category ? `
                                <div class="flex items-center space-x-1 mt-1">
                                    <i data-lucide="tag" class="h-3 w-3 text-gray-400"></i>
                                    <span class="text-xs text-gray-500">${suggestion.category}</span>
                                </div>
                            ` : ''}
                        </div>
                        ${isClickable ? `
                            <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                                <i data-lucide="arrow-right" class="h-4 w-4 text-gray-400"></i>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            // Cerrar último grupo
            if (currentGroup !== null) {
                html += '</div>';
            }
            
            list.innerHTML = html;
            
            // Agregar event listeners a las sugerencias clicables
            list.querySelectorAll('.suggestion-item[data-action="clickable"]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(item.dataset.suggestionIndex);
                    const suggestion = suggestions[index];
                    if (suggestion && suggestion.action) {
                        suggestion.action();
                        hideSearchSuggestions();
                    }
                });
                
                // Mejorar hover visual
                item.addEventListener('mouseenter', () => {
                    item.classList.add('shadow-sm');
                });
                item.addEventListener('mouseleave', () => {
                    item.classList.remove('shadow-sm');
                });
            });
            
            container.classList.remove('hidden');
            safeCreateIcons();
        }
        
        // Ocultar sugerencias
        function hideSearchSuggestions() {
            const container = document.getElementById('search-suggestions');
            container.classList.add('hidden');
        }
        
        // Obtener historial de búsquedas recientes
        function getSearchHistory() {
            const history = localStorage.getItem('inventory-search-history');
            return history ? JSON.parse(history) : [];
        }
        
        // Guardar búsqueda en el historial
        function saveToSearchHistory(searchTerm) {
            if (!searchTerm || searchTerm.trim().length < 2) return;
            
            let history = getSearchHistory();
            
            // Remover si ya existe
            history = history.filter(term => term.toLowerCase() !== searchTerm.toLowerCase());
            
            // Agregar al inicio
            history.unshift(searchTerm.trim());
            
            // Mantener solo las últimas 10
            history = history.slice(0, 10);
            
            localStorage.setItem('inventory-search-history', JSON.stringify(history));
        }
        
        // --- FUNCIONES DE BÚSQUEDA AVANZADA ---
        
        // Realizar búsqueda inteligente con soporte para operadores lógicos
        function performSmartSearch(query) {
            if (!query || query.trim().length === 0) {
                state.searchTerm = '';
                renderInventoryView();
                return;
            }
            
            // Guardar en historial
            saveToSearchHistory(query);
            
            // Actualizar el término de búsqueda en el estado
            state.searchTerm = query;
            
            // Resetear filtros especiales (mantener compatibilidad con sintaxis antigua)
            if (query.includes('categoría:') || query.includes('categoria:')) {
                const category = query.split(':')[1]?.trim();
                if (category) {
                    state.activeCategory = category;
                }
            } else if (query.includes('stock:bajo') || query.includes('stock bajo')) {
                state.inventoryFilter = 'low';
            } else if (query.includes('prestado:true') || query.includes('prestado')) {
                state.inventoryFilter = 'returnable';
            } else if (query.includes('fecha:nuevo') || query.includes('nuevo')) {
                state.inventoryFilter = 'recent';
            } else {
                state.activeCategory = null;
                state.inventoryFilter = 'all';
            }
            
            renderInventoryView();
        }
        
        // Filtrar inventario usando la búsqueda avanzada
        function filterInventoryWithAdvancedSearch(items, query) {
            if (!query || !query.trim()) {
                return items;
            }
            
            const parsedQuery = parseAdvancedQuery(query);
            
            // Si la consulta está vacía, devolver todos los items
            if (parsedQuery.type === 'empty') {
                return items;
            }
            
            // Si es búsqueda simple, usar AND implícito (todos los términos deben estar)
            if (parsedQuery.type === 'simple') {
                return items.filter(item => {
                    const searchText = `${item.description} ${item.category}`.toLowerCase();
                    // Todos los términos deben estar presentes (AND implícito)
                    return parsedQuery.terms.every(term => {
                        if (term.type === 'exact') {
                            return searchText.includes(term.value.toLowerCase());
                        }
                        return searchText.includes(term.value.toLowerCase());
                    });
                });
            }
            
            // Si es búsqueda avanzada, usar el AST
            if (parsedQuery.type === 'advanced' && parsedQuery.ast) {
                return items.filter(item => evaluateAST(parsedQuery.ast, item));
            }
            
            // Fallback
            return items;
        }

        // --- FUNCIONES DE EXPORTACIÓN/IMPORTACIÓN ---
        
        async function exportInventory(format = 'csv') {
            try {
                showNotification('Preparando exportación...', 'info');
                
                let exportContent, filename, mimeType;
                
                switch (format) {
                    case 'csv':
                        exportContent = generateCSV();
                        filename = `inventario_${new Date().toISOString().split('T')[0]}.csv`;
                        mimeType = 'text/csv';
                        break;
                    case 'json':
                        exportContent = JSON.stringify(state.inventory, null, 2);
                        filename = `inventario_${new Date().toISOString().split('T')[0]}.json`;
                        mimeType = 'application/json';
                        break;
                    case 'excel':
                        // Para Excel usamos CSV con extensión .xlsx (compatible)
                        exportContent = generateCSV();
                        filename = `inventario_${new Date().toISOString().split('T')[0]}.xlsx`;
                        mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                        break;
                    default:
                        throw new Error('Formato no soportado');
                }
                
                downloadFile(exportContent, filename, mimeType);
                showNotification(`Inventario exportado como ${filename}`, 'success');
                
            } catch (error) {
                console.error('Error al exportar inventario:', error);
                showNotification('Error al exportar inventario', 'error');
            }
        }
        
        function generateCSV() {
            const headers = ['ID', 'Nombre', 'Categoría', 'Stock', 'Unidad', 'Stock Mínimo', 'Precio', 'Proveedor', 'Ubicación', 'Descripción', 'Fecha Creación', 'Fecha Actualización'];
            const rows = state.inventory.map(item => [
                item.id,
                item.name,
                item.category,
                item.stock,
                item.unit,
                item.minStock,
                item.price || '',
                item.supplier || '',
                item.location || '',
                item.description || '',
                item.createdAt ? new Date(item.createdAt.seconds * 1000).toLocaleDateString() : '',
                item.updatedAt ? new Date(item.updatedAt.seconds * 1000).toLocaleDateString() : ''
            ]);
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))
                .join('\n');
                
            return csvContent;
        }
        
        async function importInventory(file) {
            try {
                if (!file) {
                    throw new Error('No se seleccionó archivo');
                }
                
                showNotification('Procesando archivo...', 'info');
                
                const fileContent = await readFileContent(file);
                const parsedFileData = parseFileContent(fileContent, file.name);
                
                if (!parsedFileData || parsedFileData.length === 0) {
                    throw new Error('El archivo está vacío o no contiene datos válidos');
                }
                
                // Validar datos
                const validatedData = validateImportData(parsedFileData);
                
                // Mostrar preview de importación
                showImportPreview(validatedData, file.name);
                
            } catch (error) {
                console.error('Error al importar inventario:', error);
                showNotification(`Error al importar: ${error.message}`, 'error');
            }
        }
        
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Error al leer el archivo'));
                reader.readAsText(file);
            });
        }
        
        function parseFileContent(content, filename) {
            const extension = filename.split('.').pop().toLowerCase();
            
            switch (extension) {
                case 'csv':
                    return parseCSV(content);
                case 'json':
                    return JSON.parse(content);
                case 'xlsx':
                case 'xls':
                    return parseCSV(content); // Para Excel, asumimos que es CSV
                default:
                    throw new Error('Formato de archivo no soportado');
            }
        }
        
        function parseCSV(csvContent) {
            const lines = csvContent.split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            const parsedRows = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    parsedRows.push(row);
                }
            }
            
            return parsedRows;
        }
        
        function validateImportData(data) {
            const requiredFields = ['Nombre', 'Stock', 'Unidad', 'Stock Mínimo'];
            const validatedData = [];
            const errors = [];
            
            data.forEach((row, index) => {
                const errors = [];
                
                // Validar campos requeridos
                requiredFields.forEach(field => {
                    if (!row[field] || row[field].toString().trim() === '') {
                        errors.push(`${field} es requerido`);
                    }
                });
                
                // Validar tipos de datos
                if (row['Stock'] && isNaN(parseFloat(row['Stock']))) {
                    errors.push('Stock debe ser un número');
                }
                
                if (row['Stock Mínimo'] && isNaN(parseFloat(row['Stock Mínimo']))) {
                    errors.push('Stock Mínimo debe ser un número');
                }
                
                if (row['Precio'] && row['Precio'] !== '' && isNaN(parseFloat(row['Precio']))) {
                    errors.push('Precio debe ser un número');
                }
                
                validatedData.push({
                    ...row,
                    _errors: errors,
                    _rowNumber: index + 2 // +2 porque empezamos desde la fila 2 (después del header)
                });
            });
            
            return validatedData;
        }
        
        function showImportPreview(data, filename) {
            const validRows = data.filter(row => row._errors.length === 0);
            const invalidRows = data.filter(row => row._errors.length > 0);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-900">Previsualización de Importación</h3>
                        <button class="close-preview-btn text-gray-500 hover:text-gray-700">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-600">
                            Archivo: <span class="font-medium">${filename}</span>
                        </p>
                        <p class="text-sm text-gray-600">
                            Filas válidas: <span class="text-green-600 font-medium">${validRows.length}</span> | 
                            Filas con errores: <span class="text-red-600 font-medium">${invalidRows.length}</span>
                        </p>
                    </div>
                    
                    ${invalidRows.length > 0 ? `
                        <div class="mb-4 p-4 bg-red-50 border border-gray-200 rounded">
                            <h4 class="font-medium text-red-900 mb-2">Errores encontrados:</h4>
                            <div class="space-y-1 text-sm text-red-700">
                                ${invalidRows.slice(0, 5).map(row => 
                                    `<div>Fila ${row._rowNumber}: ${row._errors.join(', ')}</div>`
                                ).join('')}
                                ${invalidRows.length > 5 ? `<div>... y ${invalidRows.length - 5} errores más</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${validRows.length > 0 ? `
                        <div class="mb-4">
                            <h4 class="font-medium text-gray-900 mb-2">Datos a importar (${validRows.length} elementos):</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white border border-gray-200 rounded">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Categoría</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Stock</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Unidad</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Stock Mínimo</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${validRows.slice(0, 10).map(row => `
                                            <tr>
                                                <td class="px-4 py-2 text-sm text-gray-900">${row['Nombre']}</td>
                                                <td class="px-4 py-2 text-sm text-gray-900">${row['Categoría'] || ''}</td>
                                                <td class="px-4 py-2 text-sm text-gray-900">${row['Stock']}</td>
                                                <td class="px-4 py-2 text-sm text-gray-900">${row['Unidad']}</td>
                                                <td class="px-4 py-2 text-sm text-gray-900">${row['Stock Mínimo']}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                ${validRows.length > 10 ? `<p class="text-sm text-gray-500 mt-2">... y ${validRows.length - 10} elementos más</p>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="flex justify-end space-x-3">
                        <button class="cancel-import-btn px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded">
                            Cancelar
                        </button>
                        ${validRows.length > 0 ? `
                            <button class="confirm-import-btn px-4 py-2 bg-black hover:bg-gray-800 text-white rounded">
                                Importar ${validRows.length} elementos
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            safeCreateIcons();
            
            // Event listeners
            modal.querySelector('.close-preview-btn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modal.querySelector('.cancel-import-btn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            if (validRows.length > 0) {
                modal.querySelector('.confirm-import-btn').addEventListener('click', () => {
                    processImport(validRows);
                    document.body.removeChild(modal);
                });
            }
        }
        
        async function processImport(validRows) {
            try {
                showNotification('Importando datos...', 'info');
                
                const batch = writeBatch(db);
                let importedCount = 0;
                
                for (const row of validRows) {
                    const newItem = {
                        name: row['Nombre'].trim(),
                        category: row['Categoría']?.trim() || 'Sin categoría',
                        stock: parseFloat(row['Stock']),
                        unit: row['Unidad'].trim(),
                        minStock: parseFloat(row['Stock Mínimo']),
                        price: row['Precio'] ? parseFloat(row['Precio']) : null,
                        supplier: row['Proveedor']?.trim() || '',
                        location: row['Ubicación']?.trim() || '',
                        description: row['Descripción']?.trim() || '',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };
                    
                    const docRef = doc(collection(db, 'inventory'));
                    batch.set(docRef, newItem);
                    importedCount++;
                }
                
                await batch.commit();
                
                showNotification(`Importación exitosa: ${importedCount} elementos agregados`, 'success');
                // Los listeners en tiempo real actualizarán el inventario automáticamente
                
            } catch (error) {
                console.error('Error al procesar importación:', error);
                showNotification('Error al importar datos', 'error');
            }
        }
        
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // --- FUNCIONES DE BACKUP ---
        
        async function createBackup() {
            try {
                showNotification('Creando backup...', 'info');
                
                const backupData = {
                    timestamp: new Date().toISOString(),
                    version: '1.0',
                    inventory: state.inventory,
                    transactions: state.transactions,
                    activeLoans: state.activeLoans,
                    shoppingList: state.shoppingList,
                    settings: state.settings,
                    categories: state.categories
                };
                
                const backupJson = JSON.stringify(backupData, null, 2);
                const filename = `backup_${new Date().toISOString().split('T')[0]}_${new Date().toTimeString().split(' ')[0].replace(/:/g, '-')}.json`;
                
                downloadFile(backupJson, filename, 'application/json');
                
                // Actualizar fecha del último backup
                state.settings.backup.lastBackupDate = new Date().toISOString();
                await setDoc(doc(db, 'settings', 'global'), state.settings);
                
                showNotification('Backup creado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error al crear backup:', error);
                showNotification('Error al crear backup', 'error');
            }
        }
        
        async function restoreBackup(file) {
            try {
                if (!file) {
                    throw new Error('No se seleccionó archivo de backup');
                }
                
                showNotification('Procesando backup...', 'info');
                
                const content = await readFileContent(file);
                const backupData = JSON.parse(content);
                
                // Validar estructura del backup
                if (!backupData.inventory || !Array.isArray(backupData.inventory)) {
                    throw new Error('Archivo de backup inválido');
                }
                
                // Mostrar confirmación
                showRestoreConfirmation(backupData, file.name);
                
            } catch (error) {
                console.error('Error al restaurar backup:', error);
                showNotification(`Error al restaurar: ${error.message}`, 'error');
            }
        }
        
        function showRestoreConfirmation(backupData, filename) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded p-6 max-w-2xl w-full mx-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-900">Confirmar Restauración</h3>
                        <button class="close-restore-btn text-gray-500 hover:text-gray-700">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4 p-4 bg-yellow-50 border border-gray-200 rounded">
                        <div class="flex items-center">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-600 mr-2"></i>
                            <p class="text-yellow-800 font-medium">¡Advertencia!</p>
                        </div>
                        <p class="text-yellow-700 text-sm mt-1">
                            Esta acción reemplazará todos los datos actuales con los del backup. Esta acción no se puede deshacer.
                        </p>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-600">
                            Archivo: <span class="font-medium">${filename}</span>
                        </p>
                        <p class="text-sm text-gray-600">
                            Fecha del backup: <span class="font-medium">${new Date(backupData.timestamp).toLocaleString()}</span>
                        </p>
                        <p class="text-sm text-gray-600">
                            Elementos en el backup:
                        </p>
                        <ul class="text-sm text-gray-600 ml-4">
                            <li>• Inventario: ${backupData.inventory.length} elementos</li>
                            <li>• Transacciones: ${backupData.transactions?.length || 0} registros</li>
                            <li>• Préstamos activos: ${backupData.activeLoans?.length || 0} registros</li>
                            <li>• Lista de compras: ${backupData.shoppingList?.length || 0} elementos</li>
                        </ul>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button class="cancel-restore-btn px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded">
                            Cancelar
                        </button>
                        <button class="confirm-restore-btn px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded">
                            Restaurar Backup
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            safeCreateIcons();
            
            // Event listeners
            modal.querySelector('.close-restore-btn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modal.querySelector('.cancel-restore-btn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modal.querySelector('.confirm-restore-btn').addEventListener('click', async () => {
                document.body.removeChild(modal);
                await processRestore(backupData);
            });
        }
        
        async function processRestore(backupData) {
            try {
                showNotification('Restaurando backup...', 'info');
                
                // Restaurar datos directamente a Firestore
                // Los listeners en tiempo real actualizarán el estado automáticamente
                
                // Restaurar configuraciones
                if (backupData.settings) {
                    await setDoc(doc(db, 'settings', 'global'), backupData.settings);
                }
                
                showNotification('Backup restaurado exitosamente', 'success');
                
                // Recargar vista actual
                if (state.currentPage === 'inventory') {
                    renderInventoryView();
                } else if (state.currentPage === 'history') {
                    renderHistoryView();
                } else if (state.currentPage === 'active-loans') {
                    renderActiveLoansView();
                } else if (state.currentPage === 'shopping-list') {
                    renderShoppingListView();
                }
                
            } catch (error) {
                console.error('Error al procesar restauración:', error);
                showNotification('Error al restaurar backup', 'error');
            }
        }

        // --- SISTEMA DE BACKUP AUTOMÁTICO ---
        
        let autoBackupInterval = null;
        
        function initializeAutoBackup() {
            // Limpiar intervalo existente si existe
            if (autoBackupInterval) {
                clearInterval(autoBackupInterval);
            }
            
            // Verificar si el backup automático está habilitado
            if (state.settings.backup?.autoBackup) {
                const frequency = state.settings.backup?.backupFrequency || 'weekly';
                const intervalMs = getBackupIntervalMs(frequency);
                
                if (intervalMs > 0) {
                    // Ejecutar backup automático
                    autoBackupInterval = setInterval(async () => {
                        try {
                            await performAutoBackup();
                        } catch (error) {
                            console.error('Error en backup automático:', error);
                        }
                    }, intervalMs);
                    
                }
            }
        }
        
        function getBackupIntervalMs(frequency) {
            switch (frequency) {
                case 'daily':
                    return 24 * 60 * 60 * 1000; // 24 horas
                case 'weekly':
                    return 7 * 24 * 60 * 60 * 1000; // 7 días
                case 'monthly':
                    return 30 * 24 * 60 * 60 * 1000; // 30 días
                default:
                    return 0; // Deshabilitado
            }
        }
        
        async function performAutoBackup() {
            try {
                const backupData = {
                    timestamp: new Date().toISOString(),
                    version: '1.0',
                    type: 'auto',
                    inventory: state.inventory,
                    transactions: state.transactions,
                    activeLoans: state.activeLoans,
                    shoppingList: state.shoppingList,
                    settings: state.settings,
                    categories: state.categories
                };
                
                // Guardar backup en Firestore
                await saveBackupToFirestore(backupData);
                
                // Actualizar fecha del último backup
                state.settings.backup.lastBackupDate = new Date().toISOString();
                await setDoc(doc(db, 'settings', 'global'), state.settings);
                
                // Notificación discreta
                if (state.settings.notificationPreferences?.soundAlerts) {
                    playNotificationSound('success');
                }
                
            } catch (error) {
                console.error('Error en backup automático:', error);
                
                // Notificar error al usuario
                showNotification('Error en backup automático', 'error');
            }
        }
        
        async function saveBackupToFirestore(backupData) {
            try {
                const backupRef = doc(collection(db, 'backups'));
                await setDoc(backupRef, {
                    ...backupData,
                    createdAt: serverTimestamp(),
                    createdBy: state.user?.uid || 'system'
                });
                
                // Limpiar backups antiguos (mantener solo los últimos 10)
                await cleanupOldBackups();
                
            } catch (error) {
                console.error('Error al guardar backup en Firestore:', error);
                throw error;
            }
        }
        
        async function cleanupOldBackups() {
            try {
                const backupsRef = collection(db, 'backups');
                const q = query(backupsRef, orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                
                if (snapshot.docs.length > 10) {
                    const docsToDelete = snapshot.docs.slice(10);
                    const batch = writeBatch(db);
                    
                    docsToDelete.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                }
                
            } catch (error) {
                console.error('Error al limpiar backups antiguos:', error);
            }
        }
        
        async function loadBackups() {
            try {
                const backupsRef = collection(db, 'backups');
                const q = query(backupsRef, orderBy('createdAt', 'desc'), limit(20));
                const snapshot = await getDocs(q);
                
                return snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
            } catch (error) {
                console.error('Error al cargar backups:', error);
                return [];
            }
        }
        
        async function restoreFromFirestoreBackup(backupId) {
            try {
                const backupRef = doc(db, 'backups', backupId);
                const backupDoc = await getDoc(backupRef);
                
                if (!backupDoc.exists()) {
                    throw new Error('Backup no encontrado');
                }
                
                const backupData = backupDoc.data();
                
                // Mostrar confirmación
                showRestoreConfirmation(backupData, `Backup del ${new Date(backupData.timestamp).toLocaleDateString()}`);
                
            } catch (error) {
                console.error('Error al restaurar backup:', error);
                showNotification(`Error al restaurar: ${error.message}`, 'error');
            }
        }
        
        function playNotificationSound(type) {
            try {
                // Crear sonidos usando Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Configurar frecuencia según el tipo
                switch (type) {
                    case 'success':
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        break;
                    case 'error':
                        oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                        break;
                    case 'warning':
                        oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                        break;
                }
                
                // Configurar volumen y duración
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
                
            } catch (error) {
                console.error('Error al reproducir sonido:', error);
            }
        }
        
        // --- GESTIÓN DE CONFIGURACIONES DE BACKUP ---
        
        function updateBackupSettings(newSettings) {
            // Actualizar configuración de backup
            state.settings.backup = { ...state.settings.backup, ...newSettings };
            
            // Reinicializar backup automático si es necesario
            initializeAutoBackup();
            
            // Mostrar notificación
            if (newSettings.autoBackup) {
                const frequency = newSettings.backupFrequency || state.settings.backup.backupFrequency;
                showNotification(`Backup automático habilitado (${frequency})`, 'success');
            } else {
                showNotification('Backup automático deshabilitado', 'info');
            }
        }
        
        // --- FUNCIONES DE UTILIDAD PARA BACKUP ---
        
        function formatBackupSize(data) {
            const size = new Blob([JSON.stringify(data)]).size;
            if (size < 1024) return `${size} B`;
            if (size < 1024 * 1024) return `${(size / 1024).toFixed(1)} KB`;
            return `${(size / (1024 * 1024)).toFixed(1)} MB`;
        }
        
        function getBackupFrequencyText(frequency) {
            switch (frequency) {
                case 'daily': return 'Diario';
                case 'weekly': return 'Semanal';
                case 'monthly': return 'Mensual';
                default: return 'Deshabilitado';
            }
        }
        
        function showBackupStatus() {
            const lastBackup = state.settings.backup?.lastBackupDate;
            const autoBackup = state.settings.backup?.autoBackup;
            const frequency = state.settings.backup?.backupFrequency;
            
            if (!lastBackup) {
                return 'Nunca';
            }
            
            const lastBackupDate = new Date(lastBackup);
            const now = new Date();
            const diffMs = now - lastBackupDate;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return 'Hoy';
            } else if (diffDays === 1) {
                return 'Ayer';
            } else if (diffDays < 7) {
                return `Hace ${diffDays} días`;
            } else {
                return lastBackupDate.toLocaleDateString();
            }
        }

        // --- SISTEMA DE NOTIFICACIONES MEJORADO ---
        
        function checkLowStockAlerts() {
            if (state.settings.notificationPreferences?.lowStockAlert === 'never') {
                return;
            }
            
            const lowStockItems = state.inventory.filter(item => 
                item.stock <= item.minStock
            );
            
            if (lowStockItems.length > 0) {
                const message = `Hay ${lowStockItems.length} productos con stock bajo`;
                
                if (state.settings.notificationPreferences?.popupAlerts) {
                    showLowStockModal(lowStockItems);
                } else {
                    showNotification(message, 'warning');
                }
                
                if (state.settings.notificationPreferences?.soundAlerts) {
                    playNotificationSound('warning');
                }
            }
        }
        
        function showLowStockModal(lowStockItems) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-600 mr-2"></i>
                            Alertas de Stock Bajo
                        </h3>
                        <button class="close-low-stock-modal text-gray-500 hover:text-gray-700">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4 p-4 bg-yellow-50 border border-gray-200 rounded">
                        <div class="flex items-center">
                            <i data-lucide="info" class="w-5 h-5 text-yellow-600 mr-2"></i>
                            <p class="text-yellow-800 font-medium">
                                Se encontraron ${lowStockItems.length} productos con stock bajo o crítico
                            </p>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Categoría</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Stock Actual</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Stock Mínimo</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${lowStockItems.map(item => {
                                    const isCritical = item.stock <= item.minStock * 0.5;
                                    const isWarning = item.stock <= item.minStock;
                                    const statusClass = isCritical ? 'text-red-600' : 'text-yellow-600';
                                    const statusText = isCritical ? 'Crítico' : 'Bajo';
                                    
                                    return `
                                        <tr>
                                            <td class="px-4 py-2 text-sm text-gray-900">${item.name}</td>
                                            <td class="px-4 py-2 text-sm text-gray-900">${item.category}</td>
                                            <td class="px-4 py-2 text-sm text-gray-900">${item.stock} ${item.unit}</td>
                                            <td class="px-4 py-2 text-sm text-gray-900">${item.minStock} ${item.unit}</td>
                                            <td class="px-4 py-2 text-sm ${statusClass} font-medium">${statusText}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="close-low-stock-modal px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded">
                            Cerrar
                        </button>
                        <button class="go-to-inventory-btn px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">
                            Ir a Inventario
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            safeCreateIcons();
            
            // Event listeners
            modal.querySelector('.close-low-stock-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modal.querySelector('.go-to-inventory-btn').addEventListener('click', () => {
                document.body.removeChild(modal);
                window.location.hash = '#inventory';
                navigateTo('inventory');
            });
        }
        
        function checkInactiveItems() {
            const inactiveDays = state.settings.notificationPreferences?.inactiveItemsDays || 30;
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - inactiveDays);
            
            const inactiveItems = state.inventory.filter(item => {
                if (!item.updatedAt) return true;
                const lastUpdate = new Date(item.updatedAt.seconds * 1000);
                return lastUpdate < cutoffDate;
            });
            
            if (inactiveItems.length > 0) {
                const message = `${inactiveItems.length} productos sin movimiento en ${inactiveDays} días`;
                showNotification(message, 'info');
                
                if (state.settings.notificationPreferences?.soundAlerts) {
                    playNotificationSound('warning');
                }
            }
        }
        
        async function sendDailyEmailReport() {
            if (!state.settings.notificationPreferences?.dailyEmail) {
                return;
            }
            
            try {
                const lowStockItems = state.inventory.filter(item => 
                    item.stock <= item.minStock
                );
                
                if (lowStockItems.length === 0) {
                    return; // No enviar email si no hay problemas
                }
                
                const reportData = {
                    date: new Date().toLocaleDateString(),
                    lowStockCount: lowStockItems.length,
                    lowStockItems: lowStockItems.map(item => ({
                        name: item.name,
                        category: item.category,
                        stock: item.stock,
                        minStock: item.minStock,
                        unit: item.unit
                    })),
                    totalItems: state.inventory.length,
                    recipients: state.settings.notificationPreferences?.emailRecipients
                };
                
                // Aquí se integraría con un servicio de email
                // Simular envío exitoso
                showNotification('Reporte diario enviado', 'success');
                
            } catch (error) {
                console.error('Error al enviar reporte diario:', error);
                showNotification('Error al enviar reporte diario', 'error');
            }
        }
        
        async function sendWeeklyEmailReport() {
            if (!state.settings.notificationPreferences?.weeklyEmail) {
                return;
            }
            
            try {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                const weeklyTransactions = state.transactions.filter(transaction => {
                    const transactionDate = new Date(transaction.timestamp.seconds * 1000);
                    return transactionDate >= weekAgo;
                });
                
                const reportData = {
                    date: new Date().toLocaleDateString(),
                    weekStart: weekAgo.toLocaleDateString(),
                    totalTransactions: weeklyTransactions.length,
                    totalItems: state.inventory.length,
                    lowStockItems: state.inventory.filter(item => item.stock <= item.minStock).length,
                    recipients: state.settings.notificationPreferences?.emailRecipients
                };
                
                // Aquí se integraría con un servicio de email
                // Simular envío exitoso
                showNotification('Reporte semanal enviado', 'success');
                
            } catch (error) {
                console.error('Error al enviar reporte semanal:', error);
                showNotification('Error al enviar reporte semanal', 'error');
            }
        }
        
        function setupNotificationSchedules() {
            // Limpiar schedules existentes
            if (window.dailyEmailSchedule) {
                clearInterval(window.dailyEmailSchedule);
            }
            if (window.weeklyEmailSchedule) {
                clearInterval(window.weeklyEmailSchedule);
            }
            if (window.inactiveItemsSchedule) {
                clearInterval(window.inactiveItemsSchedule);
            }
            
            // Programar reporte diario (cada 24 horas)
            if (state.settings.notificationPreferences?.dailyEmail) {
                window.dailyEmailSchedule = setInterval(sendDailyEmailReport, 24 * 60 * 60 * 1000);
            }
            
            // Programar reporte semanal (cada 7 días)
            if (state.settings.notificationPreferences?.weeklyEmail) {
                window.weeklyEmailSchedule = setInterval(sendWeeklyEmailReport, 7 * 24 * 60 * 60 * 1000);
            }
            
            // Programar verificación de productos inactivos (cada 6 horas)
            window.inactiveItemsSchedule = setInterval(checkInactiveItems, 6 * 60 * 60 * 1000);
        }
        
        function validateEmailRecipients(emails) {
            if (!emails) return true;
            
            const emailList = emails.split(',').map(email => email.trim());
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            return emailList.every(email => emailRegex.test(email));
        }
        
        function updateCategoryThreshold(category, threshold) {
            if (!state.settings.notificationPreferences.categoryThresholds) {
                state.settings.notificationPreferences.categoryThresholds = {};
            }
            
            state.settings.notificationPreferences.categoryThresholds[category] = threshold;
        }
        
        function getCategoryThreshold(category) {
            return state.settings.notificationPreferences?.categoryThresholds?.[category] || 
                   state.settings.defaultMinStock || 5;
        }
        
        function showNotificationWithAction(message, type, actionText, actionCallback) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded shadow-sm max-w-md transform transition-all duration-300 translate-x-full`;
            
            const typeClasses = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                warning: 'bg-yellow-500 text-white',
                info: 'bg-blue-500 text-white'
            };
            
            notification.className += ` ${typeClasses[type] || typeClasses.info}`;
            
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : type === 'warning' ? 'alert-triangle' : 'info'}" class="w-5 h-5 mr-2"></i>
                        <span class="text-sm font-medium">${message}</span>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        ${actionText ? `<button class="action-btn text-sm underline hover:no-underline">${actionText}</button>` : ''}
                        <button class="close-notification-btn text-sm hover:opacity-75">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            safeCreateIcons();
            
            // Animar entrada
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Event listeners
            const closeBtn = notification.querySelector('.close-notification-btn');
            closeBtn.addEventListener('click', () => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            });
            
            if (actionText && actionCallback) {
                const actionBtn = notification.querySelector('.action-btn');
                actionBtn.addEventListener('click', () => {
                    actionCallback();
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                });
            }
            
            // Auto-remove después de 5 segundos
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }
            }, 5000);
        }

        // --- SISTEMA DE PREVIEW Y GESTIÓN DE CAMBIOS ---
        
        let originalSettings = null;
        let hasUnsavedChanges = false;
        
        function initializeSettingsPreview() {
            // Guardar configuración original
            originalSettings = JSON.parse(JSON.stringify(state.settings));
            hasUnsavedChanges = false;
            
            // Agregar event listeners para cambios en tiempo real
            setupPreviewEventListeners();
            
            // Actualizar indicadores de cambio
            updateChangeIndicators();
        }
        
        function setupPreviewEventListeners() {
            // Event listeners para cambios de apariencia que se pueden previsualizar
            const previewElements = [
                'font-size', 'color-theme', 'button-size', 'compact-sidebar', 
                'animations-enabled', 'table-density', 'show-column-lines', 
                'enable-row-hover', 'show-stock-badges'
            ];
            
            previewElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.addEventListener('change', handlePreviewChange);
                    element.addEventListener('input', handlePreviewChange);
                }
            });
        }
        
        function handlePreviewChange(event) {
            const element = event.target;
            const elementId = element.id;
            
            // Aplicar cambio inmediatamente para preview
            applyPreviewChange(elementId, element);
            
            // Marcar como modificado
            markAsChanged(elementId);
            
            // Actualizar indicadores
            updateChangeIndicators();
            
            // Actualizar estado de cambios no guardados
            hasUnsavedChanges = true;
            updateSaveButtonState();
        }
        
        function applyPreviewChange(elementId, element) {
            switch (elementId) {
                case 'font-size':
                    applyFontSizePreview(element.value);
                    break;
                case 'color-theme':
                    applyColorThemePreview(element.value);
                    break;
                case 'button-size':
                    applyButtonSizePreview(element.value);
                    break;
                case 'compact-sidebar':
                    applySidebarPreview(element.checked);
                    break;
                case 'animations-enabled':
                    applyAnimationsPreview(element.checked);
                    break;
                case 'table-density':
                    applyTableDensityPreview(element.value);
                    break;
                case 'show-column-lines':
                    applyColumnLinesPreview(element.checked);
                    break;
                case 'enable-row-hover':
                    applyRowHoverPreview(element.checked);
                    break;
                case 'show-stock-badges':
                    applyStockBadgesPreview(element.checked);
                    break;
            }
        }
        
        function applyFontSizePreview(fontSize) {
            document.body.classList.remove('small-font', 'large-font');
            if (fontSize === 'small') {
                document.body.classList.add('small-font');
            } else if (fontSize === 'large') {
                document.body.classList.add('large-font');
            }
        }
        
        function applyColorThemePreview(theme) {
            const root = document.documentElement;
            root.classList.remove('theme-blue', 'theme-green', 'theme-purple', 'theme-orange');
            root.classList.add(`theme-${theme}`);
            
            const themes = {
                blue: { '--primary-color': '#3b82f6', '--primary-hover': '#2563eb' },
                green: { '--primary-color': '#10b981', '--primary-hover': '#059669' },
                purple: { '--primary-color': '#8b5cf6', '--primary-hover': '#7c3aed' },
                orange: { '--primary-color': '#f59e0b', '--primary-hover': '#d97706' }
            };
            
            const currentTheme = themes[theme];
            Object.entries(currentTheme).forEach(([property, value]) => {
                root.style.setProperty(property, value);
            });
        }
        
        function applyButtonSizePreview(buttonSize) {
            const root = document.documentElement;
            root.classList.remove('button-size-normal', 'button-size-large', 'button-size-extra-large');
            root.classList.add(`button-size-${buttonSize}`);
            
            const buttonSizes = {
                normal: { '--button-padding': '0.5rem 1rem', '--button-font-size': '0.875rem', '--button-height': '2.5rem' },
                large: { '--button-padding': '0.75rem 1.5rem', '--button-font-size': '1rem', '--button-height': '3rem' },
                'extra-large': { '--button-padding': '1rem 2rem', '--button-font-size': '1.125rem', '--button-height': '3.5rem' }
            };
            
            const currentSize = buttonSizes[buttonSize];
            Object.entries(currentSize).forEach(([property, value]) => {
                root.style.setProperty(property, value);
            });
        }
        
        function applySidebarPreview(isCompact) {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return;
            
            sidebar.classList.toggle('w-64', !isCompact);
            sidebar.classList.toggle('w-20', isCompact);
            
            sidebar.querySelectorAll('span').forEach(el => {
                el.classList.toggle('opacity-0', isCompact);
                el.classList.toggle('hidden', isCompact);
            });
            sidebar.querySelectorAll('.nav-link').forEach(el => {
                el.classList.toggle('justify-center', isCompact);
            });
        }
        
        function applyAnimationsPreview(enabled) {
            if (!enabled) {
                document.body.classList.add('no-animations');
            } else {
                document.body.classList.remove('no-animations');
            }
        }
        
        function applyTableDensityPreview(density) {
            document.body.classList.remove('table-compact', 'table-comfortable', 'table-spacious');
            document.body.classList.add(`table-${density}`);
        }
        
        function applyColumnLinesPreview(showLines) {
            document.body.classList.toggle('show-column-lines', showLines);
        }
        
        function applyRowHoverPreview(enableHover) {
            document.body.classList.toggle('enable-row-hover', enableHover);
        }
        
        function applyStockBadgesPreview(showBadges) {
            document.body.classList.toggle('show-stock-badges', showBadges);
        }
        
        function markAsChanged(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('setting-changed');
                
                // Agregar indicador visual
                if (!element.parentNode.querySelector('.change-indicator')) {
                    const indicator = document.createElement('span');
                    indicator.className = 'change-indicator absolute -top-1 -right-1 w-3 h-3 bg-blue-500 rounded-full border-2 border-white';
                    indicator.title = 'Configuración modificada';
                    element.parentNode.style.position = 'relative';
                    element.parentNode.appendChild(indicator);
                }
            }
        }
        
        function updateChangeIndicators() {
            // Limpiar indicadores existentes
            document.querySelectorAll('.change-indicator').forEach(indicator => {
                indicator.remove();
            });
            
            document.querySelectorAll('.setting-changed').forEach(element => {
                element.classList.remove('setting-changed');
            });
            
            // Comparar configuraciones actuales con originales
            if (!originalSettings) return;
            
            const currentSettings = getCurrentSettingsFromDOM();
            const changedSettings = findChangedSettings(originalSettings, currentSettings);
            
            // Marcar elementos cambiados
            changedSettings.forEach(settingPath => {
                const elementId = getElementIdFromSettingPath(settingPath);
                const element = document.getElementById(elementId);
                if (element) {
                    markAsChanged(elementId);
                }
            });
            
            hasUnsavedChanges = changedSettings.length > 0;
            updateSaveButtonState();
        }
        
        function getCurrentSettingsFromDOM() {
            // Esta función debería extraer las configuraciones actuales del DOM
            // Por simplicidad, retornamos un objeto básico
            return {
                interfaceCustomization: {
                    fontSize: document.getElementById('font-size')?.value || 'medium',
                    colorTheme: document.getElementById('color-theme')?.value || 'blue',
                    buttonSize: document.getElementById('button-size')?.value || 'normal',
                    compactSidebar: document.getElementById('compact-sidebar')?.checked || false,
                    animationsEnabled: document.getElementById('animations-enabled')?.checked || true
                },
                displayPreferences: {
                    tableDensity: document.getElementById('table-density')?.value || 'comfortable',
                    showColumnLines: document.getElementById('show-column-lines')?.checked || false,
                    enableRowHover: document.getElementById('enable-row-hover')?.checked || true,
                    showStockBadges: document.getElementById('show-stock-badges')?.checked || false
                }
            };
        }
        
        function findChangedSettings(original, current) {
            const changes = [];
            
            function compareObjects(obj1, obj2, path = '') {
                for (const key in obj2) {
                    const currentPath = path ? `${path}.${key}` : key;
                    
                    if (typeof obj2[key] === 'object' && obj2[key] !== null) {
                        if (!obj1[key] || typeof obj1[key] !== 'object') {
                            changes.push(currentPath);
                        } else {
                            compareObjects(obj1[key], obj2[key], currentPath);
                        }
                    } else if (obj1[key] !== obj2[key]) {
                        changes.push(currentPath);
                    }
                }
            }
            
            compareObjects(original, current);
            return changes;
        }
        
        function getElementIdFromSettingPath(settingPath) {
            const pathMap = {
                'interfaceCustomization.fontSize': 'font-size',
                'interfaceCustomization.colorTheme': 'color-theme',
                'interfaceCustomization.buttonSize': 'button-size',
                'interfaceCustomization.compactSidebar': 'compact-sidebar',
                'interfaceCustomization.animationsEnabled': 'animations-enabled',
                'displayPreferences.tableDensity': 'table-density',
                'displayPreferences.showColumnLines': 'show-column-lines',
                'displayPreferences.enableRowHover': 'enable-row-hover',
                'displayPreferences.showStockBadges': 'show-stock-badges'
            };
            
            return pathMap[settingPath] || '';
        }
        
        function updateSaveButtonState() {
            const saveBtn = document.getElementById('save-settings-btn');
            if (!saveBtn) return;
            
            if (hasUnsavedChanges) {
                saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                saveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                saveBtn.disabled = false;
                
                // Agregar indicador de cambios no guardados
                if (!saveBtn.querySelector('.unsaved-indicator')) {
                    const indicator = document.createElement('span');
                    indicator.className = 'unsaved-indicator ml-2 w-2 h-2 bg-orange-500 rounded-full animate-pulse';
                    indicator.title = 'Hay cambios sin guardar';
                    saveBtn.appendChild(indicator);
                }
            } else {
                saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                saveBtn.disabled = true;
                
                // Remover indicador
                const indicator = saveBtn.querySelector('.unsaved-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }
        }
        
        function resetToOriginalSettings() {
            if (!originalSettings) return;
            
            // Restaurar valores originales en el DOM
            restoreSettingsToDOM(originalSettings);
            
            // Aplicar configuraciones originales
            applySettingsToUI(originalSettings);
            
            // Limpiar indicadores de cambio
            updateChangeIndicators();
            
            showNotification('Cambios revertidos a la configuración original', 'info');
        }
        
        function restoreSettingsToDOM(settings) {
            // Restaurar valores en el DOM
            if (settings.interfaceCustomization) {
                const { fontSize, colorTheme, buttonSize, compactSidebar, animationsEnabled } = settings.interfaceCustomization;
                
                const fontSizeEl = document.getElementById('font-size');
                if (fontSizeEl) fontSizeEl.value = fontSize;
                
                const colorThemeEl = document.getElementById('color-theme');
                if (colorThemeEl) colorThemeEl.value = colorTheme;
                
                const buttonSizeEl = document.getElementById('button-size');
                if (buttonSizeEl) buttonSizeEl.value = buttonSize;
                
                const compactSidebarEl = document.getElementById('compact-sidebar');
                if (compactSidebarEl) compactSidebarEl.checked = compactSidebar;
                
                const animationsEnabledEl = document.getElementById('animations-enabled');
                if (animationsEnabledEl) animationsEnabledEl.checked = animationsEnabled;
            }
            
            if (settings.displayPreferences) {
                const { tableDensity, showColumnLines, enableRowHover, showStockBadges } = settings.displayPreferences;
                
                const tableDensityEl = document.getElementById('table-density');
                if (tableDensityEl) tableDensityEl.value = tableDensity;
                
                const showColumnLinesEl = document.getElementById('show-column-lines');
                if (showColumnLinesEl) showColumnLinesEl.checked = showColumnLines;
                
                const enableRowHoverEl = document.getElementById('enable-row-hover');
                if (enableRowHoverEl) enableRowHoverEl.checked = enableRowHover;
                
                const showStockBadgesEl = document.getElementById('show-stock-badges');
                if (showStockBadgesEl) showStockBadgesEl.checked = showStockBadges;
            }
        }
        
        function setupSettingsSearch() {
            const searchInput = document.getElementById('settings-search');
            if (!searchInput) return;
            
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                filterSettingsElements(searchTerm);
            });
        }
        
        function filterSettingsElements(searchTerm) {
            const settingsContainer = document.querySelector('.settings-content');
            if (!settingsContainer) return;
            
            const elements = settingsContainer.querySelectorAll('.setting-group, .setting-item');
            
            elements.forEach(element => {
                const text = element.textContent.toLowerCase();
                const matches = text.includes(searchTerm);
                
                element.style.display = matches ? 'block' : 'none';
            });
            
            // Mostrar mensaje si no hay resultados
            if (searchTerm && !Array.from(elements).some(el => el.style.display !== 'none')) {
                showNoResultsMessage();
            } else {
                hideNoResultsMessage();
            }
        }
        
        function showNoResultsMessage() {
            let noResultsMsg = document.getElementById('no-settings-results');
            if (!noResultsMsg) {
                noResultsMsg = document.createElement('div');
                noResultsMsg.id = 'no-settings-results';
                noResultsMsg.className = 'text-center py-8 text-gray-500';
                noResultsMsg.innerHTML = `
                    <i data-lucide="search" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                    <p class="text-lg font-medium">No se encontraron configuraciones</p>
                    <p class="text-sm">Intenta con otros términos de búsqueda</p>
                `;
                
                const settingsContent = document.querySelector('.settings-content');
                if (settingsContent) {
                    settingsContent.appendChild(noResultsMsg);
                    safeCreateIcons();
                }
            }
            noResultsMsg.style.display = 'block';
        }
        
        function hideNoResultsMessage() {
            const noResultsMsg = document.getElementById('no-settings-results');
            if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
        }
        
        function applySettingsPreset(presetName) {
            const presets = {
                compact: {
                    interfaceCustomization: {
                        fontSize: 'small',
                        compactSidebar: true,
                        buttonSize: 'normal'
                    },
                    displayPreferences: {
                        tableDensity: 'compact'
                    }
                },
                balanced: {
                    interfaceCustomization: {
                        fontSize: 'medium',
                        compactSidebar: false,
                        buttonSize: 'normal'
                    },
                    displayPreferences: {
                        tableDensity: 'comfortable'
                    }
                },
                spacious: {
                    interfaceCustomization: {
                        fontSize: 'large',
                        compactSidebar: false,
                        buttonSize: 'large'
                    },
                    displayPreferences: {
                        tableDensity: 'spacious'
                    }
                }
            };
            
            const preset = presets[presetName];
            if (!preset) return;
            
            // Aplicar preset
            restoreSettingsToDOM(preset);
            applySettingsToUI(preset);
            
            // Actualizar indicadores
            updateChangeIndicators();
            
            showNotification(`Preset "${presetName}" aplicado`, 'success');
        }

        // --- SISTEMA DE VALIDACIONES MEJORADO ---
        
        function validateSettings(settings) {
            const errors = [];
            const warnings = [];
            
            // Validar configuraciones básicas
            validateBasicSettings(settings, errors, warnings);
            
            // Validar configuraciones de interfaz
            validateInterfaceSettings(settings, errors, warnings);
            
            // Validar configuraciones operacionales
            validateOperationalSettings(settings, errors, warnings);
            
            // Validar configuraciones de notificaciones
            validateNotificationSettings(settings, errors, warnings);
            
            // Validar configuraciones de backup
            validateBackupSettings(settings, errors, warnings);
            
            // Validar configuraciones de dashboard
            validateDashboardSettings(settings, errors, warnings);
            
            // Validar configuraciones de validaciones personalizadas
            validateCustomValidations(settings, errors, warnings);
            
            // Validar configuraciones de display
            validateDisplaySettings(settings, errors, warnings);
            
            return { errors, warnings };
        }
        
        function validateBasicSettings(settings, errors, warnings) {
            // Items per page
            if (settings.itemsPerPage < 5 || settings.itemsPerPage > 100) {
                errors.push('Artículos por página debe estar entre 5 y 100');
            } else if (settings.itemsPerPage > 50) {
                warnings.push('Muchos artículos por página pueden afectar el rendimiento');
            }
            
            // Session timeout
            if (settings.sessionTimeout < 15 || settings.sessionTimeout > 1440) {
                errors.push('Timeout de sesión debe estar entre 15 y 1440 minutos');
            }
            
            // Default min stock
            if (settings.defaultMinStock < 0 || settings.defaultMinStock > 1000) {
                errors.push('Stock mínimo por defecto debe estar entre 0 y 1000');
            }
            
            // Default unit
            const validUnits = ['pza', 'kg', 'l', 'm', 'm²', 'm³', 'caja', 'pack'];
            if (!validUnits.includes(settings.defaultUnit)) {
                errors.push('Unidad por defecto no válida');
            }
        }
        
        function validateInterfaceSettings(settings, errors, warnings) {
            if (!settings.interfaceCustomization) return;
            
            const { fontSize, colorTheme, buttonSize, compactSidebar } = settings.interfaceCustomization;
            
            // Font size
            if (!['small', 'medium', 'large'].includes(fontSize)) {
                errors.push('Tamaño de fuente no válido');
            }
            
            // Color theme
            if (!['blue', 'green', 'purple', 'orange'].includes(colorTheme)) {
                errors.push('Tema de color no válido');
            }
            
            // Button size
            if (!['normal', 'large', 'extra-large'].includes(buttonSize)) {
                errors.push('Tamaño de botón no válido');
            }
            
            // Compact sidebar
            if (typeof compactSidebar !== 'boolean') {
                errors.push('Sidebar compacto debe ser verdadero o falso');
            }
        }
        
        function validateOperationalSettings(settings, errors, warnings) {
            if (!settings.operationalPreferences) return;
            
            const { defaultTransactionType, recentItemsCount, autoSaveInterval, enableBulkOperations, showAdvancedFilters } = settings.operationalPreferences;
            
            // Default transaction type
            const validTypes = ['Entrada', 'Salida', 'Ajuste'];
            if (!validTypes.includes(defaultTransactionType)) {
                errors.push('Tipo de transacción por defecto no válido');
            }
            
            // Recent items count
            if (recentItemsCount < 1 || recentItemsCount > 50) {
                errors.push('Cantidad de elementos recientes debe estar entre 1 y 50');
            }
            
            // Auto save interval (si existe)
            if (autoSaveInterval !== undefined) {
                if (autoSaveInterval < 5 || autoSaveInterval > 300) {
                    errors.push('Intervalo de auto-guardado debe estar entre 5 y 300 segundos');
                }
            }
            
            // Bulk operations
            if (enableBulkOperations !== undefined && typeof enableBulkOperations !== 'boolean') {
                errors.push('Operaciones en bloque debe ser verdadero o falso');
            }
            
            // Advanced filters
            if (showAdvancedFilters !== undefined && typeof showAdvancedFilters !== 'boolean') {
                errors.push('Filtros avanzados debe ser verdadero o falso');
            }
        }
        
        function validateNotificationSettings(settings, errors, warnings) {
            if (!settings.notificationPreferences) return;
            
            const { 
                lowStockAlert, 
                inactiveItemsDays, 
                emailRecipients, 
                dailyEmail, 
                weeklyEmail 
            } = settings.notificationPreferences;
            
            // Low stock alert
            if (!['always', 'on_login', 'never'].includes(lowStockAlert)) {
                errors.push('Tipo de alerta de stock bajo no válido');
            }
            
            // Inactive items days
            if (inactiveItemsDays < 7 || inactiveItemsDays > 365) {
                errors.push('Días para productos inactivos debe estar entre 7 y 365');
            }
            
            // Email recipients
            if (emailRecipients && !validateEmailRecipients(emailRecipients)) {
                errors.push('Formato de emails de destinatarios inválido');
            }
            
            // Email notifications
            if ((dailyEmail || weeklyEmail) && !emailRecipients) {
                warnings.push('Email habilitado pero no hay destinatarios configurados');
            }
        }
        
        function validateBackupSettings(settings, errors, warnings) {
            if (!settings.backup) return;
            
            const { autoBackup, backupFrequency } = settings.backup;
            
            // Auto backup
            if (typeof autoBackup !== 'boolean') {
                errors.push('Backup automático debe ser verdadero o falso');
            }
            
            // Backup frequency
            if (backupFrequency && !['daily', 'weekly', 'monthly'].includes(backupFrequency)) {
                errors.push('Frecuencia de backup no válida (debe ser: daily, weekly, monthly)');
            }
        }
        
        function validateDashboardSettings(settings, errors, warnings) {
            if (!settings.dashboardCustomization) return;
            
            const { chartType, defaultDateRange, refreshInterval } = settings.dashboardCustomization;
            
            // Chart type
            if (chartType && !['line', 'bar', 'pie', 'area'].includes(chartType)) {
                errors.push('Tipo de gráfico no válido (debe ser: line, bar, pie, area)');
            }
            
            // Default date range
            if (defaultDateRange && !['7d', '30d', '90d', '1y', 'all'].includes(defaultDateRange)) {
                errors.push('Rango de fechas por defecto no válido (debe ser: 7d, 30d, 90d, 1y, all)');
            }
            
            // Refresh interval
            if (refreshInterval !== undefined) {
                if (refreshInterval < 10 || refreshInterval > 3600) {
                    errors.push('Intervalo de actualización debe estar entre 10 y 3600 segundos');
                } else if (refreshInterval < 30) {
                    warnings.push('Intervalos de actualización muy cortos pueden afectar el rendimiento');
                }
            }
        }
        
        function validateCustomValidations(settings, errors, warnings) {
            if (!settings.customValidations) return;
            
            const { maxQuantityPerTransaction, requireNotesForLargeTransactions, preventNegativeStock } = settings.customValidations;
            
            // Max quantity per transaction
            if (maxQuantityPerTransaction !== undefined) {
                if (maxQuantityPerTransaction < 1 || maxQuantityPerTransaction > 10000) {
                    errors.push('Cantidad máxima por transacción debe estar entre 1 y 10000');
                }
            }
            
            // Require notes for large transactions
            if (requireNotesForLargeTransactions !== undefined && typeof requireNotesForLargeTransactions !== 'boolean') {
                errors.push('Requerir notas para transacciones grandes debe ser verdadero o falso');
            }
            
            // Prevent negative stock
            if (preventNegativeStock !== undefined && typeof preventNegativeStock !== 'boolean') {
                errors.push('Prevenir stock negativo debe ser verdadero o falso');
            }
        }
        
        function validateDisplaySettings(settings, errors, warnings) {
            if (!settings.displayPreferences) return;
            
            const { defaultView, showStockBadges } = settings.displayPreferences;
            
            // Default view
            if (defaultView && !['table', 'grid', 'list'].includes(defaultView)) {
                errors.push('Vista por defecto no válida (debe ser: table, grid, list)');
            }
            
            // Show stock badges
            if (showStockBadges !== undefined && typeof showStockBadges !== 'boolean') {
                errors.push('Mostrar badges de stock debe ser verdadero o falso');
            }
        }
        
        function showValidationResults(errors, warnings) {
            if (errors.length === 0 && warnings.length === 0) {
                return true; // Válido
            }
            
            // Mostrar errores
            if (errors.length > 0) {
                const errorMessage = errors.join('\n');
                showNotification(`Errores de validación:\n${errorMessage}`, 'error');
                return false;
            }
            
            // Mostrar advertencias
            if (warnings.length > 0) {
                const warningMessage = warnings.join('\n');
                showNotification(`Advertencias:\n${warningMessage}`, 'warning');
            }
            
            return true; // Válido con advertencias
        }
        
        function validateAndShowFeedback(settings) {
            const { errors, warnings } = validateSettings(settings);
            return showValidationResults(errors, warnings);
        }
        
        function validateField(fieldName, value, element = null) {
            let isValid = true;
            let message = '';
            
            switch (fieldName) {
                case 'itemsPerPage':
                    if (value < 5 || value > 100) {
                        isValid = false;
                        message = 'Debe estar entre 5 y 100';
                    } else if (value > 50) {
                        message = 'Valores altos pueden afectar el rendimiento';
                    }
                    break;
                    
                case 'sessionTimeout':
                    if (value < 15 || value > 1440) {
                        isValid = false;
                        message = 'Debe estar entre 15 y 1440 minutos';
                    }
                    break;
                    
                case 'defaultMinStock':
                    if (value < 0 || value > 1000) {
                        isValid = false;
                        message = 'Debe estar entre 0 y 1000';
                    }
                    break;
                    
                case 'inactiveItemsDays':
                    if (value < 7 || value > 365) {
                        isValid = false;
                        message = 'Debe estar entre 7 y 365 días';
                    }
                    break;
                    
                case 'recentItemsCount':
                    if (value < 1 || value > 50) {
                        isValid = false;
                        message = 'Debe estar entre 1 y 50';
                    }
                    break;
                    
                case 'autoSaveInterval':
                    if (value < 5 || value > 300) {
                        isValid = false;
                        message = 'Debe estar entre 5 y 300 segundos';
                    }
                    break;
                    
                case 'emailRecipients':
                    if (value && !validateEmailRecipients(value)) {
                        isValid = false;
                        message = 'Formato de email inválido';
                    }
                    break;
            }
            
            // Aplicar estilo visual
            if (element) {
                if (!isValid) {
                    element.classList.add('border-red-500', 'focus:ring-red-500');
                    element.classList.remove('border-gray-300', 'focus:ring-black');
                } else {
                    element.classList.remove('border-red-500', 'focus:ring-red-500');
                    element.classList.add('border-gray-300', 'focus:ring-black');
                }
                
                // Mostrar/ocultar mensaje de validación
                let validationMsg = element.parentNode.querySelector('.validation-message');
                if (!validationMsg && (!isValid || message)) {
                    validationMsg = document.createElement('div');
                    validationMsg.className = 'validation-message text-xs mt-1';
                    element.parentNode.appendChild(validationMsg);
                }
                
                if (validationMsg) {
                    if (!isValid) {
                        validationMsg.className = 'validation-message text-xs mt-1 text-red-600';
                        validationMsg.textContent = message;
                        validationMsg.style.display = 'block';
                    } else if (message) {
                        validationMsg.className = 'validation-message text-xs mt-1 text-yellow-600';
                        validationMsg.textContent = message;
                        validationMsg.style.display = 'block';
                    } else {
                        validationMsg.style.display = 'none';
                    }
                }
            }
            
            return { isValid, message };
        }
        
        function setupFieldValidation() {
            // Configurar validación en tiempo real para campos numéricos
            const numericFields = [
                'items-per-page',
                'session-timeout', 
                'default-min-stock',
                'inactive-items-days',
                'recent-items-count',
                'auto-save-interval'
            ];
            
            numericFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', (e) => {
                        const value = parseInt(e.target.value) || 0;
                        const fieldName = fieldId.replace(/-/g, '').replace('itemsperpage', 'itemsPerPage')
                                                 .replace('sessiontimeout', 'sessionTimeout')
                                                 .replace('defaultminstock', 'defaultMinStock')
                                                 .replace('inactiveitemsdays', 'inactiveItemsDays')
                                                 .replace('recentitemscount', 'recentItemsCount')
                                                 .replace('autosaveinterval', 'autoSaveInterval');
                        validateField(fieldName, value, field);
                    });
                }
            });
            
            // Configurar validación para emails
            const emailField = document.getElementById('email-recipients');
            if (emailField) {
                emailField.addEventListener('input', (e) => {
                    validateField('emailRecipients', e.target.value, emailField);
                });
            }
        }
        
        // --- FUNCIÓN applySettingsToUI() MEJORADA ---
        
        function applySettingsToUI(settings) {
            try {
                // Aplicar configuraciones básicas
                applyBasicSettings(settings);
                
                // Aplicar configuraciones de interfaz
                applyInterfaceSettings(settings);
                
                // Aplicar configuraciones operacionales
                applyOperationalSettings(settings);
                
                // Aplicar configuraciones de dashboard
                applyDashboardSettings(settings);
                
                // Aplicar configuraciones de notificaciones
                applyNotificationSettings(settings);
                
                // Aplicar configuraciones de backup
                applyBackupSettings(settings);
                
                // Aplicar configuraciones de productividad
                applyProductivitySettings(settings);
                
                // Aplicar configuraciones de display
                applyDisplaySettings(settings);
                
            } catch (error) {
                console.error('Error aplicando configuraciones:', error);
                showNotification('Error al aplicar configuraciones', 'error');
            }
        }
        
        function applyBasicSettings(settings) {
            // Items per page
            if (settings.itemsPerPage) {
                state.itemsPerPage = settings.itemsPerPage;
            }
            
            // Session timeout, audit log y barcode scanning se aplican internamente en otras funciones
        }
        
        function applyInterfaceSettings(settings) {
            if (!settings.interfaceCustomization) return;
            
            const { 
                fontSize, 
                colorTheme, 
                buttonSize, 
                compactSidebar, 
                animationsEnabled 
            } = settings.interfaceCustomization;
            
            // Font size
            if (fontSize) {
                document.body.classList.remove('small-font', 'large-font');
                if (fontSize === 'small') {
                    document.body.classList.add('small-font');
                } else if (fontSize === 'large') {
                    document.body.classList.add('large-font');
                }
            }
            
            // Color theme
            if (colorTheme) {
                applyColorTheme();
            }
            
            // Button size
            if (buttonSize) {
                applyButtonSize();
            }
            
            // Compact sidebar
            if (typeof compactSidebar === 'boolean') {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.classList.toggle('w-64', !compactSidebar);
                    sidebar.classList.toggle('w-20', compactSidebar);
                    
                    sidebar.querySelectorAll('span').forEach(el => {
                        el.classList.toggle('opacity-0', compactSidebar);
                        el.classList.toggle('hidden', compactSidebar);
                    });
                    sidebar.querySelectorAll('.nav-link').forEach(el => {
                        el.classList.toggle('justify-center', compactSidebar);
                    });
                }
            }
            
            // Animations
            if (typeof animationsEnabled === 'boolean') {
                if (!animationsEnabled) {
                    document.body.classList.add('no-animations');
                } else {
                    document.body.classList.remove('no-animations');
                }
            }
        }
        
        function applyOperationalSettings(settings) {
            if (!settings.operationalPreferences) return;
            
            const { 
                defaultTransactionType, 
                recentItemsCount, 
                showRecentItems, 
                confirmBeforeDelete,
                enableKeyboardShortcuts,
                enableBulkOperations,
                showAdvancedFilters
            } = settings.operationalPreferences;
            
            // Default transaction type - guardar en state
            if (defaultTransactionType) {
                state.settings.operationalPreferences.defaultTransactionType = defaultTransactionType;
                // Aplicar a selects de transacciones en la UI si existen
                document.querySelectorAll('#transaction-type, .transaction-type-select').forEach(select => {
                    if (select) select.value = defaultTransactionType;
                });
            }
            
            // Recent items count - guardar en state
            if (recentItemsCount) {
                state.settings.operationalPreferences.recentItemsCount = recentItemsCount;
            }
            
            // Show recent items - guardar en state y aplicar
            if (typeof showRecentItems === 'boolean') {
                state.settings.operationalPreferences.showRecentItems = showRecentItems;
                const recentItemsSection = document.getElementById('recent-items-section');
                if (recentItemsSection) {
                    recentItemsSection.style.display = showRecentItems ? 'block' : 'none';
                }
            }
            
            // Confirm before delete - guardar en state (usado en funciones de eliminación)
            if (typeof confirmBeforeDelete === 'boolean') {
                state.settings.operationalPreferences.confirmBeforeDelete = confirmBeforeDelete;
            }
            
            // Keyboard shortcuts - guardar en state (usado en event listeners)
            if (typeof enableKeyboardShortcuts === 'boolean') {
                state.settings.operationalPreferences.enableKeyboardShortcuts = enableKeyboardShortcuts;
            }
            
            // Bulk operations - guardar en state
            if (typeof enableBulkOperations === 'boolean') {
                state.settings.operationalPreferences.enableBulkOperations = enableBulkOperations;
            }
            
            // Advanced filters - guardar en state
            if (typeof showAdvancedFilters === 'boolean') {
                state.settings.operationalPreferences.showAdvancedFilters = showAdvancedFilters;
                // Mostrar/ocultar filtros avanzados si existen
                const advancedFilters = document.getElementById('advanced-filters');
                if (advancedFilters) {
                    advancedFilters.style.display = showAdvancedFilters ? 'block' : 'none';
                }
            }
        }
        
        function applyDashboardSettings(settings) {
            if (!settings.dashboardCustomization) return;
            
            const { 
                showStockOverview, 
                showRecentTransactions, 
                showLowStockAlerts, 
                showQuickActions,
                chartType,
                defaultDateRange,
                refreshInterval 
            } = settings.dashboardCustomization;
            
            // Dashboard elements - guardar en state para uso en renderDashboard
            if (typeof showStockOverview === 'boolean') {
                state.settings.dashboardCustomization.showStockOverview = showStockOverview;
            }
            
            if (typeof showRecentTransactions === 'boolean') {
                state.settings.dashboardCustomization.showRecentTransactions = showRecentTransactions;
            }
            
            if (typeof showLowStockAlerts === 'boolean') {
                state.settings.dashboardCustomization.showLowStockAlerts = showLowStockAlerts;
            }
            
            if (typeof showQuickActions === 'boolean') {
                state.settings.dashboardCustomization.showQuickActions = showQuickActions;
            }
            
            // Chart settings - guardar para uso en gráficos del dashboard
            if (chartType) {
                state.settings.dashboardCustomization.chartType = chartType;
                // Guardar en localStorage para persistencia
                localStorage.setItem('dashboardChartType', chartType);
            }
            
            if (defaultDateRange) {
                state.settings.dashboardCustomization.defaultDateRange = defaultDateRange;
                localStorage.setItem('dashboardDateRange', defaultDateRange);
            }
            
            if (refreshInterval) {
                state.settings.dashboardCustomization.refreshInterval = refreshInterval;
                // Si hay un intervalo activo, detenerlo y crear uno nuevo
                if (window.dashboardRefreshInterval) {
                    clearInterval(window.dashboardRefreshInterval);
                }
                // Crear nuevo intervalo si estamos en el dashboard
                if (window.location.hash === '#dashboard') {
                    window.dashboardRefreshInterval = setInterval(() => {
                        if (document.getElementById('main-content') && window.renderDashboard) {
                            renderDashboard();
                        }
                    }, refreshInterval * 1000);
                }
            }
        }
        
        function applyNotificationSettings(settings) {
            if (!settings.notificationPreferences) return;
            
            const { 
                lowStockAlert, 
                soundAlerts, 
                popupAlerts, 
                emailNotifications,
                dailyEmail,
                weeklyEmail,
                inactiveItemsDays 
            } = settings.notificationPreferences;
            
            // Las configuraciones de notificaciones se aplican directamente al state
        }
        
        function applyBackupSettings(settings) {
            if (!settings.backup) return;
            
            const { autoBackup, backupFrequency, lastBackupDate } = settings.backup;
            
            // Auto backup - guardar en state
            if (typeof autoBackup === 'boolean') {
                state.settings.backup.autoBackup = autoBackup;
                // La función initializeAutoBackup() se llamará desde handleSaveSettings
            }
            
            // Backup frequency - guardar en state
            if (backupFrequency) {
                state.settings.backup.backupFrequency = backupFrequency;
            }
            
            // Last backup date - guardar en state
            if (lastBackupDate) {
                state.settings.backup.lastBackupDate = lastBackupDate;
            }
        }
        
        function applyProductivitySettings(settings) {
            if (!settings.productivitySettings) return;
            
            const { 
                autoSave, 
                autoSaveInterval, 
                rememberLastPage, 
                enableKeyboardShortcuts 
            } = settings.productivitySettings;
            
            // Las configuraciones de productividad se guardan en el state y se aplican automáticamente
        }
        
        function applyDisplaySettings(settings) {
            if (!settings.displayPreferences) return;
            
            const { 
                tableDensity, 
                defaultView,
                showColumnLines, 
                enableRowHover, 
                showStockBadges 
            } = settings.displayPreferences;
            
            // Table density
            if (tableDensity) {
                document.body.classList.remove('table-compact', 'table-comfortable', 'table-spacious');
                document.body.classList.add(`table-${tableDensity}`);
                // Aplicar estilos CSS
                const style = document.createElement('style');
                style.id = 'table-density-style';
                const densityStyles = {
                    compact: { padding: '0.5rem', fontSize: '0.875rem' },
                    comfortable: { padding: '0.75rem', fontSize: '1rem' },
                    spacious: { padding: '1rem', fontSize: '1.125rem' }
                };
                if (!densityStyles[tableDensity]) return;
                const existingStyle = document.getElementById('table-density-style');
                if (existingStyle) existingStyle.remove();
                document.head.appendChild(style);
            }
            
            // Default view - guardar en state y localStorage
            if (defaultView) {
                state.settings.displayPreferences.defaultView = defaultView;
                localStorage.setItem('defaultInventoryView', defaultView);
            }
            
            // Column lines
            if (typeof showColumnLines === 'boolean') {
                document.body.classList.toggle('show-column-lines', showColumnLines);
                // Aplicar estilos a tablas
                const tables = document.querySelectorAll('table');
                tables.forEach(table => {
                    if (showColumnLines) {
                        table.style.borderCollapse = 'separate';
                        table.style.borderSpacing = '0';
                        table.querySelectorAll('th, td').forEach(cell => {
                            cell.style.borderRight = '1px solid #e5e7eb';
                        });
                    } else {
                        table.querySelectorAll('th, td').forEach(cell => {
                            cell.style.borderRight = 'none';
                        });
                    }
                });
            }
            
            // Row hover
            if (typeof enableRowHover === 'boolean') {
                document.body.classList.toggle('enable-row-hover', enableRowHover);
            }
            
            // Stock badges - aplicar a badges de stock si existen
            if (typeof showStockBadges === 'boolean') {
                state.settings.displayPreferences.showStockBadges = showStockBadges;
                document.body.classList.toggle('show-stock-badges', showStockBadges);
                const stockBadges = document.querySelectorAll('.stock-badge, .stock-status-badge');
                stockBadges.forEach(badge => {
                    badge.style.display = showStockBadges ? 'inline-flex' : 'none';
                });
            }
        }

        // --- SISTEMA DE PRUEBAS Y VERIFICACIÓN ---
        
        function runConfigurationTests() {
            const testResults = {
                timestamp: new Date().toISOString(),
                totalTests: 0,
                passedTests: 0,
                failedTests: 0,
                warnings: 0,
                results: []
            };
            
            // Ejecutar todas las pruebas
            testBasicSettings(testResults);
            testInterfaceSettings(testResults);
            testOperationalSettings(testResults);
            testNotificationSettings(testResults);
            testBackupSettings(testResults);
            testProductivitySettings(testResults);
            testDisplaySettings(testResults);
            testExportImportFunctionality(testResults);
            testValidationSystem(testResults);
            testPreviewSystem(testResults);
            testUIComponents(testResults);
            
            // Calcular estadísticas finales
            testResults.totalTests = testResults.results.length;
            testResults.passedTests = testResults.results.filter(r => r.status === 'passed').length;
            testResults.failedTests = testResults.results.filter(r => r.status === 'failed').length;
            testResults.warnings = testResults.results.filter(r => r.status === 'warning').length;
            
            // Mostrar resultados
            showTestResults(testResults);
            
            return testResults;
        }
        
        function testBasicSettings(testResults) {
            const category = 'Configuraciones Básicas';
            
            // Test items per page
            testResult('Items per page', () => {
                const value = state.settings.itemsPerPage;
                return value >= 5 && value <= 100;
            }, testResults, category);
            
            // Test session timeout
            testResult('Session timeout', () => {
                const value = state.settings.sessionTimeout;
                return value >= 15 && value <= 1440;
            }, testResults, category);
            
            // Test default min stock
            testResult('Default min stock', () => {
                const value = state.settings.defaultMinStock;
                return value >= 0 && value <= 1000;
            }, testResults, category);
            
            // Test default unit
            testResult('Default unit', () => {
                const validUnits = ['pza', 'kg', 'l', 'm', 'm²', 'm³', 'caja', 'pack'];
                return validUnits.includes(state.settings.defaultUnit);
            }, testResults, category);
            
            // Test enable audit log
            testResult('Enable audit log', () => {
                return typeof state.settings.enableAuditLog === 'boolean';
            }, testResults, category);
            
            // Test barcode scanning
            testResult('Barcode scanning', () => {
                return typeof state.settings.barcodeScanning === 'boolean';
            }, testResults, category);
        }
        
        function testInterfaceSettings(testResults) {
            const category = 'Configuraciones de Interfaz';
            
            if (!state.settings.interfaceCustomization) {
                addTestResult('Interface customization object', 'failed', 'Object missing', testResults, category);
                return;
            }
            
            // Test font size
            testResult('Font size', () => {
                const value = state.settings.interfaceCustomization.fontSize;
                return ['small', 'medium', 'large'].includes(value);
            }, testResults, category);
            
            // Test color theme
            testResult('Color theme', () => {
                const value = state.settings.interfaceCustomization.colorTheme;
                return ['blue', 'green', 'purple', 'orange'].includes(value);
            }, testResults, category);
            
            // Test button size
            testResult('Button size', () => {
                const value = state.settings.interfaceCustomization.buttonSize;
                return ['normal', 'large', 'extra-large'].includes(value);
            }, testResults, category);
            
            // Test compact sidebar
            testResult('Compact sidebar', () => {
                return typeof state.settings.interfaceCustomization.compactSidebar === 'boolean';
            }, testResults, category);
            
            // Test animations enabled
            testResult('Animations enabled', () => {
                return typeof state.settings.interfaceCustomization.animationsEnabled === 'boolean';
            }, testResults, category);
        }
        
        function testOperationalSettings(testResults) {
            const category = 'Configuraciones Operacionales';
            
            if (!state.settings.operationalPreferences) {
                addTestResult('Operational preferences object', 'failed', 'Object missing', testResults, category);
                return;
            }
            
            // Test default transaction type
            testResult('Default transaction type', () => {
                const value = state.settings.operationalPreferences.defaultTransactionType;
                return ['Entrada', 'Salida', 'Ajuste'].includes(value);
            }, testResults, category);
            
            // Test recent items count
            testResult('Recent items count', () => {
                const value = state.settings.operationalPreferences.recentItemsCount;
                return value >= 1 && value <= 50;
            }, testResults, category);
            
            // Test show recent items
            testResult('Show recent items', () => {
                return typeof state.settings.operationalPreferences.showRecentItems === 'boolean';
            }, testResults, category);
            
            // Test confirm before delete
            testResult('Confirm before delete', () => {
                return typeof state.settings.operationalPreferences.confirmBeforeDelete === 'boolean';
            }, testResults, category);
            
            // Test keyboard shortcuts
            testResult('Keyboard shortcuts', () => {
                return typeof state.settings.operationalPreferences.enableKeyboardShortcuts === 'boolean';
            }, testResults, category);
        }
        
        function testNotificationSettings(testResults) {
            const category = 'Configuraciones de Notificaciones';
            
            if (!state.settings.notificationPreferences) {
                addTestResult('Notification preferences object', 'failed', 'Object missing', testResults, category);
                return;
            }
            
            // Test low stock alert
            testResult('Low stock alert', () => {
                const value = state.settings.notificationPreferences.lowStockAlert;
                return ['always', 'on_login', 'never'].includes(value);
            }, testResults, category);
            
            // Test sound alerts
            testResult('Sound alerts', () => {
                return typeof state.settings.notificationPreferences.soundAlerts === 'boolean';
            }, testResults, category);
            
            // Test popup alerts
            testResult('Popup alerts', () => {
                return typeof state.settings.notificationPreferences.popupAlerts === 'boolean';
            }, testResults, category);
            
            // Test inactive items days
            testResult('Inactive items days', () => {
                const value = state.settings.notificationPreferences.inactiveItemsDays;
                return value >= 7 && value <= 365;
            }, testResults, category);
            
            // Test email recipients
            testResult('Email recipients validation', () => {
                const emails = state.settings.notificationPreferences.emailRecipients;
                if (!emails) return true; // Optional field
                return validateEmailRecipients(emails);
            }, testResults, category);
        }
        
        function testBackupSettings(testResults) {
            const category = 'Configuraciones de Backup';
            
            if (!state.settings.backup) {
                addTestResult('Backup settings object', 'failed', 'Object missing', testResults, category);
                return;
            }
            
            // Test auto backup
            testResult('Auto backup', () => {
                return typeof state.settings.backup.autoBackup === 'boolean';
            }, testResults, category);
            
            // Test backup frequency
            testResult('Backup frequency', () => {
                const value = state.settings.backup.backupFrequency;
                return ['daily', 'weekly', 'monthly'].includes(value);
            }, testResults, category);
            
            // Test backup functions exist
            testResult('Backup functions', () => {
                return typeof createBackup === 'function' && 
                       typeof restoreBackup === 'function' &&
                       typeof initializeAutoBackup === 'function';
            }, testResults, category);
        }
        
        function testProductivitySettings(testResults) {
            const category = 'Configuraciones de Productividad';
            
            if (!state.settings.productivitySettings) {
                addTestResult('Productivity settings object', 'failed', 'Object missing', testResults, category);
                return;
            }
            
            // Test auto save
            testResult('Auto save', () => {
                return typeof state.settings.productivitySettings.autoSave === 'boolean';
            }, testResults, category);
            
            // Test auto save interval
            testResult('Auto save interval', () => {
                const value = state.settings.productivitySettings.autoSaveInterval;
                return value >= 5 && value <= 300;
            }, testResults, category);
            
            // Test remember last page
            testResult('Remember last page', () => {
                return typeof state.settings.productivitySettings.rememberLastPage === 'boolean';
            }, testResults, category);
        }
        
        function testDisplaySettings(testResults) {
            const category = 'Configuraciones de Display';
            
            if (!state.settings.displayPreferences) {
                addTestResult('Display preferences object', 'failed', 'Object missing', testResults, category);
                return;
            }
            
            // Test table density
            testResult('Table density', () => {
                const value = state.settings.displayPreferences.tableDensity;
                return ['compact', 'comfortable', 'spacious'].includes(value);
            }, testResults, category);
            
            // Test show column lines
            testResult('Show column lines', () => {
                return typeof state.settings.displayPreferences.showColumnLines === 'boolean';
            }, testResults, category);
            
            // Test enable row hover
            testResult('Enable row hover', () => {
                return typeof state.settings.displayPreferences.enableRowHover === 'boolean';
            }, testResults, category);
        }
        
        function testExportImportFunctionality(testResults) {
            const category = 'Funcionalidad Export/Import';
            
            // Test export functions exist
            testResult('Export functions', () => {
                return typeof exportInventory === 'function' && 
                       typeof generateCSV === 'function' &&
                       typeof downloadFile === 'function';
            }, testResults, category);
            
            // Test import functions exist
            testResult('Import functions', () => {
                return typeof importInventory === 'function' && 
                       typeof parseCSV === 'function' &&
                       typeof validateImportData === 'function';
            }, testResults, category);
            
            // Test backup functions exist
            testResult('Backup functions', () => {
                return typeof createBackup === 'function' && 
                       typeof restoreBackup === 'function';
            }, testResults, category);
        }
        
        function testValidationSystem(testResults) {
            const category = 'Sistema de Validaciones';
            
            // Test validation functions exist
            testResult('Validation functions', () => {
                return typeof validateSettings === 'function' && 
                       typeof validateField === 'function' &&
                       typeof validateAndShowFeedback === 'function';
            }, testResults, category);
            
            // Test validation with sample data
            testResult('Sample validation', () => {
                const sampleSettings = {
                    itemsPerPage: 25,
                    sessionTimeout: 480,
                    defaultMinStock: 5,
                    defaultUnit: 'pza',
                    interfaceCustomization: {
                        fontSize: 'medium',
                        colorTheme: 'blue',
                        buttonSize: 'normal'
                    }
                };
                
                const { errors } = validateSettings(sampleSettings);
                return errors.length === 0;
            }, testResults, category);
        }
        
        function testPreviewSystem(testResults) {
            const category = 'Sistema de Preview';
            
            // Test preview functions exist
            testResult('Preview functions', () => {
                return typeof initializeSettingsPreview === 'function' && 
                       typeof applyPreviewChange === 'function' &&
                       typeof updateChangeIndicators === 'function';
            }, testResults, category);
            
            // Test preview event listeners
            testResult('Preview event listeners', () => {
                const previewElements = [
                    'font-size', 'color-theme', 'button-size', 'compact-sidebar'
                ];
                
                return previewElements.every(id => {
                    const element = document.getElementById(id);
                    return element !== null;
                });
            }, testResults, category);
        }
        
        function testUIComponents(testResults) {
            const category = 'Componentes de UI';
            
            // Test settings tabs exist
            testResult('Settings tabs', () => {
                const tabs = document.querySelectorAll('.settings-tab-link');
                return tabs.length > 0;
            }, testResults, category);
            
            // Test save button exists
            testResult('Save button', () => {
                const saveBtn = document.getElementById('save-settings-btn');
                return saveBtn !== null;
            }, testResults, category);
            
            // Test search functionality
            testResult('Search functionality', () => {
                const searchInput = document.getElementById('settings-search');
                return searchInput !== null;
            }, testResults, category);
        }
        
        function testResult(testName, testFunction, testResults, category) {
            try {
                const result = testFunction();
                const status = result ? 'passed' : 'failed';
                const message = result ? 'OK' : 'Failed';
                
                addTestResult(testName, status, message, testResults, category);
            } catch (error) {
                addTestResult(testName, 'failed', `Error: ${error.message}`, testResults, category);
            }
        }
        
        function addTestResult(testName, status, message, testResults, category) {
            testResults.results.push({
                category,
                name: testName,
                status,
                message,
                timestamp: new Date().toISOString()
            });
        }
        
        function showTestResults(testResults) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <i data-lucide="test-tube" class="w-6 h-6 text-blue-600 mr-2"></i>
                            Reporte de Pruebas de Configuraciones
                        </h3>
                        <button class="close-test-results text-gray-500 hover:text-gray-700">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-blue-50 p-4 rounded">
                            <div class="text-2xl font-bold text-blue-600">${testResults.totalTests}</div>
                            <div class="text-sm text-blue-800">Total</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded">
                            <div class="text-2xl font-bold text-green-600">${testResults.passedTests}</div>
                            <div class="text-sm text-green-800">Exitosas</div>
                        </div>
                        <div class="bg-red-50 p-4 rounded">
                            <div class="text-2xl font-bold text-red-600">${testResults.failedTests}</div>
                            <div class="text-sm text-red-800">Fallidas</div>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded">
                            <div class="text-2xl font-bold text-yellow-600">${testResults.warnings}</div>
                            <div class="text-sm text-yellow-800">Advertencias</div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        ${Object.entries(groupBy(testResults.results, 'category')).map(([category, results]) => `
                            <div class="border border-gray-200 rounded">
                                <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                                    <h4 class="font-medium text-gray-900">${category}</h4>
                                </div>
                                <div class="p-4 space-y-2">
                                    ${results.map(result => `
                                        <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0">
                                            <span class="text-sm text-gray-900">${result.name}</span>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-xs text-gray-500">${result.message}</span>
                                                <span class="px-2 py-1 text-xs rounded-full ${
                                                    result.status === 'passed' ? 'bg-green-100 text-green-800' :
                                                    result.status === 'failed' ? 'bg-red-100 text-red-800' :
                                                    'bg-yellow-100 text-yellow-800'
                                                }">
                                                    ${result.status}
                                                </span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button class="close-test-results px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded">
                            Cerrar
                        </button>
                        <button class="export-test-results px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">
                            Exportar Reporte
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            safeCreateIcons();
            
            // Event listeners
            modal.querySelector('.close-test-results').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modal.querySelector('.export-test-results').addEventListener('click', () => {
                exportTestResults(testResults);
            });
        }
        
        function groupBy(array, key) {
            return array.reduce((groups, item) => {
                const group = item[key];
                groups[group] = groups[group] || [];
                groups[group].push(item);
                return groups;
            }, {});
        }
        
        function exportTestResults(testResults) {
            const reportData = {
                timestamp: testResults.timestamp,
                summary: {
                    total: testResults.totalTests,
                    passed: testResults.passedTests,
                    failed: testResults.failedTests,
                    warnings: testResults.warnings,
                    successRate: ((testResults.passedTests / testResults.totalTests) * 100).toFixed(1) + '%'
                },
                results: testResults.results
            };
            
            const data = JSON.stringify(reportData, null, 2);
            const filename = `configuraciones_test_report_${new Date().toISOString().split('T')[0]}.json`;
            
            downloadFile(data, filename, 'application/json');
            showNotification('Reporte de pruebas exportado', 'success');
        }
        
        function quickConfigurationCheck() {
            const issues = [];
            const warnings = [];
            
            // Check for missing configurations
            if (!state.settings.interfaceCustomization) {
                issues.push('Configuraciones de interfaz faltantes');
            }
            
            if (!state.settings.operationalPreferences) {
                issues.push('Configuraciones operacionales faltantes');
            }
            
            if (!state.settings.notificationPreferences) {
                issues.push('Configuraciones de notificaciones faltantes');
            }
            
            // Check for invalid values
            if (state.settings.itemsPerPage < 5 || state.settings.itemsPerPage > 100) {
                issues.push('Items per page fuera de rango válido');
            }
            
            if (state.settings.sessionTimeout < 15 || state.settings.sessionTimeout > 1440) {
                issues.push('Session timeout fuera de rango válido');
            }
            
            // Check for email configuration without recipients
            if (state.settings.notificationPreferences?.dailyEmail && 
                !state.settings.notificationPreferences?.emailRecipients) {
                warnings.push('Email diario habilitado sin destinatarios');
            }
            
            // Show results
            if (issues.length > 0) {
                showNotification(`Problemas encontrados: ${issues.join(', ')}`, 'error');
            } else if (warnings.length > 0) {
                showNotification(`Advertencias: ${warnings.join(', ')}`, 'warning');
            } else {
                showNotification('Todas las configuraciones están correctas', 'success');
            }
            
            return { issues, warnings };
        }
        
        function addTestButtonToSettings() {
            // Agregar botón de verificación rápida en el tab "General"
            const generalTab = document.querySelector('[data-tab="general"]');
            if (generalTab && !document.getElementById('quick-check-btn')) {
                const quickCheckButton = document.createElement('button');
                quickCheckButton.id = 'quick-check-btn';
                quickCheckButton.className = 'px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded flex items-center space-x-2 text-sm';
                quickCheckButton.innerHTML = `
                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                    <span>Verificación Rápida</span>
                `;
                
                quickCheckButton.addEventListener('click', () => {
                    quickConfigurationCheck();
                });
                
                // Insertar en la sección de configuraciones básicas
                const basicSection = generalTab.querySelector('.settings-section');
                if (basicSection) {
                    const header = basicSection.querySelector('.settings-section-header');
                    if (header) {
                        header.appendChild(quickCheckButton);
                        safeCreateIcons();
                    }
                }
            }
            
            // Agregar botón de pruebas completas en el tab "Avanzado"
            const advancedTab = document.querySelector('[data-tab="advanced"]');
            if (advancedTab && !document.getElementById('run-tests-btn')) {
                const testButton = document.createElement('button');
                testButton.id = 'run-tests-btn';
                testButton.className = 'px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded flex items-center space-x-2';
                testButton.innerHTML = `
                    <i data-lucide="test-tube" class="w-4 h-4"></i>
                    <span>Ejecutar Pruebas Completas</span>
                `;
                
                testButton.addEventListener('click', () => {
                    runConfigurationTests();
                });
                
                // Insertar después del botón de guardar
                const saveBtn = document.getElementById('save-settings-btn');
                if (saveBtn && saveBtn.parentNode) {
                    saveBtn.parentNode.insertBefore(testButton, saveBtn.nextSibling);
                    safeCreateIcons();
                }
            }
        }
        
        function addConfigurationStatusIndicator() {
            // Agregar indicador de estado en el header
            const header = document.querySelector('header');
            if (header && !document.getElementById('config-status-indicator')) {
                const statusIndicator = document.createElement('div');
                statusIndicator.id = 'config-status-indicator';
                statusIndicator.className = 'flex items-center space-x-2 px-3 py-1 rounded bg-gray-100 cursor-pointer';
                statusIndicator.innerHTML = `
                    <i data-lucide="settings" class="w-4 h-4 text-gray-600"></i>
                    <span class="text-sm text-gray-700">Estado: Verificando...</span>
                    <i data-lucide="chevron-down" class="w-3 h-3 text-gray-500"></i>
                `;
                
                statusIndicator.addEventListener('click', () => {
                    quickConfigurationCheck();
                });
                
                // Insertar en el header
                const headerContent = header.querySelector('.flex.items-center.justify-between');
                if (headerContent) {
                    headerContent.appendChild(statusIndicator);
                    safeCreateIcons();
                    
                    // Actualizar estado después de un delay
                    setTimeout(() => {
                        updateConfigurationStatus();
                    }, 1000);
                }
            }
        }
        
        function updateConfigurationStatus() {
            const statusIndicator = document.getElementById('config-status-indicator');
            if (!statusIndicator) return;
            
            const { issues, warnings } = quickConfigurationCheck();
            
            let statusText = 'OK';
            let statusColor = 'text-green-600';
            let bgColor = 'bg-green-50';
            let icon = 'check-circle';
            
            if (issues.length > 0) {
                statusText = 'Problemas';
                statusColor = 'text-red-600';
                bgColor = 'bg-red-50';
                icon = 'alert-circle';
            } else if (warnings.length > 0) {
                statusText = 'Advertencias';
                statusColor = 'text-yellow-600';
                bgColor = 'bg-yellow-50';
                icon = 'alert-triangle';
            }
            
            statusIndicator.className = `flex items-center space-x-2 px-3 py-1 rounded ${bgColor} cursor-pointer hover:opacity-80`;
            statusIndicator.innerHTML = `
                <i data-lucide="${icon}" class="w-4 h-4 ${statusColor}"></i>
                <span class="text-sm ${statusColor}">Estado: ${statusText}</span>
                <i data-lucide="chevron-down" class="w-3 h-3 ${statusColor}"></i>
            `;
            
            safeCreateIcons();
        }
        
        window.addEventListener('load', () => {
            setupStaticEventListeners();

            onAuthStateChanged(auth, async (user) => {
                const loginScreen = document.getElementById('login-screen');
                const appContainer = document.getElementById('app-container');

                if (user) {
                    try {
                        loginScreen.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        state.currentUser = user;
                        await fetchUserRole(user.uid);
                        
                        if (state.userRole === 'admin') {
                            await loadSettings();
                        }

                        if (!state.isInitialized) {
                            state.isInitialized = true;
                            await initializeAppState();
                        } else {
                             // If re-authenticating, re-apply settings that affect UI
                            applyInterfaceSettings(state.settings);
                            // Ensure current page is rendered after re-authentication
                            const currentPage = window.location.hash.substring(1) || 'dashboard';
                            navigateTo(currentPage, true);
                        }
                        
                        const isAdmin = state.userRole === 'admin';
                        const usersNavLink = document.getElementById('users-nav-link');
                        if (usersNavLink) {
                            usersNavLink.classList.toggle('hidden', !isAdmin);
                            usersNavLink.setAttribute('aria-hidden', !isAdmin ? 'true' : 'false');
                        }
                        // Settings link is now visible for both admins and operators
                        
                        // Manejar visibilidad del enlace de IA
                        addAINavigation();
                        
                        // Setup mobile FAB event listener
                        setupMobileFAB();
                    } catch (error) {
                        console.error("Firebase Initialization Error:", error);
                        if (error.code === 'permission-denied') {
                            showNotification('Error de permisos: Revisa la configuración de la base de datos.', 'error');
                        } else {
                            showNotification('Error al cargar los datos. Intenta de nuevo.', 'error');
                        }
                    }

                } else {
                    loginScreen.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    document.getElementById('main-content').innerHTML = '';
                    state = getInitialState();
                }
            });
        });
        
        async function fetchUserRole(uid) {
            const userDocRef = doc(db, 'users', uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                state.userRole = userDoc.data().role;
            } else {
                // Set default role for new users
                await setDoc(userDocRef, { email: auth.currentUser.email, role: 'operator' });
                state.userRole = 'operator';
            }
        }

        async function loadSettings() {
            const settingsRef = doc(db, 'settings', 'global');
            const settingsDoc = await getDoc(settingsRef);
            if (settingsDoc.exists()) {
                state.settings = { ...state.settings, ...settingsDoc.data() };
                state.itemsPerPage = state.settings.itemsPerPage || 10;
                
                // Inicializar backup automático después de cargar configuraciones
                initializeAutoBackup();
                
                // Inicializar sistema de notificaciones
                setupNotificationSchedules();
                
                // Inicializar sistema de preview de configuraciones
                setTimeout(() => {
                    initializeSettingsPreview();
                    setupSettingsSearch();
                    setupFieldValidation();
                    addTestButtonToSettings();
                    addConfigurationStatusIndicator();
                    
                    // Ejecutar verificación rápida
                    quickConfigurationCheck();
                }, 500); // Delay para asegurar que el DOM esté listo
            } else if (state.userRole === 'admin') {
                // Create initial settings document if it doesn't exist
                await setDoc(settingsRef, state.settings);
            }
        }

        function displayAuthError(errorCode) {
            const errorMessage = document.getElementById('auth-error-message');
            let message = "Ocurrió un error. Inténtelo de nuevo.";
            let iconName = "alert-circle";

            switch(errorCode) {
                case "auth/user-not-found":
                case "auth/wrong-password":
                case "auth/invalid-credential":
                    message = "Correo o contraseña incorrectos.";
                    iconName = "x-circle";
                    break;
                case "auth/invalid-input":
                    message = "Por favor, complete todos los campos.";
                    iconName = "alert-triangle";
                    break;
                case "auth/too-many-requests":
                    message = "Demasiados intentos fallidos. Inténtelo más tarde.";
                    iconName = "lock";
                    break;
                case "auth/network-request-failed":
                    message = "Error de conexión. Verifique su internet.";
                    iconName = "wifi-off";
                    break;
            }
            
            errorMessage.innerHTML = `
                <div class="flex items-center justify-center space-x-2">
                    <i data-lucide="${iconName}" class="h-5 w-5"></i>
                    <span>${message}</span>
                </div>
            `;
            errorMessage.classList.remove('hidden');
            safeCreateIcons();
        }

        async function handleSuccessfulLogin(user) {
            const loginScreen = document.getElementById('login-screen');
            const appContainer = document.getElementById('app-container');

            try {
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                state.currentUser = user;
                
                await fetchUserRole(user.uid);
                
                if (state.userRole === 'admin') {
                    await loadSettings();
                }

                if (!state.isInitialized) {
                    state.isInitialized = true;
                    await initializeAppState();
                } else {
                    applyInterfaceSettings(state.settings);
                }
                
                const isAdmin = state.userRole === 'admin';
                const usersNavLink = document.getElementById('users-nav-link');
                if (usersNavLink) {
                    usersNavLink.classList.toggle('hidden', !isAdmin);
                    usersNavLink.setAttribute('aria-hidden', !isAdmin ? 'true' : 'false');
                }
                
                // Manejar visibilidad del enlace de IA
                addAINavigation();
                
                // Setup mobile FAB event listener
                setupMobileFAB();
                
            } catch (error) {
                // Show error but don't reset login state
                displayAuthError('auth/unknown-error');
            }
        }

        async function initializeAppState() {
            applyInterfaceSettings(state.settings);
            
            // Ensure main-content is visible and ready
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                mainContent.style.display = 'block';
            }
            
            const page = window.location.hash.substring(1) || 'dashboard';
            navigateTo(page); 
            await checkAndLoadInitialData();
            setupRealtimeListeners();
            
            // Apply enhanced UI styles
            applyEnhancedStyles();
            
            // Add AI navigation link for admin users
            addAINavigation();
            
            // Also try again after a delay to ensure everything is loaded
            setTimeout(() => {
                addAINavigation();
                applyEnhancedStyles(); // Re-apply styles after content loads
                // Re-render current page to ensure content is displayed
                const currentPage = window.location.hash.substring(1) || 'dashboard';
                if (currentPage && state.isInitialized) {
                    navigateTo(currentPage, true);
                }
            }, 500);
        }

        async function checkAndLoadInitialData() {
            const inventoryRef = collection(db, 'inventory');
            const snapshot = await getDocs(query(inventoryRef));
            if (snapshot.empty) {
                showNotification('Cargando inventario...', 'info');
                const initialInventory = getFullInventoryList(); 
                if (initialInventory.length === 0) {
                    showNotification('No hay artículos en el inventario. Agrega algunos en la sección de inventario.', 'info');
                    return;
                }
                const batch = writeBatch(db);
                initialInventory.forEach(item => {
                    const docRef = doc(collection(db, 'inventory'));
                    batch.set(docRef, { ...item });
                });
                await batch.commit();
                showNotification('Inventario cargado correctamente.', 'success');
                
                // Construir índice de búsqueda después de cargar inventario inicial
                buildSearchIndex();
            }
        }
        
        function setupRealtimeListeners() {
            // CRITICAL FIX: Clean up existing listeners before creating new ones to prevent duplicate listeners
            // This prevents infinite Promise.then chains caused by multiple listeners firing simultaneously
            if (unsubscribeFunctions.length > 0) {
                cleanupListeners();
            }
            
            const handleSnapshotError = (collectionName, error) => {
                console.error(`Error fetching ${collectionName}:`, error);
                showNotification(`Error al cargar ${collectionName}. Intenta de nuevo.`, 'error');
            };

            const unsubscribeInventory = onSnapshot(collection(db, 'inventory'), (snapshot) => {
                state.inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.description.localeCompare(b.description));
                
                // Reconstruir índice de búsqueda cuando cambia el inventario
                buildSearchIndex();
                
                const uniqueCategoriesFromInventory = [...new Set(state.inventory.map(item => item.category))];
                const categoriesFromSettings = state.settings.categories || [];
                state.categories = ['Todas', ...new Set([...uniqueCategoriesFromInventory, ...categoriesFromSettings])].sort();

                const currentPage = window.location.hash.substring(1) || 'dashboard';
                if (state.isInitialized) {
                    if (currentPage === 'inventory' || currentPage === 'settings') {
                        navigateTo(currentPage, true);
                    }
                    if (currentPage === 'dashboard') renderDashboardView();
                }
            }, (error) => handleSnapshotError('inventario', error));
            unsubscribeFunctions.push(unsubscribeInventory);

            const loansQuery = query(collection(db, 'loans'), where('returnedAt', '==', null));
            const unsubscribeLoans = onSnapshot(loansQuery, (snapshot) => {
                state.activeLoans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.isInitialized && window.location.hash === '#active-loans') renderActiveLoansView();
            }, (error) => handleSnapshotError('préstamos activos', error));
            unsubscribeFunctions.push(unsubscribeLoans);

            const unsubscribeTransactions = onSnapshot(collection(db, 'transactions'), (snapshot) => {
                state.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.isInitialized) {
                    const currentPage = window.location.hash.substring(1);
                    if (currentPage === 'history') renderHistoryView();
                    if (currentPage === 'dashboard') renderDashboardView();
                }
            }, (error) => handleSnapshotError('transacciones', error));
            unsubscribeFunctions.push(unsubscribeTransactions);

            const unsubscribeShoppingList = onSnapshot(collection(db, 'shoppingList'), (snapshot) => {
                state.shoppingList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateShoppingListCount();
                if (state.isInitialized && window.location.hash === '#shopping-list') renderShoppingListView();
            }, (error) => handleSnapshotError('lista de compras', error));
            unsubscribeFunctions.push(unsubscribeShoppingList);
            
            if (state.userRole === 'admin') {
                const unsubscribeSettings = onSnapshot(doc(db, 'settings', 'global'), (docSnap) => {
                    if (docSnap.exists()) {
                        const newSettings = { ...getInitialState().settings, ...docSnap.data() };
                        const oldSettings = state.settings;
                        
                        // CRITICAL FIX: Prevent infinite loops by checking if settings actually changed
                        // Compare serialized versions to detect real changes
                        const oldSettingsStr = JSON.stringify(oldSettings);
                        const newSettingsStr = JSON.stringify(newSettings);
                        
                        // Only process if settings actually changed
                        if (oldSettingsStr !== newSettingsStr) {
                            state.settings = newSettings;
                            state.itemsPerPage = state.settings.itemsPerPage || 10;
                            
                            // Apply all settings to UI
                            applySettingsToUI(newSettings);
                            
                            const uniqueCategoriesFromInventory = [...new Set(state.inventory.map(item => item.category))];
                            const categoriesFromSettings = state.settings.categories || [];
                            state.categories = ['Todas', ...new Set([...uniqueCategoriesFromInventory, ...categoriesFromSettings])].sort();

                            const currentPage = window.location.hash.substring(1);
                            if (state.isInitialized) {
                               if(currentPage === 'settings' || currentPage === 'inventory') {
                                   navigateTo(currentPage, true);
                               }
                               if(currentPage === 'dashboard') renderDashboardView();
                            }
                        }
                    }
                }, (error) => handleSnapshotError('configuraciones', error));
                unsubscribeFunctions.push(unsubscribeSettings);

                const unsubscribeUsers = onSnapshot(collection(db, 'users'), (snapshot) => {
                    state.allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if(state.isInitialized && window.location.hash === '#users') renderUsersView();
                }, (error) => handleSnapshotError('usuarios', error));
                unsubscribeFunctions.push(unsubscribeUsers);
            }
        }

        // --- NAVEGACIÓN Y RENDERIZADO DE VISTAS ---
        function navigateTo(page, isRefresh = false) {
            const pageTitle = document.getElementById('page-title');
            const searchContainer = document.getElementById('search-input').parentElement.parentElement;
            
            const searchablePages = ['inventory', 'active-loans', 'history'];
            searchContainer.classList.toggle('hidden', !searchablePages.includes(page));

            if (!isRefresh) {
                 updateActiveNavLink(page);
            }

            switch (page) {
                case 'dashboard':
                    if (!isRefresh) pageTitle.textContent = 'Dashboard';
                    renderDashboardView();
                    break;
                case 'inventory':
                    if (!isRefresh) pageTitle.textContent = 'Inventario';
                    renderInventoryView();
                    break;
                case 'active-loans':
                    if (!isRefresh) pageTitle.textContent = 'Préstamos Activos';
                    renderActiveLoansView();
                    break;
                case 'history':
                    if (!isRefresh) pageTitle.textContent = 'Historial';
                    renderHistoryView();
                    break;
                case 'reports':
                    if (!isRefresh) pageTitle.textContent = 'Reportes';
                    renderReportsView();
                    break;
                case 'shopping-list':
                    if (!isRefresh) pageTitle.textContent = 'Lista de Compras';
                    renderShoppingListView();
                    break;
                case 'users':
                    if (state.userRole === 'admin') {
                        if (!isRefresh) pageTitle.textContent = 'Usuarios';
                        renderUsersView();
                    } else { window.location.hash = 'dashboard'; }
                    break;
                case 'settings':
                    if (!isRefresh) pageTitle.textContent = state.userRole === 'admin' ? 'Ajustes' : 'Configuración';
                    renderSettingsView();
                    break;
                default:
                    window.location.hash = 'dashboard';
            }
            safeCreateIcons();
            // Enhance mobile tables and experience after navigation
            setTimeout(() => {
                enhanceMobileTables();
                enhanceMobileExperience();
                applyEnhancedStyles(); // Apply enhanced UI styles
            }, 100);
        }

        function updateActiveNavLink(page) {
            document.querySelectorAll('#main-nav .nav-link').forEach(link => {
                link.classList.remove('active');
                link.removeAttribute('aria-current');
                if (link.getAttribute('href') === `#${page}`) {
                    link.classList.add('active');
                    link.setAttribute('aria-current', 'page');
                }
            });
        }
        
        // Function to update search results count for accessibility
        function updateSearchResultsCount(count, total) {
            const resultsCountEl = document.getElementById('search-results-count');
            if (resultsCountEl) {
                if (count === 0) {
                    resultsCountEl.textContent = 'No se encontraron resultados de búsqueda';
                } else {
                    resultsCountEl.textContent = `Se encontraron ${count} ${count === 1 ? 'resultado' : 'resultados'} de ${total} artículos`;
                }
            }
        }
        
        // Function to update ARIA live region
        function announceToScreenReader(message, priority = 'polite') {
            const liveRegion = document.getElementById('aria-live-region');
            if (liveRegion) {
                liveRegion.setAttribute('aria-live', priority);
                liveRegion.textContent = message;
                // Clear after announcement
                setTimeout(() => {
                    liveRegion.textContent = '';
                }, 1000);
            }
        }
        
        // --- IMPLEMENTACIÓN DE AJUSTES DE INTERFAZ ---
        
        function applyColorTheme() {
            const theme = state.settings.interfaceCustomization?.colorTheme || 'blue';
            const root = document.documentElement;
            
            // Remove existing theme classes
            root.classList.remove('theme-blue', 'theme-green', 'theme-purple', 'theme-orange');
            
            // Add new theme class
            root.classList.add(`theme-${theme}`);
            
            // Apply CSS custom properties for the theme
            const themes = {
                blue: {
                    '--primary-color': '#3b82f6',
                    '--primary-hover': '#2563eb',
                    '--primary-light': '#dbeafe',
                    '--primary-dark': '#1e40af',
                    '--sidebar-active-bg': '#3b82f6'
                },
                green: {
                    '--primary-color': '#10b981',
                    '--primary-hover': '#059669',
                    '--primary-light': '#d1fae5',
                    '--primary-dark': '#047857',
                    '--sidebar-active-bg': '#10b981'
                },
                purple: {
                    '--primary-color': '#8b5cf6',
                    '--primary-hover': '#7c3aed',
                    '--primary-light': '#ede9fe',
                    '--primary-dark': '#5b21b6',
                    '--sidebar-active-bg': '#8b5cf6'
                },
                orange: {
                    '--primary-color': '#f59e0b',
                    '--primary-hover': '#d97706',
                    '--primary-light': '#fef3c7',
                    '--primary-dark': '#92400e',
                    '--sidebar-active-bg': '#f59e0b'
                }
            };
            
            const currentTheme = themes[theme];
            Object.entries(currentTheme).forEach(([property, value]) => {
                root.style.setProperty(property, value);
            });
        }
        
        function applyButtonSize() {
            const buttonSize = state.settings.interfaceCustomization?.buttonSize || 'normal';
            const root = document.documentElement;
            
            // Remove existing button size classes
            root.classList.remove('button-size-normal', 'button-size-large', 'button-size-extra-large');
            
            // Add new button size class
            root.classList.add(`button-size-${buttonSize}`);
            
            // Apply CSS custom properties for button sizes
            const buttonSizes = {
                normal: {
                    '--button-padding': '0.5rem 1rem',
                    '--button-font-size': '0.875rem',
                    '--button-height': '2.5rem'
                },
                large: {
                    '--button-padding': '0.75rem 1.5rem',
                    '--button-font-size': '1rem',
                    '--button-height': '3rem'
                },
                'extra-large': {
                    '--button-padding': '1rem 2rem',
                    '--button-font-size': '1.125rem',
                    '--button-height': '3.5rem'
                }
            };
            
            const currentSize = buttonSizes[buttonSize];
            Object.entries(currentSize).forEach(([property, value]) => {
                root.style.setProperty(property, value);
            });
        }

        // --- VISTAS ---
        function renderDashboardView() {
            const mainContent = document.getElementById('main-content');
            const { dashboardCustomization } = state.settings;

            const lowStockCount = state.inventory.filter(item => item.stock < item.minStock).length;
            const activeLoansCount = state.activeLoans.length;
            const totalTransactions = state.transactions.length;

            mainContent.innerHTML = `
                <div class="space-y-8">
                    <!-- Welcome Section -->
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-8 text-white shadow-2xl" style="box-shadow: var(--elevation-4);">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold mb-2">¡Bienvenido de vuelta!</h2>
                                <p class="text-gray-300 text-lg">Aquí tienes un resumen de tu inventario</p>
                            </div>
                            <div class="hidden md:block">
                                <i data-lucide="trending-up" class="h-16 w-16 text-white/30"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                        <div class="bg-white p-6 rounded-xl border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-200 group cursor-pointer" 
                             style="box-shadow: var(--shadow-md);" 
                             title="Total de artículos en el inventario">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-gray-600 mb-1">Artículos Totales</p>
                                    <p class="text-3xl font-bold text-gray-900 group-hover:scale-110 transition-transform duration-300">${state.inventory.length}</p>
                                    ${state.inventory.length > 0 ? `<p class="text-xs text-gray-500 mt-1 flex items-center"><i data-lucide="check-circle" class="h-3 w-3 mr-1 text-green-600"></i>${state.inventory.filter(i => i.stock > 0).length} con stock disponible</p>` : ''}
                                </div>
                                <div class="h-16 w-16 rounded-2xl bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center group-hover:scale-125 group-hover:rotate-6 transition-all duration-300 shadow-lg" style="box-shadow: var(--shadow-lg);">
                                    <i data-lucide="package" class="h-8 w-8 text-blue-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-200 group cursor-pointer" 
                             style="box-shadow: var(--shadow-md);" 
                             title="Artículos con stock por debajo del mínimo">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-gray-600 mb-1">Stock Bajo</p>
                                    <p class="text-3xl font-bold text-red-600 group-hover:scale-110 transition-transform duration-300">${lowStockCount}</p>
                                    ${lowStockCount > 0 ? `<p class="text-xs text-red-500 mt-1 flex items-center"><i data-lucide="alert-triangle" class="h-3 w-3 mr-1"></i>Requiere atención</p>` : '<p class="text-xs text-green-600 mt-1 flex items-center"><i data-lucide="check-circle" class="h-3 w-3 mr-1"></i>Todo en orden</p>'}
                                </div>
                                <div class="h-16 w-16 rounded-2xl bg-gradient-to-br from-red-100 to-red-200 flex items-center justify-center group-hover:scale-125 group-hover:rotate-6 transition-all duration-300 shadow-lg" style="box-shadow: var(--shadow-lg);">
                                    <i data-lucide="alert-triangle" class="h-8 w-8 text-red-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-200 group cursor-pointer" 
                             style="box-shadow: var(--shadow-md);" 
                             title="Préstamos activos pendientes de devolución">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-gray-600 mb-1">Préstamos Activos</p>
                                    <p class="text-3xl font-bold text-green-600 group-hover:scale-110 transition-transform duration-300">${activeLoansCount}</p>
                                    ${activeLoansCount > 0 ? `<p class="text-xs text-gray-500 mt-1 flex items-center"><i data-lucide="clock" class="h-3 w-3 mr-1"></i>En seguimiento</p>` : '<p class="text-xs text-gray-500 mt-1 flex items-center"><i data-lucide="check" class="h-3 w-3 mr-1"></i>Sin préstamos</p>'}
                                </div>
                                <div class="h-16 w-16 rounded-2xl bg-gradient-to-br from-green-100 to-green-200 flex items-center justify-center group-hover:scale-125 group-hover:rotate-6 transition-all duration-300 shadow-lg" style="box-shadow: var(--shadow-lg);">
                                    <i data-lucide="arrow-right-left" class="h-8 w-8 text-green-600"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-200 group cursor-pointer" 
                             style="box-shadow: var(--shadow-md);" 
                             title="Total de transacciones registradas">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-gray-600 mb-1">Transacciones</p>
                                    <p class="text-3xl font-bold text-purple-600 group-hover:scale-110 transition-transform duration-300">${totalTransactions}</p>
                                    ${totalTransactions > 0 ? `<p class="text-xs text-gray-500 mt-1 flex items-center"><i data-lucide="file-text" class="h-3 w-3 mr-1"></i>Registradas en total</p>` : '<p class="text-xs text-gray-500 mt-1 flex items-center"><i data-lucide="file-x" class="h-3 w-3 mr-1"></i>Sin transacciones</p>'}
                                </div>
                                <div class="h-16 w-16 rounded-2xl bg-gradient-to-br from-purple-100 to-purple-200 flex items-center justify-center group-hover:scale-125 group-hover:rotate-6 transition-all duration-300 shadow-lg" style="box-shadow: var(--shadow-lg);">
                                    <i data-lucide="activity" class="h-8 w-8 text-purple-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Dashboard Content -->
                    <div id="dashboard-widgets" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6"></div>
                </div>
            `;
            
            const widgetsContainer = document.getElementById('dashboard-widgets');
            let widgetsHTML = '';
            
            if (dashboardCustomization.showQuickActions) {
                 const keyboardShortcutsEnabled = state.settings?.operationalPreferences?.enableKeyboardShortcuts || state.settings?.productivitySettings?.enableKeyboardShortcuts || false;
                 const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                 const modifierKey = isMac ? '⌘' : 'Ctrl';
                 
                 widgetsHTML += `
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 col-span-full lg:col-span-2" style="box-shadow: var(--shadow-lg);">
                        <div class="flex items-center mb-6">
                            <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-indigo-100 to-indigo-200 flex items-center justify-center mr-3 shadow-md">
                                <i data-lucide="zap" class="h-5 w-5 text-indigo-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900">Acciones Rápidas</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button id="quick-add-item" 
                                    class="quick-action-card action-add-item quick-action-tooltip" 
                                    data-tooltip="Agregar un nuevo artículo al inventario"
                                    aria-label="Agregar Artículo">
                                <div class="quick-action-icon">
                                    <i data-lucide="plus"></i>
                                </div>
                                <div class="quick-action-title">Agregar Artículo</div>
                                <div class="quick-action-description">Registra un nuevo artículo en el sistema de inventario</div>
                                ${state.userRole === 'admin' ? '<div class="quick-action-admin-badge"><i data-lucide="shield" class="w-3 h-3"></i> Solo Admin</div>' : ''}
                                ${keyboardShortcutsEnabled ? `
                                    <div class="quick-action-shortcut">
                                        <span class="quick-action-shortcut-key">${modifierKey}</span>
                                        <span>+</span>
                                        <span class="quick-action-shortcut-key">1</span>
                                    </div>
                                ` : ''}
                            </button>
                            <button id="quick-add-entry" 
                                    class="quick-action-card action-add-entry quick-action-tooltip" 
                                    data-tooltip="Registrar una nueva entrada de inventario"
                                    aria-label="Nueva Entrada">
                                <div class="quick-action-icon">
                                    <i data-lucide="plus-circle"></i>
                                </div>
                                <div class="quick-action-title">Nueva Entrada</div>
                                <div class="quick-action-description">Registra una entrada de stock al inventario</div>
                                ${keyboardShortcutsEnabled ? `
                                    <div class="quick-action-shortcut">
                                        <span class="quick-action-shortcut-key">${modifierKey}</span>
                                        <span>+</span>
                                        <span class="quick-action-shortcut-key">2</span>
                                    </div>
                                ` : ''}
                            </button>
                            <button id="quick-add-checkout" 
                                    class="quick-action-card action-checkout quick-action-tooltip" 
                                    data-tooltip="Realizar un intercambio o préstamo"
                                    aria-label="Intercambio">
                                <div class="quick-action-icon">
                                    <i data-lucide="arrow-right-left"></i>
                                </div>
                                <div class="quick-action-title">Intercambio</div>
                                <div class="quick-action-description">Registra un préstamo o intercambio de artículo</div>
                                ${keyboardShortcutsEnabled ? `
                                    <div class="quick-action-shortcut">
                                        <span class="quick-action-shortcut-key">${modifierKey}</span>
                                        <span>+</span>
                                        <span class="quick-action-shortcut-key">3</span>
                                    </div>
                                ` : ''}
                            </button>
                        </div>
                    </div>
                 `;
            }

            if (dashboardCustomization.showStockOverview) {
                widgetsHTML += `
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-200" style="box-shadow: var(--shadow-lg);">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center mr-3 shadow-md">
                                    <i data-lucide="bar-chart-3" class="h-5 w-5 text-blue-600"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-900">Artículos Más Utilizados</h3>
                            </div>
                        </div>
                        <div class="h-64">
                            <canvas id="topConsumablesChart"></canvas>
                        </div>
                    </div>`;
            }
            if (dashboardCustomization.showLowStockAlerts) {
                 widgetsHTML += `
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-200" style="box-shadow: var(--shadow-lg);">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-red-100 to-red-200 flex items-center justify-center mr-3 shadow-md">
                                    <i data-lucide="pie-chart" class="h-5 w-5 text-red-600"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-900">Herramientas Reportadas</h3>
                            </div>
                        </div>
                        <div class="h-64">
                            <canvas id="topReportedChart"></canvas>
                        </div>
                    </div>`;
            }
            if (dashboardCustomization.showRecentTransactions) {
                widgetsHTML += `
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-200" style="box-shadow: var(--shadow-lg);">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-green-100 to-green-200 flex items-center justify-center mr-3 shadow-md">
                                    <i data-lucide="users" class="h-5 w-5 text-green-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900">Empleados con Más Préstamos</h3>
                            </div>
                        </div>
                        <div class="h-64">
                            <canvas id="topEmployeesChart"></canvas>
                        </div>
                    </div>`;
            }

            // Nuevo widget: Tendencias Temporales
            widgetsHTML += `
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-100 hover:shadow-lg transition-shadow duration-300 col-span-full lg:col-span-2">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div class="h-8 w-8 rounded-lg bg-gradient-to-br from-indigo-100 to-indigo-200 flex items-center justify-center mr-3">
                                <i data-lucide="trending-up" class="h-4 w-4 text-indigo-600"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900">Tendencias de Transacciones (30 días)</h3>
                        </div>
                    </div>
                    <div class="h-80">
                        <canvas id="transactionsTrendChart"></canvas>
                    </div>
                </div>`;

            // Nuevo widget: Distribución por Categorías
            widgetsHTML += `
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-100 hover:shadow-lg transition-shadow duration-300">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div class="h-8 w-8 rounded-lg bg-gradient-to-br from-purple-100 to-purple-200 flex items-center justify-center mr-3">
                                <i data-lucide="layers" class="h-4 w-4 text-purple-600"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900">Distribución por Categorías</h3>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="categoryDistributionChart"></canvas>
                    </div>
                </div>`;

            if(widgetsHTML === ''){
                widgetsContainer.innerHTML = `
                    <div class="bg-white p-12 rounded shadow-sm border border-gray-100 text-center col-span-full">
                        <div class="h-16 w-16 rounded bg-gray-100 flex items-center justify-center mx-auto mb-6">
                            <i data-lucide="layout-dashboard" class="h-8 w-8 text-gray-400"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">El Panel de Control está vacío</h3>
                        <p class="text-gray-500 mb-6">Personaliza tu dashboard habilitando widgets desde la configuración</p>
                        <a href="#settings" class="inline-flex items-center px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded transition-colors duration-200">
                            <i data-lucide="settings" class="h-4 w-4 mr-2"></i>
                            Ir a Configuración
                        </a>
                    </div>
                `;
            } else {
                 widgetsContainer.innerHTML = widgetsHTML;
                 generateCharts();
                 if (dashboardCustomization.showQuickActions) {
                     // Quick action: Add Item
                     const quickAddItemBtn = document.getElementById('quick-add-item');
                     if (quickAddItemBtn) {
                         const handleAddItem = () => {
                             if (state.userRole === 'admin') {
                                 showNewItemModal();
                             } else {
                                 showNotification("Solo los administradores pueden agregar artículos.", "info");
                             }
                         };
                         quickAddItemBtn.addEventListener('click', handleAddItem);
                         // Store handler for keyboard shortcut
                         quickAddItemBtn._quickActionHandler = handleAddItem;
                     }
                     
                     // Quick action: Add Entry
                     const quickAddEntryBtn = document.getElementById('quick-add-entry');
                     if (quickAddEntryBtn) {
                         const handleAddEntry = () => showEntryModal();
                         quickAddEntryBtn.addEventListener('click', handleAddEntry);
                         quickAddEntryBtn._quickActionHandler = handleAddEntry;
                     }
                     
                     // Quick action: Checkout
                     const quickAddCheckoutBtn = document.getElementById('quick-add-checkout');
                     if (quickAddCheckoutBtn) {
                         const handleCheckout = () => showCheckoutModal();
                         quickAddCheckoutBtn.addEventListener('click', handleCheckout);
                         quickAddCheckoutBtn._quickActionHandler = handleCheckout;
                     }
                 }
            }
            safeCreateIcons();
        }

        function renderInventoryView() {
            const mainContent = document.getElementById('main-content');
            
            let filteredInventory = state.inventory;

            // Filtro de categoría (rápido con índice)
            if (state.activeCategory !== 'Todas') {
                filteredInventory = filteredInventory.filter(item => item.category === state.activeCategory);
            }

            // Filtro por resultados de búsqueda IA (tiene prioridad)
            if (state.aiSearchResults && state.aiSearchResults.length > 0) {
                filteredInventory = filteredInventory.filter(item => 
                    state.aiSearchResults.includes(item.id)
                );
            }
            // Búsqueda avanzada con operadores lógicos (solo si no hay búsqueda IA activa)
            else if (state.searchTerm) {
                filteredInventory = filterInventoryWithAdvancedSearch(filteredInventory, state.searchTerm);
            }

            if (state.inventoryFilter === 'low') {
                filteredInventory = filteredInventory.filter(item => item.stock < item.minStock);
            }

            const totalPages = Math.ceil(filteredInventory.length / state.itemsPerPage);
            state.currentPage = Math.min(state.currentPage, totalPages) || 1;
            const paginatedInventory = filteredInventory.slice((state.currentPage - 1) * state.itemsPerPage, state.currentPage * state.itemsPerPage);

            // Update search results count for accessibility
            updateSearchResultsCount(filteredInventory.length, state.inventory.length);

            const isAdmin = state.userRole === 'admin';
            
            const filterButtonClasses = (filter) => `px-4 py-2 text-sm font-medium rounded-md ${state.inventoryFilter === filter ? 'bg-indigo-600 text-white' : 'bg-white themed-text hover:bg-gray-100'}`;

            mainContent.innerHTML = `
                <div class="space-y-6 animate-fade-in">
                    <!-- Header Section -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 animate-fade-in-up">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-900">Inventario</h2>
                            <p class="text-gray-600 mt-1">Gestiona tu inventario de forma eficiente</p>
                        </div>
                        <div class="flex space-x-3 relative z-0">
                            <button id="new-item-btn" class="relative z-0 text-white font-semibold py-4 px-8 rounded-xl flex items-center justify-center transition-all duration-200 min-h-[60px] min-w-[60px] hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl" style="background-color: var(--color-primary-accent); box-shadow: var(--shadow-md);" aria-label="Agregar nuevo artículo${isAdmin ? '' : ' (solo administrador)'}" ${!isAdmin ? 'aria-disabled="true" disabled' : ''}>
                                <i data-lucide="plus" class="h-8 w-8" aria-hidden="true"></i>
                            </button>
                            <button id="bulk-add-btn" class="relative z-0 text-white font-semibold py-4 px-6 rounded-xl flex items-center justify-center transition-all duration-200 min-h-[60px] hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl" style="background-color: var(--color-primary-accent); box-shadow: var(--shadow-md);" aria-label="Agregar varios artículos${isAdmin ? '' : ' (solo administrador)'}" ${!isAdmin ? 'aria-disabled="true" disabled' : ''}>
                                <i data-lucide="layers" class="h-6 w-6 mr-2" aria-hidden="true"></i>
                                <span class="hidden sm:inline">Agregar Varios</span>
                            </button>
                        </div>
                    </div>

                    <!-- Filters and Categories -->
                    <div class="flex flex-col lg:flex-row gap-6">
                        <!-- Categories Sidebar -->
                        <div class="lg:w-1/4">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100" style="box-shadow: var(--shadow-lg);">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-gray-900">Categorías</h3>
                                    <button id="add-category-btn-inventory" class="bg-green-600 hover:bg-green-700 text-white p-3 rounded-xl transition-all duration-200 min-h-[48px] min-w-[48px] flex items-center justify-center shadow-md hover:shadow-lg hover:scale-110 active:scale-95" title="Agregar nueva categoría">
                                        <i data-lucide="plus" class="h-6 w-6"></i>
                                    </button>
                                </div>
                                <ul id="category-list" class="space-y-2">
                                    <li>
                                        <a href="#" class="category-filter flex items-center px-4 py-3 rounded-xl transition-all duration-200 ${state.activeCategory === 'Todas' ? 'bg-gray-900 text-white font-semibold shadow-md' : 'hover:bg-gray-100 text-gray-700 hover:shadow-sm'}" data-category="Todas">
                                            <i data-lucide="grid-3x3" class="h-4 w-4 mr-3"></i>
                                            Todas
                                        </a>
                                    </li>
                                    ${state.categories.map(cat => `
                                        <li>
                                            <a href="#" class="category-filter flex items-center px-4 py-3 rounded-xl transition-all duration-200 ${state.activeCategory === cat ? 'bg-gray-900 text-white font-semibold shadow-md' : 'hover:bg-gray-100 text-gray-700 hover:shadow-sm'}" data-category="${cat}">
                                                <i data-lucide="folder" class="h-4 w-4 mr-3"></i>
                                                ${cat}
                                            </a>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>

                        <!-- Main Content -->
                        <div class="lg:w-3/4">
                            <!-- Filter Buttons -->
                            <div class="flex flex-wrap gap-2 mb-6">
                                <button class="inventory-filter-btn px-5 py-2.5 text-sm font-semibold rounded-xl transition-all duration-200 ${state.inventoryFilter === 'all' ? 'text-white shadow-md' : 'text-[#374151] hover:bg-gray-100 hover:shadow-sm'}" data-filter="all" style="${state.inventoryFilter === 'all' ? 'background-color: var(--color-primary-accent); box-shadow: var(--shadow-md);' : 'background-color: #E5E7EB;'}">
                                    <i data-lucide="grid-3x3" class="h-4 w-4 mr-2"></i>
                                    Todos
                                </button>
                                <button class="inventory-filter-btn px-5 py-2.5 text-sm font-semibold rounded-xl transition-all duration-200 ${state.inventoryFilter === 'low' ? 'bg-red-600 text-white shadow-md' : 'text-[#374151] hover:bg-gray-100 hover:shadow-sm'}" data-filter="low" style="${state.inventoryFilter === 'low' ? 'box-shadow: var(--shadow-md);' : 'background-color: #E5E7EB;'}">
                                    <i data-lucide="alert-triangle" class="h-4 w-4 mr-2"></i>
                                    Stock Bajo
                                </button>
                                
                                <!-- Chip de búsqueda tradicional -->
                                ${state.searchTerm ? `
                                    <div class="flex items-center space-x-2 px-4 py-2 bg-blue-500 text-white rounded-xl shadow-md">
                                        <i data-lucide="search" class="h-4 w-4"></i>
                                        <span class="text-sm font-medium">"${state.searchTerm}"</span>
                                        <button id="clear-search-chip" class="ml-2 hover:bg-white/20 rounded-full p-1 transition-colors" title="Limpiar búsqueda">
                                            <i data-lucide="x" class="h-3 w-3"></i>
                                        </button>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- Inventory Table Desktop -->
                            <div class="inventory-table-desktop rounded-xl overflow-hidden" style="background-color: var(--color-bg-content); border: 1px solid #E5E7EB; box-shadow: var(--shadow-lg);">
                                <div class="overflow-x-auto">
                                    <div class="mobile-table-container">
                                        <table class="min-w-full mobile-table" role="table" aria-label="Tabla de inventario">
                                            <caption class="sr-only">Tabla de inventario mostrando artículos, categorías, stock y acciones disponibles</caption>
                                            <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                                            <tr>
                                                <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Artículo</th>
                                                <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Categoría</th>
                                                <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Stock</th>
                                                <th scope="col" class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="inventory-table-body" class="divide-y divide-gray-200">
                                            ${paginatedInventory.length > 0 ? paginatedInventory.map(item => `
                                                <tr class="hover:bg-gray-50 transition-all duration-200 ${item.stock < item.minStock ? 'bg-red-50/50 border-l-4 border-l-red-500' : ''}">
                                                    <td class="px-6 py-4">
                                                        <div class="flex items-center">
                                                            <div class="h-12 w-12 rounded-xl bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center mr-4 shadow-sm">
                                                                <i data-lucide="package" class="h-6 w-6 text-gray-600"></i>
                                                            </div>
                                                            <div>
                                                                <div class="text-sm font-semibold text-gray-900">${item.description}</div>
                                                                ${item.stock < item.minStock ? '<div class="text-xs font-medium text-red-600 flex items-center mt-1"><i data-lucide="alert-circle" class="h-3 w-3 mr-1"></i>Stock bajo</div>' : ''}
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-800 shadow-sm">
                                                            <i data-lucide="folder" class="h-3 w-3 mr-1.5"></i>
                                                            ${item.category}
                                                        </span>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <div class="text-sm font-semibold text-gray-900">${item.stock} ${item.unit}</div>
                                                        <div class="text-xs text-gray-500 mt-1">Min: ${item.minStock}</div>
                                                    </td>
                                                    <td class="px-6 py-4 text-center">
                                                        <div class="flex items-center justify-center space-x-2">
                                                            <button class="action-btn p-3 text-green-600 hover:text-green-700 hover:bg-green-100 rounded-xl transition-all duration-200 min-h-[48px] min-w-[48px] flex items-center justify-center hover:scale-110 active:scale-95 shadow-sm hover:shadow-md" data-action="entry" data-id="${item.id}" aria-label="Registrar entrada para ${item.description}">
                                                                <i data-lucide="plus-circle" class="h-6 w-6" aria-hidden="true"></i>
                                                            </button>
                                                            <button class="action-btn p-3 ${item.stock <= 0 ? 'text-gray-400 cursor-not-allowed opacity-50' : 'text-blue-600 hover:text-blue-700 hover:bg-blue-100'} rounded-xl transition-all duration-200 min-h-[48px] min-w-[48px] flex items-center justify-center hover:scale-110 active:scale-95 shadow-sm hover:shadow-md" data-action="checkout" data-id="${item.id}" aria-label="${item.stock <= 0 ? 'Sin stock disponible para ' + item.description : 'Registrar salida o préstamo para ' + item.description}" ${item.stock <= 0 ? 'disabled aria-disabled="true"' : ''}>
                                                                <i data-lucide="arrow-right-left" class="h-6 w-6" aria-hidden="true"></i>
                                                            </button>
                                                            <button class="action-btn p-3 text-yellow-600 hover:text-yellow-700 hover:bg-yellow-100 rounded-xl transition-all duration-200 min-h-[48px] min-w-[48px] flex items-center justify-center hover:scale-110 active:scale-95 shadow-sm hover:shadow-md" data-action="add-to-cart" data-id="${item.id}" aria-label="Añadir ${item.description} a lista de compras">
                                                                <i data-lucide="shopping-cart" class="h-6 w-6" aria-hidden="true"></i>
                                                            </button>
                                                            ${isAdmin ? `
                                                                <button class="action-btn p-3 text-purple-600 hover:text-purple-700 hover:bg-purple-100 rounded-xl transition-all duration-200 min-h-[48px] min-w-[48px] flex items-center justify-center hover:scale-110 active:scale-95 shadow-sm hover:shadow-md" data-action="edit" data-id="${item.id}" aria-label="Editar artículo ${item.description} (solo administrador)">
                                                                    <i data-lucide="pencil" class="h-6 w-6" aria-hidden="true"></i>
                                                                </button>
                                                                <button class="action-btn p-3 text-orange-600 hover:text-orange-700 hover:bg-orange-100 rounded-xl transition-all duration-200 min-h-[48px] min-w-[48px] flex items-center justify-center hover:scale-110 active:scale-95 shadow-sm hover:shadow-md" data-action="edit-stock" data-id="${item.id}" aria-label="Editar stock de ${item.description} (solo administrador)">
                                                                    <i data-lucide="edit-3" class="h-6 w-6" aria-hidden="true"></i>
                                                                </button>
                                                                <button class="action-btn p-3 text-red-600 hover:text-red-700 hover:bg-red-100 rounded-xl transition-all duration-200 min-h-[48px] min-w-[48px] flex items-center justify-center hover:scale-110 active:scale-95 shadow-sm hover:shadow-md" data-action="delete" data-id="${item.id}" aria-label="Eliminar artículo ${item.description} (solo administrador)">
                                                                    <i data-lucide="trash-2" class="h-6 w-6" aria-hidden="true"></i>
                                                                </button>
                                                            ` : ''}
                                                        </div>
                                                    </td>
                                                </tr>
                                            `).join('') : `
                                                <tr>
                                                    <td colspan="5" class="px-6 py-12 text-center">
                                                        <div class="flex flex-col items-center">
                                                            <i data-lucide="package" class="h-16 w-16 text-gray-400 mb-4"></i>
                                                            <h3 class="text-lg font-semibold text-gray-900 mb-2">No se encontraron artículos</h3>
                                                            <p class="text-gray-500">Intenta ajustar los filtros o agregar nuevos artículos</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `}
                                </tbody>
                                        </table>
                                    </div>
                            <div id="paginator" class="px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-xl">${generatePaginator(totalPages)}</div>
                        </div>
                        
                        <!-- Inventory Mobile Cards -->
                        <div class="inventory-mobile-cards">
                            ${paginatedInventory.length > 0 ? paginatedInventory.map(item => `
                                <div class="inventory-card ${item.stock < item.minStock ? 'low-stock' : ''}" data-id="${item.id}">
                                    <div class="inventory-card-header">
                                        <div class="inventory-card-icon">
                                            <i data-lucide="package" class="h-6 w-6 text-gray-600"></i>
                                        </div>
                                        <div class="inventory-card-info">
                                            <div class="inventory-card-title">${item.description}</div>
                                            ${item.stock < item.minStock ? '<div class="inventory-card-badge">Stock bajo</div>' : ''}
                                        </div>
                                    </div>
                                    
                                    <div class="inventory-card-field">
                                        <div class="inventory-card-field-label">
                                            <i data-lucide="folder" class="h-4 w-4"></i>
                                            <span>Categoría:</span>
                                        </div>
                                        <div class="inventory-card-field-value">
                                            <span class="inventory-card-category">${item.category || 'Sin categoría'}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="inventory-card-field">
                                        <div class="inventory-card-field-label">
                                            <i data-lucide="box" class="h-4 w-4"></i>
                                            <span>Stock:</span>
                                        </div>
                                        <div class="inventory-card-field-value">
                                            <span class="inventory-card-stock">${item.stock} ${item.unit}</span>
                                            <span class="inventory-card-stock-min">Min: ${item.minStock}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="inventory-card-actions">
                                        <button class="inventory-card-action-btn entry action-btn" data-action="entry" data-id="${item.id}" title="Registrar Entrada">
                                            <i data-lucide="plus-circle" class="h-5 w-5"></i>
                                        </button>
                                        <button class="inventory-card-action-btn checkout action-btn ${item.stock <= 0 ? 'disabled' : ''}" data-action="checkout" data-id="${item.id}" title="${item.stock <= 0 ? 'Sin Stock Disponible' : 'Registrar Salida/Préstamo'}" ${item.stock <= 0 ? 'disabled' : ''}>
                                            <i data-lucide="arrow-right-left" class="h-5 w-5"></i>
                                        </button>
                                        <button class="inventory-card-action-btn cart action-btn" data-action="add-to-cart" data-id="${item.id}" title="Añadir a Lista de Compras">
                                            <i data-lucide="shopping-cart" class="h-5 w-5"></i>
                                        </button>
                                        ${isAdmin ? `
                                            <button class="inventory-card-action-btn edit action-btn" data-action="edit" data-id="${item.id}" title="Editar Artículo">
                                                <i data-lucide="pencil" class="h-5 w-5"></i>
                                            </button>
                                            <button class="inventory-card-action-btn edit-stock action-btn" data-action="edit-stock" data-id="${item.id}" title="Editar Stock">
                                                <i data-lucide="edit-3" class="h-5 w-5"></i>
                                            </button>
                                            <button class="inventory-card-action-btn delete action-btn" data-action="delete" data-id="${item.id}" title="Eliminar Artículo">
                                                <i data-lucide="trash-2" class="h-5 w-5"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('') : `
                                <div class="text-center py-12">
                                    <div class="flex flex-col items-center">
                                        <i data-lucide="package" class="h-12 w-12 text-gray-400 mb-4"></i>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2">No se encontraron artículos</h3>
                                        <p class="text-gray-500">Intenta ajustar los filtros o agregar nuevos artículos</p>
                                    </div>
                                </div>
                            `}
                            <div id="paginator-mobile" class="mt-6">${generatePaginator(totalPages)}</div>
                        </div>
                    </div>
                </div>
            `;
            if (isAdmin) {
                document.getElementById('new-item-btn').addEventListener('click', showNewItemModal);
                document.getElementById('bulk-add-btn').addEventListener('click', showBulkAddItemsModal);
            }
            safeCreateIcons();
        }

        function renderActiveLoansView() {
            const mainContent = document.getElementById('main-content');
            
            let filteredLoans = state.activeLoans;
            
            // Búsqueda optimizada con fuzzy matching
            if (state.searchTerm) {
                const searchLower = state.searchTerm.toLowerCase();
                filteredLoans = filteredLoans
                    .map(loan => {
                        const searchText = `${loan.itemDescription} ${loan.borrower}`.toLowerCase();
                        const score = fuzzyMatch(searchLower, searchText);
                        return { loan, score };
                    })
                    .filter(({ score }) => score > 0)
                    .sort((a, b) => b.score - a.score)
                    .map(({ loan }) => loan);
            }

            // Check if user has seen the onboarding tooltip before
            const hasSeenOnboarding = localStorage.getItem('devoluciones-onboarding-seen') === 'true';
            const showOnboarding = !hasSeenOnboarding && filteredLoans.length > 0;

            // Calculate statistics
            const totalLoans = filteredLoans.length;
            const today = new Date();
            const overdueLoans = filteredLoans.filter(loan => {
                const loanDate = new Date(loan.loanedAt.seconds * 1000);
                const daysDiff = Math.floor((today - loanDate) / (1000 * 60 * 60 * 24));
                return daysDiff > 30; // Consider overdue after 30 days
            }).length;

            mainContent.innerHTML = `
                <div class="relative space-y-6">
                    ${showOnboarding ? `
                        <div id="onboarding-tooltip" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 bg-yellow-400 border-4 border-yellow-600 rounded-xl p-6 shadow-2xl max-w-sm mx-auto" style="box-shadow: var(--elevation-5);">
                            <div class="flex items-start space-x-3">
                                <div class="text-4xl">💡</div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-bold text-gray-800 mb-2">Primera vez aquí?</h3>
                                    <div class="text-gray-700 text-sm space-y-1">
                                        <p><strong>1.</strong> Toque aquí para escanear el artículo</p>
                                        <p><strong>2.</strong> Toque el botón verde para confirmar</p>
                                    </div>
                                </div>
                                <button id="close-tooltip" class="text-gray-600 hover:text-gray-800 text-xl font-bold">&times;</button>
                            </div>
                        </div>
                        <div id="tooltip-overlay" class="fixed inset-0 bg-black bg-opacity-30 z-40"></div>
                    ` : ''}
                    
                    <!-- Statistics Summary -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100" style="box-shadow: var(--shadow-lg);">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-semibold text-gray-600 mb-1">Total Préstamos</p>
                                    <p class="text-3xl font-bold text-gray-900">${totalLoans}</p>
                                </div>
                                <div class="h-14 w-14 rounded-xl bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center shadow-md">
                                    <i data-lucide="arrow-right-left" class="h-7 w-7 text-blue-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100" style="box-shadow: var(--shadow-lg);">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-semibold text-gray-600 mb-1">Vencidos</p>
                                    <p class="text-3xl font-bold ${overdueLoans > 0 ? 'text-red-600' : 'text-green-600'}">${overdueLoans}</p>
                                </div>
                                <div class="h-14 w-14 rounded-xl bg-gradient-to-br ${overdueLoans > 0 ? 'from-red-100 to-red-200' : 'from-green-100 to-green-200'} flex items-center justify-center shadow-md">
                                    <i data-lucide="${overdueLoans > 0 ? 'alert-triangle' : 'check-circle'}" class="h-7 w-7 ${overdueLoans > 0 ? 'text-red-600' : 'text-green-600'}"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100" style="box-shadow: var(--shadow-lg);">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-semibold text-gray-600 mb-1">Activos</p>
                                    <p class="text-3xl font-bold text-green-600">${totalLoans - overdueLoans}</p>
                                </div>
                                <div class="h-14 w-14 rounded-xl bg-gradient-to-br from-green-100 to-green-200 flex items-center justify-center shadow-md">
                                    <i data-lucide="check" class="h-7 w-7 text-green-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="themed-card rounded-xl shadow-lg overflow-x-auto" style="box-shadow: var(--shadow-lg);">
                        <div class="mobile-table-container">
                            <table class="min-w-full themed-divide divide-y mobile-table">
                            <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Artículo</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Prestado a</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Fecha de Préstamo</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Días</th>
                                    <th class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="themed-table-body themed-divide divide-y">
                                ${filteredLoans.length > 0 ? filteredLoans.map(loan => {
                                    const loanDate = new Date(loan.loanedAt.seconds * 1000);
                                    const daysDiff = Math.floor((today - loanDate) / (1000 * 60 * 60 * 24));
                                    const isOverdue = daysDiff > 30;
                                    return `
                                    <tr class="hover:bg-gray-50 transition-all duration-200 ${isOverdue ? 'bg-red-50/50 border-l-4 border-l-red-500' : ''}">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center mr-3 shadow-sm">
                                                    <i data-lucide="package" class="h-5 w-5 text-gray-600"></i>
                                                </div>
                                                <span class="font-semibold text-gray-900">${loan.itemDescription}</span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="font-medium text-gray-700">${loan.borrower}</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="text-sm text-gray-600">${loanDate.toLocaleDateString()}</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${isOverdue ? 'bg-red-100 text-red-800' : daysDiff > 20 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                                <i data-lucide="${isOverdue ? 'alert-triangle' : 'clock'}" class="h-3 w-3 mr-1"></i>
                                                ${daysDiff} días
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                            <button class="return-btn bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl min-h-[48px] min-w-[48px] flex items-center justify-center transition-all duration-200 hover:scale-110 active:scale-95 shadow-md hover:shadow-lg" data-loan-id="${loan.id}" data-item-id="${loan.itemId}" title="Devolución">
                                                <i data-lucide="rotate-ccw" class="h-6 w-6"></i>
                                            </button>
                                            <button class="report-loss-btn bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-xl min-h-[48px] min-w-[48px] flex items-center justify-center transition-all duration-200 hover:scale-110 active:scale-95 shadow-md hover:shadow-lg" data-loan-id="${loan.id}" data-item-id="${loan.itemId}" title="Pérdida">
                                                <i data-lucide="x-circle" class="h-6 w-6"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `;
                                }).join('') : `
                                    <tr>
                                        <td colspan="5" class="text-center py-12">
                                            <div class="flex flex-col items-center">
                                                <i data-lucide="arrow-right-left" class="h-16 w-16 text-gray-400 mb-4"></i>
                                                <h3 class="text-lg font-semibold text-gray-900 mb-2">No hay préstamos activos</h3>
                                                <p class="text-gray-500">Todos los artículos están disponibles</p>
                                            </div>
                                        </td>
                                    </tr>
                                `}
                            </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners for onboarding tooltip
            if (showOnboarding) {
                const tooltip = document.getElementById('onboarding-tooltip');
                const overlay = document.getElementById('tooltip-overlay');
                const closeBtn = document.getElementById('close-tooltip');
                
                const dismissTooltip = () => {
                    tooltip.style.display = 'none';
                    overlay.style.display = 'none';
                    localStorage.setItem('devoluciones-onboarding-seen', 'true');
                };
                
                closeBtn.addEventListener('click', dismissTooltip);
                overlay.addEventListener('click', dismissTooltip);
                
                // Dismiss when user performs any action
                const actionButtons = document.querySelectorAll('.return-btn, .report-loss-btn');
                actionButtons.forEach(btn => {
                    btn.addEventListener('click', dismissTooltip);
                });
            }
            
            safeCreateIcons();
        }

        function renderHistoryView() {
            const mainContent = document.getElementById('main-content');
            const isAdmin = state.userRole === 'admin';
            mainContent.innerHTML = `
                <div class="space-y-6 animate-fade-in">
                    <div class="themed-card rounded-xl shadow-lg animate-fade-in-up" style="box-shadow: var(--shadow-lg);">
                        <div class="p-6">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                                <nav class="-mb-px flex space-x-2 overflow-x-auto scrollbar-hide" aria-label="Tabs">
                                    <a href="#" class="tab-link whitespace-nowrap pb-3 px-4 border-b-2 font-semibold text-sm rounded-t-lg transition-all duration-200 themed-text-light hover:text-gray-900 hover:bg-gray-50" data-type="salidas">
                                        <i data-lucide="arrow-right" class="h-4 w-4 inline mr-2"></i>Salidas
                                    </a>
                                    <a href="#" class="tab-link whitespace-nowrap pb-3 px-4 border-b-2 font-semibold text-sm rounded-t-lg transition-all duration-200 themed-text-light hover:text-gray-900 hover:bg-gray-50" data-type="prestamos">
                                        <i data-lucide="arrow-right-left" class="h-4 w-4 inline mr-2"></i>Préstamos
                                    </a>
                                    <a href="#" class="tab-link whitespace-nowrap pb-3 px-4 border-b-2 font-semibold text-sm rounded-t-lg transition-all duration-200 themed-text-light hover:text-gray-900 hover:bg-gray-50" data-type="devoluciones">
                                        <i data-lucide="rotate-ccw" class="h-4 w-4 inline mr-2"></i>Devoluciones
                                    </a>
                                    <a href="#" class="tab-link whitespace-nowrap pb-3 px-4 border-b-2 font-semibold text-sm rounded-t-lg transition-all duration-200 themed-text-light hover:text-gray-900 hover:bg-gray-50" data-type="bajas">
                                        <i data-lucide="x-circle" class="h-4 w-4 inline mr-2"></i>Bajas
                                    </a>
                                    <a href="#" class="tab-link whitespace-nowrap pb-3 px-4 border-b-2 font-semibold text-sm rounded-t-lg transition-all duration-200 themed-text-light hover:text-gray-900 hover:bg-gray-50" data-type="entradas">
                                        <i data-lucide="arrow-down" class="h-4 w-4 inline mr-2"></i>Entradas
                                    </a>
                                </nav>
                                <div class="flex items-center gap-2">
                                    <button id="history-view-toggle" class="px-4 py-2 text-sm font-semibold rounded-xl bg-gray-100 hover:bg-gray-200 themed-text flex items-center gap-2 transition-all duration-200 hover:shadow-md" style="box-shadow: var(--shadow-sm);">
                                        <i data-lucide="${state.historyViewMode === 'table' ? 'layout-grid' : 'table'}" class="h-4 w-4"></i>
                                        <span>${state.historyViewMode === 'table' ? 'Tarjetas' : 'Tabla'}</span>
                                    </button>
                                    <button id="history-filters-toggle" class="px-4 py-2 text-sm font-semibold rounded-xl bg-gray-900 hover:bg-gray-800 text-white flex items-center gap-2 transition-all duration-200 hover:shadow-lg" style="box-shadow: var(--shadow-md);">
                                        <i data-lucide="filter" class="h-4 w-4"></i>
                                        <span>Filtros</span>
                                    </button>
                                </div>
                            </div>
                            <div id="history-filters-panel" class="hidden mb-4 p-5 bg-gray-50 rounded-xl border border-gray-200 animate-fade-in-up">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium themed-text-light mb-1">Fecha Desde</label>
                                    <input type="date" id="filter-date-from" class="themed-input w-full px-3 py-2 border rounded-md text-sm" value="${state.historyFilters.dateFrom || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium themed-text-light mb-1">Fecha Hasta</label>
                                    <input type="date" id="filter-date-to" class="themed-input w-full px-3 py-2 border rounded-md text-sm" value="${state.historyFilters.dateTo || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium themed-text-light mb-1">Responsable</label>
                                    <input type="text" id="filter-responsible" class="themed-input w-full px-3 py-2 border rounded-md text-sm" placeholder="Nombre del responsable" value="${state.historyFilters.responsible || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium themed-text-light mb-1">Cantidad</label>
                                    <div class="flex gap-2">
                                        <input type="number" id="filter-quantity-min" class="themed-input w-full px-3 py-2 border rounded-md text-sm" placeholder="Mín" min="0" value="${state.historyFilters.quantityMin || ''}">
                                        <input type="number" id="filter-quantity-max" class="themed-input w-full px-3 py-2 border rounded-md text-sm" placeholder="Máx" min="0" value="${state.historyFilters.quantityMax || ''}">
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end gap-2 mt-4">
                                <button id="history-filters-clear" class="px-4 py-2 text-sm font-medium rounded-md bg-gray-200 hover:bg-gray-300 text-gray-700">
                                    Limpiar
                                </button>
                                <button id="history-filters-apply" class="px-4 py-2 text-sm font-medium rounded-md bg-indigo-600 hover:bg-indigo-700 text-white">
                                    Aplicar
                                </button>
                            </div>
                        </div>
                        <div id="history-sort-controls" class="mb-4 flex flex-wrap items-center gap-2">
                            <label class="text-sm font-medium themed-text-light">Ordenar por:</label>
                            <select id="history-sort-by" class="themed-input px-3 py-2 border rounded-md text-sm">
                                <option value="date" ${state.historySortBy === 'date' ? 'selected' : ''}>Fecha</option>
                                <option value="quantity" ${state.historySortBy === 'quantity' ? 'selected' : ''}>Cantidad</option>
                                <option value="responsible" ${state.historySortBy === 'responsible' ? 'selected' : ''}>Responsable</option>
                                <option value="item" ${state.historySortBy === 'item' ? 'selected' : ''}>Artículo</option>
                            </select>
                            <button id="history-sort-order" class="px-3 py-2 text-sm font-medium rounded-md bg-gray-100 hover:bg-gray-200 themed-text flex items-center gap-2">
                                <i data-lucide="${state.historySortOrder === 'asc' ? 'arrow-up' : 'arrow-down'}" class="h-4 w-4"></i>
                                <span>${state.historySortOrder === 'asc' ? 'Ascendente' : 'Descendente'}</span>
                            </button>
                        </div>
                    </div>
                    <div id="history-content" class="p-4"></div>
                    <div id="history-pagination" class="p-4 border-t themed-border"></div>
                </div>
            `;
            
            // Event listeners
            document.querySelectorAll('.tab-link').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    state.historyCurrentPage = 1;
                    renderHistoryTab(tab.dataset.type);
                });
            });
            
            document.getElementById('history-view-toggle').addEventListener('click', () => {
                state.historyViewMode = state.historyViewMode === 'table' ? 'cards' : 'table';
                const currentTab = document.querySelector('.tab-link.border-indigo-500')?.dataset.type || 'salidas';
                renderHistoryTab(currentTab);
            });
            
            document.getElementById('history-filters-toggle').addEventListener('click', () => {
                const panel = document.getElementById('history-filters-panel');
                panel.classList.toggle('hidden');
            });
            
            document.getElementById('history-filters-apply').addEventListener('click', () => {
                state.historyFilters.dateFrom = document.getElementById('filter-date-from').value || null;
                state.historyFilters.dateTo = document.getElementById('filter-date-to').value || null;
                state.historyFilters.responsible = document.getElementById('filter-responsible').value || '';
                state.historyFilters.quantityMin = document.getElementById('filter-quantity-min').value ? parseInt(document.getElementById('filter-quantity-min').value) : null;
                state.historyFilters.quantityMax = document.getElementById('filter-quantity-max').value ? parseInt(document.getElementById('filter-quantity-max').value) : null;
                state.historyCurrentPage = 1;
                const currentTab = document.querySelector('.tab-link.border-indigo-500')?.dataset.type || 'salidas';
                renderHistoryTab(currentTab);
            });
            
            document.getElementById('history-filters-clear').addEventListener('click', () => {
                state.historyFilters = { dateFrom: null, dateTo: null, responsible: '', quantityMin: null, quantityMax: null };
                document.getElementById('filter-date-from').value = '';
                document.getElementById('filter-date-to').value = '';
                document.getElementById('filter-responsible').value = '';
                document.getElementById('filter-quantity-min').value = '';
                document.getElementById('filter-quantity-max').value = '';
                state.historyCurrentPage = 1;
                const currentTab = document.querySelector('.tab-link.border-indigo-500')?.dataset.type || 'salidas';
                renderHistoryTab(currentTab);
            });
            
            document.getElementById('history-sort-by').addEventListener('change', (e) => {
                state.historySortBy = e.target.value;
                const currentTab = document.querySelector('.tab-link.border-indigo-500')?.dataset.type || 'salidas';
                renderHistoryTab(currentTab);
            });
            
            document.getElementById('history-sort-order').addEventListener('click', () => {
                state.historySortOrder = state.historySortOrder === 'asc' ? 'desc' : 'asc';
                const currentTab = document.querySelector('.tab-link.border-indigo-500')?.dataset.type || 'salidas';
                renderHistoryTab(currentTab);
            });
            
            safeCreateIcons();
            renderHistoryTab('salidas');
        }

        function renderHistoryTab(tabType) {
            document.querySelectorAll('.tab-link').forEach(tab => {
                const isSelected = tab.dataset.type === tabType;
                tab.classList.toggle('border-indigo-500', isSelected);
                tab.classList.toggle('text-indigo-600', isSelected);
                tab.classList.toggle('text-blue-600', isSelected);
                tab.classList.toggle('border-transparent', !isSelected);
                tab.classList.toggle('themed-text-light', !isSelected);
                tab.classList.toggle('text-gray-600', !isSelected);
            });

            const content = document.getElementById('history-content');
            const isAdmin = state.userRole === 'admin';
            const typeMap = {
                salidas: ['Salida', 'Intercambio'], prestamos: ['Préstamo'],
                devoluciones: ['Devolución'], bajas: ['Baja', 'Eliminado'], entradas: ['Entrada', 'Creación']
            };
            
            // Filtrar por tipo de transacción
            let data = state.transactions.filter(t => typeMap[tabType].includes(t.type));
            
            // Aplicar búsqueda con fuzzy matching
            const lowerCaseSearch = state.searchTerm.toLowerCase();
            if (state.searchTerm) {
                data = data
                    .map(t => {
                        const searchText = `${t.itemDescription} ${t.user || ''} ${t.borrower || ''} ${t.supplier || ''}`.toLowerCase();
                        const score = fuzzyMatch(lowerCaseSearch, searchText);
                        return { transaction: t, score };
                    })
                    .filter(({ score }) => score > 0)
                    .sort((a, b) => b.score - a.score)
                    .map(({ transaction }) => transaction);
            }
            
            // Aplicar filtros avanzados
            if (state.historyFilters.dateFrom) {
                // Parsear fecha en timezone local para evitar problemas de UTC
                const [year, month, day] = state.historyFilters.dateFrom.split('-').map(Number);
                const dateFrom = new Date(year, month - 1, day, 0, 0, 0, 0);
                data = data.filter(t => {
                    if (!t.timestamp?.seconds) return false;
                    const transDate = new Date(t.timestamp.seconds * 1000);
                    transDate.setHours(0, 0, 0, 0);
                    return transDate >= dateFrom;
                });
            }
            
            if (state.historyFilters.dateTo) {
                // Parsear fecha en timezone local para evitar problemas de UTC
                const [year, month, day] = state.historyFilters.dateTo.split('-').map(Number);
                const dateTo = new Date(year, month - 1, day, 23, 59, 59, 999);
                data = data.filter(t => {
                    if (!t.timestamp?.seconds) return false;
                    const transDate = new Date(t.timestamp.seconds * 1000);
                    return transDate <= dateTo;
                });
            }
            
            if (state.historyFilters.responsible) {
                const responsibleLower = state.historyFilters.responsible.toLowerCase();
                data = data.filter(t => {
                    const responsible = (t.type === 'Devolución' ? (t.borrower || '') : (t.supplier || t.user || t.borrower) || '').toLowerCase();
                    return responsible.includes(responsibleLower);
                });
            }
            
            if (state.historyFilters.quantityMin !== null) {
                data = data.filter(t => t.quantity >= state.historyFilters.quantityMin);
            }
            
            if (state.historyFilters.quantityMax !== null) {
                data = data.filter(t => t.quantity <= state.historyFilters.quantityMax);
            }
            
            // Aplicar ordenamiento
            data.sort((a, b) => {
                let aVal, bVal;
                switch (state.historySortBy) {
                    case 'date':
                        aVal = a.timestamp?.seconds || 0;
                        bVal = b.timestamp?.seconds || 0;
                        break;
                    case 'quantity':
                        aVal = a.quantity || 0;
                        bVal = b.quantity || 0;
                        break;
                    case 'responsible':
                        aVal = (a.type === 'Devolución' ? (a.borrower || '') : (a.supplier || a.user || a.borrower) || '').toLowerCase();
                        bVal = (b.type === 'Devolución' ? (b.borrower || '') : (b.supplier || b.user || b.borrower) || '').toLowerCase();
                        break;
                    case 'item':
                        aVal = (a.itemDescription || '').toLowerCase();
                        bVal = (b.itemDescription || '').toLowerCase();
                        break;
                    default:
                        aVal = a.timestamp?.seconds || 0;
                        bVal = b.timestamp?.seconds || 0;
                }
                
                if (typeof aVal === 'string') {
                    return state.historySortOrder === 'asc' 
                        ? aVal.localeCompare(bVal)
                        : bVal.localeCompare(aVal);
                } else {
                    return state.historySortOrder === 'asc' 
                        ? aVal - bVal
                        : bVal - aVal;
                }
            });
            
            // Paginación
            const totalItems = data.length;
            const totalPages = Math.ceil(totalItems / state.itemsPerPage);
            const startIndex = (state.historyCurrentPage - 1) * state.itemsPerPage;
            const endIndex = startIndex + state.itemsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);
            
            // Renderizar según el modo de vista
            if (state.historyViewMode === 'cards') {
                renderHistoryCards(paginatedData, isAdmin);
            } else {
                renderHistoryTable(paginatedData, isAdmin);
            }
            
            // Renderizar controles de paginación
            renderHistoryPagination(totalPages, totalItems);
            
            safeCreateIcons();
        }
        
        function renderHistoryTable(data, isAdmin) {
            const content = document.getElementById('history-content');
            const headers = ['Fecha', 'Tipo', 'Artículo', 'Cantidad', 'Responsable', 'Notas', ...(isAdmin ? ['Acciones'] : [])];
            
            content.innerHTML = `
                <div class="overflow-x-auto">
                    <div class="mobile-table-container">
                        <table class="min-w-full themed-divide divide-y mobile-table">
                        <thead class="themed-table-header">
                            <tr>${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium themed-text-light uppercase tracking-wider">${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody class="themed-table-body themed-divide divide-y">
                            ${data.length > 0 ? data.map(t => {
                                const responsible = t.type === 'Devolución' ? (t.borrower || 'N/A') : (t.supplier || t.user || t.borrower) || 'N/A';
                                const dateStr = t.timestamp?.seconds ? new Date(t.timestamp.seconds * 1000).toLocaleString() : 'Fecha no disponible';
                                return `
                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800">
                                    <td class="px-6 py-4 whitespace-nowrap">${dateStr}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${t.type}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${t.itemDescription || 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${t.quantity || 0}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${responsible}</td>
                                    <td class="px-6 py-4 whitespace-nowrap max-w-xs truncate" title="${t.notes || ''}">${t.notes || ''}</td>
                                    ${isAdmin ? `
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center gap-2">
                                            <button data-transaction-id="${t.id}" data-action="edit" class="edit-transaction-btn p-2 text-blue-600 hover:bg-blue-50 rounded transition-colors" title="Editar">
                                                <i data-lucide="edit-2" class="h-4 w-4"></i>
                                            </button>
                                            <button data-transaction-id="${t.id}" data-action="delete" class="delete-transaction-btn p-2 text-red-600 hover:bg-red-50 rounded transition-colors" title="Borrar">
                                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                                            </button>
                                        </div>
                                    </td>
                                    ` : ''}
                                </tr>
                            `;
                            }).join('') : `<tr><td colspan="${headers.length}" class="text-center py-10 themed-text-light">No hay registros.</td></tr>`}
                        </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Agregar event listeners para botones de editar/borrar
            document.querySelectorAll('.edit-transaction-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const transactionId = btn.dataset.transactionId;
                    const transaction = state.transactions.find(t => t.id === transactionId);
                    if (transaction) {
                        showEditTransactionModal(transaction);
                    }
                });
            });
            
            document.querySelectorAll('.delete-transaction-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const transactionId = btn.dataset.transactionId;
                    handleDeleteTransaction(transactionId);
                });
            });
        }
        
        function renderHistoryCards(data, isAdmin) {
            const content = document.getElementById('history-content');
            
            if (data.length === 0) {
                content.innerHTML = `<div class="text-center py-10 themed-text-light">No hay registros.</div>`;
                return;
            }
            
            content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${data.map((t, index) => {
                        const responsible = t.type === 'Devolución' ? (t.borrower || 'N/A') : (t.supplier || t.user || t.borrower) || 'N/A';
                        const dateStr = t.timestamp?.seconds ? new Date(t.timestamp.seconds * 1000).toLocaleString() : 'Fecha no disponible';
                        const typeColors = {
                            'Salida': 'bg-red-100 text-red-800 border-red-200',
                            'Entrada': 'bg-green-100 text-green-800 border-green-200',
                            'Préstamo': 'bg-blue-100 text-blue-800 border-blue-200',
                            'Devolución': 'bg-purple-100 text-purple-800 border-purple-200',
                            'Baja': 'bg-gray-100 text-gray-800 border-gray-200',
                            'Eliminado': 'bg-gray-100 text-gray-800 border-gray-200',
                            'Intercambio': 'bg-orange-100 text-orange-800 border-orange-200',
                            'Creación': 'bg-indigo-100 text-indigo-800 border-indigo-200'
                        };
                        const typeIcons = {
                            'Salida': 'arrow-right',
                            'Entrada': 'arrow-down',
                            'Préstamo': 'arrow-right-left',
                            'Devolución': 'rotate-ccw',
                            'Baja': 'x-circle',
                            'Eliminado': 'trash-2',
                            'Intercambio': 'refresh-cw',
                            'Creación': 'plus-circle'
                        };
                        const typeColor = typeColors[t.type] || 'bg-gray-100 text-gray-800 border-gray-200';
                        const typeIcon = typeIcons[t.type] || 'file-text';
                        
                        return `
                        <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-5 hover:shadow-xl hover:-translate-y-1 transition-all duration-200" style="box-shadow: var(--shadow-lg);">
                            <div class="flex justify-between items-start mb-4">
                                <span class="inline-flex items-center px-3 py-1.5 text-xs font-bold rounded-full border-2 ${typeColor}">
                                    <i data-lucide="${typeIcon}" class="h-3 w-3 mr-1.5"></i>
                                    ${t.type}
                                </span>
                                ${isAdmin ? `
                                <div class="flex gap-1">
                                    <button data-transaction-id="${t.id}" data-action="edit" class="edit-transaction-btn p-2 text-blue-600 hover:bg-blue-50 rounded-xl transition-all duration-200 hover:scale-110 active:scale-95 shadow-sm hover:shadow-md" title="Editar">
                                        <i data-lucide="edit-2" class="h-4 w-4"></i>
                                    </button>
                                    <button data-transaction-id="${t.id}" data-action="delete" class="delete-transaction-btn p-2 text-red-600 hover:bg-red-50 rounded-xl transition-all duration-200 hover:scale-110 active:scale-95 shadow-sm hover:shadow-md" title="Borrar">
                                        <i data-lucide="trash-2" class="h-4 w-4"></i>
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                            <h3 class="font-bold text-lg text-gray-900 mb-3 flex items-center">
                                <i data-lucide="package" class="h-5 w-5 mr-2 text-gray-400"></i>
                                ${t.itemDescription || 'N/A'}
                            </h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between items-center bg-gray-50 rounded-lg px-3 py-2">
                                    <span class="text-gray-600 font-medium flex items-center">
                                        <i data-lucide="hash" class="h-4 w-4 mr-1.5"></i>
                                        Cantidad:
                                    </span>
                                    <span class="font-bold text-gray-900">${t.quantity || 0}</span>
                                </div>
                                <div class="flex justify-between items-center bg-gray-50 rounded-lg px-3 py-2">
                                    <span class="text-gray-600 font-medium flex items-center">
                                        <i data-lucide="user" class="h-4 w-4 mr-1.5"></i>
                                        Responsable:
                                    </span>
                                    <span class="font-semibold text-gray-900">${responsible}</span>
                                </div>
                                <div class="flex justify-between items-center bg-gray-50 rounded-lg px-3 py-2">
                                    <span class="text-gray-600 font-medium flex items-center">
                                        <i data-lucide="calendar" class="h-4 w-4 mr-1.5"></i>
                                        Fecha:
                                    </span>
                                    <span class="font-semibold text-gray-700 text-xs">${dateStr}</span>
                                </div>
                                ${t.notes ? `
                                <div class="mt-3 pt-3 border-t border-gray-200">
                                    <p class="text-xs text-gray-600 italic flex items-start">
                                        <i data-lucide="message-square" class="h-3 w-3 mr-1.5 mt-0.5 flex-shrink-0"></i>
                                        ${t.notes}
                                    </p>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    }).join('')}
                </div>
            `;
            
            // Agregar event listeners para botones de editar/borrar
            document.querySelectorAll('.edit-transaction-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const transactionId = btn.dataset.transactionId;
                    const transaction = state.transactions.find(t => t.id === transactionId);
                    if (transaction) {
                        showEditTransactionModal(transaction);
                    }
                });
            });
            
            document.querySelectorAll('.delete-transaction-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const transactionId = btn.dataset.transactionId;
                    handleDeleteTransaction(transactionId);
                });
            });
        }
        
        function renderHistoryPagination(totalPages, totalItems) {
            const paginationEl = document.getElementById('history-pagination');
            if (totalPages <= 1) {
                paginationEl.innerHTML = totalItems > 0 ? `<div class="text-sm themed-text-light text-center">Mostrando ${totalItems} registro${totalItems !== 1 ? 's' : ''}</div>` : '';
                return;
            }
            
            const startItem = (state.historyCurrentPage - 1) * state.itemsPerPage + 1;
            const endItem = Math.min(state.historyCurrentPage * state.itemsPerPage, totalItems);
            
            paginationEl.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="text-sm themed-text-light">
                        Mostrando ${startItem}-${endItem} de ${totalItems} registro${totalItems !== 1 ? 's' : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        <button 
                            data-pagination-action="prev"
                            class="history-pagination-btn px-3 py-2 text-sm font-medium rounded-md bg-gray-100 hover:bg-gray-200 themed-text ${state.historyCurrentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${state.historyCurrentPage === 1 ? 'disabled' : ''}
                        >
                            <i data-lucide="chevron-left" class="h-4 w-4 inline"></i> Anterior
                        </button>
                        <div class="flex items-center gap-1">
                            ${Array.from({ length: Math.min(totalPages, 7) }, (_, i) => {
                                let pageNum;
                                if (totalPages <= 7) {
                                    pageNum = i + 1;
                                } else if (state.historyCurrentPage <= 4) {
                                    pageNum = i + 1;
                                } else if (state.historyCurrentPage >= totalPages - 3) {
                                    pageNum = totalPages - 6 + i;
                                } else {
                                    pageNum = state.historyCurrentPage - 3 + i;
                                }
                                const isActive = pageNum === state.historyCurrentPage;
                                return `
                                    <button 
                                        data-pagination-page="${pageNum}"
                                        class="history-pagination-btn px-3 py-2 text-sm font-medium rounded-md ${isActive ? 'bg-indigo-600 text-white' : 'bg-gray-100 hover:bg-gray-200 themed-text'}"
                                    >
                                        ${pageNum}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                        <button 
                            data-pagination-action="next"
                            data-pagination-total="${totalPages}"
                            class="history-pagination-btn px-3 py-2 text-sm font-medium rounded-md bg-gray-100 hover:bg-gray-200 themed-text ${state.historyCurrentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${state.historyCurrentPage === totalPages ? 'disabled' : ''}
                        >
                            Siguiente <i data-lucide="chevron-right" class="h-4 w-4 inline"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Agregar event listeners para los botones de paginación
            paginationEl.querySelectorAll('.history-pagination-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.disabled) return;
                    
                    const action = btn.dataset.paginationAction;
                    const pageNum = btn.dataset.paginationPage;
                    
                    if (action === 'prev') {
                        state.historyCurrentPage = Math.max(1, state.historyCurrentPage - 1);
                    } else if (action === 'next') {
                        const totalPages = parseInt(btn.dataset.paginationTotal);
                        state.historyCurrentPage = Math.min(totalPages, state.historyCurrentPage + 1);
                    } else if (pageNum) {
                        state.historyCurrentPage = parseInt(pageNum);
                    }
                    
                    const currentTab = document.querySelector('.tab-link.border-indigo-500')?.dataset.type || 'salidas';
                    renderHistoryTab(currentTab);
                });
            });
        }


        function renderReportsView() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="space-y-8">
                    <!-- Header Section -->
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-8 text-white shadow-2xl" style="box-shadow: var(--elevation-4);">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold mb-2">Centro de Reportes</h2>
                                <p class="text-gray-300 text-lg">Genera reportes detallados en PDF y Excel</p>
                            </div>
                            <div class="hidden md:block">
                                <i data-lucide="file-text" class="h-16 w-16 text-white/30"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Report Types -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Inventario Completo -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-200" style="box-shadow: var(--shadow-lg);">
                            <div class="flex items-center mb-4">
                                <div class="h-14 w-14 rounded-xl bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center mr-4 shadow-md">
                                    <i data-lucide="archive" class="h-7 w-7 text-blue-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">Inventario Completo</h3>
                                    <p class="text-sm text-gray-600 mt-1">Todos los artículos con stock, categorías y detalles</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button data-type="inventory" data-format="pdf" class="report-btn flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2.5 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors duration-200 shadow-md hover:shadow-lg">
                                    <i data-lucide="file-text" class="h-4 w-4"></i>
                                    <span>PDF</span>
                                </button>
                                <button data-type="inventory" data-format="excel" class="report-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors duration-200 shadow-md hover:shadow-lg">
                                    <i data-lucide="file-spreadsheet" class="h-4 w-4"></i>
                                    <span>Excel</span>
                                </button>
                            </div>
                        </div>

                        <!-- Préstamos Activos -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-200" style="box-shadow: var(--shadow-lg);">
                            <div class="flex items-center mb-4">
                                <div class="h-14 w-14 rounded-xl bg-gradient-to-br from-orange-100 to-orange-200 flex items-center justify-center mr-4 shadow-md">
                                    <i data-lucide="arrow-right-left" class="h-7 w-7 text-orange-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">Préstamos Activos</h3>
                                    <p class="text-sm text-gray-600 mt-1">Préstamos pendientes con fechas y responsables</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button data-type="loans" data-format="pdf" class="report-btn flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2.5 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors duration-200 shadow-md hover:shadow-lg">
                                    <i data-lucide="file-text" class="h-4 w-4"></i>
                                    <span>PDF</span>
                                </button>
                                <button data-type="loans" data-format="excel" class="report-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors duration-200 shadow-md hover:shadow-lg">
                                    <i data-lucide="file-spreadsheet" class="h-4 w-4"></i>
                                    <span>Excel</span>
                                </button>
                            </div>
                        </div>

                        <!-- Historial de Salidas -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-200" style="box-shadow: var(--shadow-lg);">
                            <div class="flex items-center mb-4">
                                <div class="h-14 w-14 rounded-xl bg-gradient-to-br from-green-100 to-green-200 flex items-center justify-center mr-4 shadow-md">
                                    <i data-lucide="log-out" class="h-7 w-7 text-green-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">Historial de Salidas</h3>
                                    <p class="text-sm text-gray-600 mt-1">Registro completo de salidas de inventario</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button data-type="salidas" data-format="pdf" class="report-btn flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2.5 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors duration-200 shadow-md hover:shadow-lg">
                                    <i data-lucide="file-text" class="h-4 w-4"></i>
                                    <span>PDF</span>
                                </button>
                                <button data-type="salidas" data-format="excel" class="report-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors duration-200 shadow-md hover:shadow-lg">
                                    <i data-lucide="file-spreadsheet" class="h-4 w-4"></i>
                                    <span>Excel</span>
                                </button>
                            </div>
                        </div>

                        <!-- Historial de Préstamos -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-200" style="box-shadow: var(--shadow-lg);">
                            <div class="flex items-center mb-4">
                                <div class="h-14 w-14 rounded-xl bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center mr-4 shadow-md">
                                    <i data-lucide="arrow-right-left" class="h-7 w-7 text-blue-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">Historial de Préstamos</h3>
                                    <p class="text-sm text-gray-600 mt-1">Registro completo de préstamos realizados</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button data-type="prestamos" data-format="pdf" class="report-btn flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2.5 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors duration-200 shadow-md hover:shadow-lg">
                                    <i data-lucide="file-text" class="h-4 w-4"></i>
                                    <span>PDF</span>
                                </button>
                                <button data-type="prestamos" data-format="excel" class="report-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors duration-200 shadow-md hover:shadow-lg">
                                    <i data-lucide="file-spreadsheet" class="h-4 w-4"></i>
                                    <span>Excel</span>
                                </button>
                            </div>
                        </div>

                        <!-- Historial de Devoluciones -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-200" style="box-shadow: var(--shadow-lg);">
                            <div class="flex items-center mb-4">
                                <div class="h-14 w-14 rounded-xl bg-gradient-to-br from-purple-100 to-purple-200 flex items-center justify-center mr-4 shadow-md">
                                    <i data-lucide="log-in" class="h-7 w-7 text-purple-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">Historial de Devoluciones</h3>
                                    <p class="text-sm text-gray-600 mt-1">Registro completo de devoluciones recibidas</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button data-type="devoluciones" data-format="pdf" class="report-btn flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2.5 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors duration-200 shadow-md hover:shadow-lg">
                                    <i data-lucide="file-text" class="h-4 w-4"></i>
                                    <span>PDF</span>
                                </button>
                                <button data-type="devoluciones" data-format="excel" class="report-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors duration-200 shadow-md hover:shadow-lg">
                                    <i data-lucide="file-spreadsheet" class="h-4 w-4"></i>
                                    <span>Excel</span>
                                </button>
                            </div>
                        </div>

                        <!-- Inventario Manual -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-200" style="box-shadow: var(--shadow-lg);">
                            <div class="flex items-center mb-4">
                                <div class="h-14 w-14 rounded-xl bg-gradient-to-br from-yellow-100 to-yellow-200 flex items-center justify-center mr-4 shadow-md">
                                    <i data-lucide="clipboard-check" class="h-7 w-7 text-yellow-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">Inventario Manual</h3>
                                    <p class="text-sm text-gray-600 mt-1">Formulario para conteo físico de inventario</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button id="generate-manual-inventory-pdf" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2.5 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors duration-200 shadow-md hover:shadow-lg">
                                    <i data-lucide="file-text" class="h-4 w-4"></i>
                                    <span>Generar PDF</span>
                                </button>
                            </div>
                        </div>

                        <!-- Reporte de Stock Bajo -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-200" style="box-shadow: var(--shadow-lg);">
                            <div class="flex items-center mb-4">
                                <div class="h-14 w-14 rounded-xl bg-gradient-to-br from-red-100 to-red-200 flex items-center justify-center mr-4 shadow-md">
                                    <i data-lucide="alert-triangle" class="h-7 w-7 text-red-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">Stock Bajo</h3>
                                    <p class="text-sm text-gray-600 mt-1">Artículos con stock por debajo del mínimo</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button data-type="low-stock" data-format="pdf" class="report-btn flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2.5 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors duration-200 shadow-md hover:shadow-lg">
                                    <i data-lucide="file-text" class="h-4 w-4"></i>
                                    <span>PDF</span>
                                </button>
                                <button data-type="low-stock" data-format="excel" class="report-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-4 rounded-xl flex items-center justify-center space-x-2 transition-colors duration-200 shadow-md hover:shadow-lg">
                                    <i data-lucide="file-spreadsheet" class="h-4 w-4"></i>
                                    <span>Excel</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Report Preview Section -->
                    <div id="report-preview" class="hidden bg-white rounded shadow-sm border border-gray-100 p-6 mt-6">
                        <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">Vista Previa del Reporte</h3>
                                <p class="text-sm text-gray-500 mt-1">Revisa los datos antes de descargar</p>
                            </div>
                            <button id="close-preview" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded transition-colors duration-200">
                                <i data-lucide="x" class="h-5 w-5"></i>
                            </button>
                        </div>
                        <div id="preview-content" class="max-h-[600px] overflow-y-auto">
                            <!-- Preview content will be inserted here -->
                        </div>
                    </div>
                </div>
            `;
            safeCreateIcons();
        }

        function renderShoppingListView() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="themed-card p-6 rounded shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Lista de Compras</h2>
                        <div class="flex space-x-2">
                            <button id="generate-pdf-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded flex items-center space-x-2 transition-all duration-200 ${state.shoppingList.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${state.shoppingList.length === 0 ? 'disabled' : ''}>
                                <i data-lucide="file-text"></i><span>PDF</span>
                            </button>
                            <button id="generate-excel-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded flex items-center space-x-2 transition-all duration-200 ${state.shoppingList.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${state.shoppingList.length === 0 ? 'disabled' : ''}>
                                <i data-lucide="file-spreadsheet"></i><span>Excel</span>
                            </button>
                        </div>
                    </div>
                    <ul id="shopping-list-items" class="themed-divide divide-y">
                        ${state.shoppingList.length > 0 ? state.shoppingList.map(item => `
                            <li class="py-3 flex justify-between items-center">
                                <span><span class="font-bold text-indigo-600">${item.quantity} x</span> ${item.description}</span>
                                <button class="remove-from-cart-btn text-red-500 hover:text-red-700" data-id="${item.id}"><i data-lucide="x-circle"></i></button>
                            </li>
                        `).join('') : `<li class="py-10 text-center themed-text-light">La lista de compras está vacía.</li>`}
                    </ul>
                </div>
            `;
            safeCreateIcons();
        }

        function renderUsersView() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="themed-card rounded shadow-sm overflow-x-auto">
                    <div class="mobile-table-container">
                        <table class="min-w-full themed-divide divide-y mobile-table">
                        <thead class="themed-table-header">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium themed-text-light uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium themed-text-light uppercase tracking-wider">Rol</th>
                                <th class="px-6 py-3 text-left text-xs font-medium themed-text-light uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="themed-table-body themed-divide divide-y">
                            ${state.allUsers.map(user => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${user.role}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        ${state.currentUser.uid !== user.id ? `
                                            <select class="role-selector themed-input border rounded-md" data-uid="${user.id}">
                                                <option value="operator" ${user.role === 'operator' ? 'selected' : ''}>Operador</option>
                                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                            </select>
                                        ` : '<span class="themed-text-light">(Tú)</span>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.querySelectorAll('.role-selector').forEach(selector => {
                selector.addEventListener('change', async (e) => {
                    const newRole = e.target.value;
                    const uid = e.target.dataset.uid;
                    try {
                        await updateDoc(doc(db, 'users', uid), { role: newRole });
                        showNotification('Rol actualizado correctamente.', 'success');
                    } catch (error) {
                        showNotification('Error al cambiar el rol. Intenta de nuevo.', 'error');
                    }
                });
            });
        }
        
        function renderSettingsView() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) {
                console.error('main-content element not found');
                return;
            }
            
            // Ensure main-content is visible
            mainContent.style.display = 'block';
            mainContent.style.visibility = 'visible';
            
            const isAdmin = state.userRole === 'admin';
            
            mainContent.innerHTML = `
            <div class="max-w-7xl mx-auto space-y-6">
                <!-- Header -->
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold themed-text">${isAdmin ? 'Ajustes del Sistema' : 'Configuración Personal'}</h1>
                        <p class="text-lg themed-text-light mt-1">${isAdmin ? 'Cambia cómo funciona la aplicación para que sea más fácil de usar' : 'Personaliza tu experiencia de usuario'}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        ${isAdmin ? `
                            <button id="reset-settings-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded flex items-center space-x-2">
                                <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                <span>Restablecer</span>
                            </button>
                        ` : ''}
                        <button id="save-settings-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded flex items-center space-x-2">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            <span>Guardar Cambios</span>
                        </button>
                    </div>
                </div>

                <!-- Configuration Tabs -->
                <div class="themed-card rounded shadow-sm border border-opacity-20">
                    <div class="border-b border-opacity-10 px-6 py-4">
                        <nav class="flex space-x-8 overflow-x-auto scrollbar-hide" aria-label="Settings Tabs">
                            ${isAdmin ? `
                                <a href="#" class="settings-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600 transition-all duration-200" data-tab="general">
                                    <i data-lucide="settings" class="w-4 h-4 inline mr-2"></i>General
                                </a>
                                <a href="#" class="settings-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent themed-text-light hover:text-indigo-500 transition-all duration-200" data-tab="interface">
                                    <i data-lucide="monitor" class="w-4 h-4 inline mr-2"></i>Interfaz
                                </a>
                                <a href="#" class="settings-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent themed-text-light hover:text-indigo-500 transition-all duration-200" data-tab="advanced">
                                    <i data-lucide="zap" class="w-4 h-4 inline mr-2"></i>Avanzado
                                </a>
                            ` : `
                                <a href="#" class="settings-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600 transition-all duration-200" data-tab="my-config">
                                    <i data-lucide="user" class="w-4 h-4 inline mr-2"></i>Mi Configuración
                                </a>
                                <a href="#" class="settings-tab-link whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent themed-text-light hover:text-indigo-500 transition-all duration-200" data-tab="preferences">
                                    <i data-lucide="bell" class="w-4 h-4 inline mr-2"></i>Preferencias
                                </a>
                            `}
                        </nav>
                    </div>
                    <div id="settings-tab-content" class="p-8"></div>
                </div>
            </div>
            `;
            
            // Ensure content is rendered after a brief delay to allow DOM to update
            setTimeout(() => {
                renderSettingsTab(isAdmin ? 'general' : 'my-config');
                safeCreateIcons();
                // Double-check that content is visible
                if (mainContent) {
                    mainContent.style.display = 'block';
                    mainContent.style.visibility = 'visible';
                }
            }, 50);
        }

        function renderSettingsTab(tabName) {
            // Update tab styling
            document.querySelectorAll('.settings-tab-link').forEach(tab => {
                const isSelected = tab.dataset.tab === tabName;
                tab.classList.toggle('active', isSelected);
                tab.classList.toggle('border-indigo-500', isSelected);
                tab.classList.toggle('text-indigo-600', isSelected);
                tab.classList.toggle('text-blue-600', isSelected);
                tab.classList.toggle('border-transparent', !isSelected);
                tab.classList.toggle('themed-text-light', !isSelected);
                tab.classList.toggle('text-gray-600', !isSelected);
            });

            const content = document.getElementById('settings-tab-content');
            
            switch(tabName) {
                case 'general':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Basic Configuration -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-indigo-100 rounded mr-3">
                                            <i data-lucide="settings" class="w-5 h-5 text-indigo-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Ajustes Básicos</h3>
                                    </div>
                                    <div class="space-y-4">
                                        <div>
                                            <label for="items-per-page" class="block text-sm font-medium text-gray-700 mb-2">Artículos por página</label>
                                            <input type="number" id="items-per-page" value="${state.settings.itemsPerPage || 10}" min="5" max="50" step="5" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                                            <p class="text-xs text-gray-500 mt-1">Cuántos artículos mostrar en cada página</p>
                                        </div>
                                        <div>
                                            <label for="default-unit" class="block text-sm font-medium text-gray-700 mb-2">Unidad por defecto</label>
                                            <input type="text" id="default-unit" value="${state.settings.defaultUnit || 'pza'}" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                                            <p class="text-xs text-gray-500 mt-1">Unidad que se pone sola cuando agregas productos nuevos</p>
                                        </div>
                                        <div>
                                            <label for="default-min-stock" class="block text-sm font-medium text-gray-700 mb-2">Stock mínimo por defecto</label>
                                            <input type="number" id="default-min-stock" value="${state.settings.defaultMinStock || 5}" min="0" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                                            <p class="text-xs text-gray-500 mt-1">Cantidad mínima que se pone sola cuando agregas productos nuevos</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Security & Session -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-green-100 rounded mr-3">
                                            <i data-lucide="shield" class="w-5 h-5 text-green-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Seguridad</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="session-timeout" class="block text-sm font-medium text-gray-700 mb-2">Tiempo para cerrar sesión (minutos)</label>
                                            <input type="number" id="session-timeout" value="${state.settings.sessionTimeout || 480}" min="30" max="1440" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors">
                                            <p class="text-xs text-gray-500 mt-1">Cuánto tiempo antes de cerrar la sesión sola</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="enable-audit-log" class="block text-sm font-medium text-gray-700">Guardar historial</label>
                                                <p class="text-xs text-gray-500 mt-1">Guarda un registro de todo lo que se hace</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="enable-audit-log" ${state.settings.enableAuditLog ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="barcode-scanning" class="block text-sm font-medium text-gray-700">Leer códigos de barras</label>
                                                <p class="text-xs text-gray-500 mt-1">Permite leer códigos de barras con la cámara</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="barcode-scanning" ${state.settings.barcodeScanning ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'interface':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Display Settings -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-purple-100 rounded mr-3">
                                            <i data-lucide="table" class="w-5 h-5 text-purple-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Cómo ver las listas</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="table-density" class="block text-sm font-medium text-gray-700 mb-2">Espacio entre filas</label>
                                            <select id="table-density" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors">
                                                <option value="compact" ${state.settings.displayPreferences?.tableDensity === 'compact' ? 'selected' : ''}>Compacta</option>
                                                <option value="comfortable" ${state.settings.displayPreferences?.tableDensity === 'comfortable' ? 'selected' : ''}>Cómoda</option>
                                                <option value="spacious" ${state.settings.displayPreferences?.tableDensity === 'spacious' ? 'selected' : ''}>Espaciosa</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Cuánto espacio hay entre las filas</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="show-column-lines" class="block text-sm font-medium text-gray-700">Mostrar líneas entre columnas</label>
                                                <p class="text-xs text-gray-500 mt-1">Muestra líneas que separan las columnas</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="show-column-lines" ${state.settings.displayPreferences?.showColumnLines ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="enable-row-hover" class="block text-sm font-medium text-gray-700">Resaltar filas al pasar el mouse</label>
                                                <p class="text-xs text-gray-500 mt-1">Resalta la fila cuando pasas el mouse encima</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="enable-row-hover" ${state.settings.displayPreferences?.enableRowHover ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Interface Customization -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-orange-100 rounded mr-3">
                                            <i data-lucide="palette" class="w-5 h-5 text-orange-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Apariencia</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="font-size" class="block text-sm font-medium text-gray-700 mb-2">Tamaño de fuente</label>
                                            <select id="font-size" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors">
                                                <option value="small" ${state.settings.interfaceCustomization?.fontSize === 'small' ? 'selected' : ''}>Pequeña</option>
                                                <option value="medium" ${state.settings.interfaceCustomization?.fontSize === 'medium' ? 'selected' : ''}>Mediana</option>
                                                <option value="large" ${state.settings.interfaceCustomization?.fontSize === 'large' ? 'selected' : ''}>Grande</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Cambia el tamaño del texto</p>
                                        </div>
                                        <div>
                                            <label for="color-theme" class="block text-sm font-medium text-gray-700 mb-2">Tema de color</label>
                                            <select id="color-theme" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors">
                                                <option value="blue" ${state.settings.interfaceCustomization?.colorTheme === 'blue' ? 'selected' : ''}>Azul (por defecto)</option>
                                                <option value="green" ${state.settings.interfaceCustomization?.colorTheme === 'green' ? 'selected' : ''}>Verde</option>
                                                <option value="purple" ${state.settings.interfaceCustomization?.colorTheme === 'purple' ? 'selected' : ''}>Morado</option>
                                                <option value="orange" ${state.settings.interfaceCustomization?.colorTheme === 'orange' ? 'selected' : ''}>Naranja</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Cambia los colores principales de la aplicación</p>
                                        </div>
                                        <div>
                                            <label for="button-size" class="block text-sm font-medium text-gray-700 mb-2">Tamaño de botones</label>
                                            <select id="button-size" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors">
                                                <option value="normal" ${state.settings.interfaceCustomization?.buttonSize === 'normal' ? 'selected' : ''}>Normal</option>
                                                <option value="large" ${state.settings.interfaceCustomization?.buttonSize === 'large' ? 'selected' : ''}>Grande</option>
                                                <option value="extra-large" ${state.settings.interfaceCustomization?.buttonSize === 'extra-large' ? 'selected' : ''}>Extra Grande</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Tamaño de los botones en la interfaz</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="compact-sidebar" class="block text-sm font-medium text-gray-700">Barra lateral pequeña</label>
                                                <p class="text-xs text-gray-500 mt-1">Hace la barra lateral más pequeña</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="compact-sidebar" ${state.settings.interfaceCustomization?.compactSidebar ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="animations-enabled" class="block text-sm font-medium text-gray-700">Animaciones</label>
                                                <p class="text-xs text-gray-500 mt-1">Muestra movimientos y efectos</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="animations-enabled" ${state.settings.interfaceCustomization?.animationsEnabled ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'display':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Table & List Settings -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-purple-100 rounded mr-3">
                                            <i data-lucide="table" class="w-5 h-5 text-purple-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Cómo ver las listas</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="table-density" class="block text-sm font-medium text-gray-700 mb-2">Espacio entre filas</label>
                                            <select id="table-density" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors">
                                                <option value="compact" ${state.settings.displayPreferences?.tableDensity === 'compact' ? 'selected' : ''}>Compacta</option>
                                                <option value="comfortable" ${state.settings.displayPreferences?.tableDensity === 'comfortable' ? 'selected' : ''}>Cómoda</option>
                                                <option value="spacious" ${state.settings.displayPreferences?.tableDensity === 'spacious' ? 'selected' : ''}>Espaciosa</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Cuánto espacio hay entre las filas</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="show-column-lines" class="block text-sm font-medium text-gray-700">Mostrar líneas entre columnas</label>
                                                <p class="text-xs text-gray-500 mt-1">Muestra líneas que separan las columnas</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="show-column-lines" ${state.settings.displayPreferences?.showColumnLines ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="enable-row-hover" class="block text-sm font-medium text-gray-700">Resaltar filas al pasar el mouse</label>
                                                <p class="text-xs text-gray-500 mt-1">Resalta la fila cuando pasas el mouse encima</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="enable-row-hover" ${state.settings.displayPreferences?.enableRowHover ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Interface Customization -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-orange-100 rounded mr-3">
                                            <i data-lucide="palette" class="w-5 h-5 text-orange-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Apariencia</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="font-size" class="block text-sm font-medium text-gray-700 mb-2">Tamaño de fuente</label>
                                            <select id="font-size" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors">
                                                <option value="small" ${state.settings.interfaceCustomization?.fontSize === 'small' ? 'selected' : ''}>Pequeña</option>
                                                <option value="medium" ${state.settings.interfaceCustomization?.fontSize === 'medium' ? 'selected' : ''}>Mediana</option>
                                                <option value="large" ${state.settings.interfaceCustomization?.fontSize === 'large' ? 'selected' : ''}>Grande</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Cambia el tamaño del texto</p>
                                        </div>
                                        <div>
                                            <label for="color-theme" class="block text-sm font-medium text-gray-700 mb-2">Tema de color</label>
                                            <select id="color-theme" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors">
                                                <option value="blue" ${state.settings.interfaceCustomization?.colorTheme === 'blue' ? 'selected' : ''}>Azul (por defecto)</option>
                                                <option value="green" ${state.settings.interfaceCustomization?.colorTheme === 'green' ? 'selected' : ''}>Verde</option>
                                                <option value="purple" ${state.settings.interfaceCustomization?.colorTheme === 'purple' ? 'selected' : ''}>Morado</option>
                                                <option value="orange" ${state.settings.interfaceCustomization?.colorTheme === 'orange' ? 'selected' : ''}>Naranja</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Cambia los colores principales de la aplicación</p>
                                        </div>
                                        <div>
                                            <label for="button-size" class="block text-sm font-medium text-gray-700 mb-2">Tamaño de botones</label>
                                            <select id="button-size" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors">
                                                <option value="normal" ${state.settings.interfaceCustomization?.buttonSize === 'normal' ? 'selected' : ''}>Normal</option>
                                                <option value="large" ${state.settings.interfaceCustomization?.buttonSize === 'large' ? 'selected' : ''}>Grande</option>
                                                <option value="extra-large" ${state.settings.interfaceCustomization?.buttonSize === 'extra-large' ? 'selected' : ''}>Extra Grande</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Tamaño de los botones en la interfaz</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="compact-sidebar" class="block text-sm font-medium text-gray-700">Barra lateral pequeña</label>
                                                <p class="text-xs text-gray-500 mt-1">Hace la barra lateral más pequeña</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="compact-sidebar" ${state.settings.interfaceCustomization?.compactSidebar ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="animations-enabled" class="block text-sm font-medium text-gray-700">Animaciones</label>
                                                <p class="text-xs text-gray-500 mt-1">Muestra movimientos y efectos</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="animations-enabled" ${state.settings.interfaceCustomization?.animationsEnabled ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'operational':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Quick Actions & Shortcuts -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-cyan-100 rounded mr-3">
                                            <i data-lucide="zap" class="w-5 h-5 text-cyan-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Acciones Rápidas</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="default-transaction-type" class="block text-sm font-medium text-gray-700 mb-2">Tipo de transacción por defecto</label>
                                            <select id="default-transaction-type" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-colors">
                                                <option value="Entrada" ${state.settings.operationalPreferences?.defaultTransactionType === 'Entrada' ? 'selected' : ''}>Entrada</option>
                                                <option value="Salida" ${state.settings.operationalPreferences?.defaultTransactionType === 'Salida' ? 'selected' : ''}>Salida</option>
                                                <option value="Ajuste" ${state.settings.operationalPreferences?.defaultTransactionType === 'Ajuste' ? 'selected' : ''}>Ajuste</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Tipo de transacción preseleccionado al registrar movimientos</p>
                                        </div>
                                        <div>
                                            <label for="recent-items-count" class="block text-sm font-medium text-gray-700 mb-2">Elementos recientes a mostrar</label>
                                            <input type="number" id="recent-items-count" value="${state.settings.operationalPreferences?.recentItemsCount || 10}" min="5" max="50" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-colors">
                                            <p class="text-xs text-gray-500 mt-1">Cantidad de elementos recientes que se muestran para acceso rápido</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="show-recent-items" class="block text-sm font-medium text-gray-700">Mostrar elementos recientes</label>
                                                <p class="text-xs text-gray-500 mt-1">Muestra una lista de elementos utilizados recientemente</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="show-recent-items" ${state.settings.operationalPreferences?.showRecentItems ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="confirm-before-delete" class="block text-sm font-medium text-gray-700">Confirmar antes de eliminar</label>
                                                <p class="text-xs text-gray-500 mt-1">Solicita confirmación antes de eliminar elementos</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="confirm-before-delete" ${state.settings.operationalPreferences?.confirmBeforeDelete ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Productivity Settings -->
                                <div class="bg-gray-50 rounded p-6 border border-emerald-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-emerald-100 rounded mr-3">
                                            <i data-lucide="clock" class="w-5 h-5 text-emerald-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Productividad</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="auto-save" class="block text-sm font-medium text-gray-700">Auto-guardar formularios</label>
                                                <p class="text-xs text-gray-500 mt-1">Guarda automáticamente los formularios mientras escribes</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="auto-save" ${state.settings.productivitySettings?.autoSave ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div>
                                            <label for="auto-save-interval" class="block text-sm font-medium text-gray-700 mb-2">Intervalo de auto-guardado (segundos)</label>
                                            <input type="number" id="auto-save-interval" value="${state.settings.productivitySettings?.autoSaveInterval || 30}" min="10" max="300" step="10" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                                            <p class="text-xs text-gray-500 mt-1">Cada cuántos segundos se guarda automáticamente</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="remember-last-page" class="block text-sm font-medium text-gray-700">Recordar última página</label>
                                                <p class="text-xs text-gray-500 mt-1">Abre en la última página visitada al iniciar sesión</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="remember-last-page" ${state.settings.productivitySettings?.rememberLastPage ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="enable-keyboard-shortcuts" class="block text-sm font-medium text-gray-700">Atajos de teclado</label>
                                                <p class="text-xs text-gray-500 mt-1">Usar teclas para acciones rápidas</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="enable-keyboard-shortcuts" ${state.settings.productivitySettings?.enableKeyboardShortcuts ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'advanced':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Dashboard Settings -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-cyan-100 rounded mr-3">
                                            <i data-lucide="layout-dashboard" class="w-5 h-5 text-cyan-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Panel Principal</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="show-stock-overview" class="block text-sm font-medium text-gray-700">Mostrar resumen de stock</label>
                                                <p class="text-xs text-gray-500 mt-1">Muestra el resumen de inventario en el panel</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="show-stock-overview" ${state.settings.dashboardCustomization?.showStockOverview ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="show-recent-transactions" class="block text-sm font-medium text-gray-700">Mostrar transacciones recientes</label>
                                                <p class="text-xs text-gray-500 mt-1">Muestra las últimas transacciones en el panel</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="show-recent-transactions" ${state.settings.dashboardCustomization?.showRecentTransactions ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="show-low-stock-alerts" class="block text-sm font-medium text-gray-700">Mostrar alertas de stock bajo</label>
                                                <p class="text-xs text-gray-500 mt-1">Muestra productos con stock bajo en el panel</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="show-low-stock-alerts" ${state.settings.dashboardCustomization?.showLowStockAlerts ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="show-quick-actions" class="block text-sm font-medium text-gray-700">Mostrar acciones rápidas</label>
                                                <p class="text-xs text-gray-500 mt-1">Muestra botones de acciones rápidas en el panel</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="show-quick-actions" ${state.settings.dashboardCustomization?.showQuickActions ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Data Management -->
                                <div class="bg-gray-50 rounded p-6 border border-emerald-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-emerald-100 rounded mr-3">
                                            <i data-lucide="database" class="w-5 h-5 text-emerald-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Gestión de Datos</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="auto-backup" class="block text-sm font-medium text-gray-700">Backup automático</label>
                                                <p class="text-xs text-gray-500 mt-1">Hace copias de seguridad automáticamente</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="auto-backup" ${state.settings.backup?.autoBackup ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div>
                                            <label for="backup-frequency" class="block text-sm font-medium text-gray-700 mb-2">Frecuencia de backup</label>
                                            <select id="backup-frequency" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                                                <option value="daily" ${state.settings.backup?.backupFrequency === 'daily' ? 'selected' : ''}>Diario</option>
                                                <option value="weekly" ${state.settings.backup?.backupFrequency === 'weekly' ? 'selected' : ''}>Semanal</option>
                                                <option value="monthly" ${state.settings.backup?.backupFrequency === 'monthly' ? 'selected' : ''}>Mensual</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Con qué frecuencia hacer backup</p>
                                        </div>
                                        <div class="flex space-x-3">
                                            <button id="export-data-btn" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2 px-4 rounded flex items-center justify-center space-x-2">
                                                <i data-lucide="download" class="w-4 h-4"></i>
                                                <span>Exportar</span>
                                            </button>
                                            <button id="import-data-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded flex items-center justify-center space-x-2">
                                                <i data-lucide="upload" class="w-4 h-4"></i>
                                                <span>Importar</span>
                                            </button>
                                        </div>
                                        <div class="flex space-x-3">
                                            <button id="create-backup-btn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded flex items-center justify-center space-x-2">
                                                <i data-lucide="save" class="w-4 h-4"></i>
                                                <span>Crear Backup</span>
                                            </button>
                                            <button id="restore-backup-btn" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white font-medium py-2 px-4 rounded flex items-center justify-center space-x-2">
                                                <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                                <span>Restaurar</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Notifications Settings -->
                            <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                <div class="flex items-center mb-4">
                                    <div class="p-2 bg-amber-100 rounded mr-3">
                                        <i data-lucide="bell" class="w-5 h-5 text-amber-600"></i>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-900">Notificaciones</h3>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="low-stock-alert" class="block text-sm font-medium text-gray-700 mb-2">Alerta de stock bajo</label>
                                        <select id="low-stock-alert" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors">
                                            <option value="always" ${state.settings.notificationPreferences?.lowStockAlert === 'always' ? 'selected' : ''}>Siempre</option>
                                            <option value="on_login" ${state.settings.notificationPreferences?.lowStockAlert === 'on_login' ? 'selected' : ''}>Al iniciar sesión</option>
                                            <option value="never" ${state.settings.notificationPreferences?.lowStockAlert === 'never' ? 'selected' : ''}>Nunca</option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">Cuándo mostrar alertas de stock bajo</p>
                                    </div>
                                    <div>
                                        <label for="inactive-items-days" class="block text-sm font-medium text-gray-700 mb-2">Días para productos inactivos</label>
                                        <input type="number" id="inactive-items-days" value="${state.settings.notificationPreferences?.inactiveItemsDays || 30}" min="7" max="365" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors">
                                        <p class="text-xs text-gray-500 mt-1">Días sin movimiento para considerar inactivo</p>
                                    </div>
                                    <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                        <div>
                                            <label for="sound-alerts" class="block text-sm font-medium text-gray-700">Sonidos de alerta</label>
                                            <p class="text-xs text-gray-500 mt-1">Reproducir sonidos para alertas</p>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="sound-alerts" ${state.settings.notificationPreferences?.soundAlerts ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                        <div>
                                            <label for="daily-email" class="block text-sm font-medium text-gray-700">Email diario</label>
                                            <p class="text-xs text-gray-500 mt-1">Enviar resumen diario por email</p>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="daily-email" ${state.settings.notificationPreferences?.dailyEmail ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'dashboard':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Dashboard Widgets -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-pink-100 rounded mr-3">
                                            <i data-lucide="layout-dashboard" class="w-5 h-5 text-pink-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Widgets del Panel</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="show-stock-overview" class="block text-sm font-medium text-gray-700">Resumen de stock</label>
                                                <p class="text-xs text-gray-500 mt-1">Muestra el gráfico de artículos más utilizados</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="show-stock-overview" ${state.settings.dashboardCustomization?.showStockOverview ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="show-recent-transactions" class="block text-sm font-medium text-gray-700">Transacciones recientes</label>
                                                <p class="text-xs text-gray-500 mt-1">Muestra el gráfico de empleados con más préstamos</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="show-recent-transactions" ${state.settings.dashboardCustomization?.showRecentTransactions ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="show-low-stock-alerts" class="block text-sm font-medium text-gray-700">Alertas de stock bajo</label>
                                                <p class="text-xs text-gray-500 mt-1">Muestra el gráfico de herramientas más reportadas</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="show-low-stock-alerts" ${state.settings.dashboardCustomization?.showLowStockAlerts ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="show-quick-actions" class="block text-sm font-medium text-gray-700">Acciones rápidas</label>
                                                <p class="text-xs text-gray-500 mt-1">Muestra widget con botones de acciones comunes</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="show-quick-actions" ${state.settings.dashboardCustomization?.showQuickActions ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Chart & Display Options -->
                                <div class="bg-gradient-to-br from-indigo-50 to-blue-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-indigo-100 rounded mr-3">
                                            <i data-lucide="bar-chart-3" class="w-5 h-5 text-indigo-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Gráficos y Visualización</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="chart-type" class="block text-sm font-medium text-gray-700 mb-2">Tipo de gráfico por defecto</label>
                                            <select id="chart-type" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                                                <option value="bar" ${state.settings.dashboardCustomization?.chartType === 'bar' ? 'selected' : ''}>Barras</option>
                                                <option value="line" ${state.settings.dashboardCustomization?.chartType === 'line' ? 'selected' : ''}>Líneas</option>
                                                <option value="pie" ${state.settings.dashboardCustomization?.chartType === 'pie' ? 'selected' : ''}>Circular</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Tipo de gráfico preferido para mostrar datos</p>
                                        </div>
                                        <div>
                                            <label for="default-date-range" class="block text-sm font-medium text-gray-700 mb-2">Rango de fecha por defecto</label>
                                            <select id="default-date-range" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                                                <option value="7days" ${state.settings.dashboardCustomization?.defaultDateRange === '7days' ? 'selected' : ''}>Últimos 7 días</option>
                                                <option value="30days" ${state.settings.dashboardCustomization?.defaultDateRange === '30days' ? 'selected' : ''}>Últimos 30 días</option>
                                                <option value="90days" ${state.settings.dashboardCustomization?.defaultDateRange === '90days' ? 'selected' : ''}>Últimos 90 días</option>
                                                <option value="year" ${state.settings.dashboardCustomization?.defaultDateRange === 'year' ? 'selected' : ''}>Último año</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Periodo de tiempo predeterminado para los informes</p>
                                        </div>
                                        <div>
                                            <label for="refresh-interval" class="block text-sm font-medium text-gray-700 mb-2">Intervalo de actualización (segundos)</label>
                                            <input type="number" id="refresh-interval" value="${state.settings.dashboardCustomization?.refreshInterval || 60}" min="10" max="3600" step="10" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                                            <p class="text-xs text-gray-500 mt-1">Frecuencia con la que se actualizan automáticamente los datos del panel</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'stock':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                
                                <!-- Stock Validations -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-red-100 rounded mr-3">
                                            <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Validaciones de Stock</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="max-quantity-transaction" class="block text-sm font-medium text-gray-700 mb-2">Cantidad máxima por transacción</label>
                                            <input type="number" id="max-quantity-transaction" value="${state.settings.customValidations?.maxQuantityPerTransaction || 1000}" min="1" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors">
                                            <p class="text-xs text-gray-500 mt-1">Límite máximo de productos que se pueden mover en una sola transacción</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="require-notes-large" class="block text-sm font-medium text-gray-700">Requerir notas en transacciones grandes</label>
                                                <p class="text-xs text-gray-500 mt-1">Obliga a incluir notas cuando las cantidades son altas</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="require-notes-large" ${state.settings.customValidations?.requireNotesForLargeTransactions ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="prevent-negative-stock" class="block text-sm font-medium text-gray-700">Prevenir stock negativo</label>
                                                <p class="text-xs text-gray-500 mt-1">Impide realizar operaciones que resulten en stock negativo</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="prevent-negative-stock" ${state.settings.customValidations?.preventNegativeStock ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'notifications':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Stock Alerts -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-yellow-100 rounded mr-3">
                                            <i data-lucide="bell" class="w-5 h-5 text-yellow-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Alertas de Stock</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="low-stock-notifications" class="block text-sm font-medium text-gray-700">Alertas de stock bajo</label>
                                                <p class="text-xs text-gray-500 mt-1">Recibe notificaciones cuando el stock esté bajo</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="low-stock-notifications" ${state.settings.lowStockNotifications ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div>
                                            <label for="notification-emails" class="block text-sm font-medium text-gray-700 mb-2">Correos para notificaciones</label>
                                            <textarea id="notification-emails" rows="3" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors" placeholder="correo1@ejemplo.com, correo2@ejemplo.com">${state.settings.notificationEmails || ''}</textarea>
                                            <p class="text-xs text-gray-500 mt-1">Separar múltiples correos con comas</p>
                                        </div>
                                        <div>
                                            <label for="stock-alert-days" class="block text-sm font-medium text-gray-700 mb-2">Días para alertas de stock</label>
                                            <input type="text" id="stock-alert-days" value="${(state.settings.stockAlertDays || [1, 7, 30]).join(', ')}" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors" placeholder="1, 7, 30">
                                            <p class="text-xs text-gray-500 mt-1">Intervalos en días para mostrar alertas (separados por comas)</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Scheduled Reports -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-blue-100 rounded mr-3">
                                            <i data-lucide="calendar" class="w-5 h-5 text-blue-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Reportes Programados</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="enable-scheduled-reports" class="block text-sm font-medium text-gray-700">Habilitar reportes automáticos</label>
                                                <p class="text-xs text-gray-500 mt-1">Genera y envía reportes de forma automática</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="enable-scheduled-reports" ${state.settings.enableScheduledReports ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div>
                                            <label for="report-schedule" class="block text-sm font-medium text-gray-700 mb-2">Frecuencia de reportes</label>
                                            <select id="report-schedule" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-black focus:border-blue-500 transition-colors">
                                                <option value="daily" ${state.settings.reportSchedule === 'daily' ? 'selected' : ''}>Diario</option>
                                                <option value="weekly" ${state.settings.reportSchedule === 'weekly' ? 'selected' : ''}>Semanal</option>
                                                <option value="monthly" ${state.settings.reportSchedule === 'monthly' ? 'selected' : ''}>Mensual</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Con qué frecuencia se generan los reportes automáticos</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'workflow':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Approval Workflows -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-purple-100 rounded mr-3">
                                            <i data-lucide="workflow" class="w-5 h-5 text-purple-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Flujos de Aprobación</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="enable-workflow-approvals" class="block text-sm font-medium text-gray-700">Requerir aprobaciones</label>
                                                <p class="text-xs text-gray-500 mt-1">Requiere aprobación para transacciones importantes</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="enable-workflow-approvals" ${state.settings.enableWorkflowApprovals ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div>
                                            <label for="approval-threshold" class="block text-sm font-medium text-gray-700 mb-2">Umbral para aprobación (cantidad)</label>
                                            <input type="number" id="approval-threshold" value="${state.settings.approvalThreshold || 100}" min="1" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors">
                                            <p class="text-xs text-gray-500 mt-1">Transacciones superiores a esta cantidad requerirán aprobación de supervisor</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Data Management -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-gray-100 rounded mr-3">
                                            <i data-lucide="database" class="w-5 h-5 text-gray-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Gestión de Datos</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="data-retention-days" class="block text-sm font-medium text-gray-700 mb-2">Días de retención de historial</label>
                                            <input type="number" id="data-retention-days" value="${state.settings.dataRetentionDays || 365}" min="30" max="2555" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-gray-500 focus:border-gray-500 transition-colors">
                                            <p class="text-xs text-gray-500 mt-1">Tiempo para mantener registros históricos antes del archivado automático</p>
                                        </div>
                                        <div class="pt-4">
                                            <button id="archive-old-data-btn" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-medium py-2.5 px-4 rounded flex items-center justify-center space-x-2 transition-colors">
                                                <i data-lucide="archive" class="w-4 h-4"></i>
                                                <span>Archivar Datos Antiguos</span>
                                            </button>
                                            <p class="text-xs text-gray-500 mt-2">Archiva registros más antiguos que el período de retención configurado</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'data':
                    content.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold flex items-center"><i data-lucide="upload" class="mr-2"></i>Importar Datos</h3>
                                <div>
                                    <label for="import-file" class="block text-sm font-medium themed-text-light mb-1">Importar inventario desde CSV</label>
                                    <input type="file" id="import-file" accept=".csv" class="themed-input w-full border rounded-md px-4 py-3">
                                    <p class="text-xs themed-text-light mt-1">Formato: descripción, categoría, tipo, stock, unidad, minStock</p>
                                </div>
                                <button id="import-data-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded flex items-center space-x-2">
                                    <i data-lucide="upload"></i><span>Importar Datos</span>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold flex items-center"><i data-lucide="download" class="mr-2"></i>Exportar y Respaldar</h3>
                                <div class="space-y-2">
                                    <button id="export-inventory-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded flex items-center justify-center space-x-2">
                                        <i data-lucide="download"></i><span>Exportar Inventario Completo</span>
                                    </button>
                                    <button id="export-settings-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded flex items-center justify-center space-x-2">
                                        <i data-lucide="settings"></i><span>Respaldar Configuraciones</span>
                                    </button>
                                    <button id="export-full-backup-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded flex items-center justify-center space-x-2">
                                        <i data-lucide="hard-drive"></i><span>Respaldo Completo</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'categories':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Category Management -->
                                <div class="bg-gray-50 rounded p-6 border border-emerald-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-emerald-100 rounded mr-3">
                                            <i data-lucide="folder-plus" class="w-5 h-5 text-emerald-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Gestión de Categorías</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="new-category-name" class="block text-sm font-medium text-gray-700 mb-2">Añadir Nueva Categoría</label>
                                            <div class="flex space-x-3">
                                                <input type="text" id="new-category-name" placeholder="Nombre de la categoría" maxlength="50" class="themed-input flex-grow border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                                                <button id="add-category-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-medium px-4 py-2.5 rounded flex items-center space-x-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                                    <span>Añadir</span>
                                                </button>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1">Crea una nueva categoría para organizar tus productos (máximo 50 caracteres)</p>
                                        </div>
                                        <div>
                                            <h4 class="text-sm font-medium text-gray-700 mb-3">Categorías Existentes</h4>
                                            <div id="category-management-list" class="space-y-2 max-h-80 overflow-y-auto">
                                                ${(() => {
                                                    const categoriesList = state.categories.filter(c => c !== 'Todas');
                                                    if (categoriesList.length === 0) {
                                                        return `
                                                            <div class="text-center py-8 text-gray-500">
                                                                <i data-lucide="folder-x" class="w-12 h-12 mx-auto mb-3 text-gray-400"></i>
                                                                <p class="text-sm">No hay categorías creadas aún</p>
                                                                <p class="text-xs mt-1">Crea una categoría arriba para comenzar</p>
                                                            </div>
                                                        `;
                                                    }
                                                    return categoriesList.map(cat => {
                                                        const itemCount = state.inventory ? state.inventory.filter(item => item.category === cat).length : 0;
                                                        return `
                                                            <div class="flex items-center justify-between p-3 bg-white rounded border border-gray-200 hover:border-emerald-300 transition-colors group">
                                                                <div class="flex items-center space-x-3 flex-grow min-w-0">
                                                                    <div class="p-1.5 bg-emerald-100 rounded-md flex-shrink-0">
                                                                        <i data-lucide="folder" class="w-3.5 h-3.5 text-emerald-600"></i>
                                                                    </div>
                                                                    <div class="flex-grow min-w-0">
                                                                        <span class="category-name text-gray-900 font-medium block truncate">${cat}</span>
                                                                        <div class="flex items-center space-x-2 mt-0.5">
                                                                            <span class="text-xs ${itemCount === 0 ? 'text-gray-400' : 'text-emerald-600'} flex items-center">
                                                                                <i data-lucide="${itemCount === 0 ? 'package' : 'package-check'}" class="w-3 h-3 mr-1"></i>
                                                                                ${itemCount === 0 ? 'Sin artículos' : `${itemCount} artículo${itemCount === 1 ? '' : 's'}`}
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="flex items-center space-x-2 flex-shrink-0">
                                                                    <button class="rename-category-btn p-1.5 text-blue-500 hover:text-blue-600 hover:bg-blue-50 rounded-md transition-colors" data-category="${cat}" title="Renombrar categoría">
                                                                        <i data-lucide="pencil" class="w-4 h-4"></i>
                                                                    </button>
                                                                    <button class="delete-category-btn p-1.5 text-red-500 hover:text-red-600 hover:bg-red-50 rounded-md transition-colors" data-category="${cat}" title="Eliminar categoría">
                                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        `;
                                                    }).join('');
                                                })()}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Bulk Operations -->
                                <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-amber-100 rounded mr-3">
                                            <i data-lucide="layers" class="w-5 h-5 text-amber-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Acciones Masivas</h3>
                                    </div>
                                    <div class="space-y-6">
                                        <div class="p-4 bg-white rounded border border-gray-200">
                                            <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                                                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                                                Cambiar Tipo de Categoría
                                            </h4>
                                            <div class="space-y-3">
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                    <div>
                                                        <label class="block text-xs text-gray-500 mb-1">Categoría</label>
                                                        <select id="bulk-category-select" class="themed-input w-full border border-gray-300 rounded px-4 py-3 text-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors">
                                                            ${state.categories.filter(c => c !== 'Todas').map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs text-gray-500 mb-1">Nuevo Tipo</label>
                                                        <select id="bulk-type-select" class="themed-input w-full border border-gray-300 rounded px-4 py-3 text-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors">
                                                            <option value="Consumible">Consumible</option>
                                                            <option value="Retornable">Retornable</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <button id="bulk-update-type-btn" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-medium py-2 px-4 rounded flex items-center justify-center space-x-2 transition-colors">
                                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                                    <span>Actualizar Tipo</span>
                                                </button>
                                                <p class="text-xs text-gray-500">Esta acción cambiará el tipo de todos los artículos en la categoría seleccionada</p>
                                            </div>
                                        </div>
                                        
                                        <div class="p-4 bg-red-50 rounded border border-gray-200">
                                            <h4 class="text-sm font-medium text-red-700 mb-3 flex items-center">
                                                <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                                                Eliminar Categoría Completa
                                            </h4>
                                            <div class="space-y-3">
                                                <div>
                                                    <label class="block text-xs text-red-600 mb-1">Seleccionar categoría a eliminar</label>
                                                    <select id="bulk-delete-category-select" class="themed-input w-full border border-red-300 rounded px-4 py-3 text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors">
                                                        <option value="" selected disabled>Seleccionar categoría...</option>
                                                        ${state.categories.filter(c => c !== 'Todas').map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                                    </select>
                                                </div>
                                                <button id="bulk-delete-category-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded flex items-center justify-center space-x-2 transition-colors">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    <span>Eliminar Categoría</span>
                                                </button>
                                                <div class="p-3 bg-red-100 rounded-md">
                                                    <p class="text-xs text-red-700 font-medium">⚠️ Acción Irreversible</p>
                                                    <p class="text-xs text-red-600 mt-1">Esta acción eliminará la categoría y todos los artículos que contiene de forma permanente</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'my-config':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Display Settings -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-blue-100 rounded mr-3">
                                            <i data-lucide="eye" class="w-5 h-5 text-blue-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Cómo Ver el Inventario</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="operator-items-per-page" class="block text-sm font-medium text-gray-700 mb-2">Artículos por página</label>
                                            <select id="operator-items-per-page" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-black focus:border-blue-500 transition-colors">
                                                <option value="10" ${state.settings.itemsPerPage === 10 ? 'selected' : ''}>10 artículos</option>
                                                <option value="20" ${state.settings.itemsPerPage === 20 ? 'selected' : ''}>20 artículos</option>
                                                <option value="30" ${state.settings.itemsPerPage === 30 ? 'selected' : ''}>30 artículos</option>
                                                <option value="50" ${state.settings.itemsPerPage === 50 ? 'selected' : ''}>50 artículos</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Cuántos artículos ver en cada página</p>
                                        </div>
                                        <div>
                                            <label for="operator-table-density" class="block text-sm font-medium text-gray-700 mb-2">Espacio entre filas</label>
                                            <select id="operator-table-density" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-black focus:border-blue-500 transition-colors">
                                                <option value="compact" ${state.settings.displayPreferences?.tableDensity === 'compact' ? 'selected' : ''}>Compacta</option>
                                                <option value="comfortable" ${state.settings.displayPreferences?.tableDensity === 'comfortable' ? 'selected' : ''}>Cómoda</option>
                                                <option value="spacious" ${state.settings.displayPreferences?.tableDensity === 'spacious' ? 'selected' : ''}>Espaciosa</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Cuánto espacio hay entre las filas</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="operator-show-lines" class="block text-sm font-medium text-gray-700">Mostrar líneas entre columnas</label>
                                                <p class="text-xs text-gray-500 mt-1">Muestra líneas que separan las columnas</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="operator-show-lines" ${state.settings.displayPreferences?.showColumnLines ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Appearance Settings -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-purple-100 rounded mr-3">
                                            <i data-lucide="palette" class="w-5 h-5 text-purple-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Apariencia</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="operator-font-size" class="block text-sm font-medium text-gray-700 mb-2">Tamaño del texto</label>
                                            <select id="operator-font-size" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors">
                                                <option value="small" ${state.settings.interfaceCustomization?.fontSize === 'small' ? 'selected' : ''}>Pequeño</option>
                                                <option value="medium" ${state.settings.interfaceCustomization?.fontSize === 'medium' ? 'selected' : ''}>Mediano</option>
                                                <option value="large" ${state.settings.interfaceCustomization?.fontSize === 'large' ? 'selected' : ''}>Grande</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Cambia el tamaño del texto</p>
                                        </div>
                                        <div>
                                            <label for="operator-color-theme" class="block text-sm font-medium text-gray-700 mb-2">Tema de color</label>
                                            <select id="operator-color-theme" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors">
                                                <option value="blue" ${state.settings.interfaceCustomization?.colorTheme === 'blue' ? 'selected' : ''}>Azul (por defecto)</option>
                                                <option value="green" ${state.settings.interfaceCustomization?.colorTheme === 'green' ? 'selected' : ''}>Verde</option>
                                                <option value="purple" ${state.settings.interfaceCustomization?.colorTheme === 'purple' ? 'selected' : ''}>Morado</option>
                                                <option value="orange" ${state.settings.interfaceCustomization?.colorTheme === 'orange' ? 'selected' : ''}>Naranja</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Cambia los colores principales</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="operator-compact-sidebar" class="block text-sm font-medium text-gray-700">Barra lateral pequeña</label>
                                                <p class="text-xs text-gray-500 mt-1">Hace la barra lateral más pequeña</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="operator-compact-sidebar" ${state.settings.interfaceCustomization?.compactSidebar ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="operator-animations" class="block text-sm font-medium text-gray-700">Animaciones</label>
                                                <p class="text-xs text-gray-500 mt-1">Muestra movimientos y efectos</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="operator-animations" ${state.settings.interfaceCustomization?.animationsEnabled ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Workflow Settings -->
                            <div class="bg-gray-50 rounded p-6 border border-emerald-200">
                                <div class="flex items-center mb-4">
                                    <div class="p-2 bg-emerald-100 rounded mr-3">
                                        <i data-lucide="zap" class="w-5 h-5 text-emerald-600"></i>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-900">Trabajo Diario</h3>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="operator-default-action" class="block text-sm font-medium text-gray-700 mb-2">Acción por defecto</label>
                                        <select id="operator-default-action" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                                            <option value="Entrada" ${state.settings.operationalPreferences?.defaultTransactionType === 'Entrada' ? 'selected' : ''}>Entrada</option>
                                            <option value="Salida" ${state.settings.operationalPreferences?.defaultTransactionType === 'Salida' ? 'selected' : ''}>Salida</option>
                                            <option value="Ajuste" ${state.settings.operationalPreferences?.defaultTransactionType === 'Ajuste' ? 'selected' : ''}>Ajuste</option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">Tipo de transacción preseleccionado</p>
                                    </div>
                                    <div>
                                        <label for="operator-recent-count" class="block text-sm font-medium text-gray-700 mb-2">Elementos recientes a mostrar</label>
                                        <input type="number" id="operator-recent-count" value="${state.settings.operationalPreferences?.recentItemsCount || 10}" min="5" max="50" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                                        <p class="text-xs text-gray-500 mt-1">Cantidad de elementos recientes para acceso rápido</p>
                                    </div>
                                    <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                        <div>
                                            <label for="operator-show-recent" class="block text-sm font-medium text-gray-700">Mostrar elementos recientes</label>
                                            <p class="text-xs text-gray-500 mt-1">Muestra una lista de elementos utilizados recientemente</p>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="operator-show-recent" ${state.settings.operationalPreferences?.showRecentItems ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                        <div>
                                            <label for="operator-keyboard-shortcuts" class="block text-sm font-medium text-gray-700">Atajos de teclado</label>
                                            <p class="text-xs text-gray-500 mt-1">Usar teclas para acciones rápidas</p>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="operator-keyboard-shortcuts" ${state.settings.productivitySettings?.enableKeyboardShortcuts ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Productivity Settings -->
                            <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                <div class="flex items-center mb-4">
                                    <div class="p-2 bg-amber-100 rounded mr-3">
                                        <i data-lucide="clock" class="w-5 h-5 text-amber-600"></i>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-900">Productividad</h3>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                        <div>
                                            <label for="operator-auto-save" class="block text-sm font-medium text-gray-700">Auto-guardar formularios</label>
                                            <p class="text-xs text-gray-500 mt-1">Guarda automáticamente los formularios mientras escribes</p>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="operator-auto-save" ${state.settings.productivitySettings?.autoSave ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                        <div>
                                            <label for="operator-remember-page" class="block text-sm font-medium text-gray-700">Recordar última página</label>
                                            <p class="text-xs text-gray-500 mt-1">Abre en la última página visitada al iniciar sesión</p>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="operator-remember-page" ${state.settings.productivitySettings?.rememberLastPage ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                        <div>
                                            <label for="operator-confirm-delete" class="block text-sm font-medium text-gray-700">Confirmar antes de eliminar</label>
                                            <p class="text-xs text-gray-500 mt-1">Solicita confirmación antes de eliminar elementos</p>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="operator-confirm-delete" ${state.settings.operationalPreferences?.confirmBeforeDelete ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'preferences':
                    content.innerHTML = `
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                                <!-- Alert Settings -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-amber-100 rounded mr-3">
                                            <i data-lucide="bell" class="w-5 h-5 text-amber-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Alertas</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="operator-low-stock-alert" class="block text-sm font-medium text-gray-700 mb-2">Alerta de stock bajo</label>
                                            <select id="operator-low-stock-alert" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors">
                                                <option value="always" ${state.settings.notificationPreferences?.lowStockAlert === 'always' ? 'selected' : ''}>Siempre</option>
                                                <option value="on_login" ${state.settings.notificationPreferences?.lowStockAlert === 'on_login' ? 'selected' : ''}>Al iniciar sesión</option>
                                                <option value="never" ${state.settings.notificationPreferences?.lowStockAlert === 'never' ? 'selected' : ''}>Nunca</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">Cuándo mostrar alertas de stock bajo</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="operator-sound-alerts" class="block text-sm font-medium text-gray-700">Sonidos de alerta</label>
                                                <p class="text-xs text-gray-500 mt-1">Reproducir sonidos para alertas</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="operator-sound-alerts" ${state.settings.notificationPreferences?.soundAlerts ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- System Settings -->
                                <div class="bg-gray-50 rounded p-6 border border-gray-200">
                                    <div class="flex items-center mb-4">
                                        <div class="p-2 bg-gray-100 rounded mr-3">
                                            <i data-lucide="settings" class="w-5 h-5 text-gray-600"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-900">Sistema</h3>
                                    </div>
                                    <div class="space-y-5">
                                        <div>
                                            <label for="operator-session-timeout" class="block text-sm font-medium text-gray-700 mb-2">Tiempo de sesión (minutos)</label>
                                            <input type="number" id="operator-session-timeout" value="${state.settings.sessionTimeout || 480}" min="15" max="1440" class="themed-input w-full border border-gray-300 rounded px-4 py-2.5 focus:ring-2 focus:ring-gray-500 focus:border-gray-500 transition-colors">
                                            <p class="text-xs text-gray-500 mt-1">Tiempo antes de cerrar sesión automáticamente</p>
                                        </div>
                                        <div class="flex items-center justify-between p-4 bg-white rounded border border-gray-200">
                                            <div>
                                                <label for="operator-barcode-scanning" class="block text-sm font-medium text-gray-700">Escaneo de códigos de barras</label>
                                                <p class="text-xs text-gray-500 mt-1">Permitir escanear códigos de barras</p>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="operator-barcode-scanning" ${state.settings.barcodeScanning ? 'checked' : ''}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
            safeCreateIcons();
        }



        // --- LÓGICA DE EVENTOS ---
        function setupStaticEventListeners() {
            // Handle form submission
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault(); // Prevent default form submission
                
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                const loginButton = document.getElementById('login-button');
                const loginIcon = document.getElementById('login-icon');
                const loginText = document.getElementById('login-text');
                const loginSpinner = document.getElementById('login-spinner');

                // Hide any previous error messages
                document.getElementById('auth-error-message').classList.add('hidden');

                // Validate inputs
                if (!email || !password) {
                    displayAuthError('auth/invalid-input');
                    return;
                }

                // Show loading state
                loginButton.disabled = true;
                loginIcon.classList.add('hidden');
                loginText.classList.add('hidden');
                loginSpinner.classList.remove('hidden');

                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    await handleSuccessfulLogin(userCredential.user);
                    
                } catch (error) {
                    displayAuthError(error.code);
                } finally {
                    // Reset button state
                    loginButton.disabled = false;
                    loginIcon.classList.remove('hidden');
                    loginText.classList.remove('hidden');
                    loginSpinner.classList.add('hidden');
                }
            });

            // Email validation in real-time
            const emailInput = document.getElementById('email');
            const emailValidation = document.getElementById('email-validation');
            
            if (emailInput && emailValidation) {
                emailInput.addEventListener('input', (e) => {
                    const email = e.target.value.trim();
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    
                    if (email.length > 0) {
                        if (emailRegex.test(email)) {
                            emailValidation.classList.remove('hidden');
                            emailInput.classList.remove('border-red-300');
                            emailInput.classList.add('border-green-300');
                        } else {
                            emailValidation.classList.add('hidden');
                            emailInput.classList.remove('border-green-300');
                            emailInput.classList.add('border-red-300');
                        }
                    } else {
                        emailValidation.classList.add('hidden');
                        emailInput.classList.remove('border-green-300', 'border-red-300');
                    }
                });
            }

            // Debug button (temporary)
            document.getElementById('debug-button').addEventListener('click', async () => {
                try {
                    const testRef = collection(db, 'test');
                    alert('✅ Firebase está conectado correctamente');
                } catch (error) {
                    alert('❌ Error de conexión con Firebase: ' + error.message);
                }
            });

            document.getElementById('logout-button').addEventListener('click', () => { 
                cleanupListeners(); // Clean up listeners before logout
                signOut(auth); 
            });
            
            document.getElementById('main-nav').addEventListener('click', (e) => {
                const navLink = e.target.closest('.nav-link');
                if (navLink) {
                    e.preventDefault();
                    window.location.hash = navLink.getAttribute('href').substring(1);
                }
            });
            

            window.addEventListener('hashchange', () => {
                const page = window.location.hash.substring(1) || 'dashboard';
                if(state.isInitialized) {
                    navigateTo(page);
                }
            });
            
            // Handle initial page load with hash (when page is refreshed)
            // This ensures content is rendered even if auth state changes after page load
            // Use a more robust approach that checks multiple times
            if (window.location.hash) {
                const checkAndNavigate = () => {
                    if (state.isInitialized && state.currentUser) {
                        const currentPage = window.location.hash.substring(1) || 'dashboard';
                        const mainContent = document.getElementById('main-content');
                        if (mainContent && (!mainContent.innerHTML.trim() || currentPage === 'settings')) {
                            navigateTo(currentPage, true);
                        }
                    } else if (!state.isInitialized) {
                        // Keep checking until initialized
                        setTimeout(checkAndNavigate, 100);
                    }
                };
                // Start checking after a brief delay
                setTimeout(checkAndNavigate, 200);
            }

            // Mobile menu functionality
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobile-overlay');
            const menuButton = document.getElementById('menu-button');
            
            if (menuButton && sidebar) {
                menuButton.addEventListener('click', () => {
                    const isOpen = !sidebar.classList.contains('-translate-x-full');
                    sidebar.classList.toggle('-translate-x-full');
                    mobileOverlay?.classList.toggle('hidden');
                    menuButton.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
                    menuButton.setAttribute('aria-label', isOpen ? 'Abrir menú de navegación' : 'Cerrar menú de navegación');
                });
                
                // Close sidebar when clicking overlay
                if (mobileOverlay) {
                    mobileOverlay.addEventListener('click', () => {
                        sidebar.classList.add('-translate-x-full');
                        mobileOverlay.classList.add('hidden');
                        menuButton.setAttribute('aria-expanded', 'false');
                        menuButton.setAttribute('aria-label', 'Abrir menú de navegación');
                    });
                }
            }
            
            
            // Handle window resize for mobile enhancements
            window.addEventListener('resize', () => {
                setTimeout(() => {
                    enhanceMobileTables();
                    enhanceMobileExperience();
                }, 100);
            });

            // Chrome autocomplete blocking - nuclear option
            const searchInput = document.getElementById('search-input');
            
            // Readonly trick: Chrome won't autocomplete readonly fields
            searchInput.setAttribute('readonly', 'readonly');
            setTimeout(() => {
                searchInput.removeAttribute('readonly');
            }, 100);
            
            // Remove autocomplete on focus
            searchInput.addEventListener('focus', function() {
                this.setAttribute('autocomplete', 'new-password');
                this.setAttribute('autocomplete', 'off');
                this.setAttribute('autocomplete', 'nope');
            });
            
            // Prevent Chrome from adding autocomplete back
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.attributeName === 'autocomplete') {
                        const currentValue = searchInput.getAttribute('autocomplete');
                        if (currentValue !== 'off' && currentValue !== 'new-password') {
                            searchInput.setAttribute('autocomplete', 'off');
                        }
                    }
                });
            });
            observer.observe(searchInput, { attributes: true });

            // === SEARCHBAR MEJORADO - Event Listeners ===
            
            const clearBtn = document.getElementById('clear-search-btn');
            const advancedPanel = document.getElementById('advanced-search-panel');
            const advancedToggle = document.getElementById('advanced-search-toggle');
            const syntaxHighlight = document.getElementById('search-syntax-highlight');
            let searchTimeout;
            
            // Update clear button visibility and syntax highlighting
            function updateSearchUI(value) {
                if (clearBtn) {
                    if (value && value.length > 0) {
                        clearBtn.classList.remove('hidden');
                    } else {
                        clearBtn.classList.add('hidden');
                    }
                    // Asegurar que los iconos se rendericen
                    setTimeout(() => {
                        if (typeof safeCreateIcons === 'function') {
                            safeCreateIcons();
                        }
                    }, 50);
                }
                
                // Syntax highlighting
                if (syntaxHighlight && value) {
                    syntaxHighlight.innerHTML = highlightSearchSyntax(value);
                } else if (syntaxHighlight) {
                    syntaxHighlight.innerHTML = '';
                }
            }
            
            // Inicializar iconos del searchbar después de cargar
            setTimeout(() => {
                if (typeof safeCreateIcons === 'function') {
                    safeCreateIcons();
                }
            }, 200);
            
            // Input event with debouncing
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                updateSearchUI(searchTerm);
                
                // Debounced search execution
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    state.searchTerm = searchTerm;
                    state.currentPage = 1;
                    const page = window.location.hash.substring(1) || 'dashboard';
                    navigateTo(page, true);
                }, 300);
            });
            
            // Clear search button
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    searchInput.value = '';
                    updateSearchUI('');
                    state.searchTerm = '';
                    hideSearchSuggestions();
                    searchInput.focus();
                    const page = window.location.hash.substring(1) || 'dashboard';
                    navigateTo(page, true);
                });
            }
            
            // Advanced search panel toggle
            if (advancedToggle && advancedPanel) {
                advancedToggle.addEventListener('click', () => {
                    const isExpanded = !advancedPanel.classList.contains('hidden');
                    advancedPanel.classList.toggle('hidden');
                    advancedToggle.setAttribute('aria-expanded', isExpanded ? 'false' : 'true');
                    setTimeout(() => {
                        if (typeof safeCreateIcons === 'function') {
                            safeCreateIcons();
                        }
                    }, 50);
                });
            }
            
            // Keyboard shortcuts (sin sugerencias)
            searchInput.addEventListener('keydown', (e) => {
                switch (e.key) {
                    case 'Escape':
                        if (searchInput.value) {
                            searchInput.value = '';
                            updateSearchUI('');
                            state.searchTerm = '';
                            hideSearchSuggestions();
                            navigateTo(window.location.hash.substring(1) || 'dashboard', true);
                        } else {
                            searchInput.blur();
                        }
                        e.preventDefault();
                        break;
                }
            });
            
            // Global keyboard shortcut: Ctrl+K / Cmd+K to focus search
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    const searchablePages = ['inventory', 'active-loans', 'history'];
                    const currentPage = window.location.hash.substring(1) || 'dashboard';
                    if (searchablePages.includes(currentPage)) {
                        e.preventDefault();
                        searchInput.focus();
                        searchInput.select();
                    }
                }
            });
            
            // Reposition suggestions on scroll and resize
            window.addEventListener('scroll', () => {
                const suggestions = document.getElementById('search-suggestions');
                if (suggestions && !suggestions.classList.contains('hidden')) {
                    positionSearchSuggestions();
                }
            }, true);
            
            window.addEventListener('resize', () => {
                const suggestions = document.getElementById('search-suggestions');
                if (suggestions && !suggestions.classList.contains('hidden')) {
                    positionSearchSuggestions();
                }
                updateSearchUI(searchInput.value);
            });
            
            // Ocultar sugerencias al hacer clic fuera
            document.addEventListener('click', (e) => {
                const searchContainer = document.querySelector('.mobile-search');
                const suggestions = document.getElementById('search-suggestions');
                if (searchContainer && suggestions && !searchContainer.contains(e.target)) {
                    hideSearchSuggestions();
                }
            });
            
            document.body.addEventListener('click', (e) => {
                if (!state.isInitialized) return;
                const target = e.target;

                // Settings Page Events
                if (window.location.hash === '#settings') {
                    if (target.closest('#save-settings-btn')) { handleSaveSettings(); return; }
                    if (target.closest('#reset-settings-btn')) { resetToOriginalSettings(); return; }
                    if (target.closest('.preset-btn')) { 
                        const presetName = target.closest('.preset-btn').dataset.preset;
                        applySettingsPreset(presetName); 
                        return; 
                    }
                    if (target.closest('#add-category-btn')) { handleAddCategory(); return; }
                    if (target.closest('#bulk-update-type-btn')) { handleBulkUpdateCategoryType(); return; }
                    if (target.closest('#bulk-delete-category-btn')) {
                        const categoryToDelete = document.getElementById('bulk-delete-category-select').value;
                        if (categoryToDelete) {
                            handleDeleteCategory(categoryToDelete);
                        } else {
                            showNotification('Selecciona una categoría para eliminar.', 'info');
                        }
                        return;
                    }
                    if (target.closest('#import-data-btn')) { handleImportData(); return; }
                    if (target.closest('#export-inventory-btn')) { handleExportInventory(); return; }
                    if (target.closest('#export-settings-btn')) { handleExportSettings(); return; }
                    if (target.closest('#export-full-backup-btn')) { handleExportFullBackup(); return; }
                    if (target.closest('#archive-old-data-btn')) { handleArchiveOldData(); return; }
                    
                    // New Export/Import/Backup Events
                    if (target.closest('#export-data-btn')) { 
                        const format = target.closest('#export-data-btn').dataset.format || 'csv';
                        exportInventory(format); 
                        return; 
                    }
                    if (target.closest('#import-data-btn')) { 
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.csv,.json,.xlsx,.xls';
                        input.onchange = (e) => importInventory(e.target.files[0]);
                        input.click();
                        return; 
                    }
                    if (target.closest('#create-backup-btn')) { createBackup(); return; }
                    if (target.closest('#restore-backup-btn')) { 
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.json';
                        input.onchange = (e) => restoreBackup(e.target.files[0]);
                        input.click();
                        return; 
                    }
                    
                    const settingsTab = target.closest('.settings-tab-link');
                    if (settingsTab) { e.preventDefault(); renderSettingsTab(settingsTab.dataset.tab); return; }
                    
                    const renameBtn = target.closest('.rename-category-btn');
                    if (renameBtn) { handleRenameCategory(renameBtn.dataset.category); return; }
                    const deleteBtn = target.closest('.delete-category-btn');
                    if (deleteBtn) { handleDeleteCategory(deleteBtn.dataset.category); return; }
                }
                
                const addCategoryBtnInventory = target.closest('#add-category-btn-inventory');
                if (addCategoryBtnInventory) { showAddCategoryModal(); return; }

                const categoryFilter = target.closest('.category-filter');
                if (categoryFilter) { e.preventDefault(); state.activeCategory = categoryFilter.dataset.category; state.currentPage = 1; renderInventoryView(); return; }

                const inventoryFilter = target.closest('.inventory-filter-btn');
                if (inventoryFilter) { e.preventDefault(); state.inventoryFilter = inventoryFilter.dataset.filter; state.currentPage = 1; renderInventoryView(); return; }
                
                // Event listeners para chips de búsqueda
                if (target.id === 'clear-search-chip') { 
                    e.preventDefault(); 
                    state.searchTerm = '';
                    document.getElementById('search-input').value = '';
                    renderInventoryView(); 
                    return; 
                }

                const pageLink = target.closest('.page-link');
                if (pageLink) { e.preventDefault(); const page = parseInt(pageLink.dataset.page, 10); if (page) { state.currentPage = page; renderInventoryView(); } return; }

                const actionBtn = target.closest('.action-btn');
                if (actionBtn) { handleInventoryAction(actionBtn.dataset.action, actionBtn.dataset.id); return; }

                const returnBtn = target.closest('.return-btn');
                if (returnBtn) { handleReturnLoan(returnBtn.dataset.loanId, returnBtn.dataset.itemId); return; }
                
                const reportLossBtn = target.closest('.report-loss-btn');
                if(reportLossBtn) { handleReportLoanLoss(reportLossBtn.dataset.loanId, reportLossBtn.dataset.itemId); return; }

                const tabLink = target.closest('.tab-link');
                if (tabLink) { e.preventDefault(); renderHistoryTab(tabLink.dataset.type); return; }

                const reportBtn = target.closest('.report-btn');
                if (reportBtn) { 
                    const reportType = reportBtn.dataset.type;
                    const format = reportBtn.dataset.format;
                    showReportPreview(reportType, format);
                    return; 
                }

                const removeFromCartBtn = target.closest('.remove-from-cart-btn');
                if (removeFromCartBtn) { removeFromShoppingList(removeFromCartBtn.dataset.id); return; }
                
                if (target.id === 'generate-pdf-btn') { generateShoppingListPDF(); return; }
                if (target.id === 'generate-excel-btn') { generateShoppingListExcel(); return; }
                if (target.id === 'generate-manual-inventory-pdf') { generateManualInventoryPDF(); return; }
                
                // Preview report events
                if (target.id === 'close-preview' || target.closest('#close-preview')) { 
                    closeReportPreview(); 
                    return; 
                }
                if (target.id === 'cancel-preview-btn') { 
                    closeReportPreview(); 
                    return; 
                }
                if (target.id === 'confirm-download-btn') { 
                    confirmReportDownload(); 
                    return; 
                }
            });
            
            // Enhanced keyboard shortcuts listener
            document.body.addEventListener('keydown', (e) => {
                if (!state.isInitialized || !state.settings.operationalPreferences.enableKeyboardShortcuts) return;

                // Ignore shortcuts if user is typing in an input (except for global shortcuts)
                if ((e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') && 
                    !(e.ctrlKey || e.metaKey)) {
                    return;
                }

                // Global shortcuts (work even in inputs)
                if (e.key.toLowerCase() === 'k' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    document.getElementById('search-input')?.focus();
                }

                if (e.key.toLowerCase() === 'n' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    if (state.userRole === 'admin') {
                        showNewItemModal();
                    } else {
                        showNotification("Solo los administradores pueden agregar artículos.", "info");
                    }
                }

                // Quick Actions shortcuts (Ctrl/Cmd + 1, 2, 3)
                if ((e.ctrlKey || e.metaKey) && !e.shiftKey && !e.altKey) {
                    if (e.key === '1') {
                        e.preventDefault();
                        const quickAddItemBtn = document.getElementById('quick-add-item');
                        if (quickAddItemBtn && quickAddItemBtn._quickActionHandler) {
                            quickAddItemBtn._quickActionHandler();
                        }
                    } else if (e.key === '2') {
                        e.preventDefault();
                        const quickAddEntryBtn = document.getElementById('quick-add-entry');
                        if (quickAddEntryBtn && quickAddEntryBtn._quickActionHandler) {
                            quickAddEntryBtn._quickActionHandler();
                        }
                    } else if (e.key === '3') {
                        e.preventDefault();
                        const quickAddCheckoutBtn = document.getElementById('quick-add-checkout');
                        if (quickAddCheckoutBtn && quickAddCheckoutBtn._quickActionHandler) {
                            quickAddCheckoutBtn._quickActionHandler();
                        }
                    }
                }

                // Navigation shortcuts (only when not in inputs)
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'SELECT') {
                    if (e.key.toLowerCase() === 'f') {
                        e.preventDefault();
                        document.getElementById('search-input')?.focus();
                    }

                    if (e.key.toLowerCase() === 's' && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        // Save current form if any is open
                        const activeModal = document.querySelector('.modal:not(.hidden)');
                        if (activeModal) {
                            const saveBtn = activeModal.querySelector('button[type="submit"], .btn-save');
                            if (saveBtn) saveBtn.click();
                        }
                    }

                    if (e.key === 'Escape') {
                        e.preventDefault();
                        // Close any open modal
                        const activeModal = document.querySelector('.modal:not(.hidden)');
                        if (activeModal) {
                            const closeBtn = activeModal.querySelector('.modal-close, .close-modal');
                            if (closeBtn) closeBtn.click();
                        }
                    }

                    // Navigation shortcuts
                    if (e.key.toLowerCase() === 'd' && !e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        navigateTo('dashboard');
                    }
                    if (e.key.toLowerCase() === 'i' && !e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        navigateTo('inventory');
                    }
                    if (e.key.toLowerCase() === 'h' && !e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        navigateTo('history');
                    }
                }

                // Form shortcuts (when in inputs)
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        // Try to submit form or move to next field
                        const form = e.target.closest('form');
                        if (form) {
                            const submitBtn = form.querySelector('button[type="submit"]');
                            if (submitBtn && submitBtn.offsetParent !== null) {
                                submitBtn.click();
                            } else {
                                // Move to next input
                                const inputs = Array.from(form.querySelectorAll('input, textarea, select'));
                                const currentIndex = inputs.indexOf(e.target);
                                if (currentIndex < inputs.length - 1) {
                                    inputs[currentIndex + 1].focus();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // --- MANEJO DE ACCIONES ---
        function handleInventoryAction(action, id) {
            const item = state.inventory.find(i => i.id === id);
            if (!item) return;
            switch (action) {
                case 'entry': showEntryModal(item); break;
                case 'checkout':
                    if (item.stock <= 0) {
                        showNotification('No hay stock disponible para este artículo.', 'error');
                        return;
                    }
                    showCheckoutModal(item);
                    break;
                case 'edit': showEditItemModal(item); break;
                case 'edit-stock': showEditStockModal(item); break;
                case 'delete': handleDeleteItem(item); break;
                case 'add-to-cart': showAddToCartModal(item); break;
            }
        }

        async function handleDeleteItem(item) {
            const deleteLogic = async () => {
                try {
                    await deleteDoc(doc(db, 'inventory', item.id));
                    await addDoc(collection(db, 'transactions'), {
                        itemDescription: item.description, type: 'Eliminado', quantity: item.stock,
                        timestamp: serverTimestamp(), user: state.currentUser.email, notes: 'Artículo eliminado del sistema'
                    });
                    showNotification('Artículo eliminado.', 'success');
                } catch (error) {
                    showNotification('Error al eliminar. Intenta de nuevo.', 'error');
                }
            };

            if (state.settings.operationalPreferences.confirmBeforeDelete) {
                showConfirmationModal(`¿Estás seguro de que quieres eliminar "${item.description}"? Esta acción no se puede deshacer.`, deleteLogic);
            } else {
                deleteLogic();
            }
        }

        async function handleReturnLoan(loanId, itemId) {
            const itemRef = doc(db, 'inventory', itemId);
            const loanRef = doc(db, 'loans', loanId);
            try {
                const itemDoc = await getDoc(itemRef);
                if (!itemDoc.exists()) throw new Error("Item not found");
                const loanDoc = await getDoc(loanRef);
                if (!loanDoc.exists()) throw new Error("Loan not found");
                
                const batch = writeBatch(db);
                batch.update(itemRef, { stock: itemDoc.data().stock + 1 });
                batch.update(loanRef, { returnedAt: serverTimestamp() });
                const transactionRef = doc(collection(db, 'transactions'));
                batch.set(transactionRef, {
                    itemId: itemId, itemDescription: itemDoc.data().description, type: 'Devolución',
                    quantity: 1, borrower: loanDoc.data().borrower,
                    timestamp: serverTimestamp(), user: state.currentUser.email,
                    returnedBy: state.currentUser.email
                });
                await batch.commit();
                showNotification('Devolución guardada.', 'success');
            } catch (error) {
                showNotification('Error al devolver. Intenta de nuevo.', 'error');
            }
        }
        async function handleReportLoanLoss(loanId, itemId) {
            const loan = state.activeLoans.find(l => l.id === loanId);
            const item = state.inventory.find(i => i.id === itemId);
            if (!loan || !item) return;
            showReportLossModal(loan, item);
        }

        // --- LÓGICA DE MODALES ---
        // Store element that opened modal for focus restoration
        let previousActiveElement = null;
        
        function showModal(title, content, maxWidth = 'max-w-2xl') {
            const modalContainer = document.getElementById('modal-container');
            // Store current active element
            previousActiveElement = document.activeElement;
            
            const modalId = 'modal-' + Date.now();
            const titleId = 'modal-title-' + Date.now();
            
            modalContainer.innerHTML = `
                <div id="app-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40" role="dialog" aria-modal="true" aria-labelledby="${titleId}" aria-describedby="${modalId}-description">
                    <div class="relative top-4 sm:top-20 mx-auto p-4 sm:p-5 border w-full sm:w-auto ${maxWidth} shadow-sm rounded-md themed-card themed-border pop-animation mobile-modal" id="${modalId}">
                        <div class="flex justify-between items-center pb-3 border-b themed-border">
                            <h3 id="${titleId}" class="text-xl sm:text-2xl font-bold">${title}</h3>
                            <button id="close-modal-btn" class="p-2 rounded hover:bg-gray-100 transition-colors" aria-label="Cerrar modal">
                                <i data-lucide="x" class="h-5 w-5 sm:h-6 sm:w-6" aria-hidden="true"></i>
                            </button>
                        </div>
                        <div class="mt-3" id="${modalId}-description">${content}</div>
                    </div>
                </div>`;
            safeCreateIcons();
            
            const modal = document.getElementById('app-modal');
            const closeBtn = document.getElementById('close-modal-btn');
            const modalContent = document.getElementById(modalId);
            
            // Close button handler
            closeBtn.addEventListener('click', () => {
                closeModal();
                // Restore focus to previous element
                if (previousActiveElement && typeof previousActiveElement.focus === 'function') {
                    previousActiveElement.focus();
                }
            });
            
            // Close on backdrop click
            modal.addEventListener('click', (e) => { 
                if (e.target.id === 'app-modal') {
                    closeModal();
                    if (previousActiveElement && typeof previousActiveElement.focus === 'function') {
                        previousActiveElement.focus();
                    }
                }
            });
            
            // Trap focus within modal
            const focusableElements = modalContent.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];
            
            // Handle Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    if (previousActiveElement && typeof previousActiveElement.focus === 'function') {
                        previousActiveElement.focus();
                    }
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
            
            // Trap focus with Tab key
            const handleTab = (e) => {
                if (e.key !== 'Tab') return;
                
                if (e.shiftKey) {
                    if (document.activeElement === firstFocusable) {
                        e.preventDefault();
                        lastFocusable.focus();
                    }
                } else {
                    if (document.activeElement === lastFocusable) {
                        e.preventDefault();
                        firstFocusable.focus();
                    }
                }
            };
            modalContent.addEventListener('keydown', handleTab);
            
            // Auto-focus first input in modal
            setTimeout(() => {
                const firstInput = modalContent.querySelector('input:not([type="hidden"]):not([disabled]), textarea:not([disabled]), select:not([disabled])');
                if (firstInput) {
                    firstInput.focus();
                } else if (firstFocusable) {
                    firstFocusable.focus();
                }
            }, 100);
        }
        function closeModal() { 
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = '';
            // Restore focus if previous element exists
            if (previousActiveElement && typeof previousActiveElement.focus === 'function') {
                previousActiveElement.focus();
            }
        }
        
        // Mobile table enhancement function
        function enhanceMobileTables() {
            const tables = document.querySelectorAll('.mobile-table');
            tables.forEach(table => {
                const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
                const rows = table.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    cells.forEach((cell, index) => {
                        if (headers[index]) {
                            cell.setAttribute('data-label', headers[index]);
                        }
                    });
                });
            });
        }
        
        // Enhanced table styling function
        function enhanceTables() {
            const tables = document.querySelectorAll('table:not(.table-enhanced)');
            tables.forEach(table => {
                table.classList.add('table-enhanced');
                
                // Add action buttons container to each row if not present
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    if (!row.querySelector('.action-buttons')) {
                        const lastCell = row.querySelector('td:last-child');
                        if (lastCell && !lastCell.classList.contains('action-cell')) {
                            lastCell.innerHTML += '<div class="action-buttons inline-flex space-x-1 ml-2"></div>';
                        }
                    }
                });
            });
        }

        // Auto-apply enhanced styles when DOM is ready
        function applyEnhancedStyles() {
            // Apply to existing tables
            enhanceTables();
            
            // Apply themed-input class to inputs that don't have it
            const inputs = document.querySelectorAll('input:not(.themed-input), textarea:not(.themed-input), select:not(.themed-input)');
            inputs.forEach(input => {
                if (!input.classList.contains('themed-input')) {
                    input.classList.add('themed-input');
                }
            });
            
            // Apply focus-enhanced class to interactive elements
            const interactiveElements = document.querySelectorAll('button, input, textarea, select, a');
            interactiveElements.forEach(el => {
                if (!el.classList.contains('focus-enhanced')) {
                    el.classList.add('focus-enhanced');
                }
            });
        }

        // Mobile-specific enhancements
        function enhanceMobileExperience() {
            // Add mobile classes to buttons
            const buttons = document.querySelectorAll('button:not(.mobile-btn)');
            buttons.forEach(btn => {
                if (window.innerWidth < 768) {
                    btn.classList.add('mobile-btn');
                }
            });
            
            // Enhance form inputs for mobile
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (window.innerWidth < 768) {
                    input.classList.add('mobile-form');
                }
            });
            
            // Close sidebar on mobile when navigating
            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                const mobileOverlay = document.getElementById('mobile-overlay');
                if (sidebar && !sidebar.classList.contains('-translate-x-full')) {
                    sidebar.classList.add('-translate-x-full');
                    mobileOverlay.classList.add('hidden');
                }
            }
        }

        function showConfirmationModal(message, onConfirm) {
            const content = `
                <p class="themed-text-light mb-6">${message}</p>
                <div class="flex justify-end space-x-4">
                    <button id="confirm-cancel" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Cancelar</button>
                    <button id="confirm-accept" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Confirmar</button>
                </div>`;
            showModal('Confirmación Requerida', content, 'max-w-md');
            document.getElementById('confirm-accept').addEventListener('click', () => { onConfirm(); closeModal(); });
            document.getElementById('confirm-cancel').addEventListener('click', closeModal);
        }

        function showEntryModal(item = null) {
            // If no item is passed, show a selector
            const itemSelector = !item ? `
                <div class="mb-4">
                    <label for="item-select" class="block text-sm font-medium themed-text-light">Seleccionar Artículo</label>
                    <select id="item-select" name="item-select" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        <option value="" disabled selected>Elige un artículo...</option>
                        ${state.inventory.map(i => `<option value="${i.id}">${i.description}</option>`).join('')}
                    </select>
                </div>` : `<p class="mb-4"><strong>Artículo:</strong> ${item.description}</p>`;

            const content = `
                ${itemSelector}
                <form id="entry-form">
                    <div class="mb-4">
                        <label for="quantity" class="block text-sm font-medium themed-text-light">Cantidad</label>
                        <input type="number" id="quantity" name="quantity" min="1" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                    </div>
                    <div class="mb-4">
                        <label for="supplier" class="block text-sm font-medium themed-text-light">Proveedor (Opcional)</label>
                        <input type="text" id="supplier" name="supplier" class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                    </div>
                    <div class="mb-4">
                        <label for="notes" class="block text-sm font-medium themed-text-light">Notas (Opcional)</label>
                        <textarea id="notes" name="notes" rows="2" class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm"></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded min-h-[56px] flex items-center justify-center transition-all duration-200">
                            <i data-lucide="plus-circle" class="h-6 w-6 mr-2"></i>
                            Registrar Entrada
                        </button>
                    </div>
                </form>`;
            showModal('Registrar Entrada', content, 'max-w-md');
            document.getElementById('entry-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const itemToUpdate = item || state.inventory.find(i => i.id === e.target.closest('.relative').querySelector('#item-select')?.value);
                if (!itemToUpdate) {
                    showNotification("Por favor, selecciona un artículo.", "error");
                    return;
                }
                const { quantity, supplier, notes } = e.target.elements;
                const itemRef = doc(db, 'inventory', itemToUpdate.id);
                await updateDoc(itemRef, { stock: itemToUpdate.stock + parseInt(quantity.value) });
                await addDoc(collection(db, 'transactions'), {
                    itemId: itemToUpdate.id, itemDescription: itemToUpdate.description, type: 'Entrada', quantity: parseInt(quantity.value),
                    supplier: supplier.value, notes: notes.value, timestamp: serverTimestamp(), user: state.currentUser.email
                });
                showNotification('Entrada registrada.', 'success');
                closeModal();
            });
        }
        function showCheckoutModal(item = null) {
             const itemSelector = !item ? `
                <div class="mb-4">
                    <label for="item-select" class="block text-sm font-medium themed-text-light mb-2">Seleccionar Artículo</label>
                    
                    <!-- Búsqueda inteligente -->
                    <div class="relative mb-3">
                        <input type="text" id="item-search" placeholder="Buscar..." 
                               class="themed-input w-full px-4 py-3 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <i data-lucide="search" class="h-4 w-4 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <!-- Sugerencias inteligentes -->
                    <div id="smart-suggestions" class="mb-3">
                        <div class="flex items-center mb-2">
                            <i data-lucide="zap" class="h-4 w-4 text-yellow-500 mr-2"></i>
                            <span class="text-sm font-medium text-gray-700">Más utilizados</span>
                        </div>
                        <div id="suggestions-list" class="grid grid-cols-1 gap-2">
                            <!-- Las sugerencias se cargarán dinámicamente -->
                        </div>
                    </div>
                    
                    <!-- Selector tradicional -->
                    <select id="item-select" name="item-select" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        <option value="" disabled selected>O elige de la lista...</option>
                        ${state.inventory.map(i => `<option value="${i.id}">${i.description}</option>`).join('')}
                    </select>
                </div>` : `<p class="mb-4"><strong>Artículo:</strong> ${item.description}</p>`;

            const content = `
                ${itemSelector}
                <form id="checkout-form">
                     <!-- Form fields will be populated by JS -->
                </form>`;
            showModal('Registrar Salida / Préstamo', content, 'max-w-md');

            const formContainer = document.getElementById('checkout-form');
            const itemSelect = document.getElementById('item-select');
            
            // Cargar sugerencias inteligentes
            if (!item) {
                loadSmartSuggestions();
                setupSmartSearch();
            }
            
            const populateForm = (selectedItem) => {
                if (!selectedItem) {
                    formContainer.innerHTML = '';
                    return;
                }
                
                const hasStock = selectedItem.stock > 0;
                const isEndmill = selectedItem.category.toLowerCase().includes('endmill');
                const maxQuantity = Math.min(selectedItem.stock, state.settings.customValidations?.maxQuantityPerTransaction || 1000);
                const requireNotes = state.settings.customValidations?.requireNotesForLargeTransactions;
                
                formContainer.innerHTML = `
                    <div class="mb-4">
                        <label class="block text-sm font-medium themed-text-light">Tipo de Operación</label>
                        <div class="mt-2 space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="operationType" value="consumible" class="form-radio text-blue-600" checked>
                                <span class="ml-2 text-sm themed-text-light">Consumible (Salida)</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="operationType" value="retornable" class="form-radio text-green-600">
                                <span class="ml-2 text-sm themed-text-light">Retornable (Préstamo)</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Consumible fields -->
                    <div id="consumible-fields">
                        <div class="mb-4">
                            <label for="quantity" class="block text-sm font-medium themed-text-light">Cantidad</label>
                            <input type="number" id="quantity" name="quantity" min="1" max="${maxQuantity}" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                            <p class="text-xs themed-text-light mt-1">Máximo: ${maxQuantity} ${selectedItem.unit}</p>
                        </div>
                        <div class="mb-4">
                            <label for="user" class="block text-sm font-medium themed-text-light">Nombre de quien retira</label>
                            <input type="text" id="user" name="user" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        </div>
                        ${isEndmill ? `
                        <div class="mb-4">
                            <label class="block text-sm font-medium themed-text-light">¿Devolvió pieza rota?</label>
                            <div class="mt-2 space-x-4">
                                <label><input type="radio" name="exchange" value="yes" class="form-radio"> Sí (Intercambio)</label>
                                <label><input type="radio" name="exchange" value="no" class="form-radio" checked> No (Salida)</label>
                            </div>
                        </div>` : ''}
                        <div class="mb-4" id="notes-container" ${requireNotes ? '' : 'style="display:none"'}>
                            <label for="notes" class="block text-sm font-medium themed-text-light">Notas ${requireNotes ? '(Requerido para cantidades grandes)' : '(Opcional)'}</label>
                            <textarea id="notes" name="notes" rows="2" class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm"></textarea>
                        </div>
                    </div>
                    
                    <!-- Retornable fields -->
                    <div id="retornable-fields" style="display: none;">
                        <div class="mb-4">
                            <label for="borrower" class="block text-sm font-medium themed-text-light">Nombre de quien solicita</label>
                            <input type="text" id="borrower" name="borrower" class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm" ${!hasStock ? 'disabled' : ''}>
                        </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded min-h-[56px] flex items-center justify-center transition-all duration-200 ${!hasStock ? 'opacity-50 cursor-not-allowed' : ''}" ${!hasStock ? 'disabled' : ''}>
                            <i data-lucide="arrow-right-left" class="h-6 w-6 mr-2"></i>
                            <span id="submit-btn-text">Registrar Salida</span>
                        </button>
                    </div>
                `;
                
                // Add event listeners for radio buttons
                const operationTypeRadios = formContainer.querySelectorAll('input[name="operationType"]');
                const consumibleFields = document.getElementById('consumible-fields');
                const retornableFields = document.getElementById('retornable-fields');
                const submitBtnText = document.getElementById('submit-btn-text');
                
                operationTypeRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        if (e.target.value === 'consumible') {
                            consumibleFields.style.display = 'block';
                            retornableFields.style.display = 'none';
                            submitBtnText.textContent = 'Registrar Salida';
                        } else {
                            consumibleFields.style.display = 'none';
                            retornableFields.style.display = 'block';
                            submitBtnText.textContent = 'Registrar Préstamo';
                        }
                    });
                });
            };
            
            if(item) {
                populateForm(item);
            } else {
                itemSelect.addEventListener('change', (e) => {
                    const selectedItem = state.inventory.find(i => i.id === e.target.value);
                    populateForm(selectedItem);
                });
            }

            formContainer.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    const selectedItem = item || (itemSelect ? state.inventory.find(i => i.id === itemSelect.value) : null);
                    if (!selectedItem) {
                         showNotification("Selecciona un artículo.", "error");
                         return;
                    }
                    
                    // Get the operation type selected by the operator
                    const operationType = e.target.elements.operationType.value;
                    
                    if (operationType === 'consumible') {
                        // Logic for Consumable
                        const quantity = e.target.elements.quantity;
                        const user = e.target.elements.user;
                        const exchange = e.target.elements.exchange;
                        const notes = e.target.elements.notes;
                        
                        if (!quantity || !user || !quantity.value || !user.value) {
                            showNotification('Completa todos los campos requeridos.', 'error');
                            return;
                        }
                        
                        const qty = parseInt(quantity.value);
                        const isEndmill = selectedItem.category.toLowerCase().includes('endmill');
                        const isExchange = isEndmill && exchange && exchange.value === 'yes';

                        // El stock siempre debe bajar, incluso en intercambios, porque la pieza rota no se puede usar
                        if (state.settings.customValidations?.preventNegativeStock && selectedItem.stock - qty < 0) {
                            showNotification('No puedes tener menos de 0 en stock.', 'error');
                            return;
                        }

                        const itemRef = doc(db, 'inventory', selectedItem.id);
                        await updateDoc(itemRef, { stock: selectedItem.stock - qty });
                        await addDoc(collection(db, 'transactions'), {
                            itemId: selectedItem.id, itemDescription: selectedItem.description, type: isExchange ? 'Intercambio' : 'Salida',
                            quantity: qty, user: user.value, notes: notes?.value || '', timestamp: serverTimestamp()
                        });
                        showNotification('Salida guardada.', 'success');
                    } else {
                        // Logic for Retornable
                        if (selectedItem.stock <= 0) {
                            showNotification('No hay stock disponible para este artículo.', 'error');
                            return;
                        }
                        
                        const borrowerElement = e.target.elements.borrower;
                        if (!borrowerElement) {
                            showNotification('Error: Campo de prestamista no encontrado.', 'error');
                            return;
                        }
                        
                        const borrower = borrowerElement.value;
                        if (!borrower || borrower.trim() === '') {
                            showNotification('El nombre es requerido.', 'error');
                            return;
                        }
                        
                        const batch = writeBatch(db);
                        const itemRef = doc(db, 'inventory', selectedItem.id);
                        batch.update(itemRef, { stock: selectedItem.stock - 1 });
                        batch.set(doc(collection(db, 'loans')), {
                            itemId: selectedItem.id, itemDescription: selectedItem.description, borrower: borrower,
                            loanedAt: serverTimestamp(), returnedAt: null
                        });
                        batch.set(doc(collection(db, 'transactions')), {
                            itemId: selectedItem.id, itemDescription: selectedItem.description, type: 'Préstamo',
                            quantity: 1, borrower: borrower, timestamp: serverTimestamp()
                        });
                        await batch.commit();
                        showNotification('Préstamo registrado.', 'success');
                    }
                    closeModal();
                } catch (error) {
                    console.error('Error in checkout form submission:', error);
                    showNotification('Error al procesar la operación. Intenta de nuevo.', 'error');
                }
            });
        }

        function loadSmartSuggestions() {
            const suggestionsList = document.getElementById('suggestions-list');
            if (!suggestionsList) return;

            const suggestions = getSmartSuggestions('');
            
            if (suggestions.length === 0) {
                suggestionsList.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">No hay datos de uso reciente</p>';
                return;
            }

            suggestionsList.innerHTML = suggestions.map(suggestion => {
                const item = state.inventory.find(i => i.id === suggestion.itemId);
                if (!item) return '';
                
                const usageText = suggestion.totalUsage > 0 ? 
                    `${suggestion.totalUsage} usos` : 'Nuevo';
                const lastUsed = suggestion.lastUsed ? 
                    `Último: ${new Date(suggestion.lastUsed).toLocaleDateString()}` : '';
                
                return `
                    <button type="button" 
                            class="suggestion-item w-full text-left p-3 rounded border border-gray-200 hover:bg-gray-50 transition-colors"
                            data-item-id="${suggestion.itemId}">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">${suggestion.description}</div>
                                <div class="text-sm text-gray-500">${suggestion.category}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500">${usageText}</div>
                                ${lastUsed ? `<div class="text-xs text-gray-400">${lastUsed}</div>` : ''}
                            </div>
                        </div>
                    </button>
                `;
            }).join('');

            // Agregar event listeners a las sugerencias
            suggestionsList.querySelectorAll('.suggestion-item').forEach(button => {
                button.addEventListener('click', () => {
                    const itemId = button.dataset.itemId;
                    const selectedItem = state.inventory.find(i => i.id === itemId);
                    if (selectedItem) {
                        // Seleccionar en el dropdown
                        const itemSelect = document.getElementById('item-select');
                        if (itemSelect) {
                            itemSelect.value = itemId;
                            itemSelect.dispatchEvent(new Event('change'));
                        }
                        // Limpiar búsqueda
                        const searchInput = document.getElementById('item-search');
                        if (searchInput) {
                            searchInput.value = '';
                        }
                    }
                });
            });
        }

        function setupSmartSearch() {
            const searchInput = document.getElementById('item-search');
            if (!searchInput) return;

            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const searchTerm = e.target.value;
                    const suggestions = getSmartSuggestions(searchTerm);
                    updateSuggestionsList(suggestions);
                }, 200);
            });

            // Limpiar búsqueda al hacer clic fuera
            searchInput.addEventListener('blur', () => {
                setTimeout(() => {
                    if (document.activeElement !== searchInput) {
                        searchInput.value = '';
                        loadSmartSuggestions();
                    }
                }, 200);
            });
        }

        function updateSuggestionsList(suggestions) {
            const suggestionsList = document.getElementById('suggestions-list');
            if (!suggestionsList) return;

            if (suggestions.length === 0) {
                suggestionsList.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">No se encontraron artículos</p>';
                return;
            }

            suggestionsList.innerHTML = suggestions.map(suggestion => {
                const item = state.inventory.find(i => i.id === suggestion.itemId);
                if (!item) return '';
                
                const usageText = suggestion.totalUsage > 0 ? 
                    `${suggestion.totalUsage} usos` : 'Nuevo';
                const lastUsed = suggestion.lastUsed ? 
                    `Último: ${new Date(suggestion.lastUsed).toLocaleDateString()}` : '';
                
                return `
                    <button type="button" 
                            class="suggestion-item w-full text-left p-3 rounded border border-gray-200 hover:bg-gray-50 transition-colors"
                            data-item-id="${suggestion.itemId}">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">${suggestion.description}</div>
                                <div class="text-sm text-gray-500">${suggestion.category}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500">${usageText}</div>
                                ${lastUsed ? `<div class="text-xs text-gray-400">${lastUsed}</div>` : ''}
                            </div>
                        </div>
                    </button>
                `;
            }).join('');

            // Agregar event listeners a las sugerencias
            suggestionsList.querySelectorAll('.suggestion-item').forEach(button => {
                button.addEventListener('click', () => {
                    const itemId = button.dataset.itemId;
                    const selectedItem = state.inventory.find(i => i.id === itemId);
                    if (selectedItem) {
                        // Seleccionar en el dropdown
                        const itemSelect = document.getElementById('item-select');
                        if (itemSelect) {
                            itemSelect.value = itemId;
                            itemSelect.dispatchEvent(new Event('change'));
                        }
                        // Limpiar búsqueda
                        const searchInput = document.getElementById('item-search');
                        if (searchInput) {
                            searchInput.value = '';
                        }
                    }
                });
            });
        }

        
        function showReportLossModal(loan, item) {
            const content = `
                <p class="mb-2"><strong>Artículo:</strong> ${item.description}</p>
                <p class="mb-4"><strong>Prestado a:</strong> ${loan.borrower}</p>
                <p class="text-sm text-red-600 mb-4">Esta acción cerrará el préstamo y registrará el artículo como baja por pérdida.</p>
                <form id="report-loss-form">
                    <div class="mb-4">
                        <label for="reason" class="block text-sm font-medium themed-text-light">Motivo de Pérdida</label>
                        <input type="text" id="reason" name="reason" value="Perdido durante préstamo" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                    </div>
                    <div class="flex justify-end"><button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-8 rounded min-h-[56px] flex items-center justify-center transition-all duration-200">
                        <i data-lucide="x-circle" class="h-6 w-6 mr-2"></i>
                        Confirmar Pérdida
                    </button></div>
                </form>`;
            showModal('Reportar Herramienta Perdida', content, 'max-w-md');
            document.getElementById('report-loss-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const reason = e.target.reason.value;
                const batch = writeBatch(db);
                batch.update(doc(db, 'loans', loan.id), { returnedAt: serverTimestamp(), status: 'lost' });
                batch.set(doc(collection(db, 'transactions')), {
                    itemId: item.id, itemDescription: item.description, type: 'Baja', quantity: 1,
                    notes: `Pérdida por ${loan.borrower}. Motivo: ${reason}`,
                    timestamp: serverTimestamp(), user: state.currentUser.email
                });
                await batch.commit();
                showNotification('Pérdida registrada.', 'success');
                closeModal();
            });
        }
        function showAddToCartModal(item) {
            const content = `
                <p class="mb-4"><strong>Artículo:</strong> ${item.description}</p>
                <form id="add-to-cart-form">
                    <div class="mb-4">
                        <label for="quantity" class="block text-sm font-medium themed-text-light">Cantidad</label>
                        <input type="number" id="quantity" name="quantity" min="1" value="1" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                    </div>
                    <div class="flex justify-end"><button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-4 px-8 rounded min-h-[56px] flex items-center justify-center transition-all duration-200">
                        <i data-lucide="shopping-cart" class="h-6 w-6 mr-2"></i>
                        Añadir a la Lista
                    </button></div>
                </form>`;
            showModal('Añadir a Lista de Compras', content, 'max-w-md');
            document.getElementById('add-to-cart-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const quantity = parseInt(e.target.quantity.value);
                await addToShoppingList(item, quantity);
                closeModal();
            });
        }
        
        function getCategoryOptions(selectedCategory) {
            return state.categories
                .filter(c => c !== 'Todas')
                .map(cat => `<option value="${cat}" ${cat === selectedCategory ? 'selected' : ''}>${cat}</option>`)
                .join('');
        }

        function showEditItemModal(item) {
            const content = `
                <form id="edit-item-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label for="description" class="block text-sm font-medium themed-text-light">Descripción</label>
                            <input type="text" id="description" name="item-description-edit" value="${item.description}" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm" autocomplete="chrome-off">
                        </div>
                        <div>
                            <label for="category" class="block text-sm font-medium themed-text-light">Categoría</label>
                            <select id="category" class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">${getCategoryOptions(item.category)}</select>
                        </div>
                        <div>
                            <label for="minStock" class="block text-sm font-medium themed-text-light">Stock Mínimo</label>
                            <input type="number" id="minStock" value="${item.minStock || 0}" min="0" class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        </div>
                         <div>
                            <label for="unit" class="block text-sm font-medium themed-text-light">Unidad</label>
                            <input type="text" id="unit" value="${item.unit || 'pza'}" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        </div>
                    </div>
                    <div class="flex justify-end mt-6">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded min-h-[56px] flex items-center justify-center transition-all duration-200">
                             <i data-lucide="save" class="h-6 w-6 mr-2"></i>
                             <span id="save-btn-text">Guardar Cambios</span>
                             <i id="save-spinner" data-lucide="loader" class="h-5 w-5 animate-spin hidden ml-2"></i>
                        </button>
                    </div>
                </form>
            `;
            showModal('Editar Artículo', content);
            
            document.getElementById('edit-item-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const { description, category, minStock, unit } = e.target.elements;
                const saveBtnText = document.getElementById('save-btn-text');
                const saveSpinner = document.getElementById('save-spinner');
                saveBtnText.classList.add('hidden');
                saveSpinner.classList.remove('hidden');

                const updatedData = {
                    description: toTitleCase(description.value),
                    category: category.value,
                    unit: unit.value,
                    minStock: parseInt(minStock.value)
                };

                await updateDoc(doc(db, 'inventory', item.id), updatedData);
                showNotification('Artículo actualizado.', 'success');
                closeModal();
            });
        }

        function showEditStockModal(item) {
            const content = `
                <form id="edit-stock-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium themed-text-light mb-2">Artículo</label>
                        <div class="p-3 bg-gray-50 rounded">
                            <div class="font-medium text-gray-900">${item.description}</div>
                            <div class="text-sm text-gray-500">${item.category}</div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="current-stock" class="block text-sm font-medium themed-text-light mb-2">Stock Actual</label>
                        <div class="p-3 bg-blue-50 rounded">
                            <div class="text-lg font-semibold text-blue-700">${item.stock} ${item.unit}</div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label for="new-stock" class="block text-sm font-medium themed-text-light mb-2">Nuevo Stock Total</label>
                        <input type="number" id="new-stock" value="${item.stock}" min="0" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                        <p class="text-xs text-gray-500 mt-1">Ingresa el nuevo total de stock para este artículo</p>
                    </div>
                    <div class="mb-4">
                        <label for="stock-reason" class="block text-sm font-medium themed-text-light mb-2">Motivo del Ajuste</label>
                        <textarea id="stock-reason" rows="3" placeholder="Ej: Inventario físico, corrección de error, etc." class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm"></textarea>
                    </div>
                    <div class="flex justify-end mt-6">
                        <button type="submit" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 px-8 rounded min-h-[56px] flex items-center justify-center transition-all duration-200">
                             <i data-lucide="edit-3" class="h-6 w-6 mr-2"></i>
                             <span id="save-btn-text">Actualizar Stock</span>
                             <i id="save-spinner" data-lucide="loader" class="h-5 w-5 animate-spin hidden ml-2"></i>
                        </button>
                    </div>
                </form>
            `;
            showModal('Editar Stock', content);
            
            document.getElementById('edit-stock-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveBtnText = document.getElementById('save-btn-text');
                const saveSpinner = document.getElementById('save-spinner');
                saveBtnText.classList.add('hidden');
                saveSpinner.classList.remove('hidden');

                const newStock = parseInt(e.target['new-stock'].value);
                const reason = e.target['stock-reason'].value || 'Ajuste de stock por administrador';
                const stockDifference = newStock - item.stock;

                try {
                    // Update the stock in the database
                    await updateDoc(doc(db, 'inventory', item.id), { stock: newStock });
                    
                    // Add transaction record
                    await addDoc(collection(db, 'transactions'), {
                        itemId: item.id,
                        itemDescription: item.description,
                        type: stockDifference > 0 ? 'Ajuste Positivo' : 'Ajuste Negativo',
                        quantity: Math.abs(stockDifference),
                        timestamp: serverTimestamp(),
                        user: state.currentUser.email,
                        notes: reason
                    });
                    
                    showNotification(`Stock actualizado de ${item.stock} a ${newStock} ${item.unit}.`, 'success');
                    closeModal();
                } catch(error) {
                    showNotification('Error al actualizar el stock.', 'error');
                    saveBtnText.classList.remove('hidden');
                    saveSpinner.classList.add('hidden');
                }
            });
        }

        function showEditTransactionModal(transaction) {
            if (state.userRole !== 'admin') {
                showNotification('Solo los administradores pueden editar transacciones.', 'error');
                return;
            }
            
            // Extraer fecha en timezone local para consistencia con la visualización en tabla
            const getLocalDateString = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            const transactionDate = transaction.timestamp?.seconds 
                ? getLocalDateString(new Date(transaction.timestamp.seconds * 1000))
                : getLocalDateString(new Date());
            
            const responsible = transaction.type === 'Devolución' 
                ? (transaction.borrower || '') 
                : (transaction.supplier || transaction.user || transaction.borrower || '');
            
            const content = `
                <form id="edit-transaction-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium themed-text-light mb-2">Tipo de Transacción</label>
                        <div class="p-3 bg-gray-50 rounded">
                            <div class="font-medium text-gray-900">${transaction.type}</div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium themed-text-light mb-2">Artículo</label>
                        <div class="p-3 bg-gray-50 rounded">
                            <div class="font-medium text-gray-900">${transaction.itemDescription || 'N/A'}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="edit-transaction-quantity" class="block text-sm font-medium themed-text-light mb-1">Cantidad</label>
                            <input type="number" id="edit-transaction-quantity" value="${transaction.quantity || 0}" min="0" required class="themed-input w-full px-4 py-3 border rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="edit-transaction-date" class="block text-sm font-medium themed-text-light mb-1">Fecha</label>
                            <input type="date" id="edit-transaction-date" value="${transactionDate}" required class="themed-input w-full px-4 py-3 border rounded-md shadow-sm">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="edit-transaction-responsible" class="block text-sm font-medium themed-text-light mb-1">Responsable</label>
                        <input type="text" id="edit-transaction-responsible" value="${responsible}" class="themed-input w-full px-4 py-3 border rounded-md shadow-sm" placeholder="Nombre del responsable">
                    </div>
                    <div class="mb-4">
                        <label for="edit-transaction-notes" class="block text-sm font-medium themed-text-light mb-1">Notas</label>
                        <textarea id="edit-transaction-notes" rows="3" class="themed-input w-full px-4 py-3 border rounded-md shadow-sm" placeholder="Notas adicionales...">${transaction.notes || ''}</textarea>
                    </div>
                    <div class="flex justify-end mt-6">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded min-h-[56px] flex items-center justify-center transition-all duration-200">
                            <i data-lucide="save" class="h-6 w-6 mr-2"></i>
                            <span id="save-transaction-btn-text">Guardar Cambios</span>
                            <i id="save-transaction-spinner" data-lucide="loader" class="h-5 w-5 animate-spin hidden ml-2"></i>
                        </button>
                    </div>
                </form>
            `;
            showModal('Editar Transacción', content);
            
            document.getElementById('edit-transaction-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveBtnText = document.getElementById('save-transaction-btn-text');
                const saveSpinner = document.getElementById('save-transaction-spinner');
                saveBtnText.classList.add('hidden');
                saveSpinner.classList.remove('hidden');
                
                try {
                    const quantity = parseInt(e.target['edit-transaction-quantity'].value);
                    const responsible = e.target['edit-transaction-responsible'].value.trim();
                    const notes = e.target['edit-transaction-notes'].value.trim();
                    const dateValue = e.target['edit-transaction-date'].value;
                    
                    // Parsear fecha en timezone local para evitar problemas de UTC
                    const [year, month, day] = dateValue.split('-').map(Number);
                    const originalTimestamp = transaction.timestamp?.seconds 
                        ? new Date(transaction.timestamp.seconds * 1000)
                        : new Date();
                    
                    // Crear nueva fecha en timezone local con la fecha seleccionada
                    // y preservar la hora original del timestamp
                    const selectedDate = new Date(
                        year, 
                        month - 1, 
                        day,
                        originalTimestamp.getHours(),
                        originalTimestamp.getMinutes(),
                        originalTimestamp.getSeconds(),
                        originalTimestamp.getMilliseconds()
                    );
                    
                    // Usar Timestamp de Firestore para compatibilidad
                    const newTimestamp = Timestamp.fromDate(selectedDate);
                    
                    // Determinar qué campo actualizar según el tipo de transacción
                    const updateData = {
                        quantity: quantity,
                        notes: notes,
                        timestamp: newTimestamp
                    };
                    
                    if (transaction.type === 'Devolución') {
                        updateData.borrower = responsible;
                    } else if (transaction.type === 'Préstamo') {
                        updateData.borrower = responsible;
                    } else {
                        // Para Salida, Entrada, etc.
                        if (transaction.supplier) {
                            updateData.supplier = responsible;
                        } else {
                            updateData.user = responsible;
                        }
                    }
                    
                    await updateDoc(doc(db, 'transactions', transaction.id), updateData);
                    showNotification('Transacción actualizada exitosamente.', 'success');
                    closeModal();
                } catch (error) {
                    console.error('Error al actualizar transacción:', error);
                    showNotification('Error al actualizar la transacción.', 'error');
                    saveBtnText.classList.remove('hidden');
                    saveSpinner.classList.add('hidden');
                }
            });
        }
        
        async function handleDeleteTransaction(transactionId) {
            if (state.userRole !== 'admin') {
                showNotification('Solo los administradores pueden borrar transacciones.', 'error');
                return;
            }
            
            const transaction = state.transactions.find(t => t.id === transactionId);
            if (!transaction) {
                showNotification('Transacción no encontrada.', 'error');
                return;
            }
            
            const confirmMessage = `¿Estás seguro de que deseas borrar esta transacción?\n\n` +
                `Tipo: ${transaction.type}\n` +
                `Artículo: ${transaction.itemDescription || 'N/A'}\n` +
                `Cantidad: ${transaction.quantity || 0}\n` +
                `Fecha: ${transaction.timestamp?.seconds ? new Date(transaction.timestamp.seconds * 1000).toLocaleString() : 'N/A'}\n\n` +
                `Esta acción no se puede deshacer.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'transactions', transactionId));
                showNotification('Transacción borrada exitosamente.', 'success');
                
                // Actualizar la vista si estamos en el historial
                const currentPage = window.location.hash.substring(1);
                if (currentPage === 'history') {
                    const currentTab = document.querySelector('.tab-link.border-indigo-500')?.dataset.type || 'salidas';
                    renderHistoryTab(currentTab);
                }
            } catch (error) {
                console.error('Error al borrar transacción:', error);
                showNotification('Error al borrar la transacción.', 'error');
            }
        }
        
        // Exponer funciones en window para acceso desde onclick
        window.showEditTransactionModal = showEditTransactionModal;
        window.handleDeleteTransaction = handleDeleteTransaction;

        function showNewItemModal() {
            const lastValues = getLastUsedValues();
            const mostUsedCategories = getMostUsedCategories();
            
            const content = `
                <form id="new-item-form">
                    <div class="space-y-4">
                        <!-- Smart defaults checkbox -->
                        <div class="bg-blue-50 p-3 rounded">
                            <label class="flex items-center">
                                <input type="checkbox" id="use-smart-defaults" class="form-checkbox text-blue-600 mr-2">
                                <span class="text-sm themed-text-light">Usar estos valores como predeterminados para la próxima vez</span>
                            </label>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label for="description" class="block text-sm font-medium themed-text-light">Descripción</label>
                                <div class="relative">
                                    <input type="text" id="description" name="item-description-new" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm" placeholder="Escribe la descripción del artículo..." autocomplete="chrome-off">
                                    <div id="description-suggestions" class="absolute top-full mt-1 left-0 right-0 z-[100] bg-white border border-gray-300 rounded-md shadow-sm hidden max-h-40 overflow-y-auto"></div>
                                </div>
                            </div>
                            
                            <div>
                                <label for="category" class="block text-sm font-medium themed-text-light">Categoría</label>
                                <div class="relative">
                                    <select id="category" class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                                        <option value="">Selecciona una categoría...</option>
                                        ${mostUsedCategories.length > 0 ? `
                                            <optgroup label="Más utilizadas">
                                                ${mostUsedCategories.map(cat => `<option value="${cat}" ${cat === lastValues.category ? 'selected' : ''}>${cat}</option>`).join('')}
                                            </optgroup>
                                            <optgroup label="Todas las categorías">
                                                ${getCategoryOptions(lastValues.category)}
                                            </optgroup>
                                        ` : getCategoryOptions(lastValues.category)}
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label for="stock" class="block text-sm font-medium themed-text-light">Stock Inicial</label>
                                <input type="number" id="stock" value="0" min="0" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                            </div>
                            
                            <div>
                                <label for="minStock" class="block text-sm font-medium themed-text-light">Stock Mínimo</label>
                                <input type="number" id="minStock" value="${state.settings.defaultMinStock || 5}" min="0" class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                            </div>
                            
                            <div>
                                <label for="unit" class="block text-sm font-medium themed-text-light">Unidad</label>
                                <div class="relative">
                                    <input type="text" id="unit" value="${lastValues.unit}" required class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm" list="unit-suggestions">
                                    <datalist id="unit-suggestions">
                                        <option value="pza">
                                        <option value="kg">
                                        <option value="g">
                                        <option value="m">
                                        <option value="cm">
                                        <option value="l">
                                        <option value="ml">
                                        <option value="m²">
                                        <option value="m³">
                                        <option value="caja">
                                        <option value="bolsa">
                                        <option value="rollo">
                                    </datalist>
                                    <div id="unit-category-suggestions" class="absolute top-full mt-1 left-0 right-0 z-[100] bg-white border border-gray-300 rounded-md shadow-sm hidden max-h-32 overflow-y-auto"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" id="cancel-new-item-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded flex items-center">
                                <i data-lucide="x" class="h-5 w-5 mr-2"></i>
                                Cancelar
                            </button>
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded min-h-[56px] flex items-center justify-center transition-all duration-200">
                                <i data-lucide="plus" class="h-6 w-6 mr-2"></i>
                                <span id="save-btn-text">Crear Artículo</span>
                                <i id="save-spinner" data-lucide="loader" class="h-5 w-5 animate-spin hidden ml-2"></i>
                            </button>
                        </div>
                    </div>
                </form>
            `;
            showModal('Crear Nuevo Artículo', content);

            // Focus on description field
            setTimeout(() => document.getElementById('description').focus(), 100);

            // Setup autocompletado for description
            const descriptionInput = document.getElementById('description');
            const suggestionsDiv = document.getElementById('description-suggestions');
            
            descriptionInput.addEventListener('input', (e) => {
                const input = e.target.value.trim();
                const suggestions = getDescriptionSuggestions(input);
                
                if (suggestions.length > 0 && input.length >= 2) {
                    suggestionsDiv.innerHTML = suggestions.map(suggestion => 
                        `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer suggestion-item" data-suggestion="${suggestion}">${suggestion}</div>`
                    ).join('');
                    suggestionsDiv.classList.remove('hidden');
                } else {
                    suggestionsDiv.classList.add('hidden');
                }
            });

            // Handle suggestion clicks
            suggestionsDiv.addEventListener('click', (e) => {
                if (e.target.classList.contains('suggestion-item')) {
                    descriptionInput.value = e.target.dataset.suggestion;
                    suggestionsDiv.classList.add('hidden');
                    descriptionInput.focus();
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!descriptionInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.classList.add('hidden');
                }
            });

            // Setup category-based unit suggestions
            const categorySelect = document.getElementById('category');
            const unitInput = document.getElementById('unit');
            const unitSuggestionsDiv = document.getElementById('unit-category-suggestions');
            
            categorySelect.addEventListener('change', (e) => {
                const selectedCategory = e.target.value;
                if (selectedCategory) {
                    const suggestedUnits = getMostUsedUnitsForCategory(selectedCategory);
                    if (suggestedUnits.length > 0) {
                        unitSuggestionsDiv.innerHTML = suggestedUnits.map(unit => 
                            `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer unit-suggestion" data-unit="${unit}">${unit}</div>`
                        ).join('');
                        unitSuggestionsDiv.classList.remove('hidden');
                    }
                } else {
                    unitSuggestionsDiv.classList.add('hidden');
                }
            });

            // Handle unit suggestion clicks
            unitSuggestionsDiv.addEventListener('click', (e) => {
                if (e.target.classList.contains('unit-suggestion')) {
                    unitInput.value = e.target.dataset.unit;
                    unitSuggestionsDiv.classList.add('hidden');
                    unitInput.focus();
                }
            });

            // Hide unit suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!unitInput.contains(e.target) && !unitSuggestionsDiv.contains(e.target)) {
                    unitSuggestionsDiv.classList.add('hidden');
                }
            });

            // Keyboard shortcuts
            const form = document.getElementById('new-item-form');
            form.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    if (e.shiftKey) {
                        // Ctrl+Shift+Enter: Save and create another
                        form.dispatchEvent(new Event('submit'));
                        setTimeout(() => {
                            if (!document.getElementById('new-item-form')) {
                                showNewItemModal();
                            }
                        }, 1000);
                    } else {
                        // Ctrl+Enter: Save and close
                        form.dispatchEvent(new Event('submit'));
                    }
                }
            });

            // Cancel button
            document.getElementById('cancel-new-item-btn').addEventListener('click', closeModal);

            // Form submission
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveBtnText = document.getElementById('save-btn-text');
                const saveSpinner = document.getElementById('save-spinner');
                saveBtnText.classList.add('hidden');
                saveSpinner.classList.remove('hidden');

                const { description, category, minStock, unit, stock } = e.target.elements;
                const useSmartDefaults = document.getElementById('use-smart-defaults').checked;
                
                const newItem = {
                    description: toTitleCase(description.value),
                    category: category.value,
                    unit: unit.value,
                    stock: parseInt(stock.value),
                    minStock: parseInt(minStock.value)
                };

                try {
                    const docRef = await addDoc(collection(db, 'inventory'), newItem);
                    await addDoc(collection(db, 'transactions'), {
                        itemId: docRef.id, itemDescription: newItem.description, type: 'Creación', quantity: newItem.stock,
                        timestamp: serverTimestamp(), user: state.currentUser.email, notes: 'Artículo nuevo creado'
                    });
                    
                    // Save last used values if checkbox is checked
                    if (useSmartDefaults) {
                        saveLastUsedValues(newItem.category, newItem.unit);
                    }
                    
                    showNotification('Artículo creado con éxito.', 'success');
                    closeModal();
                    
                    // Force refresh the inventory view if we're on the inventory page
                    if (window.location.hash.substring(1) === 'inventory') {
                        renderInventoryView();
                    }
                } catch(error) {
                    console.error('Error creating article:', error);
                    showNotification('Error al crear el artículo.', 'error');
                    saveBtnText.classList.remove('hidden');
                    saveSpinner.classList.add('hidden');
                }
            });

            // Recreate icons for new elements
            setTimeout(() => safeCreateIcons(), 100);
        }

        // Quick add item modal for mobile (simplified form)
        function showQuickAddItemModal() {
            // Check if user has permission
            if (state.userRole !== 'admin') {
                showNotification("Solo los administradores pueden agregar artículos.", "info");
                return;
            }
            
            // Check if user is logged in
            if (!state.currentUser) {
                showNotification("Debes iniciar sesión para agregar artículos.", "info");
                return;
            }

            const lastValues = getLastUsedValues();
            const mostUsedCategories = getMostUsedCategories();
            
            // Helper function to get category options (excluding most used ones to avoid duplicates)
            const getCategoryOptionsForQuick = (selectedCategory) => {
                return state.categories
                    .filter(c => c !== 'Todas' && !mostUsedCategories.includes(c))
                    .map(cat => `<option value="${cat}" ${cat === selectedCategory ? 'selected' : ''}>${cat}</option>`)
                    .join('');
            };
            
            const content = `
                <form id="quick-add-item-form">
                    <div class="space-y-6">
                        <div>
                            <label for="quick-description" class="block text-base font-medium themed-text-light mb-2">Descripción</label>
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="quick-description" 
                                    required 
                                    class="themed-input block w-full px-4 py-4 text-base border rounded shadow-sm" 
                                    placeholder="Escribe la descripción del artículo..." 
                                    autocomplete="chrome-off"
                                    style="font-size: 16px; min-height: 56px;"
                                >
                                <div id="quick-description-suggestions" class="absolute top-full mt-1 left-0 right-0 z-[100] bg-white border border-gray-300 rounded shadow-sm hidden max-h-40 overflow-y-auto"></div>
                            </div>
                        </div>
                        
                        <div>
                            <label for="quick-category" class="block text-base font-medium themed-text-light mb-2">Categoría</label>
                            <select 
                                id="quick-category" 
                                required 
                                class="themed-input block w-full px-4 py-4 text-base border rounded shadow-sm"
                                style="font-size: 16px; min-height: 56px;"
                            >
                                <option value="">Selecciona una categoría...</option>
                                ${mostUsedCategories.length > 0 ? `
                                    <optgroup label="Más utilizadas">
                                        ${mostUsedCategories.map(cat => `<option value="${cat}" ${cat === lastValues.category ? 'selected' : ''}>${cat}</option>`).join('')}
                                    </optgroup>
                                    <optgroup label="Todas las categorías">
                                        ${getCategoryOptionsForQuick(lastValues.category)}
                                    </optgroup>
                                ` : getCategoryOptionsForQuick(lastValues.category)}
                            </select>
                        </div>
                        
                        <div>
                            <label for="quick-stock" class="block text-base font-medium themed-text-light mb-2">Cantidad Inicial</label>
                            <input 
                                type="number" 
                                id="quick-stock" 
                                value="0" 
                                min="0" 
                                required 
                                class="themed-input block w-full px-4 py-4 text-base border rounded shadow-sm"
                                style="font-size: 16px; min-height: 56px;"
                                inputmode="numeric"
                            >
                        </div>
                        
                        <div class="flex flex-col gap-3 pt-4">
                            <button 
                                type="submit" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded min-h-[56px] flex items-center justify-center transition-all duration-200 shadow-sm"
                            >
                                <i data-lucide="check" class="h-6 w-6 mr-2"></i>
                                <span id="quick-save-btn-text">Agregar Artículo</span>
                                <i id="quick-save-spinner" data-lucide="loader" class="h-5 w-5 animate-spin hidden ml-2"></i>
                            </button>
                            <button 
                                type="button" 
                                id="quick-cancel-btn" 
                                class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-6 rounded min-h-[48px] flex items-center justify-center transition-colors"
                            >
                                Cancelar
                            </button>
                        </div>
                    </div>
                </form>
            `;
            
            showModal('Agregar Artículo Rápido', content, 'max-w-md');
            
            // Focus on description field
            setTimeout(() => {
                const descInput = document.getElementById('quick-description');
                if (descInput) {
                    descInput.focus();
                }
            }, 100);

            // Setup autocompletado for description
            const descriptionInput = document.getElementById('quick-description');
            const suggestionsDiv = document.getElementById('quick-description-suggestions');
            
            descriptionInput.addEventListener('input', (e) => {
                const input = e.target.value.trim();
                const suggestions = getDescriptionSuggestions(input);
                
                if (suggestions.length > 0 && input.length >= 2) {
                    suggestionsDiv.innerHTML = suggestions.map(suggestion => 
                        `<div class="px-4 py-3 hover:bg-gray-100 cursor-pointer suggestion-item border-b border-gray-100 last:border-b-0" data-suggestion="${suggestion}">${suggestion}</div>`
                    ).join('');
                    suggestionsDiv.classList.remove('hidden');
                } else {
                    suggestionsDiv.classList.add('hidden');
                }
            });

            // Handle suggestion clicks
            suggestionsDiv.addEventListener('click', (e) => {
                if (e.target.classList.contains('suggestion-item')) {
                    descriptionInput.value = e.target.dataset.suggestion;
                    suggestionsDiv.classList.add('hidden');
                    descriptionInput.focus();
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!descriptionInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.classList.add('hidden');
                }
            });

            // Cancel button
            document.getElementById('quick-cancel-btn').addEventListener('click', closeModal);

            // Form submission
            const form = document.getElementById('quick-add-item-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const saveBtnText = document.getElementById('quick-save-btn-text');
                const saveSpinner = document.getElementById('quick-save-spinner');
                saveBtnText.classList.add('hidden');
                saveSpinner.classList.remove('hidden');

                const description = document.getElementById('quick-description').value.trim();
                const category = document.getElementById('quick-category').value.trim();
                const stock = parseInt(document.getElementById('quick-stock').value) || 0;
                
                if (!description) {
                    showNotification('Por favor, ingresa una descripción.', 'error');
                    saveBtnText.classList.remove('hidden');
                    saveSpinner.classList.add('hidden');
                    return;
                }
                
                if (!category) {
                    showNotification('Por favor, selecciona una categoría.', 'error');
                    saveBtnText.classList.remove('hidden');
                    saveSpinner.classList.add('hidden');
                    return;
                }

                // Get smart defaults
                const unit = lastValues.unit || state.settings.defaultUnit || 'pza';
                const minStock = state.settings.defaultMinStock || 5;
                
                const newItem = {
                    description: toTitleCase(description),
                    category: category,
                    unit: unit,
                    stock: stock,
                    minStock: minStock
                };

                try {
                    const docRef = await addDoc(collection(db, 'inventory'), newItem);
                    await addDoc(collection(db, 'transactions'), {
                        itemId: docRef.id, 
                        itemDescription: newItem.description, 
                        type: 'Creación', 
                        quantity: newItem.stock,
                        timestamp: serverTimestamp(), 
                        user: state.currentUser.email, 
                        notes: 'Artículo creado desde formulario rápido móvil'
                    });
                    
                    // Save last used values for next time (update category with the selected one)
                    saveLastUsedValues(category, unit);
                    
                    showNotification('Artículo agregado con éxito.', 'success');
                    closeModal();
                    
                    // Force refresh the inventory view if we're on the inventory page
                    if (window.location.hash.substring(1) === 'inventory') {
                        renderInventoryView();
                    }
                } catch(error) {
                    console.error('Error creating article:', error);
                    showNotification('Error al crear el artículo.', 'error');
                    saveBtnText.classList.remove('hidden');
                    saveSpinner.classList.add('hidden');
                }
            });

            // Recreate icons for new elements
            setTimeout(() => safeCreateIcons(), 100);
        }
        
        // Make function globally accessible for onclick fallback
        window.showQuickAddItemModal = showQuickAddItemModal;

        // Helper functions for smart defaults and autocompletado
        function getLastUsedValues() {
            const lastValues = localStorage.getItem('inventory-last-values');
            return lastValues ? JSON.parse(lastValues) : {
                category: '',
                unit: state.settings.defaultUnit || 'pza'
            };
        }

        function saveLastUsedValues(category, unit) {
            localStorage.setItem('inventory-last-values', JSON.stringify({
                category,
                unit,
                timestamp: Date.now()
            }));
        }

        function getMostUsedCategories() {
            const categoryCounts = {};
            state.inventory.forEach(item => {
                categoryCounts[item.category] = (categoryCounts[item.category] || 0) + 1;
            });
            
            return Object.entries(categoryCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5)
                .map(([category]) => category);
        }

        function getMostUsedUnitsForCategory(category) {
            const unitCounts = {};
            state.inventory
                .filter(item => item.category === category)
                .forEach(item => {
                    unitCounts[item.unit] = (unitCounts[item.unit] || 0) + 1;
                });
            
            return Object.entries(unitCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3)
                .map(([unit]) => unit);
        }

        function getDescriptionSuggestions(input) {
            if (input.length < 2) return [];
            
            const suggestions = state.inventory
                .map(item => item.description)
                .filter(desc => desc.toLowerCase().includes(input.toLowerCase()))
                .slice(0, 5);
            
            return [...new Set(suggestions)]; // Remove duplicates
        }

        function showBulkAddItemsModal() {
            const content = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold themed-text-light">Agregar Múltiples Artículos</h3>
                        <div class="flex space-x-2">
                            <button type="button" id="add-row-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded flex items-center text-sm">
                                <i data-lucide="plus" class="h-4 w-4 mr-1"></i>
                                Agregar Fila
                            </button>
                            <button type="button" id="clear-all-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded flex items-center text-sm">
                                <i data-lucide="trash-2" class="h-4 w-4 mr-1"></i>
                                Limpiar Todo
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-3 py-2 text-left text-sm font-medium themed-text-light">Descripción</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left text-sm font-medium themed-text-light">Categoría</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left text-sm font-medium themed-text-light">Stock Inicial</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left text-sm font-medium themed-text-light">Stock Mínimo</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left text-sm font-medium themed-text-light">Unidad</th>
                                    <th class="border border-gray-300 px-3 py-2 text-center text-sm font-medium themed-text-light">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="bulk-items-tbody">
                                <!-- Rows will be added dynamically -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" id="cancel-bulk-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded flex items-center">
                            <i data-lucide="x" class="h-5 w-5 mr-2"></i>
                            Cancelar
                        </button>
                        <button type="button" id="save-bulk-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded flex items-center">
                            <i data-lucide="save" class="h-5 w-5 mr-2"></i>
                            <span id="save-bulk-btn-text">Guardar Todos</span>
                            <i id="save-bulk-spinner" data-lucide="loader" class="h-5 w-5 animate-spin hidden ml-2"></i>
                        </button>
                    </div>
                </div>
            `;
            showModal('Agregar Múltiples Artículos', content, 'max-w-6xl');
            
            let rowCounter = 0;
            
            function addBulkRow() {
                const tbody = document.getElementById('bulk-items-tbody');
                const rowId = `bulk-row-${rowCounter++}`;
                
                const row = document.createElement('tr');
                row.id = rowId;
                row.innerHTML = `
                    <td class="border border-gray-300 px-3 py-2">
                        <input type="text" class="bulk-description themed-input w-full px-2 py-1 border rounded text-sm" placeholder="Descripción del artículo" required>
                    </td>
                    <td class="border border-gray-300 px-3 py-2">
                        <select class="bulk-category themed-input w-full px-2 py-1 border rounded text-sm">
                            ${getCategoryOptions('')}
                        </select>
                    </td>
                    <td class="border border-gray-300 px-3 py-2">
                        <input type="number" class="bulk-stock themed-input w-full px-2 py-1 border rounded text-sm" value="0" min="0" required>
                    </td>
                    <td class="border border-gray-300 px-3 py-2">
                        <input type="number" class="bulk-minstock themed-input w-full px-2 py-1 border rounded text-sm" value="${state.settings.defaultMinStock || 5}" min="0">
                    </td>
                    <td class="border border-gray-300 px-3 py-2">
                        <input type="text" class="bulk-unit themed-input w-full px-2 py-1 border rounded text-sm" value="${state.settings.defaultUnit || 'pza'}" required>
                    </td>
                    <td class="border border-gray-300 px-3 py-2 text-center">
                        <button type="button" class="remove-row-btn bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-sm flex items-center mx-auto">
                            <i data-lucide="trash-2" class="h-4 w-4"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
                
                // Add event listener for remove button
                row.querySelector('.remove-row-btn').addEventListener('click', () => {
                    row.remove();
                });
                
                // Focus on description field
                row.querySelector('.bulk-description').focus();
            }
            
            function clearAllRows() {
                document.getElementById('bulk-items-tbody').innerHTML = '';
                rowCounter = 0;
            }
            
            // Add initial row
            addBulkRow();
            
            // Event listeners
            document.getElementById('add-row-btn').addEventListener('click', addBulkRow);
            document.getElementById('clear-all-btn').addEventListener('click', clearAllRows);
            document.getElementById('cancel-bulk-btn').addEventListener('click', closeModal);
            
            // Keyboard shortcuts for bulk add
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('save-bulk-btn').click();
                }
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeModal();
                }
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    addBulkRow();
                }
            });
            
            document.getElementById('save-bulk-btn').addEventListener('click', async () => {
                const tbody = document.getElementById('bulk-items-tbody');
                const rows = tbody.querySelectorAll('tr');
                
                if (rows.length === 0) {
                    showNotification('No hay artículos para agregar.', 'error');
                    return;
                }
                
                const items = [];
                const errors = [];
                
                rows.forEach((row, index) => {
                    const description = row.querySelector('.bulk-description').value.trim();
                    const category = row.querySelector('.bulk-category').value;
                    const stock = parseInt(row.querySelector('.bulk-stock').value) || 0;
                    const minStock = parseInt(row.querySelector('.bulk-minstock').value) || 0;
                    const unit = row.querySelector('.bulk-unit').value.trim();
                    
                    if (!description) {
                        errors.push(`Fila ${index + 1}: Descripción requerida`);
                        return;
                    }
                    
                    if (!unit) {
                        errors.push(`Fila ${index + 1}: Unidad requerida`);
                        return;
                    }
                    
                    items.push({
                        description: toTitleCase(description),
                        category,
                        stock,
                        minStock,
                        unit
                    });
                });
                
                if (errors.length > 0) {
                    showNotification(`Errores encontrados:\\n${errors.join('\\n')}`, 'error');
                    return;
                }
                
                const saveBtnText = document.getElementById('save-bulk-btn-text');
                const saveSpinner = document.getElementById('save-bulk-spinner');
                saveBtnText.classList.add('hidden');
                saveSpinner.classList.remove('hidden');
                
                try {
                    const batch = writeBatch(db);
                    const transactionPromises = [];
                    
                    items.forEach(item => {
                        const docRef = doc(collection(db, 'inventory'));
                        batch.set(docRef, item);
                        
                        // Add transaction record
                        transactionPromises.push(
                            addDoc(collection(db, 'transactions'), {
                                itemId: docRef.id,
                                itemDescription: item.description,
                                type: 'Creación',
                                quantity: item.stock,
                                timestamp: serverTimestamp(),
                                user: state.currentUser.email,
                                notes: 'Artículo nuevo creado en lote'
                            })
                        );
                    });
                    
                    await batch.commit();
                    await Promise.all(transactionPromises);
                    
                    showNotification(`${items.length} artículos creados exitosamente.`, 'success');
                    closeModal();
                    
                    // Force refresh the inventory view if we're on the inventory page
                    if (window.location.hash.substring(1) === 'inventory') {
                        renderInventoryView();
                    }
                } catch (error) {
                    console.error('Error creating bulk items:', error);
                    showNotification('Error al crear los artículos.', 'error');
                } finally {
                    saveBtnText.classList.remove('hidden');
                    saveSpinner.classList.add('hidden');
                }
            });
            
            // Recreate icons for new elements
            setTimeout(() => safeCreateIcons(), 100);
        }

        function showAddCategoryModal() {
            const content = `
                <form id="add-category-form">
                    <div class="space-y-4">
                        <div>
                            <label for="new-category-name-modal" class="block text-sm font-medium themed-text-light">Nombre de la Categoría</label>
                            <input type="text" id="new-category-name-modal" required placeholder="Ej: Herramientas, Materiales, etc." maxlength="50" class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                            <div class="mt-2 flex items-center justify-between">
                                <p id="category-validation-message" class="text-xs text-red-500 hidden"></p>
                                <p id="category-char-count" class="text-xs text-gray-500">0/50</p>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" id="cancel-category-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-8 rounded min-h-[56px] flex items-center justify-center transition-all duration-200">
                                <i data-lucide="x" class="h-6 w-6 mr-2"></i>
                                Cancelar
                            </button>
                            <button type="submit" id="save-category-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded min-h-[56px] flex items-center justify-center transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="plus" class="h-6 w-6 mr-2"></i>
                                <span id="save-category-btn-text">Crear Categoría</span>
                                <i id="save-category-spinner" data-lucide="loader" class="h-5 w-5 animate-spin hidden ml-2"></i>
                            </button>
                        </div>
                    </div>
                </form>
            `;
            showModal('Crear Nueva Categoría', content, 'max-w-md');
            safeCreateIcons();
            
            const input = document.getElementById('new-category-name-modal');
            const validationMsg = document.getElementById('category-validation-message');
            const charCount = document.getElementById('category-char-count');
            const saveBtn = document.getElementById('save-category-btn');
            const saveBtnText = document.getElementById('save-category-btn-text');
            const saveSpinner = document.getElementById('save-category-spinner');
            
            // Deshabilitar botón inicialmente (input vacío)
            saveBtn.disabled = true;
            
            // Validación en tiempo real
            input.addEventListener('input', () => {
                const value = input.value;
                charCount.textContent = `${value.length}/50`;
                
                if (value.length === 0) {
                    validationMsg.classList.add('hidden');
                    saveBtn.disabled = true;
                    return;
                }
                
                const validation = validateCategoryName(value);
                if (!validation.valid) {
                    validationMsg.textContent = validation.error;
                    validationMsg.classList.remove('hidden');
                    saveBtn.disabled = true;
                } else {
                    validationMsg.classList.add('hidden');
                    saveBtn.disabled = false;
                }
            });
            
            document.getElementById('add-category-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newCategory = input.value.trim();
                const validation = validateCategoryName(newCategory);
                
                if (!validation.valid) {
                    showNotification(validation.error, 'error');
                    return;
                }
                
                saveBtnText.classList.add('hidden');
                saveSpinner.classList.remove('hidden');
                saveBtn.disabled = true;

                try {
                    const updatedCategories = [...state.categories.filter(c => c !== 'Todas'), validation.value].sort();
                    await setDoc(doc(db, 'settings', 'global'), { categories: updatedCategories }, { merge: true });
                    showNotification('Categoría creada exitosamente.', 'success');
                    closeModal();
                    
                    // Actualizar vistas si están abiertas
                    if (window.location.hash.substring(1) === 'inventory') {
                        renderInventoryView();
                    } else if (window.location.hash.substring(1) === 'settings') {
                        renderSettingsTab('advanced');
                    }
                } catch (error) {
                    console.error('Error creating category:', error);
                    showNotification('Error al crear la categoría.', 'error');
                    saveBtnText.classList.remove('hidden');
                    saveSpinner.classList.add('hidden');
                    saveBtn.disabled = false;
                }
            });
            
            document.getElementById('cancel-category-btn').addEventListener('click', closeModal);
        }

        function showRenameCategoryModal(oldName) {
            const content = `
                <form id="rename-category-form">
                    <div class="space-y-4">
                        <div>
                            <label for="rename-category-name-modal" class="block text-sm font-medium themed-text-light">Nuevo Nombre de la Categoría</label>
                            <input type="text" id="rename-category-name-modal" required placeholder="Nombre de la categoría" value="${oldName}" maxlength="50" class="themed-input mt-1 block w-full px-4 py-3 border rounded-md shadow-sm">
                            <div class="mt-2 flex items-center justify-between">
                                <p id="rename-validation-message" class="text-xs text-red-500 hidden"></p>
                                <p id="rename-char-count" class="text-xs text-gray-500">${oldName.length}/50</p>
                            </div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                            <p class="text-xs text-blue-700">
                                <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                                Esto actualizará todos los artículos de esta categoría.
                            </p>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" id="cancel-rename-category-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-8 rounded min-h-[56px] flex items-center justify-center transition-all duration-200">
                                <i data-lucide="x" class="h-6 w-6 mr-2"></i>
                                Cancelar
                            </button>
                            <button type="submit" id="save-rename-category-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded min-h-[56px] flex items-center justify-center transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="save" class="h-6 w-6 mr-2"></i>
                                <span id="save-rename-btn-text">Guardar Cambios</span>
                                <i id="save-rename-spinner" data-lucide="loader" class="h-5 w-5 animate-spin hidden ml-2"></i>
                            </button>
                        </div>
                    </div>
                </form>
            `;
            showModal(`Renombrar Categoría: "${oldName}"`, content, 'max-w-md');
            safeCreateIcons();
            
            const input = document.getElementById('rename-category-name-modal');
            const validationMsg = document.getElementById('rename-validation-message');
            const charCount = document.getElementById('rename-char-count');
            const saveBtn = document.getElementById('save-rename-category-btn');
            const saveBtnText = document.getElementById('save-rename-btn-text');
            const saveSpinner = document.getElementById('save-rename-spinner');
            
            // Seleccionar todo el texto al abrir
            input.select();
            
            // Deshabilitar botón inicialmente (valor igual al nombre actual)
            saveBtn.disabled = true;
            
            // Validación en tiempo real
            input.addEventListener('input', () => {
                const value = input.value;
                charCount.textContent = `${value.length}/50`;
                
                if (value.trim() === oldName) {
                    validationMsg.textContent = 'El nombre debe ser diferente al actual.';
                    validationMsg.classList.remove('hidden');
                    saveBtn.disabled = true;
                    return;
                }
                
                if (value.length === 0) {
                    validationMsg.classList.add('hidden');
                    saveBtn.disabled = true;
                    return;
                }
                
                const validation = validateCategoryName(value, oldName);
                if (!validation.valid) {
                    validationMsg.textContent = validation.error;
                    validationMsg.classList.remove('hidden');
                    saveBtn.disabled = true;
                } else {
                    validationMsg.classList.add('hidden');
                    saveBtn.disabled = false;
                }
            });
            
            document.getElementById('rename-category-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = input.value.trim();
                
                if (newName === oldName) {
                    showNotification('El nombre debe ser diferente al actual.', 'info');
                    return;
                }
                
                const validation = validateCategoryName(newName, oldName);
                if (!validation.valid) {
                    showNotification(validation.error, 'error');
                    return;
                }
                
                saveBtnText.classList.add('hidden');
                saveSpinner.classList.remove('hidden');
                saveBtn.disabled = true;

                try {
                    const batch = writeBatch(db);
                    const itemsToUpdateQuery = query(collection(db, 'inventory'), where('category', '==', oldName));
                    const querySnapshot = await getDocs(itemsToUpdateQuery);
                    
                    querySnapshot.forEach(itemDoc => {
                        batch.update(itemDoc.ref, { category: validation.value });
                    });
                    
                    const updatedCategories = state.categories.map(c => c === oldName ? validation.value : c).sort();
                    batch.set(doc(db, 'settings', 'global'), { categories: updatedCategories.filter(c => c !== 'Todas')}, { merge: true });

                    await batch.commit();
                    showNotification('Categoría renombrada con éxito.', 'success');
                    closeModal();
                    
                    // Actualizar vistas si están abiertas
                    if (window.location.hash.substring(1) === 'inventory') {
                        renderInventoryView();
                    } else if (window.location.hash.substring(1) === 'settings') {
                        renderSettingsTab('advanced');
                    }
                } catch (error) {
                    console.error('Error renaming category:', error);
                    showNotification('Error al renombrar la categoría.', 'error');
                    saveBtnText.classList.remove('hidden');
                    saveSpinner.classList.add('hidden');
                    saveBtn.disabled = false;
                }
            });
            
            document.getElementById('cancel-rename-category-btn').addEventListener('click', closeModal);
        }

        // --- LÓGICA DE AJUSTES ---
        
        async function handleSaveSettings() {
            // Helper function to safely parse integers, falling back to a default if NaN
            const safeParseInt = (value, fallback) => {
                const parsed = parseInt(value, 10);
                return isNaN(parsed) ? fallback : parsed;
            };

            // Create a deep copy of the current settings to modify
            const updatedSettings = JSON.parse(JSON.stringify(state.settings));

            // Go through each possible setting in the DOM.
            // If the element exists (i.e., its tab is active), update the value in our copied object.
            // This prevents overwriting settings from inactive tabs with null/undefined.
            
            // General Tab
            const itemsPerPageEl = document.getElementById('items-per-page');
            if (itemsPerPageEl) updatedSettings.itemsPerPage = safeParseInt(itemsPerPageEl.value, updatedSettings.itemsPerPage);

            const defaultUnitEl = document.getElementById('default-unit');
            if (defaultUnitEl) updatedSettings.defaultUnit = defaultUnitEl.value;

            const defaultMinStockEl = document.getElementById('default-min-stock');
            if (defaultMinStockEl) updatedSettings.defaultMinStock = safeParseInt(defaultMinStockEl.value, updatedSettings.defaultMinStock);
            
            const sessionTimeoutEl = document.getElementById('session-timeout');
            if (sessionTimeoutEl) updatedSettings.sessionTimeout = safeParseInt(sessionTimeoutEl.value, updatedSettings.sessionTimeout);

            const enableAuditLogEl = document.getElementById('enable-audit-log');
            if (enableAuditLogEl) updatedSettings.enableAuditLog = enableAuditLogEl.checked;
            
            const barcodeScanningEl = document.getElementById('barcode-scanning');
            if (barcodeScanningEl) updatedSettings.barcodeScanning = barcodeScanningEl.checked;
            
            // Display Tab
            const tableDensityEl = document.getElementById('table-density');
            if (tableDensityEl) updatedSettings.displayPreferences.tableDensity = tableDensityEl.value;
            
            const defaultViewEl = document.getElementById('default-view');
            if (defaultViewEl) updatedSettings.displayPreferences.defaultView = defaultViewEl.value;
            
            const showColumnLinesEl = document.getElementById('show-column-lines');
            if (showColumnLinesEl) updatedSettings.displayPreferences.showColumnLines = showColumnLinesEl.checked;

            const enableRowHoverEl = document.getElementById('enable-row-hover');
            if (enableRowHoverEl) updatedSettings.displayPreferences.enableRowHover = enableRowHoverEl.checked;

            const showStockBadgesEl = document.getElementById('show-stock-badges');
            if (showStockBadgesEl) updatedSettings.displayPreferences.showStockBadges = showStockBadgesEl.checked;

            const fontSizeEl = document.getElementById('font-size');
            if (fontSizeEl) updatedSettings.interfaceCustomization.fontSize = fontSizeEl.value;
            
            const colorThemeEl = document.getElementById('color-theme');
            if (colorThemeEl) updatedSettings.interfaceCustomization.colorTheme = colorThemeEl.value;
            
            const buttonSizeEl = document.getElementById('button-size');
            if (buttonSizeEl) updatedSettings.interfaceCustomization.buttonSize = buttonSizeEl.value;
            
            const compactSidebarEl = document.getElementById('compact-sidebar');
            if (compactSidebarEl) updatedSettings.interfaceCustomization.compactSidebar = compactSidebarEl.checked;
            
            const animationsEnabledEl = document.getElementById('animations-enabled');
            if (animationsEnabledEl) updatedSettings.interfaceCustomization.animationsEnabled = animationsEnabledEl.checked;

            // Operational Tab
            const defaultTransactionTypeEl = document.getElementById('default-transaction-type');
            if (defaultTransactionTypeEl) updatedSettings.operationalPreferences.defaultTransactionType = defaultTransactionTypeEl.value;

            const recentItemsCountEl = document.getElementById('recent-items-count');
            if (recentItemsCountEl) updatedSettings.operationalPreferences.recentItemsCount = safeParseInt(recentItemsCountEl.value, updatedSettings.operationalPreferences.recentItemsCount);
            
            const enableKeyboardShortcutsEl = document.getElementById('enable-keyboard-shortcuts');
            if (enableKeyboardShortcutsEl) updatedSettings.operationalPreferences.enableKeyboardShortcuts = enableKeyboardShortcutsEl.checked;
            
            const showRecentItemsEl = document.getElementById('show-recent-items');
            if (showRecentItemsEl) updatedSettings.operationalPreferences.showRecentItems = showRecentItemsEl.checked;
            
            const autoSaveChangesEl = document.getElementById('auto-save-changes');
            if (autoSaveChangesEl) updatedSettings.operationalPreferences.autoSaveChanges = autoSaveChangesEl.checked;
            
            const confirmBeforeDeleteEl = document.getElementById('confirm-before-delete');
            if (confirmBeforeDeleteEl) updatedSettings.operationalPreferences.confirmBeforeDelete = confirmBeforeDeleteEl.checked;
            
            // Productivity Settings
            const autoSaveEl = document.getElementById('auto-save');
            if (autoSaveEl) updatedSettings.productivitySettings.autoSave = autoSaveEl.checked;
            
            const autoSaveIntervalEl = document.getElementById('auto-save-interval');
            if (autoSaveIntervalEl) updatedSettings.productivitySettings.autoSaveInterval = safeParseInt(autoSaveIntervalEl.value, updatedSettings.productivitySettings.autoSaveInterval);
            
            const rememberLastPageEl = document.getElementById('remember-last-page');
            if (rememberLastPageEl) updatedSettings.productivitySettings.rememberLastPage = rememberLastPageEl.checked;
            
            const enableKeyboardShortcutsProductivityEl = document.getElementById('enable-keyboard-shortcuts');
            if (enableKeyboardShortcutsProductivityEl) updatedSettings.productivitySettings.enableKeyboardShortcuts = enableKeyboardShortcutsProductivityEl.checked;
            
            const enableBulkOperationsEl = document.getElementById('enable-bulk-operations');
            if (enableBulkOperationsEl) updatedSettings.operationalPreferences.enableBulkOperations = enableBulkOperationsEl.checked;
            
            const showAdvancedFiltersEl = document.getElementById('show-advanced-filters');
            if (showAdvancedFiltersEl) updatedSettings.operationalPreferences.showAdvancedFilters = showAdvancedFiltersEl.checked;

            // Dashboard Tab
            const showStockOverviewEl = document.getElementById('show-stock-overview');
            if (showStockOverviewEl) updatedSettings.dashboardCustomization.showStockOverview = showStockOverviewEl.checked;

            const showRecentTransactionsEl = document.getElementById('show-recent-transactions');
            if (showRecentTransactionsEl) updatedSettings.dashboardCustomization.showRecentTransactions = showRecentTransactionsEl.checked;
            
            const showLowStockAlertsEl = document.getElementById('show-low-stock-alerts');
            if (showLowStockAlertsEl) updatedSettings.dashboardCustomization.showLowStockAlerts = showLowStockAlertsEl.checked;

            const showQuickActionsEl = document.getElementById('show-quick-actions');
            if (showQuickActionsEl) updatedSettings.dashboardCustomization.showQuickActions = showQuickActionsEl.checked;

            const chartTypeEl = document.getElementById('chart-type');
            if (chartTypeEl) updatedSettings.dashboardCustomization.chartType = chartTypeEl.value;

            const defaultDateRangeEl = document.getElementById('default-date-range');
            if (defaultDateRangeEl) updatedSettings.dashboardCustomization.defaultDateRange = defaultDateRangeEl.value;
            
            const refreshIntervalEl = document.getElementById('refresh-interval');
            if (refreshIntervalEl) updatedSettings.dashboardCustomization.refreshInterval = safeParseInt(refreshIntervalEl.value, updatedSettings.dashboardCustomization.refreshInterval);


            const maxQuantityTransactionEl = document.getElementById('max-quantity-transaction');
            if (maxQuantityTransactionEl) updatedSettings.customValidations.maxQuantityPerTransaction = safeParseInt(maxQuantityTransactionEl.value, updatedSettings.customValidations.maxQuantityPerTransaction);
            
            const requireNotesLargeEl = document.getElementById('require-notes-large');
            if (requireNotesLargeEl) updatedSettings.customValidations.requireNotesForLargeTransactions = requireNotesLargeEl.checked;

            const preventNegativeStockEl = document.getElementById('prevent-negative-stock');
            if (preventNegativeStockEl) updatedSettings.customValidations.preventNegativeStock = preventNegativeStockEl.checked;

            // Notifications Tab
            const lowStockNotificationsEl = document.getElementById('low-stock-notifications');
            if (lowStockNotificationsEl) updatedSettings.lowStockNotifications = lowStockNotificationsEl.checked;
            
            const notificationEmailsEl = document.getElementById('notification-emails');
            if (notificationEmailsEl) updatedSettings.notificationEmails = notificationEmailsEl.value;

            const stockAlertDaysEl = document.getElementById('stock-alert-days');
            if (stockAlertDaysEl) {
                updatedSettings.stockAlertDays = stockAlertDaysEl.value.split(',').map(d => safeParseInt(d.trim(), null)).filter(d => d !== null);
            }

            const enableScheduledReportsEl = document.getElementById('enable-scheduled-reports');
            if (enableScheduledReportsEl) updatedSettings.enableScheduledReports = enableScheduledReportsEl.checked;
            
            const reportScheduleEl = document.getElementById('report-schedule');
            if (reportScheduleEl) updatedSettings.reportSchedule = reportScheduleEl.value;

            // Workflow Tab
            const enableWorkflowApprovalsEl = document.getElementById('enable-workflow-approvals');
            if (enableWorkflowApprovalsEl) updatedSettings.enableWorkflowApprovals = enableWorkflowApprovalsEl.checked;

            // Operator Tab - Vista y Pantalla
            const operatorItemsPerPageEl = document.getElementById('operator-items-per-page');
            if (operatorItemsPerPageEl) updatedSettings.itemsPerPage = safeParseInt(operatorItemsPerPageEl.value, updatedSettings.itemsPerPage);

            const operatorViewTypeEl = document.getElementById('operator-view-type');
            if (operatorViewTypeEl) updatedSettings.displayPreferences.defaultView = operatorViewTypeEl.value;

            const operatorTableDensityEl = document.getElementById('operator-table-density');
            if (operatorTableDensityEl) updatedSettings.displayPreferences.tableDensity = operatorTableDensityEl.value;

            const operatorShowLinesEl = document.getElementById('operator-show-lines');
            if (operatorShowLinesEl) updatedSettings.displayPreferences.showColumnLines = operatorShowLinesEl.checked;

            // Operator Tab - Trabajo Diario
            const operatorDefaultActionEl = document.getElementById('operator-default-action');
            if (operatorDefaultActionEl) {
                const actionMap = {
                    'entry': 'Entrada',
                    'exit': 'Salida', 
                    'adjustment': 'Ajuste'
                };
                updatedSettings.operationalPreferences.defaultTransactionType = actionMap[operatorDefaultActionEl.value] || 'Entrada';
            }

            const operatorRecentItemsEl = document.getElementById('operator-recent-items');
            if (operatorRecentItemsEl) updatedSettings.operationalPreferences.recentItemsCount = safeParseInt(operatorRecentItemsEl.value, updatedSettings.operationalPreferences.recentItemsCount);

            const operatorShowRecentEl = document.getElementById('operator-show-recent');
            if (operatorShowRecentEl) updatedSettings.operationalPreferences.showRecentItems = operatorShowRecentEl.checked;

            const operatorKeyboardShortcutsEl = document.getElementById('operator-keyboard-shortcuts');
            if (operatorKeyboardShortcutsEl) updatedSettings.operationalPreferences.enableKeyboardShortcuts = operatorKeyboardShortcutsEl.checked;

            // Operator-specific settings
            const operatorConfirmDeleteEl = document.getElementById('operator-confirm-delete');
            if (operatorConfirmDeleteEl) updatedSettings.operationalPreferences.confirmBeforeDelete = operatorConfirmDeleteEl.checked;

            const operatorRecentCountEl = document.getElementById('operator-recent-count');
            if (operatorRecentCountEl) updatedSettings.operationalPreferences.recentItemsCount = safeParseInt(operatorRecentCountEl.value, updatedSettings.operationalPreferences.recentItemsCount);

            const operatorEnableHoverEl = document.getElementById('operator-enable-hover');
            if (operatorEnableHoverEl) updatedSettings.displayPreferences.enableRowHover = operatorEnableHoverEl.checked;

            // Operator Tab - Alertas
            const operatorLowStockAlertEl = document.getElementById('operator-low-stock-alert');
            if (operatorLowStockAlertEl) updatedSettings.notificationPreferences.lowStockAlert = operatorLowStockAlertEl.value;

            const operatorSoundAlertsEl = document.getElementById('operator-sound-alerts');
            if (operatorSoundAlertsEl) updatedSettings.notificationPreferences.soundAlerts = operatorSoundAlertsEl.checked;

            const operatorPopupAlertsEl = document.getElementById('operator-popup-alerts');
            if (operatorPopupAlertsEl) updatedSettings.notificationPreferences.popupAlerts = operatorPopupAlertsEl.checked;

            // Missing notification preferences
            const lowStockAlertEl = document.getElementById('low-stock-alert');
            if (lowStockAlertEl) updatedSettings.notificationPreferences.lowStockAlert = lowStockAlertEl.value;

            const soundAlertsEl = document.getElementById('sound-alerts');
            if (soundAlertsEl) updatedSettings.notificationPreferences.soundAlerts = soundAlertsEl.checked;

            const popupAlertsEl = document.getElementById('popup-alerts');
            if (popupAlertsEl) updatedSettings.notificationPreferences.popupAlerts = popupAlertsEl.checked;

            const emailNotificationsEl = document.getElementById('email-notifications');
            if (emailNotificationsEl) updatedSettings.notificationPreferences.emailNotifications = emailNotificationsEl.checked;

            // New Notification Settings
            const dailyEmailEl = document.getElementById('daily-email');
            if (dailyEmailEl) updatedSettings.notificationPreferences.dailyEmail = dailyEmailEl.checked;

            const weeklyEmailEl = document.getElementById('weekly-email');
            if (weeklyEmailEl) updatedSettings.notificationPreferences.weeklyEmail = weeklyEmailEl.checked;

            const emailRecipientsEl = document.getElementById('email-recipients');
            if (emailRecipientsEl) updatedSettings.notificationPreferences.emailRecipients = emailRecipientsEl.value;

            const inactiveItemsDaysEl = document.getElementById('inactive-items-days');
            if (inactiveItemsDaysEl) updatedSettings.notificationPreferences.inactiveItemsDays = safeParseInt(inactiveItemsDaysEl.value, updatedSettings.notificationPreferences.inactiveItemsDays);

            // Operator Tab - Apariencia
            const operatorFontSizeEl = document.getElementById('operator-font-size');
            if (operatorFontSizeEl) updatedSettings.interfaceCustomization.fontSize = operatorFontSizeEl.value;

            const operatorCompactSidebarEl = document.getElementById('operator-compact-sidebar');
            if (operatorCompactSidebarEl) updatedSettings.interfaceCustomization.compactSidebar = operatorCompactSidebarEl.checked;

            const operatorAnimationsEl = document.getElementById('operator-animations');
            if (operatorAnimationsEl) updatedSettings.interfaceCustomization.animationsEnabled = operatorAnimationsEl.checked;

            const approvalThresholdEl = document.getElementById('approval-threshold');
            if (approvalThresholdEl) updatedSettings.approvalThreshold = safeParseInt(approvalThresholdEl.value, updatedSettings.approvalThreshold);

            const dataRetentionDaysEl = document.getElementById('data-retention-days');
            if (dataRetentionDaysEl) updatedSettings.dataRetentionDays = safeParseInt(dataRetentionDaysEl.value, updatedSettings.dataRetentionDays);

            // Backup Settings
            const autoBackupEl = document.getElementById('auto-backup');
            if (autoBackupEl) {
                if (!updatedSettings.backup) updatedSettings.backup = {};
                updatedSettings.backup.autoBackup = autoBackupEl.checked;
            }

            const backupFrequencyEl = document.getElementById('backup-frequency');
            if (backupFrequencyEl) {
                if (!updatedSettings.backup) updatedSettings.backup = {};
                updatedSettings.backup.backupFrequency = backupFrequencyEl.value;
            }

            // Validación mejorada usando el sistema de validaciones
            if (!validateAndShowFeedback(updatedSettings)) {
                return; // Si hay errores, no continuar
            }

            try {
                // Save the fully merged and updated settings object
                await setDoc(doc(db, 'settings', 'global'), updatedSettings);
                
                // Update state with new settings
                state.settings = updatedSettings;
                
                // Apply settings to the UI immediately
                applySettingsToUI(updatedSettings);
                
                // Reinicializar backup automático si las configuraciones cambiaron
                initializeAutoBackup();
                
                // Reinicializar sistema de notificaciones
                setupNotificationSchedules();
                
                // Actualizar estado de cambios no guardados
                originalSettings = JSON.parse(JSON.stringify(updatedSettings));
                hasUnsavedChanges = false;
                updateChangeIndicators();
                
                showNotification('Ajustes guardados con éxito.', 'success');

            } catch (error) {
                showNotification('Error al guardar los ajustes.', 'error');
                console.error("Error saving settings: ", error);
            }
        }
        
        // Validación de nombres de categoría
        function validateCategoryName(name, excludeName = null) {
            const trimmed = name.trim();
            
            if (!trimmed) {
                return { valid: false, error: 'El nombre no puede estar vacío.' };
            }
            
            if (trimmed.length < 2) {
                return { valid: false, error: 'El nombre debe tener al menos 2 caracteres.' };
            }
            
            if (trimmed.length > 50) {
                return { valid: false, error: 'El nombre no puede tener más de 50 caracteres.' };
            }
            
            // Permitir letras, números, espacios, guiones y guiones bajos
            const validPattern = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ0-9\s\-_]+$/;
            if (!validPattern.test(trimmed)) {
                return { valid: false, error: 'Solo se permiten letras, números, espacios, guiones y guiones bajos.' };
            }
            
            // Verificar duplicados (excluyendo el nombre actual si se está renombrando)
            const categoriesToCheck = excludeName 
                ? state.categories.filter(c => c !== excludeName && c !== 'Todas')
                : state.categories.filter(c => c !== 'Todas');
            
            if (categoriesToCheck.includes(trimmed)) {
                return { valid: false, error: 'Ya existe una categoría con ese nombre.' };
            }
            
            return { valid: true, error: null, value: trimmed };
        }

        // Obtener cantidad de artículos en una categoría
        async function getCategoryItemCount(categoryName) {
            try {
                const itemsQuery = query(collection(db, 'inventory'), where('category', '==', categoryName));
                const querySnapshot = await getDocs(itemsQuery);
                return querySnapshot.size;
            } catch (error) {
                console.error('Error getting category item count:', error);
                return 0;
            }
        }

        async function handleAddCategory() {
            const input = document.getElementById('new-category-name');
            const addBtn = document.getElementById('add-category-btn');
            const originalBtnContent = addBtn.innerHTML;
            
            // Deshabilitar botón y mostrar loading
            addBtn.disabled = true;
            addBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i><span class="ml-2">Añadiendo...</span>';
            safeCreateIcons();
            
            const newCategory = input.value.trim();
            const validation = validateCategoryName(newCategory);
            
            if (!validation.valid) {
                showNotification(validation.error, 'error');
                addBtn.disabled = false;
                addBtn.innerHTML = originalBtnContent;
                safeCreateIcons();
                return;
            }
            
            try {
                const updatedCategories = [...state.categories.filter(c => c !== 'Todas'), validation.value].sort();
                await setDoc(doc(db, 'settings', 'global'), { categories: updatedCategories }, { merge: true });
                input.value = '';
                showNotification('Categoría añadida exitosamente.', 'success');
                
                // Actualizar la vista de ajustes si está abierta
                if (window.location.hash.substring(1) === 'settings') {
                    renderSettingsTab('advanced');
                }
            } catch (error) {
                console.error('Error adding category:', error);
                showNotification('Error al añadir la categoría.', 'error');
            } finally {
                addBtn.disabled = false;
                addBtn.innerHTML = originalBtnContent;
                safeCreateIcons();
            }
        }

        async function handleRenameCategory(oldName) {
            showRenameCategoryModal(oldName);
        }

        async function handleDeleteCategory(categoryName) {
            try {
                const itemsInCategoryQuery = query(collection(db, 'inventory'), where('category', '==', categoryName));
                const querySnapshot = await getDocs(itemsInCategoryQuery);
                const itemsCount = querySnapshot.size;

                let confirmationContent = `
                    <div class="space-y-4">
                        <div class="bg-red-50 border border-red-200 rounded-md p-4">
                            <div class="flex items-start">
                                <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600 mr-3 mt-0.5"></i>
                                <div>
                                    <p class="text-sm font-semibold text-red-800 mb-2">Esta acción no se puede deshacer</p>
                                    <p class="text-sm text-red-700">Se eliminará la categoría <strong>"${categoryName}"</strong></p>
                                    ${itemsCount > 0 ? `
                                        <p class="text-sm text-red-700 mt-2">
                                            También se eliminarán <strong>${itemsCount} artículo${itemsCount === 1 ? '' : 's'}</strong> que ${itemsCount === 1 ? 'pertenece' : 'pertenecen'} a esta categoría.
                                        </p>
                                    ` : `
                                        <p class="text-sm text-red-700 mt-2">Esta categoría no tiene artículos.</p>
                                    `}
                                </div>
                            </div>
                        </div>
                        ${itemsCount > 0 && itemsCount <= 10 ? `
                            <div class="bg-gray-50 border border-gray-200 rounded-md p-3 max-h-40 overflow-y-auto">
                                <p class="text-xs font-medium text-gray-700 mb-2">Artículos que se eliminarán:</p>
                                <ul class="text-xs text-gray-600 space-y-1">
                                    ${querySnapshot.docs.slice(0, 10).map(doc => {
                                        const data = doc.data();
                                        return `<li>• ${data.description || 'Sin descripción'}</li>`;
                                    }).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <div class="flex justify-end space-x-3">
                            <button id="cancel-delete-category-btn" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-6 rounded transition-colors">
                                Cancelar
                            </button>
                            <button id="confirm-delete-category-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded transition-colors flex items-center">
                                <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                                <span id="delete-category-btn-text">Eliminar Categoría</span>
                                <i id="delete-category-spinner" data-lucide="loader" class="w-4 h-4 animate-spin hidden ml-2"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                showModal('Eliminar Categoría', confirmationContent, 'max-w-md');
                safeCreateIcons();
                
                const confirmBtn = document.getElementById('confirm-delete-category-btn');
                const cancelBtn = document.getElementById('cancel-delete-category-btn');
                const btnText = document.getElementById('delete-category-btn-text');
                const spinner = document.getElementById('delete-category-spinner');
                
                cancelBtn.addEventListener('click', closeModal);
                
                confirmBtn.addEventListener('click', async () => {
                    confirmBtn.disabled = true;
                    btnText.classList.add('hidden');
                    spinner.classList.remove('hidden');
                    
                    try {
                        const batch = writeBatch(db);

                        // Delete all items in the category
                        querySnapshot.forEach(itemDoc => {
                            const itemData = itemDoc.data();
                            batch.delete(itemDoc.ref);

                            // Add a transaction log for each deleted item
                            const transactionRef = doc(collection(db, 'transactions'));
                            batch.set(transactionRef, {
                                itemDescription: itemData.description,
                                type: 'Eliminado',
                                quantity: itemData.stock,
                                timestamp: serverTimestamp(),
                                user: state.currentUser.email,
                                notes: `Artículo eliminado por borrado de categoría: ${categoryName}`
                            });
                        });

                        // Delete the category from settings
                        const updatedCategories = state.categories.filter(c => c !== categoryName && c !== 'Todas');
                        const settingsRef = doc(db, 'settings', 'global');
                        batch.set(settingsRef, { categories: updatedCategories }, { merge: true });

                        await batch.commit();
                        showNotification(`Categoría "${categoryName}" ${itemsCount > 0 ? `y sus ${itemsCount} artículo${itemsCount === 1 ? '' : 's'}` : ''} han sido eliminados.`, 'success');
                        closeModal();
                        
                        // Actualizar vistas si están abiertas
                        if (window.location.hash.substring(1) === 'inventory') {
                            renderInventoryView();
                        } else if (window.location.hash.substring(1) === 'settings') {
                            renderSettingsTab('advanced');
                        }
                    } catch (error) {
                        console.error("Error deleting category and its items:", error);
                        showNotification('Error al eliminar la categoría y sus artículos.', 'error');
                        confirmBtn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                    }
                });
            } catch (error) {
                console.error('Error getting category items:', error);
                showNotification('Error al obtener información de la categoría.', 'error');
            }
        }


        async function handleBulkUpdateCategoryType() {
            const categoryToUpdate = document.getElementById('bulk-category-select').value;
            const newType = document.getElementById('bulk-type-select').value;

            if (!categoryToUpdate) {
                showNotification('Por favor, selecciona una categoría.', 'error');
                return;
            }

            const message = `¿Estás seguro de que quieres cambiar todos los artículos en la categoría "${categoryToUpdate}" al tipo "${newType}"? Esta acción es irreversible.`;

            showConfirmationModal(message, async () => {
                const itemsToUpdateQuery = query(collection(db, 'inventory'), where('category', '==', categoryToUpdate));
                const querySnapshot = await getDocs(itemsToUpdateQuery);

                if (querySnapshot.empty) {
                    showNotification('No hay artículos en esta categoría para actualizar.', 'info');
                    return;
                }

                const batch = writeBatch(db);
                querySnapshot.forEach(itemDoc => {
                    batch.update(itemDoc.ref, { type: newType });
                });

                try {
                    await batch.commit();
                    showNotification(`Se actualizaron ${querySnapshot.size} artículos en la categoría "${categoryToUpdate}".`, 'success');
                } catch (error) {
                    showNotification('Ocurrió un error al actualizar los artículos.', 'error');
                    console.error("Error during bulk category type update:", error);
                }
            });
        }

        // --- ENHANCED DATA MANAGEMENT FUNCTIONS ---
        async function handleImportData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Por favor, selecciona un archivo CSV.', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const csv = e.target.result;
                    const lines = csv.split(/\r\n|\n/); // Handles different line endings
                    const items = [];
                    
                    // Skip header line (i=1)
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const [description, category, type, stock, unit, minStock] = line.split(',').map(s => s.trim().replace(/"/g, ''));
                        
                        if (description && category && type && stock && unit) {
                            items.push({
                                description,
                                category,
                                type,
                                stock: parseInt(stock, 10) || 0,
                                unit,
                                minStock: parseInt(minStock, 10) || state.settings.defaultMinStock || 5,
                            });
                        }
                    }
                    
                    if (items.length === 0) {
                        showNotification('No se encontraron datos válidos en el archivo.', 'error');
                        return;
                    }
                    
                    showConfirmationModal(`¿Importar ${items.length} artículos? Esta acción agregará nuevos items al inventario.`, async () => {
                        const batch = writeBatch(db);
                        let successCount = 0;
                        
                        items.forEach(item => {
                            const docRef = doc(collection(db, 'inventory'));
                            batch.set(docRef, item);
                            
                            const transactionRef = doc(collection(db, 'transactions'));
                            batch.set(transactionRef, {
                                itemDescription: item.description, type: 'Creación', quantity: item.stock,
                                timestamp: serverTimestamp(), user: state.currentUser.email, notes: 'Importado desde CSV'
                            });
                            successCount++;
                        });
                        
                        try {
                            await batch.commit();
                            showNotification(`${successCount} artículos importados con éxito.`, 'success');
                            fileInput.value = '';
                        } catch (error) {
                            showNotification('Error al importar los datos.', 'error');
                            console.error('Import error:', error);
                        }
                    });
                } catch (error) {
                    showNotification('Error al procesar el archivo CSV.', 'error');
                    console.error('CSV processing error:', error);
                }
            };
            reader.readAsText(file);
        }

        async function handleExportInventory() {
            const data = state.inventory.map(item => [
                item.description, item.category,
                item.stock, item.unit, item.minStock || 0
            ]);
            const headers = ['Descripción', 'Categoría', 'Stock', 'Unidad', 'Stock Mínimo'];
            exportToCSV('inventario_completo', headers, data);
        }

        async function handleExportSettings() {
            const settingsJson = JSON.stringify(state.settings, null, 2);
            const blob = new Blob([settingsJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `configuraciones_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
            showNotification('Configuraciones exportadas.', 'success');
        }

        async function handleExportFullBackup() {
            try {
                const backup = {
                    timestamp: new Date().toISOString(),
                    settings: state.settings,
                    categories: state.categories.filter(c => c !== 'Todas'),
                    inventory: state.inventory,
                    transactions: state.transactions,
                    activeLoans: state.activeLoans,
                    shoppingList: state.shoppingList
                };
                
                const backupJson = JSON.stringify(backup, null, 2);
                const blob = new Blob([backupJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `respaldo_completo_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link);
                link.click();
                link.remove();
                URL.revokeObjectURL(url);
                showNotification('Respaldo completo creado.', 'success');
            } catch (error) {
                showNotification('Error al crear el respaldo.', 'error');
                console.error('Backup error:', error);
            }
        }

        async function handleArchiveOldData() {
            const retentionDays = state.settings.dataRetentionDays || 365;
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - retentionDays);
            
            const oldTransactionsQuery = query(collection(db, 'transactions'), where('timestamp', '<', cutoffDate));
            const querySnapshot = await getDocs(oldTransactionsQuery);
            
            if (querySnapshot.empty) {
                showNotification('No hay datos antiguos para archivar.', 'info');
                return;
            }
            
            showConfirmationModal(`¿Archivar ${querySnapshot.size} transacciones anteriores a ${cutoffDate.toLocaleDateString()}?`, async () => {
                try {
                    const archiveBatch = writeBatch(db);
                    const deleteBatch = writeBatch(db);
                    
                    querySnapshot.forEach(transactionDoc => {
                        const transactionData = transactionDoc.data();
                        const archiveRef = doc(collection(db, 'archived_transactions'));
                        archiveBatch.set(archiveRef, { ...transactionData, archivedAt: serverTimestamp() });
                        deleteBatch.delete(transactionDoc.ref);
                    });
                    
                    await archiveBatch.commit();
                    await deleteBatch.commit();
                    
                    showNotification(`${querySnapshot.size} transacciones archivadas.`, 'success');
                } catch (error) {
                    showNotification('Error al archivar los datos.', 'error');
                    console.error('Archive error:', error);
                }
            });
        }

        // --- LÓGICA DE UTILIDADES ---
        async function uploadImage(file) {
            if (!file) return null;
            const storageRef = ref(storage, `item_images/${Date.now()}_${file.name}`);
            try {
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                return downloadURL;
            } catch (error) {
                console.error("Error uploading image: ", error);
                showNotification("Error al subir la imagen.", "error");
                return null;
            }
        }

        function generatePaginator(totalPages) {
            if (totalPages <= 1) return '';
            let pages = '';
            for (let i = 1; i <= totalPages; i++) {
                pages += `<a href="#" class="page-link px-3 py-1 rounded text-sm font-medium transition-colors ${i === state.currentPage ? 'bg-indigo-600 text-white' : 'text-gray-600 hover:bg-gray-100 hover:text-indigo-600'}" data-page="${i}">${i}</a>`;
            }
            return `<div class="flex items-center justify-center space-x-1 flex-wrap">${pages}</div>`;
        }
        function showNotification(message, type = 'info') {
            // Input validation
            if (!message || typeof message !== 'string') {
                console.warn('Invalid notification message:', message);
                return;
            }
            
            const container = document.getElementById('notification-container');
            if (!container) {
                console.warn('Notification container not found');
                return;
            }
            
            const id = `notif-${Date.now()}`;
            const notif = document.createElement('div');
            notif.id = id;
            
            // Sanitize message to prevent XSS
            const sanitizedMessage = message.replace(/[<>]/g, '');
            
            // Íconos para cada tipo
            const icons = {
                success: 'check-circle',
                error: 'x-circle',
                warning: 'alert-triangle',
                info: 'info'
            };
            
            const iconName = icons[type] || icons.info;
            
            // Tiempos variables según el tipo de notificación
            const timeouts = { 
                success: 2000,   // 2 segundos
                error: 4000,     // 4 segundos  
                warning: 3500,   // 3.5 segundos
                info: 2500       // 2.5 segundos
            };
            const duration = timeouts[type] || 2500;
            
            // Estructura HTML moderna y minimalista
            notif.className = `notification-modern notification-type-${type}`;
            notif.innerHTML = `
                <div class="notification-icon">
                    <i data-lucide="${iconName}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-message">${sanitizedMessage}</div>
                </div>
                <div class="notification-close">
                    <i data-lucide="x"></i>
                </div>
                <div class="notification-progress" style="animation-duration: ${duration}ms;"></div>
            `;
            
            container.appendChild(notif);
            safeCreateIcons();
            
            // Cerrar al hacer clic
            const closeBtn = notif.querySelector('.notification-close');
            closeBtn.addEventListener('click', () => {
                notif.classList.add('notification-fade-out');
                setTimeout(() => {
                    if (notif.parentNode) {
                        notif.remove();
                    }
                }, 300);
            });
            
            // Auto-cerrar después del tiempo especificado
            setTimeout(() => {
                if (notif.parentNode) {
                    notif.classList.add('notification-fade-out');
                    setTimeout(() => {
                        if (notif.parentNode) {
                            notif.remove();
                        }
                    }, 300);
                }
            }, duration);
        }
        // Input validation helper
        function validateInput(value, type = 'string', min = null, max = null) {
            if (value === null || value === undefined || value === '') {
                return { valid: false, error: 'Campo requerido' };
            }
            
            switch (type) {
                case 'number':
                    const num = parseFloat(value);
                    if (isNaN(num)) return { valid: false, error: 'Debe ser un número válido' };
                    if (min !== null && num < min) return { valid: false, error: `Debe ser mayor o igual a ${min}` };
                    if (max !== null && num > max) return { valid: false, error: `Debe ser menor o igual a ${max}` };
                    return { valid: true, value: num };
                case 'string':
                    if (typeof value !== 'string') return { valid: false, error: 'Debe ser texto' };
                    if (value.length < 1) return { valid: false, error: 'No puede estar vacío' };
                    if (value.length > 255) return { valid: false, error: 'Muy largo (máximo 255 caracteres)' };
                    return { valid: true, value: value.trim() };
                default:
                    return { valid: true, value };
            }
        }

        async function addToShoppingList(item, quantity) {
            const quantityValidation = validateInput(quantity, 'number', 1);
            if (!quantityValidation.valid) {
                showNotification(quantityValidation.error, 'error');
                return;
            }
            const existingItemQuery = query(collection(db, 'shoppingList'), where('itemId', '==', item.id));
            const querySnapshot = await getDocs(existingItemQuery);

            if (!querySnapshot.empty) {
                showNotification(`${item.description} ya está en la lista.`, 'info');
                return;
            }
            await addDoc(collection(db, 'shoppingList'), {
                itemId: item.id, description: item.description, quantity: quantity
            });
            showNotification(`${quantity} x ${item.description} añadido(s).`, 'success');
        }
        async function removeFromShoppingList(docId) {
            await deleteDoc(doc(db, 'shoppingList', docId));
            showNotification('Artículo eliminado de la lista.', 'success');
        }
        function updateShoppingListCount() {
            const countEl = document.getElementById('shopping-list-count');
            const count = state.shoppingList.length;
            countEl.textContent = count;
            countEl.classList.toggle('hidden', count === 0);
        }
        function generateShoppingListPDF() {
            if (state.shoppingList.length === 0) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(22);
            doc.text("Lista de Compras", 20, 20);
            doc.setFontSize(12);
            doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 20, 30);
            let y = 40;
            doc.setFontSize(10);
            state.shoppingList.forEach((item, index) => {
                if (y > 280) { doc.addPage(); y = 20; }
                const textLines = doc.splitTextToSize(`[  ] ${item.quantity} x ${item.description}`, 160);
                doc.text(textLines, 25, y);
                y += (textLines.length * 5) + 5;
            });
            doc.save("lista_de_compras.pdf");
        }

        function generateManualInventoryPDF() {
            if (state.inventory.length === 0) {
                showNotification('No hay artículos en el inventario para generar el formulario.', 'info');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Encabezado simple
            doc.setFontSize(20);
            doc.text("Formulario de Inventario Manual", 20, 20);
            doc.setFontSize(12);
            doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 20, 30);
            doc.text(`Total: ${state.inventory.length} artículos`, 20, 40);
            
            let startY = 65;
            
            // Agrupar inventario por categorías
            const inventoryByCategory = {};
            state.inventory.forEach(item => {
                if (!inventoryByCategory[item.category]) {
                    inventoryByCategory[item.category] = [];
                }
                inventoryByCategory[item.category].push(item);
            });
            
            // Preparar datos para las tablas
            const allRows = [];
            const categoryIndices = [];
            
            Object.keys(inventoryByCategory).sort().forEach(category => {
                const items = inventoryByCategory[category];
                categoryIndices.push(allRows.length);
                allRows.push([`📁 CATEGORÍA: ${category.toUpperCase()}`, '', '', '', '']);
                
                items.forEach(item => {
                    allRows.push([
                        item.description,
                        `${item.stock} ${item.unit}`,
                        '_____',
                        '□',
                        '_________________'
                    ]);
                });
            });
            
            // Crear tabla con autoTable
            doc.autoTable({
                head: [['Artículo', 'Stock Sistema', 'Cantidad Real', '✓', 'Observaciones']],
                body: allRows,
                startY: startY,
                theme: 'grid',
                headStyles: {
                    fontStyle: 'bold',
                    halign: 'left'
                },
                styles: {
                    fontSize: 9,
                    cellPadding: { top: 4, right: 3, bottom: 4, left: 3 },
                    overflow: 'linebreak',
                    valign: 'middle'
                },
                columnStyles: {
                    0: { cellWidth: 70 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 15, halign: 'center' },
                    4: { cellWidth: 45 }
                },
                margin: { left: 20, right: 20 },
                willDrawCell: function (data) {
                    // Texto en negrita para filas de categorías
                    if (categoryIndices.includes(data.row.index)) {
                        data.cell.styles.fontStyle = 'bold';
                    }
                },
                didDrawPage: function (data) {
                    // Pie de página
                    doc.setFontSize(10);
                    doc.setTextColor(128, 128, 128);
                    doc.text(
                        `Página ${doc.internal.pages.length - 1}`,
                        doc.internal.pageSize.width - 40,
                        doc.internal.pageSize.height - 10
                    );
                }
            });
            
            // Obtener la posición final después de la tabla
            const finalY = doc.lastAutoTable.finalY || startY + 200;
            
            // Verificar si hay espacio en la página actual, sino crear nueva
            if (finalY > 250) {
                doc.addPage();
                startY = 20;
            } else {
                startY = finalY + 20;
            }
            
            // Sección de artículos adicionales
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text("Artículos Adicionales Encontrados (no registrados)", 20, startY);
            startY += 10;
            
            // Crear tabla vacía para artículos adicionales
            const additionalRows = Array(15).fill(['______', '______', '_____', '□']);
            
            doc.autoTable({
                head: [['Descripción', 'Categoría', 'Cantidad', 'Observaciones']],
                body: additionalRows,
                startY: startY,
                theme: 'striped',
                headStyles: {
                    fontStyle: 'bold',
                    halign: 'left'
                },
                styles: {
                    fontSize: 9,
                    cellPadding: { top: 4, right: 3, bottom: 4, left: 3 },
                    overflow: 'linebreak'
                },
                columnStyles: {
                    0: { cellWidth: 60 },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 55 }
                },
                margin: { left: 20, right: 20 },
                didDrawPage: function (data) {
                    // Pie de página
                    doc.setFontSize(10);
                    doc.setTextColor(128, 128, 128);
                    doc.text(
                        `Página ${doc.internal.pages.length - 1}`,
                        doc.internal.pageSize.width - 40,
                        doc.internal.pageSize.height - 10
                    );
                }
            });
            
            // Información adicional
            const infoY = doc.lastAutoTable.finalY || startY + 100;
            if (infoY > 200) {
                doc.addPage();
                startY = 20;
            } else {
                startY = infoY + 15;
            }
            
            doc.setFontSize(11);
            doc.text("Información Adicional:", 20, startY);
            startY += 8;
            
            doc.setFontSize(10);
            doc.text("• Fecha de conteo: _________________", 25, startY);
            startY += 6;
            doc.text("• Responsable: _________________", 25, startY);
            startY += 6;
            doc.text("• Supervisor: _________________", 25, startY);
            startY += 8;
            doc.text("• Observaciones generales:", 25, startY);
            startY += 6;
            doc.text("_________________________________________________", 25, startY);
            startY += 6;
            doc.text("_________________________________________________", 25, startY);
            
            // Guardar el PDF
            const fileName = `inventario_manual_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            showNotification('Formulario de inventario manual generado exitosamente', 'success');
        }

        function generateShoppingListExcel() {
            if (state.shoppingList.length === 0) {
                showNotification("La lista de compras está vacía.", 'info');
                return;
            }
            
            try {
                // Preparar datos para Excel
                const excelData = [
                    ['Lista de Compras'],
                    [`Fecha: ${new Date().toLocaleDateString()}`],
                    [`Generado por: ${state.currentUser?.email || 'Usuario'}`],
                    [''], // Línea vacía
                    ['Cantidad', 'Descripción', 'Categoría', 'Prioridad'] // Encabezados
                ];
                
                // Agregar elementos de la lista
                state.shoppingList.forEach(item => {
                    excelData.push([
                        item.quantity,
                        item.description,
                        item.category || 'Sin categoría',
                        item.priority || 'Normal'
                    ]);
                });
                
                // Crear libro de trabajo
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                // Configurar ancho de columnas
                ws['!cols'] = [
                    { wch: 10 }, // Cantidad
                    { wch: 40 }, // Descripción
                    { wch: 20 }, // Categoría
                    { wch: 15 }  // Prioridad
                ];
                
                // Agregar hoja al libro
                XLSX.utils.book_append_sheet(wb, ws, 'Lista de Compras');
                
                // Generar y descargar archivo
                const date = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `lista_de_compras_${date}.xlsx`);
                showNotification('Lista de compras en Excel generada exitosamente', 'success');
                
            } catch (error) {
                console.error('Error generando lista de compras Excel:', error);
                showNotification('Error al generar la lista de compras en Excel', 'error');
            }
        }

        // --- FUNCIONES DE GENERACIÓN DE REPORTES ---
        let pendingReportType = null;
        let pendingReportFormat = null;

        function showReportPreview(reportType, format) {
            const data = getReportData(reportType);
            const headers = getReportHeaders(reportType);
            const title = getReportTitle(reportType);
            
            // Guardar el tipo y formato de reporte para la confirmación
            pendingReportType = reportType;
            pendingReportFormat = format;
            
            // Obtener el contenedor del preview
            const previewContainer = document.getElementById('report-preview');
            const previewContent = document.getElementById('preview-content');
            
            if (!previewContainer || !previewContent) {
                // Si no existe el preview, descargar directamente
                if (format === 'excel') {
                    generateExcelReport(reportType);
                } else {
                    generatePDFReport(reportType);
                }
                return;
            }
            
            // Construir la tabla HTML
            let tableHTML = `
                <div class="mb-6 p-4 bg-gray-50 rounded border border-gray-200">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <p class="text-gray-500 font-medium">Tipo de Reporte</p>
                            <p class="text-gray-900 font-semibold mt-1">${title}</p>
                        </div>
                        <div>
                            <p class="text-gray-500 font-medium">Formato</p>
                            <p class="text-gray-900 font-semibold mt-1">${format.toUpperCase()}</p>
                        </div>
                        <div>
                            <p class="text-gray-500 font-medium">Total de Registros</p>
                            <p class="text-gray-900 font-semibold mt-1">${data.length}</p>
                        </div>
                        <div>
                            <p class="text-gray-500 font-medium">Fecha</p>
                            <p class="text-gray-900 font-semibold mt-1">${new Date().toLocaleDateString()}</p>
                        </div>
                    </div>
                </div>
            `;
            
            if (data.length === 0) {
                tableHTML += `
                    <div class="text-center py-8 text-gray-500">
                        <i data-lucide="file-x" class="h-12 w-12 mx-auto mb-4 text-gray-400"></i>
                        <p>No hay datos para mostrar en este reporte.</p>
                    </div>
                `;
            } else {
                // Limitar la visualización a 50 filas para mejor rendimiento
                const displayData = data.slice(0, 50);
                const hasMore = data.length > 50;
                
                tableHTML += `
                    <div class="overflow-x-auto rounded border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    ${headers.map(header => `<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header.label}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${displayData.map((row, idx) => `
                                    <tr class="hover:bg-gray-50">
                                        ${headers.map(header => `<td class="px-4 py-3 text-sm text-gray-900">${row[header.key] || '-'}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                if (hasMore) {
                    tableHTML += `
                        <div class="mt-4 text-center text-sm text-gray-500">
                            <p>Mostrando 50 de ${data.length} registros. El archivo completo incluirá todos los registros.</p>
                        </div>
                    `;
                }
            }
            
            // Agregar botones de acción
            tableHTML += `
                <div class="mt-6 flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button id="cancel-preview-btn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded font-medium transition-colors duration-200">
                        Cancelar
                    </button>
                    <button id="confirm-download-btn" class="px-4 py-2 ${format === 'pdf' ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'} text-white rounded font-medium transition-colors duration-200 flex items-center space-x-2">
                        <i data-lucide="download" class="h-4 w-4"></i>
                        <span>Confirmar y Descargar</span>
                    </button>
                </div>
            `;
            
            previewContent.innerHTML = tableHTML;
            previewContainer.classList.remove('hidden');
            
            // Inicializar iconos
            safeCreateIcons();
            
            // Scroll al preview después de un pequeño delay para asegurar que se renderice
            setTimeout(() => {
                previewContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        function closeReportPreview() {
            const previewContainer = document.getElementById('report-preview');
            if (previewContainer) {
                previewContainer.classList.add('hidden');
                pendingReportType = null;
                pendingReportFormat = null;
            }
        }

        function confirmReportDownload() {
            if (pendingReportType && pendingReportFormat) {
                if (pendingReportFormat === 'excel') {
                    generateExcelReport(pendingReportType);
                } else {
                    generatePDFReport(pendingReportType);
                }
                closeReportPreview();
            }
        }

        function generatePDFReport(reportType) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const data = getReportData(reportType);
            const headers = getReportHeaders(reportType);
            
            if (data.length === 0) {
                // Encabezado simple
                doc.setFontSize(20);
                doc.text(getReportTitle(reportType), 20, 20);
                
                doc.setFontSize(12);
                doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 20, 30);
                
                doc.setFontSize(14);
                doc.text("No hay datos para mostrar en este reporte.", 20, 60);
                
                doc.save(`${getReportFileName(reportType)}.pdf`);
                return;
            }
            
            // Preparar datos para autoTable
            const tableHeaders = [headers.map(h => h.label)];
            const tableRows = data.map(row => headers.map(header => row[header.key] || ''));
            
            // Encabezado simple
            doc.setFontSize(20);
            doc.text(getReportTitle(reportType), 20, 20);
            
            doc.setFontSize(12);
            doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 20, 30);
            
            // Configurar tabla con autoTable
            doc.autoTable({
                head: tableHeaders,
                body: tableRows,
                startY: 50,
                theme: 'plain',
                headStyles: {
                    fontStyle: 'bold',
                    halign: 'left'
                },
                styles: {
                    fontSize: 10,
                    cellPadding: { top: 5, right: 3, bottom: 5, left: 3 },
                    overflow: 'linebreak',
                    cellWidth: 'auto'
                },
                margin: { left: 20, right: 20 },
                didDrawPage: function (data) {
                    // Pie de página
                    doc.setFontSize(10);
                    doc.setTextColor(128, 128, 128);
                    doc.text(
                        `Página ${doc.internal.pages.length - 1}`,
                        doc.internal.pageSize.width - 40,
                        doc.internal.pageSize.height - 10
                    );
                }
            });
            
            doc.save(`${getReportFileName(reportType)}.pdf`);
            showNotification(`Reporte ${getReportTitle(reportType)} generado exitosamente`, 'success');
        }

        function generateExcelReport(reportType) {
            try {
                const data = getReportData(reportType);
                const headers = getReportHeaders(reportType);
                
                if (data.length === 0) {
                    showNotification("No hay datos para mostrar en este reporte.", 'info');
                    return;
                }
                
                // Preparar datos para Excel
                const excelData = [
                    [getReportTitle(reportType)],
                    [`Fecha de generación: ${new Date().toLocaleDateString()}`],
                    [`Generado por: ${state.currentUser?.email || 'Usuario'}`],
                    [''], // Línea vacía
                    headers.map(h => h.label) // Encabezados
                ];
                
                // Agregar datos
                data.forEach(row => {
                    excelData.push(headers.map(header => row[header.key] || ''));
                });
                
                // Crear libro de trabajo
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                // Configurar ancho de columnas
                const colWidths = headers.map(header => ({ wch: header.width ? header.width / 4 : 15 }));
                ws['!cols'] = colWidths;
                
                // Agregar hoja al libro
                XLSX.utils.book_append_sheet(wb, ws, 'Reporte');
                
                // Generar y descargar archivo
                XLSX.writeFile(wb, `${getReportFileName(reportType)}.xlsx`);
                showNotification(`Reporte ${getReportTitle(reportType)} en Excel generado exitosamente`, 'success');
                
            } catch (error) {
                console.error('Error generando reporte Excel:', error);
                showNotification('Error al generar el reporte Excel', 'error');
            }
        }

        function getReportTitle(reportType) {
            const titles = {
                'inventory': 'Inventario Completo',
                'loans': 'Préstamos Activos',
                'salidas': 'Historial de Salidas',
                'prestamos': 'Historial de Préstamos',
                'devoluciones': 'Historial de Devoluciones',
                'low-stock': 'Reporte de Stock Bajo'
            };
            return titles[reportType] || 'Reporte';
        }

        function getReportFileName(reportType) {
            const date = new Date().toISOString().split('T')[0];
            const names = {
                'inventory': `inventario_completo_${date}`,
                'loans': `prestamos_activos_${date}`,
                'salidas': `historial_salidas_${date}`,
                'prestamos': `historial_prestamos_${date}`,
                'devoluciones': `historial_devoluciones_${date}`,
                'low-stock': `stock_bajo_${date}`
            };
            return names[reportType] || `reporte_${date}`;
        }

        function getReportHeaders(reportType) {
            const headers = {
                'inventory': [
                    { key: 'description', label: 'Descripción', width: 70 },
                    { key: 'category', label: 'Categoría', width: 40 },
                    { key: 'stock', label: 'Stock Actual', width: 30 },
                    { key: 'minStock', label: 'Stock Mínimo', width: 30 }
                ],
                'loans': [
                    { key: 'itemDescription', label: 'Artículo', width: 60 },
                    { key: 'borrower', label: 'Prestatario', width: 40 },
                    { key: 'quantity', label: 'Cantidad', width: 25 },
                    { key: 'loanDate', label: 'Fecha Préstamo', width: 40 }
                ],
                'salidas': [
                    { key: 'itemDescription', label: 'Artículo', width: 60 },
                    { key: 'quantity', label: 'Cantidad', width: 25 },
                    { key: 'user', label: 'Usuario', width: 40 },
                    { key: 'date', label: 'Fecha', width: 40 }
                ],
                'prestamos': [
                    { key: 'itemDescription', label: 'Artículo', width: 60 },
                    { key: 'borrower', label: 'Prestatario', width: 40 },
                    { key: 'quantity', label: 'Cantidad', width: 25 },
                    { key: 'loanDate', label: 'Fecha Préstamo', width: 40 }
                ],
                'devoluciones': [
                    { key: 'itemDescription', label: 'Artículo', width: 60 },
                    { key: 'borrower', label: 'Prestatario', width: 40 },
                    { key: 'quantity', label: 'Cantidad', width: 25 },
                    { key: 'returnDate', label: 'Fecha Devolución', width: 40 }
                ],
                'low-stock': [
                    { key: 'description', label: 'Descripción', width: 70 },
                    { key: 'stock', label: 'Stock Actual', width: 30 },
                    { key: 'minStock', label: 'Stock Mínimo', width: 30 },
                    { key: 'difference', label: 'Diferencia', width: 30 }
                ]
            };
            return headers[reportType] || [];
        }

        function getReportData(reportType) {
            switch (reportType) {
                case 'inventory':
                    return state.inventory.map(item => ({
                        ...item,
                        stock: `${item.stock} ${item.unit}`,
                        minStock: item.minStock
                    }));
                
                case 'loans':
                    return state.activeLoans.map(loan => ({
                        ...loan,
                        loanDate: new Date(loan.loanDate).toLocaleDateString(),
                        expectedReturn: loan.expectedReturn ? new Date(loan.expectedReturn).toLocaleDateString() : 'No definida'
                    }));
                
                case 'salidas':
                    return state.transactions
                        .filter(t => t.type === 'Salida')
                        .map(t => ({
                            ...t,
                            date: new Date(t.date).toLocaleDateString()
                        }));
                
                case 'prestamos':
                    return state.transactions
                        .filter(t => t.type === 'Préstamo')
                        .map(t => ({
                            ...t,
                            loanDate: new Date(t.date).toLocaleDateString(),
                            returnDate: t.returnDate ? new Date(t.returnDate).toLocaleDateString() : 'Pendiente'
                        }));
                
                case 'devoluciones':
                    return state.transactions
                        .filter(t => t.type === 'Devolución')
                        .map(t => ({
                            ...t,
                            returnDate: new Date(t.date).toLocaleDateString()
                        }));
                
                case 'low-stock':
                    return state.inventory
                        .filter(item => item.stock < item.minStock)
                        .map(item => ({
                            ...item,
                            stock: `${item.stock} ${item.unit}`,
                            minStock: `${item.minStock} ${item.unit}`,
                            difference: `${item.stock - item.minStock} ${item.unit}`
                        }));
                
                default:
                    return [];
            }
        }

        // --- SISTEMA DE SUGERENCIAS INTELIGENTES ---
        function getItemUsageStats() {
            const usageStats = {};
            
            // Analizar transacciones de los últimos 30 días
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            state.transactions
                .filter(t => new Date(t.date) >= thirtyDaysAgo)
                .forEach(transaction => {
                    const itemId = transaction.itemId;
                    if (!usageStats[itemId]) {
                        usageStats[itemId] = {
                            itemId,
                            description: transaction.itemDescription,
                            category: transaction.category,
                            type: transaction.type,
                            totalUsage: 0,
                            recentUsage: 0,
                            lastUsed: new Date(transaction.date),
                            loanCount: 0,
                            checkoutCount: 0
                        };
                    }
                    
                    usageStats[itemId].totalUsage += transaction.quantity || 1;
                    usageStats[itemId].recentUsage += transaction.quantity || 1;
                    
                    if (transaction.type === 'Préstamo') {
                        usageStats[itemId].loanCount++;
                    } else if (transaction.type === 'Salida') {
                        usageStats[itemId].checkoutCount++;
                    }
                });
            
            return Object.values(usageStats);
        }

        function getMostUsedItems(limit = 10, itemType = null) {
            const usageStats = getItemUsageStats();
            
            // Filtrar por tipo si se especifica
            let filteredStats = usageStats;
            
            // Ordenar por uso reciente y total
            return filteredStats
                .sort((a, b) => {
                    // Priorizar uso reciente (últimos 7 días)
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    
                    const aRecent = a.lastUsed >= sevenDaysAgo ? a.recentUsage : 0;
                    const bRecent = b.lastUsed >= sevenDaysAgo ? b.recentUsage : 0;
                    
                    if (aRecent !== bRecent) {
                        return bRecent - aRecent;
                    }
                    
                    // Luego por uso total
                    return b.totalUsage - a.totalUsage;
                })
                .slice(0, limit);
        }

        function generateCharts() {
            if (typeof Chart === 'undefined') {
                console.error("Chart.js is not loaded.");
                const chartAreas = ['topConsumablesChart', 'topReportedChart', 'topEmployeesChart', 'transactionsTrendChart', 'categoryDistributionChart'];
                chartAreas.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.parentElement.innerHTML = '<p class="text-center themed-text-light">No se pudieron cargar los gráficos.</p>';
                    }
                });
                return;
            }

            // Configuración común para todos los gráficos
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 12,
                                family: "'Poppins', sans-serif"
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14,
                            family: "'Poppins', sans-serif",
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13,
                            family: "'Poppins', sans-serif"
                        },
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true
                    }
                }
            };

            // Gráfico de Artículos Más Utilizados (mejorado)
            const topConsumablesChartEl = document.getElementById('topConsumablesChart');
            if (topConsumablesChartEl) {
                const consumableUsage = state.transactions.filter(t => t.type === 'Salida' || t.type === 'Intercambio').reduce((acc, t) => {
                    acc[t.itemDescription] = (acc[t.itemDescription] || 0) + t.quantity; return acc; }, {});
                const topConsumables = Object.entries(consumableUsage).sort(([,a],[,b]) => b-a).slice(0, 10);
                
                if (topConsumables.length > 0) {
                    new Chart(topConsumablesChartEl, {
                        type: 'bar',
                        data: {
                            labels: topConsumables.map(item => item[0].length > 20 ? item[0].substring(0, 20) + '...' : item[0]),
                            datasets: [{
                                label: 'Cantidad Utilizada',
                                data: topConsumables.map(item => item[1]),
                                backgroundColor: 'rgba(79, 70, 229, 0.8)',
                                borderColor: 'rgba(79, 70, 229, 1)',
                                borderWidth: 2,
                                borderRadius: 6,
                                borderSkipped: false
                            }]
                        },
                        options: {
                            ...commonOptions,
                            indexAxis: 'y',
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: {
                                        font: {
                                            family: "'Poppins', sans-serif",
                                            size: 11
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                y: {
                                    ticks: {
                                        font: {
                                            family: "'Poppins', sans-serif",
                                            size: 11
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                }
                            }
                        }
                    });
                } else {
                    topConsumablesChartEl.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No hay datos de consumo disponibles</p>';
                }
            }
            
            // Gráfico de Herramientas Reportadas (mejorado)
            const topReportedChartEl = document.getElementById('topReportedChart');
            if (topReportedChartEl) {
                const reportedItems = state.transactions.filter(t => t.type === 'Baja').reduce((acc, t) => {
                    acc[t.itemDescription] = (acc[t.itemDescription] || 0) + t.quantity; return acc; }, {});
                const topReported = Object.entries(reportedItems).sort(([,a],[,b]) => b-a).slice(0, 10);
                
                if (topReported.length > 0) {
                    const colors = ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef'];
                    new Chart(topReportedChartEl, {
                        type: 'doughnut',
                        data: {
                            labels: topReported.map(item => item[0].length > 15 ? item[0].substring(0, 15) + '...' : item[0]),
                            datasets: [{
                                data: topReported.map(item => item[1]),
                                backgroundColor: colors.slice(0, topReported.length),
                                borderColor: '#ffffff',
                                borderWidth: 2,
                                hoverOffset: 8
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: {
                                ...commonOptions.plugins,
                                legend: {
                                    ...commonOptions.plugins.legend,
                                    position: 'right'
                                }
                            }
                        }
                    });
                } else {
                    topReportedChartEl.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No hay herramientas reportadas</p>';
                }
            }

            // Gráfico de Empleados con Más Préstamos (mejorado)
            const topEmployeesChartEl = document.getElementById('topEmployeesChart');
            if (topEmployeesChartEl) {
                const employeeLoans = state.transactions.filter(t => t.type === 'Préstamo').reduce((acc, t) => {
                    if(t.borrower) acc[t.borrower] = (acc[t.borrower] || 0) + 1; return acc; }, {});
                const topEmployees = Object.entries(employeeLoans).sort(([,a],[,b]) => b-a).slice(0, 10);
                
                if (topEmployees.length > 0) {
                    new Chart(topEmployeesChartEl, {
                        type: 'bar',
                        data: {
                            labels: topEmployees.map(item => item[0]),
                            datasets: [{
                                label: 'Nº de Préstamos',
                                data: topEmployees.map(item => item[1]),
                                backgroundColor: 'rgba(20, 184, 166, 0.8)',
                                borderColor: 'rgba(20, 184, 166, 1)',
                                borderWidth: 2,
                                borderRadius: 6,
                                borderSkipped: false
                            }]
                        },
                        options: {
                            ...commonOptions,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1,
                                        font: {
                                            family: "'Poppins', sans-serif",
                                            size: 11
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        font: {
                                            family: "'Poppins', sans-serif",
                                            size: 11
                                        }
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                } else {
                    topEmployeesChartEl.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No hay préstamos registrados</p>';
                }
            }

            // Nuevo: Gráfico de Tendencias Temporales
            const transactionsTrendChartEl = document.getElementById('transactionsTrendChart');
            if (transactionsTrendChartEl) {
                const last30Days = [];
                const today = new Date();
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    last30Days.push(date.toISOString().split('T')[0]);
                }
                
                const transactionsByDate = last30Days.map(date => {
                    return state.transactions.filter(t => {
                        // Handle both timestamp (Firebase Timestamp) and date (string) formats
                        if (t.timestamp) {
                            // Firebase Timestamp object
                            const timestampSeconds = t.timestamp.seconds || (t.timestamp.toMillis ? t.timestamp.toMillis() / 1000 : null);
                            if (timestampSeconds) {
                                const transactionDate = new Date(timestampSeconds * 1000);
                                const transactionDateStr = transactionDate.toISOString().split('T')[0];
                                return transactionDateStr === date;
                            }
                        } else if (t.date && typeof t.date === 'string') {
                            // String date format
                            return t.date.startsWith(date);
                        }
                        return false;
                    }).length;
                });
                
                if (transactionsByDate.some(count => count > 0)) {
                    new Chart(transactionsTrendChartEl, {
                        type: 'line',
                        data: {
                            labels: last30Days.map(date => {
                                const d = new Date(date);
                                return d.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
                            }),
                            datasets: [{
                                label: 'Transacciones por Día',
                                data: transactionsByDate,
                                borderColor: 'rgba(79, 70, 229, 1)',
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                pointBackgroundColor: 'rgba(79, 70, 229, 1)',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2
                            }]
                        },
                        options: {
                            ...commonOptions,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1,
                                        font: {
                                            family: "'Poppins', sans-serif",
                                            size: 11
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        font: {
                                            family: "'Poppins', sans-serif",
                                            size: 10
                                        },
                                        maxRotation: 45,
                                        minRotation: 45
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                } else {
                    transactionsTrendChartEl.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No hay transacciones en los últimos 30 días</p>';
                }
            }

            // Nuevo: Gráfico de Distribución por Categorías
            const categoryDistributionChartEl = document.getElementById('categoryDistributionChart');
            if (categoryDistributionChartEl) {
                const categoryCounts = state.inventory.reduce((acc, item) => {
                    acc[item.category] = (acc[item.category] || 0) + 1;
                    return acc;
                }, {});
                
                const categories = Object.entries(categoryCounts).sort(([,a],[,b]) => b-a);
                
                if (categories.length > 0) {
                    const categoryColors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#06b6d4', '#f97316', '#ef4444'];
                    new Chart(categoryDistributionChartEl, {
                        type: 'bar',
                        data: {
                            labels: categories.map(item => item[0]),
                            datasets: [{
                                label: 'Artículos por Categoría',
                                data: categories.map(item => item[1]),
                                backgroundColor: categoryColors.slice(0, categories.length).map(c => c + 'CC'),
                                borderColor: categoryColors.slice(0, categories.length),
                                borderWidth: 2,
                                borderRadius: 8
                            }]
                        },
                        options: {
                            ...commonOptions,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1,
                                        font: {
                                            family: "'Poppins', sans-serif",
                                            size: 11
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        font: {
                                            family: "'Poppins', sans-serif",
                                            size: 11
                                        },
                                        maxRotation: 45,
                                        minRotation: 45
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                } else {
                    categoryDistributionChartEl.parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">No hay categorías disponibles</p>';
                }
            }
        }
        function exportToCSV(type, headers, data) {
            const filename = `${type}_${new Date().toISOString().slice(0,10)}.csv`;
            let csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...data.map(row => row.map(cell => `"${String(cell ?? '').replace(/"/g, '""')}"`).join(','))].join('\n');
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            link.remove();
        }
        
        function getFullInventoryList() {
            return [
                { description: 'Tornillo Allen 1/4"', category: 'Tornillería', stock: 500, unit: 'pza', minStock: 100 },
                { description: 'Endmill Plano 1/2"', category: 'Herramientas de Corte', stock: 15, unit: 'pza', minStock: 5 },
                { description: 'Calibrador Vernier Digital', category: 'Herramientas de Medición', stock: 5, unit: 'pza', minStock: 0 },
                { description: 'Guantes de Nitrilo', category: 'Seguridad', stock: 2, unit: 'caja', minStock: 1 },
                { description: 'WD-40 Lata Grande', category: 'Químicos', stock: 10, unit: 'lata', minStock: 3 },
                { description: 'Taladro Inalámbrico Dewalt', category: 'Herramienta Eléctrica', stock: 3, unit: 'pza', minStock: 0 },
            ];
        }

        // Agregar link de IA en la navegación (llamar esto en initApp o después de cargar la app)
        function addAINavigation() {
            const aiNavLink = document.getElementById('ai-nav-link');
            if (aiNavLink) {
                aiNavLink.classList.remove('hidden');
            }
        }

        // Setup mobile FAB event listener
        function setupMobileFAB() {
            // Use a delay to ensure DOM is ready
            setTimeout(() => {
                const mobileFAB = document.getElementById('mobile-fab');
                if (mobileFAB) {
                    // Remove any existing listeners by cloning
                    const oldFAB = mobileFAB;
                    const newFAB = oldFAB.cloneNode(true);
                    oldFAB.parentNode.replaceChild(newFAB, oldFAB);
                    
                    // Add click event listener to the new button
                    newFAB.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showQuickAddItemModal();
                    });
                    
                    // Also add touchstart for better mobile support
                    newFAB.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showQuickAddItemModal();
                    });
                    
                    // Recreate icons for the FAB
                    safeCreateIcons();
                } else {
                    console.warn('Mobile FAB not found');
                }
            }, 300);
        }

        // Helper functions for text formatting
        function toTitleCase(str) {
            if (!str || typeof str !== 'string') return str;
            
            // Lista de palabras que no deben capitalizarse (preposiciones, artículos, etc.)
            const lowercaseWords = ['de', 'del', 'la', 'el', 'en', 'con', 'por', 'para', 'a', 'al', 'un', 'una', 'y', 'o', 'pero', 'mas', 'sin', 'sobre', 'bajo', 'entre', 'hasta', 'desde', 'hacia', 'durante', 'mediante', 'según', 'ante', 'cabe', 'contra', 'tras'];
            
            return str
                .toLowerCase()
                .split(' ')
                .map((word, index) => {
                    // Siempre capitalizar la primera palabra
                    if (index === 0) {
                        return word.charAt(0).toUpperCase() + word.slice(1);
                    }
                    // No capitalizar palabras en la lista de excepciones
                    if (lowercaseWords.includes(word)) {
                        return word;
                    }
                    // Capitalizar todas las demás palabras
                    return word.charAt(0).toUpperCase() + word.slice(1);
                })
                .join(' ');
        }

    </script>

    <!-- AI Analysis Script -->
    <script>
        // --- FUNCIÓN GLOBAL PARA ICONOS ---
        function safeCreateIcons() {
            if (window.lucide) {
                try {
                    lucide.createIcons();
                } catch (e) {
                    console.error("Error creating lucide icons:", e);
                }
            } else {
                setTimeout(() => {
                    if(window.lucide) {
                        try {
                           lucide.createIcons();
                        } catch (e) {
                           console.error("Error creating lucide icons on retry:", e);
                        }
                    } else {
                        console.error("Lucide icons library failed to load.");
                    }
                }, 1000);
            }
        }
    </script>
</body>
</html>